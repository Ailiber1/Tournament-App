<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --hud-green: #00ff41;
      --hud-green-dim: #00aa2a;
      --hud-green-glow: rgba(0, 255, 65, 0.6);
      --hud-gold: #ffcc00;
      --hud-red: #ff3366;
      --bg-dark: #000a04;
      --bg-panel: rgba(0, 20, 10, 0.85);
      --text-primary: #c0ffc0;
      --text-dim: #4a8a4a;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: #000a04;
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .matrix-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .matrix-col {
      position: absolute;
      top: -100%;
      font-family: 'MS Gothic', monospace;
      font-size: 14px;
      line-height: 1.2;
      color: #00ff41;
      writing-mode: vertical-rl;
      animation: matrix-fall linear infinite;
      opacity: 0.12;
      text-shadow: 0 0 3px #00ff41;
    }
    @keyframes matrix-fall {
      0% { transform: translateY(0); }
      100% { transform: translateY(220vh); }
    }
    .header {
      position: relative;
      z-index: 10;
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      background: linear-gradient(180deg, rgba(0,30,15,0.95) 0%, rgba(0,15,8,0.9) 100%);
      border-bottom: 2px solid var(--hud-green);
      box-shadow: 0 0 20px var(--hud-green-glow);
    }
    .header.visible { display: flex; }
    .back-btn {
      background: transparent;
      border: 2px solid var(--hud-green);
      color: var(--hud-green);
      padding: 0.5rem 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      visibility: hidden;
    }
    .back-btn.visible { visibility: visible; }
    .back-btn:hover { background: var(--hud-green); color: var(--bg-dark); box-shadow: 0 0 15px var(--hud-green-glow); }
    .app-title {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1.3rem, 4vw, 1.8rem);
      font-weight: 900;
      color: var(--hud-green);
      text-shadow: 0 0 10px var(--hud-green-glow);
      letter-spacing: 0.15em;
    }
    .header-icons { display: flex; gap: 0.8rem; }
    .info-btn {
      background: transparent;
      border: 2px solid var(--hud-green);
      color: var(--hud-green);
      width: 38px; height: 38px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .info-btn:hover { background: var(--hud-green); color: var(--bg-dark); box-shadow: 0 0 15px var(--hud-green-glow); transform: scale(1.1); }
    .info-btn.admin-info { border-color: var(--hud-gold); color: var(--hud-gold); }
    .info-btn.admin-info:hover { background: var(--hud-gold); box-shadow: 0 0 15px rgba(255,204,0,0.5); }
    .main-container { position: relative; z-index: 5; min-height: 100vh; padding: 1rem; }
    .screen { display: none; }
    .screen.active { display: block; }
    .title-screen { min-height: 100vh; display: flex; flex-direction: column; }
    @media (min-width: 900px) {
      .title-screen { flex-direction: row; padding: 2rem; }
    }
    .title-left-menu { display: flex; flex-direction: column; gap: 0.4rem; padding: 1rem; }
    @media (min-width: 900px) {
      .title-left-menu { width: 280px; padding-top: 4rem; }
    }
    .title-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem 1rem; }
    .title-right-info { padding: 1rem; }
    @media (min-width: 900px) {
      .title-right-info { width: 300px; padding-top: 4rem; }
    }
    .main-title {
      font-family: 'Times New Roman', 'Georgia', serif;
      font-size: clamp(2.5rem, 10vw, 4.5rem);
      font-weight: bold;
      letter-spacing: 0.25em;
      position: relative;
      display: inline-block;
      color: #b8e6c8;
      background: linear-gradient(
        180deg,
        #3a6a50 0%,
        #5a9a70 10%,
        #8cd4a8 25%,
        #c8f0d8 40%,
        #e8fff0 48%,
        #ffffff 50%,
        #e8fff0 52%,
        #c8f0d8 60%,
        #8cd4a8 75%,
        #5a9a70 90%,
        #3a6a50 100%
      );
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: none;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.8)) drop-shadow(0 0 20px rgba(100, 255, 150, 0.3));
      margin-bottom: 0;
    }
    .title-wrapper {
      text-align: center;
      padding: 1.5rem 1rem 1rem;
    }
    .title-guide-icons { position: fixed; top: 1.2rem; right: 1.5rem; display: flex; gap: 0.6rem; z-index: 20; }
    
    /* PC Layout */
    .title-layout {
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 100px);
    }
    @media (min-width: 900px) {
      .title-layout {
        flex-direction: row;
        padding: 0 2rem;
      }
      .title-layout .left-menu {
        width: 280px;
        flex-shrink: 0;
        padding: 1rem 1rem 1rem 0;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      .title-layout .center-content {
        flex: 1;
        padding: 1rem 2rem;
        display: flex;
        flex-direction: column;
      }
    }
    @media (max-width: 899px) {
      .title-layout .left-menu {
        order: 2;
        max-width: 400px;
        margin: 0 auto;
        padding: 0 1rem;
        width: 100%;
      }
      .title-layout .center-content {
        order: 1;
      }
    }
    .hud-panel {
      background: var(--bg-panel);
      border: 2px solid var(--hud-green);
      position: relative;
      padding: 1.2rem;
      clip-path: polygon(0 0, calc(100% - 12px) 0, 100% 12px, 100% 100%, 12px 100%, 0 calc(100% - 12px));
      box-shadow: 0 0 15px var(--hud-green-glow), inset 0 0 30px rgba(0,255,65,0.05);
    }
    .hud-panel-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      color: var(--hud-green);
      letter-spacing: 0.08em;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--hud-green-dim);
    }
    .menu-btn {
      display: block;
      width: 100%;
      background: linear-gradient(90deg, rgba(0,40,20,0.9) 0%, rgba(0,60,30,0.8) 100%);
      border: 2px solid var(--hud-green);
      border-left: 4px solid var(--hud-green);
      color: var(--hud-green);
      padding: 0.9rem 1rem;
      font-size: 0.95rem;
      font-weight: bold;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .menu-btn:hover:not(:disabled) {
      background: linear-gradient(90deg, var(--hud-green) 0%, rgba(0,255,65,0.7) 100%);
      color: var(--bg-dark);
      box-shadow: 0 0 20px var(--hud-green-glow);
      transform: translateX(5px);
    }
    .menu-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: var(--text-dim); color: var(--text-dim); }
    .menu-btn.cancel-btn { 
      background: linear-gradient(90deg, rgba(40,10,20,0.9) 0%, rgba(60,15,30,0.8) 100%);
      border: 2px solid var(--hud-red); 
      border-left: 4px solid var(--hud-red); 
      color: var(--hud-red);
      margin-top: 1rem;
    }
    .menu-btn.cancel-btn:hover:not(:disabled) { background: linear-gradient(90deg, var(--hud-red) 0%, rgba(255,50,100,0.7) 100%); color: white; box-shadow: 0 0 20px rgba(255,50,100,0.5); }
    .info-display { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.8rem; margin-bottom: 1rem; }
    @media (max-width: 700px) { .info-display { grid-template-columns: repeat(2, 1fr); } }
    .info-item { background: rgba(0,30,15,0.6); border: 1px solid var(--hud-green-dim); padding: 0.6rem; text-align: center; }
    .info-label { font-size: 0.7rem; color: var(--text-dim); margin-bottom: 0.2rem; }
    .info-value { font-family: 'Orbitron', sans-serif; font-size: 0.9rem; color: var(--hud-green); }
    .info-value.warning { color: var(--hud-red); }
    .title-info-panel {
      max-width: 100%;
      margin: 0 0 1.5rem 0;
      background: var(--bg-panel);
      border: 2px solid var(--hud-green);
      padding: 1rem 1.5rem;
    }
    @media (max-width: 899px) {
      .title-info-panel {
        max-width: 800px;
        margin: 0 auto 1.5rem;
      }
    }
    .title-info-panel .hud-panel-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      color: var(--hud-green);
      letter-spacing: 0.08em;
      margin-bottom: 0.8rem;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid var(--hud-green-dim);
      text-align: center;
    }
    .title-info-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
    }
    @media (max-width: 600px) {
      .title-info-grid { grid-template-columns: repeat(2, 1fr); }
    }
    .title-info-item {
      background: rgba(0,40,20,0.5);
      border: 1px solid var(--hud-green-dim);
      padding: 0.8rem;
      text-align: center;
    }
    .title-info-label { font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.3rem; }
    .title-info-value { font-family: 'Orbitron', sans-serif; font-size: 1rem; color: var(--hud-green); }
    .title-info-value.warning { color: var(--hud-red); }
    .sound-controls {
      position: fixed;
      bottom: 1.5rem;
      left: 1.5rem;
      display: flex;
      gap: 0.5rem;
      z-index: 100;
    }
    .sound-btn {
      background: rgba(0, 20, 10, 0.9);
      border: 1px solid var(--hud-green);
      color: var(--hud-green);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .sound-btn:hover { background: var(--hud-green); color: var(--bg-dark); }
    .sound-btn.off { border-color: var(--text-dim); color: var(--text-dim); opacity: 0.5; }
    .sound-btn.off:hover { background: var(--text-dim); color: white; }
    @media (max-width: 600px) {
      .sound-controls { bottom: 1rem; left: 1rem; }
      .sound-btn { width: 40px; height: 40px; font-size: 1rem; }
    }
    .form-group { margin-bottom: 1.2rem; }
    .form-label { display: block; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.4rem; }
    .form-input {
      width: 100%;
      padding: 0.7rem 0.9rem;
      background: rgba(0, 20, 10, 0.9);
      border: 2px solid var(--hud-green-dim);
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.2s;
    }
    .form-input:focus { outline: none; border-color: var(--hud-green); box-shadow: 0 0 10px var(--hud-green-glow); }
    .error-message {
      background: rgba(255,50,100,0.2);
      border: 1px solid var(--hud-red);
      color: var(--hud-red);
      padding: 0.4rem;
      margin-top: 0.4rem;
      font-size: 0.8rem;
      display: none;
    }
    .error-message.visible { display: block; }
    .submit-btn {
      width: 100%;
      padding: 0.9rem;
      background: linear-gradient(180deg, rgba(0,60,30,0.9) 0%, rgba(0,40,20,0.95) 100%);
      border: 2px solid var(--hud-green);
      color: var(--hud-green);
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .submit-btn::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--hud-green); box-shadow: 0 0 10px var(--hud-green-glow); }
    .submit-btn:hover:not(:disabled) { background: var(--hud-green); color: var(--bg-dark); box-shadow: 0 0 25px var(--hud-green-glow); }
    .submit-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .participant-panel { background: var(--bg-panel); border: 2px solid var(--hud-green); }
    .lottery-sidebar .participant-panel { height: 100%; display: flex; flex-direction: column; }
    .lottery-sidebar .participant-list { flex: 1; max-height: none; overflow-y: auto; }
    @media (min-width: 900px) {
      .lottery-sidebar .participant-list { max-height: 450px; }
    }
    .participant-header { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1rem; border-bottom: 1px solid var(--hud-green-dim); }
    .participant-title { font-family: 'Orbitron', sans-serif; color: var(--hud-green); font-size: 0.9rem; }
    .participant-search { padding: 0.4rem 0.6rem; background: rgba(0,20,10,0.8); border: 1px solid var(--hud-green-dim); color: var(--text-primary); font-size: 0.85rem; width: 140px; }
    .participant-list { max-height: 350px; overflow-y: auto; }
    .participant-row { display: grid; grid-template-columns: 55px 35px 1fr 70px; align-items: center; padding: 0.5rem 0.8rem; border-bottom: 1px solid rgba(0,255,65,0.1); font-size: 0.85rem; }
    .participant-row:hover { background: rgba(0,255,65,0.05); }
    .participant-row.header { background: rgba(0,40,20,0.5); font-size: 0.75rem; color: var(--text-dim); }
    .participant-id { font-family: 'Orbitron', sans-serif; color: var(--hud-green); font-size: 0.8rem; }
    .participant-icon { width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--hud-green); background: var(--bg-dark); display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 0.8rem; }
    .participant-icon img { width: 100%; height: 100%; object-fit: cover; }
    .status-badge { padding: 0.15rem 0.4rem; font-size: 0.7rem; font-weight: bold; }
    .status-active { background: rgba(0,255,65,0.2); border: 1px solid var(--hud-green); color: var(--hud-green); }
    .status-lost { background: rgba(100,100,100,0.2); border: 1px solid #666; color: #666; }
    .status-seed { background: rgba(255,165,0,0.2); border: 1px solid #ffa500; color: #ffa500; }
    .participant-count { padding: 0.6rem 0.8rem; text-align: right; color: var(--text-dim); font-size: 0.8rem; border-top: 1px solid var(--hud-green-dim); }
    .participant-count span { color: var(--hud-gold); font-weight: bold; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 5, 2, 0.92); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-panel); border: 2px solid var(--hud-green); padding: 1.5rem; max-width: 450px; width: 90%; position: relative; clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 15px, 100% 100%, 15px 100%, 0 calc(100% - 15px)); box-shadow: 0 0 30px var(--hud-green-glow); }
    .modal-content.guide-modal { max-width: 700px; width: 95%; }
    @media (max-width: 750px) {
      .modal-content.guide-modal { max-width: 95%; }
      .guide-content h4, .guide-content p, .guide-content li { white-space: normal; }
    }
    .modal-close-btn { position: absolute; top: 8px; right: 12px; background: transparent; border: none; color: var(--text-dim); font-size: 1.5rem; cursor: pointer; }
    .modal-close-btn:hover { color: var(--hud-green); }
    .modal-title { font-family: 'Orbitron', sans-serif; color: var(--hud-green); font-size: 1.1rem; text-align: center; margin-bottom: 1.2rem; }
    .modal-buttons { display: flex; gap: 0.8rem; margin-top: 1.2rem; }
    .modal-btn { flex: 1; padding: 0.7rem; font-weight: bold; cursor: pointer; transition: all 0.2s; }
    .modal-btn-cancel { background: transparent; border: 1px solid var(--text-dim); color: var(--text-dim); }
    .modal-btn-cancel:hover { border-color: var(--hud-green); color: var(--hud-green); }
    .modal-btn-confirm { background: var(--hud-green); border: none; color: var(--bg-dark); }
    .modal-btn-confirm:hover { box-shadow: 0 0 20px var(--hud-green-glow); }
    .guide-content { color: var(--text-primary); line-height: 1.7; max-height: 55vh; overflow-y: auto; font-size: 0.9rem; }
    .guide-content h4 { color: var(--hud-green); margin: 1rem 0 0.4rem; font-size: 0.95rem; white-space: nowrap; }
    .guide-content p { color: var(--text-dim); margin-bottom: 0.4rem; white-space: nowrap; }
    .guide-content ul { margin-left: 1rem; color: var(--text-dim); }
    .guide-content li { margin-bottom: 0.3rem; white-space: nowrap; }
    .calendar-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 5, 2, 0.95); z-index: 2000; align-items: center; justify-content: center; }
    .calendar-modal.active { display: flex; }
    .calendar-container { background: var(--bg-panel); border: 2px solid var(--hud-green); padding: 1.2rem; max-width: 340px; width: 95%; box-shadow: 0 0 30px var(--hud-green-glow); position: relative; }
    .calendar-close { position: absolute; top: 8px; right: 10px; background: transparent; border: none; color: var(--text-dim); font-size: 1.3rem; cursor: pointer; }
    .calendar-title { font-family: 'Orbitron', sans-serif; color: var(--hud-green); text-align: center; margin-bottom: 0.8rem; font-size: 1rem; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
    .calendar-nav { background: transparent; border: 1px solid var(--hud-green); color: var(--hud-green); width: 32px; height: 32px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
    .calendar-nav:hover { background: var(--hud-green); color: var(--bg-dark); }
    .calendar-month-year { font-family: 'Orbitron', sans-serif; color: var(--hud-green); font-size: 0.95rem; }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 0.3rem; }
    .calendar-weekday { text-align: center; color: var(--text-dim); font-size: 0.75rem; padding: 0.2rem; }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
    .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: rgba(0,30,15,0.5); border: 1px solid transparent; color: var(--text-primary); cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
    .calendar-day:hover:not(.disabled):not(.empty) { border-color: var(--hud-green); background: rgba(0,255,65,0.2); }
    .calendar-day.selected { background: var(--hud-green) !important; color: var(--bg-dark) !important; font-weight: bold; box-shadow: 0 0 10px var(--hud-green-glow); }
    .calendar-day.today:not(.selected) { border-color: var(--hud-gold); }
    .calendar-day.disabled { color: #333; cursor: not-allowed; }
    .calendar-day.empty { background: transparent; cursor: default; }
    .calendar-time { display: flex; justify-content: center; align-items: center; gap: 0.4rem; margin-top: 0.8rem; }
    .calendar-time-input { width: 55px; padding: 0.4rem; background: rgba(0,20,10,0.8); border: 1px solid var(--hud-green-dim); color: var(--text-primary); text-align: center; font-size: 1rem; }
    .calendar-selected-display { text-align: center; color: var(--hud-gold); margin-top: 0.8rem; padding: 0.4rem; background: rgba(255,204,0,0.1); border: 1px solid var(--hud-gold); font-size: 0.9rem; }
    .calendar-confirm { width: 100%; margin-top: 0.8rem; padding: 0.7rem; background: var(--hud-green); border: none; color: var(--bg-dark); font-weight: bold; cursor: pointer; }
    .calendar-confirm:hover { box-shadow: 0 0 20px var(--hud-green-glow); }
    .toast { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%) translateY(100px); padding: 0.8rem 1.5rem; font-weight: bold; z-index: 3000; transition: transform 0.3s; border: 2px solid; font-size: 0.9rem; }
    .toast.visible { transform: translateX(-50%) translateY(0); }
    .toast.success { background: rgba(0,40,20,0.95); border-color: var(--hud-green); color: var(--hud-green); }
    .toast.error { background: rgba(40,10,20,0.95); border-color: var(--hud-red); color: var(--hud-red); }
    .my-entry-box { background: rgba(0,255,65,0.1); border: 2px solid var(--hud-green); padding: 1.2rem; text-align: center; }
    .my-entry-title { color: var(--hud-green); font-size: 1rem; margin-bottom: 0.8rem; }
    .my-entry-info { font-size: 1.1rem; color: var(--text-primary); }
    .my-entry-id { color: var(--hud-gold); font-weight: bold; }
    /* æŠ½é¸ä¼šå ´ã¸ãƒœã‚¿ãƒ³ */
    .lottery-venue-btn {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      padding: 1.2rem 2.5rem;
      background: rgba(0, 40, 20, 0.9);
      border: 2px solid var(--hud-green-dim);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .lottery-venue-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .lottery-venue-btn:not(:disabled) {
      border-color: var(--hud-green);
      box-shadow: 0 0 20px var(--hud-green-glow), inset 0 0 20px rgba(0, 255, 65, 0.1);
      animation: lottery-pulse 2s infinite;
    }
    .lottery-venue-btn:not(:disabled):hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px var(--hud-green-glow), inset 0 0 30px rgba(0, 255, 65, 0.2);
    }
    @keyframes lottery-pulse {
      0%, 100% { box-shadow: 0 0 20px var(--hud-green-glow); }
      50% { box-shadow: 0 0 35px var(--hud-green-glow), 0 0 50px rgba(0, 255, 65, 0.3); }
    }
    .lottery-icon { font-size: 2rem; }
    .lottery-text { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; color: var(--hud-green); font-weight: bold; }
    .lottery-sub { font-size: 0.75rem; color: var(--text-dim); }
    .lottery-venue-btn:not(:disabled) .lottery-sub { display: none; }
    
    /* æŠ½é¸ä¼šå ´ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .lottery-arena {
      display: none;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    .lottery-arena.active { display: block; }
    
    @media (min-width: 900px) {
      .lottery-arena {
        display: none;
        grid-template-columns: 1fr 350px;
        gap: 1.5rem;
      }
      .lottery-arena.active { display: grid; }
    }
    
    /* å·¦å´ï¼šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼‹VS */
    .lottery-main {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .roulette-container { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      position: relative;
    }
    .roulette-wheel { 
      width: 280px; 
      height: 280px; 
      border: 4px solid var(--hud-green); 
      border-radius: 50%; 
      position: relative; 
      background: radial-gradient(circle, rgba(0,60,30,0.9) 0%, rgba(0,20,10,0.95) 70%, var(--bg-dark) 100%); 
      box-shadow: 0 0 40px var(--hud-green-glow), inset 0 0 60px rgba(0,255,65,0.1);
    }
    @media (min-width: 900px) {
      .roulette-wheel { 
        width: 420px; 
        height: 420px; 
        border-width: 5px;
      }
    }
    .wheel-inner { width: 100%; height: 100%; transition: transform 4s cubic-bezier(0.17,0.67,0.12,0.99); }
    .wheel-segment { 
      position: absolute; 
      width: 100%; 
      height: 100%; 
      display: flex; 
      align-items: flex-start; 
      justify-content: center; 
      padding-top: 15px; 
      font-family: 'Orbitron', sans-serif; 
      font-size: 0.85rem; 
      color: var(--hud-green); 
      text-shadow: 0 0 8px var(--hud-green-glow);
    }
    @media (min-width: 900px) {
      .wheel-segment { font-size: 1rem; padding-top: 20px; }
    }
    
    /* VSè¡¨ç¤ºï¼ˆãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸­å¤®ã«é‡ã­ã‚‹ï¼‰ */
    .vs-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      text-align: center;
      pointer-events: none;
    }
    .vs-display { 
      background: rgba(0, 20, 10, 0.95); 
      border: 3px solid var(--hud-green); 
      border-radius: 12px;
      padding: 1rem 1.5rem; 
      text-align: center;
      box-shadow: 0 0 30px rgba(0,0,0,0.8);
    }
    @media (min-width: 900px) {
      .vs-display { padding: 1.5rem 2rem; }
    }
    .vs-title { color: var(--hud-gold); font-size: 0.9rem; margin-bottom: 0.8rem; font-weight: bold; }
    .vs-players { display: flex; align-items: center; justify-content: center; gap: 1rem; }
    @media (min-width: 900px) {
      .vs-players { gap: 1.5rem; }
    }
    .vs-player { text-align: center; }
    .vs-player-icon { 
      width: 60px; 
      height: 60px; 
      border-radius: 50%; 
      border: 3px solid var(--hud-green); 
      margin: 0 auto 0.5rem; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: var(--bg-dark); 
      overflow: hidden;
      font-size: 1.5rem;
    }
    @media (min-width: 900px) {
      .vs-player-icon { width: 80px; height: 80px; font-size: 2rem; }
    }
    .vs-player-id { color: var(--text-dim); font-size: 0.8rem; font-family: 'Orbitron', sans-serif; }
    .vs-player-name { 
      color: var(--hud-green); 
      font-weight: bold; 
      font-size: 1rem; 
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    @media (min-width: 900px) {
      .vs-player-name { font-size: 1.2rem; max-width: 120px; }
    }
    .vs-text { 
      font-family: 'Orbitron', sans-serif; 
      font-size: 2rem; 
      color: var(--hud-gold); 
      text-shadow: 0 0 15px rgba(255,204,0,0.7);
      animation: vs-pulse 1.5s infinite;
    }
    @media (min-width: 900px) {
      .vs-text { font-size: 2.5rem; }
    }
    @keyframes vs-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    /* æ“ä½œãƒœã‚¿ãƒ³ */
    .roulette-controls { 
      display: flex; 
      gap: 0.8rem; 
      flex-wrap: wrap; 
      justify-content: center; 
      margin-top: 1.5rem;
    }
    .roulette-btn { 
      padding: 0.9rem 1.5rem; 
      font-weight: bold; 
      cursor: pointer; 
      transition: all 0.2s; 
      font-size: 1rem;
      border-radius: 6px;
    }
    .roulette-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #spinBtn { background: var(--hud-green); border: none; color: var(--bg-dark); }
    #spinBtn:hover:not(:disabled) { box-shadow: 0 0 20px var(--hud-green-glow); }
    #confirmMatchBtn { background: transparent; border: 2px solid var(--hud-gold); color: var(--hud-gold); }
    #confirmMatchBtn:hover:not(:disabled) { box-shadow: 0 0 15px rgba(255,204,0,0.5); }
    
    /* å‹è€…é¸æŠãƒœã‚¿ãƒ³ */
    .winner-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      padding: 1rem 1.5rem !important;
      min-width: 140px;
    }
    .winner-btn:hover { box-shadow: 0 0 20px var(--hud-green-glow); transform: scale(1.05); }
    .winner-label { font-size: 0.8rem; color: var(--hud-gold); }
    .winner-name { font-size: 1.1rem; font-weight: bold; color: var(--hud-green); }
    
    /* ãƒãƒƒãƒãƒ³ã‚°ä¸­ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .participant-row.matching {
      background: rgba(0, 255, 65, 0.15) !important;
      border-left: 3px solid var(--hud-green);
      animation: matching-pulse 1.5s infinite;
    }
    @keyframes matching-pulse {
      0%, 100% { background: rgba(0, 255, 65, 0.1); }
      50% { background: rgba(0, 255, 65, 0.2); }
    }
    
    /* ç¾åœ¨ã®ãƒãƒƒãƒè¡¨ç¤º */
    .current-match-display {
      background: rgba(0, 40, 20, 0.9);
      border: 2px solid var(--hud-gold);
      padding: 1rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    .current-match-title { color: var(--hud-gold); font-size: 0.85rem; margin-bottom: 0.5rem; }
    .current-match-vs { 
      font-family: 'Orbitron', sans-serif; 
      color: var(--hud-green); 
      font-size: 1rem;
    }
    .current-match-vs span { color: var(--hud-gold); margin: 0 0.5rem; }
    
    /* ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ - ãƒ„ãƒªãƒ¼å‹ãƒ–ãƒ©ã‚±ãƒƒãƒˆ */
    .bracket-container {
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem 1rem;
      overflow-x: auto;
      overflow-y: auto;
      width: 100%;
      min-height: 60vh;
    }
    .bracket-container.active { display: flex; }
    
    .bracket-title {
      font-family: 'Orbitron', sans-serif;
      color: var(--hud-gold);
      font-size: 1.3rem;
      margin-bottom: 1.5rem;
      text-align: center;
      text-shadow: 0 0 10px rgba(255,204,0,0.5);
    }
    
    /* ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆãƒ–ãƒ©ã‚±ãƒƒãƒˆ - ä¼çµ±çš„ãªå½¢å¼ */
    .bracket-tree {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 1rem;
      min-width: fit-content;
    }
    
    /* å„ªå‹æ  */
    .bracket-champion-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.8rem 1.5rem;
      border: 3px solid var(--hud-gold);
      background: rgba(255, 204, 0, 0.15);
      animation: champion-glow 2s infinite;
      margin-bottom: 10px;
    }
    @keyframes champion-glow {
      0%, 100% { box-shadow: 0 0 15px rgba(255,204,0,0.3); }
      50% { box-shadow: 0 0 30px rgba(255,204,0,0.6); }
    }
    .bracket-champion-box.empty {
      border-style: dashed;
      animation: none;
      opacity: 0.6;
    }
    .champion-trophy { font-size: 1.5rem; }
    .champion-label { font-size: 0.7rem; color: var(--hud-gold); }
    .champion-name {
      font-family: 'Orbitron', sans-serif;
      font-size: 1rem;
      color: var(--hud-gold);
    }
    .bracket-champion-box.empty .champion-name { color: var(--text-dim); }
    
    /* ãƒ©ã‚¦ãƒ³ãƒ‰è¡Œ */
    .bracket-round-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 5px;
    }
    
    /* è©¦åˆãƒœãƒƒã‚¯ã‚¹ */
    .bracket-match-box {
      display: flex;
      gap: 2px;
      position: relative;
    }
    .bracket-match-box::after {
      content: '';
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 10px;
      background: var(--hud-green-dim);
    }
    .bracket-round-row:last-child .bracket-match-box::after {
      display: none;
    }
    .bracket-match-box.pending {
      filter: drop-shadow(0 0 8px rgba(255, 204, 0, 0.5));
    }
    
    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒœãƒƒã‚¯ã‚¹ï¼ˆç¸¦é•·ã€åå‰ç¸¦æ›¸ãï¼‰ */
    .bracket-player-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      width: 40px;
      min-height: 70px;
      padding: 6px 4px;
      background: rgba(0, 30, 15, 0.9);
      border: 2px solid var(--hud-green-dim);
      cursor: default;
      transition: all 0.2s;
      position: relative;
    }
    @media (min-width: 900px) {
      .bracket-player-box { width: 50px; min-height: 90px; }
    }
    
    .bracket-player-box.clickable { cursor: pointer; }
    .bracket-player-box.clickable:hover {
      background: rgba(0, 255, 65, 0.2);
      transform: scale(1.05);
    }
    .bracket-player-box.winner {
      background: rgba(0, 255, 65, 0.2);
      border-color: var(--hud-green);
    }
    .bracket-player-box.loser {
      opacity: 0.4;
      background: rgba(50, 50, 50, 0.3);
    }
    .bracket-player-box.seed {
      border-color: #ffa500;
    }
    .bracket-player-box.active {
      border-color: var(--hud-gold);
      animation: active-pulse 1.5s infinite;
    }
    @keyframes active-pulse {
      0%, 100% { box-shadow: 0 0 5px rgba(255, 204, 0, 0.4); }
      50% { box-shadow: 0 0 15px rgba(255, 204, 0, 0.7); }
    }
    .bracket-player-box.empty {
      border-style: dashed;
      opacity: 0.5;
    }
    
    /* ç¸¦æ›¸ãåå‰ */
    .player-name-v {
      writing-mode: vertical-rl;
      text-orientation: upright;
      color: var(--hud-green);
      font-size: 0.7rem;
      letter-spacing: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-height: 55px;
    }
    @media (min-width: 900px) {
      .player-name-v { font-size: 0.8rem; max-height: 70px; }
    }
    .bracket-player-box.loser .player-name-v {
      color: #555;
      text-decoration: line-through;
    }
    .bracket-player-box.winner .player-name-v {
      color: var(--hud-gold);
    }
    
    .player-id-v {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.5rem;
      color: var(--text-dim);
      margin-top: 3px;
    }
    
    .winner-mark, .seed-mark {
      font-size: 0.6rem;
      margin-bottom: 2px;
    }
    
    /* ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã¸ãƒœã‚¿ãƒ³ */
    .bracket-view-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.8rem 1.5rem;
      background: rgba(0, 40, 20, 0.9);
      border: 2px solid var(--hud-gold);
      color: var(--hud-gold);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9rem;
      margin: 0.5rem;
    }
    .bracket-view-btn:hover { box-shadow: 0 0 15px rgba(255,204,0,0.4); }
    .bracket-view-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    
    /* å³å´ï¼šå‚åŠ è€…ãƒªã‚¹ãƒˆ */
    .lottery-sidebar {
      margin-top: 1.5rem;
    }
    @media (min-width: 900px) {
      .lottery-sidebar { margin-top: 0; }
    }
    
    .history-card { background: var(--bg-panel); border: 1px solid var(--hud-green-dim); padding: 1rem; margin-bottom: 0.8rem; }
    .history-date { color: var(--text-dim); font-size: 0.8rem; }
    .history-game { color: var(--hud-green); font-size: 1.1rem; font-weight: bold; margin: 0.4rem 0; }
    .history-winner { color: var(--hud-gold); }
    .participant-status {
      text-align: center;
      padding: 2rem 1rem;
      margin-top: 1.5rem;
    }
    @media (min-width: 900px) {
      .participant-status {
        text-align: left;
        padding: 1rem 0;
      }
    }
    .participant-status-main {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.2rem;
      color: var(--hud-green);
      margin-bottom: 0.3rem;
    }
    @media (min-width: 900px) {
      .participant-status-main { font-size: 1.1rem; }
    }
    .participant-status-main span {
      color: var(--hud-gold);
      font-weight: bold;
    }
    .participant-status-sub {
      font-size: 0.7rem;
      color: var(--text-dim);
      line-height: 1.5;
    }
    
    /* HUD - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æƒ…å ±ã‚¨ãƒªã‚¢ */
    .hud-info-panel {
      position: fixed;
      bottom: 1.5rem;
      left: 320px;
      right: 2rem;
      background: rgba(0, 15, 8, 0.85);
      border: 1px solid var(--hud-green-dim);
      border-radius: 8px;
      padding: 1.2rem 1.5rem;
      z-index: 50;
      display: none;
    }
    /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ™‚ã®ã¿PCè¡¨ç¤º */
    @media (min-width: 900px) {
      #titleScreen.active ~ .hud-info-panel,
      .hud-info-panel.title-active { display: block; }
    }
    .hud-info-panel::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      border-radius: 8px;
      box-shadow: inset 0 0 20px rgba(0, 255, 65, 0.05);
      pointer-events: none;
    }
    .hud-content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    /* çŠ¶æ…‹ãƒãƒ¼ï¼ˆä¸Šéƒ¨æ¨ªé•·ï¼‰ */
    .hud-status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0, 30, 15, 0.6);
      border: 1px solid var(--hud-green);
      border-radius: 4px;
      padding: 0.8rem 1.5rem;
    }
    .hud-status-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }
    .hud-status-title {
      font-size: 0.8rem;
      color: var(--text-dim);
      letter-spacing: 0.05em;
    }
    .hud-status-list {
      display: flex;
      gap: 0.6rem;
    }
    .hud-status-item {
      font-size: 0.85rem;
      padding: 0.4rem 1rem;
      border: 1px solid var(--text-dim);
      color: var(--text-dim);
      border-radius: 3px;
      transition: all 0.3s;
    }
    .hud-status-item.active {
      border-color: var(--hud-green);
      color: var(--hud-green);
      box-shadow: 0 0 8px var(--hud-green-glow);
      text-shadow: 0 0 5px var(--hud-green-glow);
    }
    .hud-next-event {
      font-size: 0.9rem;
      color: var(--hud-gold);
    }
    .hud-system-notice {
      font-size: 0.8rem;
      color: var(--hud-red);
      margin-left: 1rem;
    }
    /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ï¼ˆä¸‹éƒ¨ï¼‰ */
    .hud-log-area {
      flex: 1;
      min-width: 0;
    }
    .hud-log-title {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-bottom: 0.6rem;
      letter-spacing: 0.05em;
    }
    .hud-log-list {
      height: 250px;
      overflow: hidden;
      font-size: 0.9rem;
      line-height: 1.6;
    }
    .hud-log-item {
      color: var(--text-primary);
      padding: 0.2rem 0;
      opacity: 1;
      transition: opacity 0.3s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .hud-log-item.fade-in {
      animation: logFadeIn 0.3s ease;
    }
    .hud-log-item.fade-out {
      opacity: 0;
    }
    .hud-log-item .log-time {
      color: var(--text-dim);
      margin-right: 0.6rem;
      font-size: 0.8rem;
    }
    @keyframes logFadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* ã‚¹ãƒãƒ›ç”¨HUD */
    .hud-mobile {
      display: none;
      background: rgba(0, 15, 8, 0.9);
      border: 1px solid var(--hud-green-dim);
      border-radius: 6px;
      padding: 0.8rem 1rem;
      margin-top: 1rem;
    }
    @media (max-width: 899px) {
      .hud-mobile { display: block; }
    }
    .hud-mobile .hud-status-bar {
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.5rem 0.8rem;
      margin-bottom: 0.8rem;
    }
    .hud-mobile .hud-status-left {
      flex-direction: column;
      gap: 0.5rem;
    }
    .hud-mobile .hud-status-list {
      justify-content: center;
      flex-wrap: wrap;
    }
    .hud-mobile .hud-next-event {
      text-align: center;
      font-size: 0.75rem;
    }
    .hud-mobile .hud-log-list {
      height: 60px;
      font-size: 0.7rem;
    }
    .hud-mobile .hud-log-title {
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="matrix-bg" id="matrixBg"></div>
  <header class="header" id="mainHeader">
    <button class="back-btn" id="backBtn" onclick="goBack()">â—€ æˆ»ã‚‹</button>
    <h1 class="app-title">ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</h1>
    <div class="header-icons">
      <button class="info-btn" onclick="showGuide('user')">?</button>
      <button class="info-btn admin-info" onclick="showGuide('admin')">ğŸ‘‘</button>
    </div>
  </header>
  <div class="main-container">
    <div class="screen active" id="titleScreen">
      <div class="title-guide-icons">
        <button class="info-btn" onclick="showGuide('user')">?</button>
        <button class="info-btn admin-info" onclick="showGuide('admin')">ğŸ‘‘</button>
      </div>
      
      <!-- ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¸Šéƒ¨ï¼‰ -->
      <div class="title-wrapper">
        <h1 class="main-title">ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</h1>
      </div>
      
      <!-- PC: å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ + ä¸­å¤®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ / ã‚¹ãƒãƒ›: ç¸¦ç©ã¿ -->
      <div class="title-layout">
        <!-- å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆPCæ™‚ï¼‰/ ä¸‹éƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆã‚¹ãƒãƒ›æ™‚ï¼‰ -->
        <div class="left-menu">
          <button class="menu-btn" id="entryBtn" onclick="navigateTo('entryScreen')" disabled>ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç™»éŒ²ã™ã‚‹</button>
          <button class="menu-btn" onclick="navigateTo('tournamentScreen')">ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹</button>
          <button class="menu-btn" onclick="navigateTo('historyScreen')">éå»ã®å¤§ä¼šè¨˜éŒ²ã‚’è¦‹ã‚‹</button>
          <button class="menu-btn" id="adminRegisterBtn" onclick="goToAdminScreen()">ç®¡ç†è€…ç™»éŒ²ã‚’ã™ã‚‹</button>
          <button class="menu-btn cancel-btn" id="cancelEntryBtn" onclick="cancelEntry()" disabled>ç™»éŒ²è§£é™¤</button>
          
          <!-- å‚åŠ è€…æ•°è¡¨ç¤ºï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸‹ï¼‰ -->
          <div class="participant-status" style="margin-top:1.5rem;padding:1rem 0;">
            <div class="participant-status-main">å‚åŠ è€…æ•°ï¼š<span id="titleParticipantCount">0</span>/100</div>
            <div class="participant-status-sub">â€»æœ€å¤§100äººãƒ»ä¸Šé™ã§ç· åˆ‡</div>
          </div>
        </div>
        
        <!-- ä¸­å¤®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="center-content">
          <!-- å¤§ä¼šæƒ…å ±ï¼ˆæ¨ªé•·ï¼‰ -->
          <div class="title-info-panel">
            <div class="hud-panel-title">â—† å¤§ä¼šæƒ…å ±</div>
            <div class="title-info-grid">
              <div class="title-info-item"><div class="title-info-label">ã‚²ãƒ¼ãƒ å</div><div class="title-info-value" id="titleGameName">æœªè¨­å®š</div></div>
              <div class="title-info-item"><div class="title-info-label">ç· åˆ‡æ—¥æ™‚</div><div class="title-info-value" id="titleDeadline">æœªè¨­å®š</div></div>
              <div class="title-info-item"><div class="title-info-label">ç®¡ç†è€…</div><div class="title-info-value" id="titleAdmin">-</div></div>
              <div class="title-info-item"><div class="title-info-label">å‚åŠ è€…</div><div class="title-info-value" id="titleCount">0å</div></div>
            </div>
          </div>
          
          <!-- ã‚¹ãƒãƒ›ç”¨HUDï¼ˆãƒ¢ãƒã‚¤ãƒ«æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
          <div class="hud-mobile" id="hudMobile">
            <div class="hud-status-bar">
              <div class="hud-status-left">
                <span class="hud-status-title">â–¶ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
                <div class="hud-status-list">
                  <span class="hud-status-item active" id="statusReceptionMobile">å—ä»˜ä¸­</span>
                  <span class="hud-status-item" id="statusClosedMobile">å—ä»˜çµ‚äº†</span>
                  <span class="hud-status-item" id="statusProgressMobile">é€²è¡Œä¸­</span>
                  <span class="hud-status-item" id="statusEndMobile">çµ‚äº†</span>
                </div>
              </div>
              <div class="hud-next-event" id="hudNextEventMobile"></div>
            </div>
            <div class="hud-log-title">â–¶ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°</div>
            <div class="hud-log-list" id="hudLogListMobile"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="screen" id="adminScreen">
      <div class="hud-panel" style="max-width:480px;margin:2rem auto;">
        <div class="hud-panel-title">â—† ç®¡ç†è€…ç™»éŒ²</div>
        <p style="margin-bottom:1.2rem;color:var(--text-dim);font-size:0.9rem;">ç®¡ç†è€…ã¨ã—ã¦ç™»éŒ²ã™ã‚‹ã¨ã€å¤§ä¼šã®è¨­å®šãƒ»é‹å–¶ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
        <div class="form-group">
          <label class="form-label">ç®¡ç†è€…å</label>
          <input type="text" class="form-input" id="adminNameInput" placeholder="ç®¡ç†è€…åã‚’å…¥åŠ›" maxlength="20">
          <div class="error-message" id="adminNameError"></div>
        </div>
        <button class="submit-btn" onclick="registerAdmin()">ç®¡ç†è€…ã¨ã—ã¦ç™»éŒ²</button>
      </div>
    </div>
    <div class="screen" id="adminSetupScreen">
      <div class="hud-panel" style="max-width:480px;margin:2rem auto;">
        <div class="hud-panel-title">â—† å¤§ä¼šè¨­å®š</div>
        <p style="margin-bottom:1.2rem;color:var(--text-dim);font-size:0.9rem;">ç· åˆ‡æ—¥æ™‚ã‚’è¨­å®šã™ã‚‹ã¨ã€å‚åŠ è€…ãŒã‚¨ãƒ³ãƒˆãƒªãƒ¼ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
        <div class="form-group">
          <label class="form-label">ã‚²ãƒ¼ãƒ åï¼ˆå¤§ä¼šåï¼‰<span style="color:var(--hud-red);"> *å¿…é ˆ</span></label>
          <input type="text" class="form-input" id="setupGameName" placeholder="ä¾‹: ã‚¹ãƒãƒ–ãƒ©SPå¤§ä¼š">
          <div class="error-message" id="setupGameNameError"></div>
        </div>
        <div class="form-group">
          <label class="form-label">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç· åˆ‡æ—¥æ™‚ <span style="color:var(--hud-red);">*å¿…é ˆ</span></label>
          <button type="button" class="form-input" id="setupDeadlineBtn" onclick="openCalendar('setup')" style="text-align:left;cursor:pointer;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ—¥æ™‚ã‚’é¸æŠ</button>
          <input type="hidden" id="setupDeadline">
          <div class="error-message" id="setupDeadlineError"></div>
        </div>
        <div class="form-group">
          <label class="form-label">å¯¾æˆ¦ç›¸æ‰‹ã‚’æ±ºã‚ã‚‹</label>
          <button type="button" class="form-input" id="matchmakingBtn" onclick="showMatchmakingInfo()" style="text-align:center;cursor:pointer;opacity:0.5;">ğŸ² å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰æŠ½é¸ï¼ˆç· åˆ‡å¾Œã«æœ‰åŠ¹åŒ–ï¼‰</button>
          <p style="font-size:0.75rem;color:var(--text-dim);margin-top:0.4rem;">â€»ç· åˆ‡æ—¥æ™‚ä»¥é™ã«æœ‰åŠ¹åŒ–ã•ã‚Œã¾ã™</p>
        </div>
        <button class="submit-btn" onclick="saveTournamentSettings()">è¨­å®šã‚’ä¿å­˜</button>
        
        <!-- ç®¡ç†è€…ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
        <div style="margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--hud-green-dim);">
          <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:0.8rem;">âš ï¸ ç®¡ç†è€…å°‚ç”¨</p>
          <button class="submit-btn" id="resetTournamentBtn" onclick="confirmResetTournament()" style="background:rgba(40,10,20,0.8);border-color:var(--hud-red);color:var(--hud-red);">ç®¡ç†è€…ç™»éŒ²è§£é™¤ãƒ»å¤§ä¼šãƒªã‚»ãƒƒãƒˆ</button>
          <p style="font-size:0.7rem;color:var(--text-dim);margin-top:0.5rem;">â€»ç· åˆ‡æ—¥æ™‚ä»¥é™ã¯å¤§ä¼šçµ‚äº†ã¾ã§ä½¿ç”¨ä¸å¯</p>
        </div>
      </div>
    </div>
    <div class="screen" id="entryScreen">
      <div class="hud-panel" style="max-width:480px;margin:2rem auto;">
        <div class="hud-panel-title">â—† ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç™»éŒ²</div>
        <div id="myEntryDisplay" style="display:none;">
          <div class="my-entry-box">
            <div class="my-entry-title">âœ“ ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¸ˆã¿</div>
            <div class="my-entry-info"><span id="myEntryName"></span><span class="my-entry-id" id="myEntryId"></span></div>
            <p style="font-size:0.75rem;color:var(--text-dim);margin-top:0.8rem;">â€»è§£é™¤ã¯ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®ã€Œç™»éŒ²è§£é™¤ã€ã‹ã‚‰</p>
          </div>
        </div>
        <div id="entryForm">
          <div class="form-group">
            <label class="form-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ </label>
            <input type="text" class="form-input" id="usernameInput" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›" maxlength="20">
            <div class="error-message" id="usernameError"></div>
          </div>
          <div class="form-group">
            <label class="form-label">ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆä»»æ„ï¼‰</label>
            <input type="file" accept="image/*" onchange="previewIcon(this)" style="display:none" id="iconInput">
            <div style="display:flex;align-items:center;gap:0.8rem;">
              <div style="position:relative;">
                <div id="iconPreview" style="width:55px;height:55px;border-radius:50%;border:2px solid var(--hud-green-dim);background:var(--bg-dark);display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;" onclick="document.getElementById('iconInput').click()"><span style="color:var(--text-dim);font-size:1.3rem;">+</span></div>
                <button type="button" id="iconDeleteBtn" onclick="clearIcon()" style="display:none;position:absolute;top:-5px;right:-5px;width:20px;height:20px;border-radius:50%;background:var(--hud-red);border:none;color:white;font-size:0.8rem;cursor:pointer;line-height:1;">Ã—</button>
              </div>
              <span style="color:var(--text-dim);font-size:0.8rem;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠ</span>
            </div>
          </div>
          <button class="submit-btn" onclick="submitEntry()">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç™»éŒ²</button>
        </div>
      </div>
    </div>
    <div class="screen" id="tournamentScreen">
      <div class="info-display" style="max-width:1200px;margin:1rem auto;">
        <div class="info-item"><div class="info-label">ã‚²ãƒ¼ãƒ å</div><div class="info-value" id="tournamentGameName">æœªè¨­å®š</div></div>
        <div class="info-item"><div class="info-label">ç®¡ç†è€…</div><div class="info-value" id="tournamentAdmin">-</div></div>
        <div class="info-item"><div class="info-label">ç· åˆ‡æ—¥æ™‚</div><div class="info-value" id="tournamentDeadline">æœªè¨­å®š</div></div>
        <div class="info-item"><div class="info-label">å‚åŠ è€…</div><div class="info-value" id="tournamentCount">0å</div></div>
      </div>
      
      <!-- æŠ½é¸ä¼šå ´ã¸ãƒœã‚¿ãƒ³ -->
      <div id="lotteryEntrance" style="max-width:700px;margin:1rem auto;text-align:center;">
        <button class="lottery-venue-btn" id="lotteryVenueBtn" onclick="enterLotteryVenue()" disabled>
          <span class="lottery-icon">âš”ï¸</span>
          <span class="lottery-text">æŠ½é¸ä¼šå ´ã¸</span>
          <span class="lottery-sub" id="lotteryBtnSub">ï¼ˆç· åˆ‡å¾Œã«è§£æ”¾ï¼‰</span>
        </button>
      </div>
      
      <!-- æŠ½é¸ä¼šå ´ï¼ˆå·¦ï¼šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã€å³ï¼šãƒªã‚¹ãƒˆï¼‰ -->
      <div class="lottery-arena" id="lotteryArena">
        <!-- å·¦å´ï¼šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼‹VS -->
        <div class="lottery-main">
          <div class="roulette-container" id="rouletteContainer">
            <div class="roulette-wheel">
              <div class="wheel-inner" id="wheelInner"></div>
              <!-- VSè¡¨ç¤ºï¼ˆä¸­å¤®ã«é‡ã­ã‚‹ï¼‰ -->
              <div class="vs-overlay">
                <div class="vs-display">
                  <div class="vs-title">âš”ï¸ å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰</div>
                  <div class="vs-players">
                    <div class="vs-player">
                      <div class="vs-player-icon" id="vsPlayer1Icon"><span>?</span></div>
                      <div class="vs-player-id" id="vsPlayer1Id">-</div>
                      <div class="vs-player-name" id="vsPlayer1Name">-</div>
                    </div>
                    <div class="vs-text">VS</div>
                    <div class="vs-player">
                      <div class="vs-player-icon" id="vsPlayer2Icon"><span>?</span></div>
                      <div class="vs-player-id" id="vsPlayer2Id">-</div>
                      <div class="vs-player-name" id="vsPlayer2Name">-</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
          <div class="roulette-controls" id="rouletteAdminControls" style="display:none;">
            <button class="roulette-btn" id="spinBtn" onclick="spinRoulette()">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå›è»¢</button>
            <button class="roulette-btn" id="confirmMatchBtn" onclick="confirmMatch()" disabled>å¯¾æˆ¦ç¢ºå®š</button>
            <button class="roulette-btn" id="endTournamentBtn" onclick="confirmEndTournament()" style="background:rgba(40,10,20,0.8);border-color:var(--hud-red);color:var(--hud-red);">å¤§ä¼šçµ‚äº†ãƒ»è¨˜éŒ²</button>
          </div>
          <div class="roulette-controls" id="matchResultControls" style="display:none;">
            <button class="roulette-btn winner-btn" id="winner1Btn" onclick="declareWinner(1)" style="background:rgba(0,80,40,0.9);border-color:var(--hud-green);">
              <span class="winner-label">ğŸ† å‹è€…</span>
              <span class="winner-name" id="winner1Name">-</span>
            </button>
            <button class="roulette-btn winner-btn" id="winner2Btn" onclick="declareWinner(2)" style="background:rgba(0,80,40,0.9);border-color:var(--hud-green);">
              <span class="winner-label">ğŸ† å‹è€…</span>
              <span class="winner-name" id="winner2Name">-</span>
            </button>
          </div>
          <!-- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ï¼ˆç®¡ç†è€…ç”¨ï¼‰ -->
          <div class="roulette-controls" id="bracketControls" style="display:none;margin-top:1rem;">
            <button class="bracket-view-btn" id="showBracketBtn" onclick="toggleBracketView()">
              ğŸ“Š ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚’è¦‹ã‚‹
            </button>
          </div>
        </div>
        
        <!-- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ï¼ˆ20åä»¥ä¸‹ã§è¡¨ç¤ºå¯èƒ½ï¼‰ -->
        <div class="bracket-container" id="bracketContainer">
          <h3 class="bracket-title">ğŸ† ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨</h3>
          <div id="bracketContent"></div>
          <div style="margin-top:1rem;">
            <button class="bracket-view-btn" onclick="toggleBracketView()">ğŸ² ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã«æˆ»ã‚‹</button>
          </div>
        </div>
        
        <!-- å³å´ï¼šå‚åŠ è€…ãƒªã‚¹ãƒˆ -->
        <div class="lottery-sidebar">
          <!-- ç¾åœ¨ã®ãƒãƒƒãƒè¡¨ç¤º -->
          <div class="current-match-display" id="currentMatchDisplay" style="display:none;">
            <div class="current-match-title">âš”ï¸ ç¾åœ¨ã®å¯¾æˆ¦</div>
            <div class="current-match-vs">
              <span id="currentMatch1">-</span>
              <span>VS</span>
              <span id="currentMatch2">-</span>
            </div>
          </div>
          <div class="participant-panel">
            <div class="participant-header">
              <h3 class="participant-title">â—† å‚åŠ è€…ãƒªã‚¹ãƒˆ</h3>
              <input type="text" class="participant-search" placeholder="ğŸ” æ¤œç´¢" oninput="filterParticipants(this.value)">
            </div>
            <div class="participant-row header"><div>ID</div><div>Icon</div><div>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</div><div>çŠ¶æ…‹</div></div>
            <div class="participant-list" id="participantList"></div>
            <div class="participant-count">å‚åŠ è€…æ•°: <span id="listCount">0</span>/100</div>
          </div>
        </div>
      </div>
      
      <!-- æŠ½é¸ä¼šå ´å…¥å ´å‰ã®å‚åŠ è€…ãƒªã‚¹ãƒˆ -->
      <div class="participant-panel" id="preArenaList" style="max-width:700px;margin:1rem auto;">
        <div class="participant-header">
          <h3 class="participant-title">â—† å‚åŠ è€…ãƒªã‚¹ãƒˆ</h3>
          <input type="text" class="participant-search" placeholder="ğŸ” æ¤œç´¢" oninput="filterParticipants(this.value)">
        </div>
        <div class="participant-row header"><div>ID</div><div>Icon</div><div>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</div><div>çŠ¶æ…‹</div></div>
        <div class="participant-list" id="participantListPre"></div>
        <div class="participant-count">å‚åŠ è€…æ•°: <span id="listCountPre">0</span>/100ï¼ˆæœ€å¤§100äººï¼‰</div>
      </div>
    </div>
    <div class="screen" id="historyScreen">
      <div class="hud-panel" style="max-width:600px;margin:2rem auto;">
        <div class="hud-panel-title">â—† éå»ã®å¤§ä¼šè¨˜éŒ²</div>
        <div id="historyList"></div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="userGuideModal">
    <div class="modal-content guide-modal">
      <button class="modal-close-btn" onclick="hideModal('userGuideModal')">Ã—</button>
      <h3 class="modal-title">â—† ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h3>
      <div class="guide-content">
        <h4>ğŸ® ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚¢ãƒ—ãƒªã¨ã¯</h4><p>å‚åŠ è€…åŒå£«ã‚’ãƒãƒƒãƒãƒ³ã‚°ã•ã›ã€å‹ã¡æ®‹ã£ãŸäººãŒå„ªå‹ã™ã‚‹å¤§ä¼šå½¢å¼ã‚’ä½œæˆãƒ»é‹å–¶ã§ãã‚‹ã‚¢ãƒ—ãƒªã§ã™ã€‚</p>
        <h4>ğŸ“ ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ–¹æ³•</h4><ul><li>ç®¡ç†è€…ãŒç· åˆ‡æ—¥æ™‚ã‚’è¨­å®šã™ã‚‹ã¨ã€Œã‚¨ãƒ³ãƒˆãƒªãƒ¼ç™»éŒ²ã™ã‚‹ã€ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™</li><li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ç™»éŒ²ã—ã¦ãã ã•ã„</li><li>ç· åˆ‡æ—¥æ™‚ã¾ã§ãªã‚‰ã€Œç™»éŒ²è§£é™¤ã€ã§è§£é™¤å¯èƒ½ã§ã™</li></ul>
        <h4>ğŸ‘€ ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹</h4><p>å¤§ä¼šæƒ…å ±ã‚„å‚åŠ è€…ãƒªã‚¹ãƒˆã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="adminGuideModal">
    <div class="modal-content guide-modal">
      <button class="modal-close-btn" onclick="hideModal('adminGuideModal')">Ã—</button>
      <h3 class="modal-title" style="color:var(--hud-gold);">â—† ç®¡ç†è€…ã‚¬ã‚¤ãƒ‰</h3>
      <div class="guide-content">
        <h4>ğŸ” ç®¡ç†è€…ç™»éŒ²</h4><p>ã€Œç®¡ç†è€…ç™»éŒ²ã‚’ã™ã‚‹ã€ã‹ã‚‰ç®¡ç†è€…åã‚’å…¥åŠ›ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚</p>
        <h4>âš™ï¸ å¤§ä¼šè¨­å®š</h4><ul><li>ã‚²ãƒ¼ãƒ åï¼ˆå¤§ä¼šåï¼‰ã‚’å…¥åŠ›</li><li>ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç· åˆ‡æ—¥æ™‚ã‚’è¨­å®š</li><li>è¨­å®šä¿å­˜ã§ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç™»éŒ²ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã™</li></ul>
        <h4>ğŸ² å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰æŠ½é¸</h4><p>ç· åˆ‡æ—¥æ™‚å¾Œã€ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã§å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰ã‚’æ±ºå®šã—ã¾ã™ã€‚</p>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="confirmCancelEntryModal">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="hideModal('confirmCancelEntryModal')">Ã—</button>
      <h3 class="modal-title">â—† ã‚¨ãƒ³ãƒˆãƒªãƒ¼è§£é™¤</h3>
      <p style="text-align:center;margin:0.8rem 0;">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
      <p style="text-align:center;color:var(--text-dim);font-size:0.85rem;">å‚åŠ è€…ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('confirmCancelEntryModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-confirm" style="background:var(--hud-red);" onclick="executeCancelEntry()">è§£é™¤ã™ã‚‹</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="cancelCompleteModal">
    <div class="modal-content">
      <h3 class="modal-title">âœ… è§£é™¤å®Œäº†</h3>
      <p style="text-align:center;margin:0.8rem 0;">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚</p>
      <div class="modal-buttons"><button class="modal-btn modal-btn-confirm" onclick="hideModal('cancelCompleteModal')">OK</button></div>
    </div>
  </div>
  <div class="modal-overlay" id="settingsCompleteModal">
    <div class="modal-content">
      <h3 class="modal-title">âœ… è¨­å®šå®Œäº†</h3>
      <p style="text-align:center;margin:0.8rem 0;">å¤§ä¼šè¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚</p>
      <p style="text-align:center;color:var(--text-dim);font-size:0.85rem;">ç· åˆ‡æ—¥æ™‚ã¾ã§ã€å‚åŠ è€…ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’å¾…ã¡ã¾ã—ã‚‡ã†ã€‚</p>
      <div class="modal-buttons"><button class="modal-btn modal-btn-confirm" onclick="hideModal('settingsCompleteModal');navigateTo('tournamentScreen',true)">ç¢ºèªã™ã‚‹</button></div>
    </div>
  </div>
  <div class="modal-overlay" id="entryCompleteModal">
    <div class="modal-content">
      <h3 class="modal-title">ğŸ‰ ã‚¨ãƒ³ãƒˆãƒªãƒ¼å®Œäº†</h3>
      <p style="text-align:center;margin:0.8rem 0;">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸï¼</p>
      <p style="text-align:center;color:var(--hud-gold);font-size:1rem;" id="entryCompleteInfo"></p>
      <div class="modal-buttons"><button class="modal-btn modal-btn-confirm" onclick="hideModal('entryCompleteModal');navigateTo('tournamentScreen',true)">ç¢ºèªã™ã‚‹</button></div>
    </div>
  </div>
  <div class="modal-overlay" id="confirmMatchModal">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="hideModal('confirmMatchModal')">Ã—</button>
      <h3 class="modal-title">å¯¾æˆ¦ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ</h3>
      <p style="text-align:center;margin:0.8rem 0;" id="confirmMatchText"></p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('confirmMatchModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-confirm" onclick="executeConfirmMatch()">ç¢ºå®š</button>
      </div>
    </div>
  </div>
  <!-- ã‚·ãƒ¼ãƒ‰æŠ½é¸ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="seedLotteryModal">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="hideModal('seedLotteryModal')">Ã—</button>
      <h3 class="modal-title" style="color:var(--hud-gold);">ğŸ–ï¸ ã‚·ãƒ¼ãƒ‰æŠ½é¸</h3>
      <p style="text-align:center;margin:0.8rem 0;color:var(--text-dim);" id="seedLotteryInfo"></p>
      <p style="text-align:center;margin:0.5rem 0;color:var(--hud-green);font-size:0.9rem;">ã‚·ãƒ¼ãƒ‰æ¨©ã‚’ç²å¾—ã—ãŸé¸æ‰‹ã¯æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«è‡ªå‹•é€²å‡ºã—ã¾ã™</p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('seedLotteryModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-confirm" onclick="executeSeedLottery()" style="background:var(--hud-gold);border-color:var(--hud-gold);color:#000;">ã‚·ãƒ¼ãƒ‰æŠ½é¸ã‚’é–‹å§‹</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="confirmWinnerModal">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="hideModal('confirmWinnerModal')">Ã—</button>
      <h3 class="modal-title">å‹è€…ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ</h3>
      <p style="text-align:center;margin:0.8rem 0;color:var(--hud-gold);font-size:1.2rem;" id="confirmWinnerText"></p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('confirmWinnerModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-confirm" onclick="executeWinner()">ç¢ºå®š</button>
      </div>
    </div>
  </div>
  <!-- å¤§ä¼šçµ‚äº†ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="endTournamentModal">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="hideModal('endTournamentModal')">Ã—</button>
      <h3 class="modal-title" style="color:var(--hud-red);">å¤§ä¼šã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ</h3>
      <p style="text-align:center;color:var(--text-dim);margin:0.8rem 0;font-size:0.9rem;">å„ªå‹è€…ã‚’é¸æŠã—ã¦è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã™</p>
      <div class="form-group">
        <label class="form-label">å„ªå‹è€…ã‚’é¸æŠ</label>
        <select id="championSelect" class="form-input" style="width:100%;padding:0.8rem;">
          <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('endTournamentModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-confirm" onclick="executeEndTournament()" style="background:var(--hud-red);border-color:var(--hud-red);">å¤§ä¼šçµ‚äº†ãƒ»è¨˜éŒ²</button>
      </div>
    </div>
  </div>
  <!-- ãƒªã‚»ãƒƒãƒˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="resetTournamentModal">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="hideModal('resetTournamentModal')">Ã—</button>
      <h3 class="modal-title" style="color:var(--hud-red);">âš ï¸ å¤§ä¼šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ</h3>
      <p style="text-align:center;color:var(--text-dim);margin:0.8rem 0;font-size:0.9rem;">ç®¡ç†è€…ç™»éŒ²ãŒè§£é™¤ã•ã‚Œã€å¤§ä¼šè¨­å®šãƒ»ã‚¨ãƒ³ãƒˆãƒªãƒ¼æƒ…å ±ãŒå…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('resetTournamentModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-confirm" onclick="executeResetTournament()" style="background:var(--hud-red);border-color:var(--hud-red);">ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ</button>
      </div>
    </div>
  </div>
  <div class="toast" id="toast"></div>
  
  <!-- BGM/SE Controls -->
  <div class="sound-controls" id="soundControls">
    <button class="sound-btn" id="bgmBtn" onclick="toggleBGM()" title="BGM ON/OFF">ğŸµ</button>
    <button class="sound-btn" id="seBtn" onclick="toggleSE()" title="SE ON/OFF">ğŸ”Š</button>
  </div>
  
  <!-- HUD - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æƒ…å ±ãƒ‘ãƒãƒ«ï¼ˆPCå°‚ç”¨ï¼‰ -->
  <div class="hud-info-panel" id="hudPanel">
    <div class="hud-content">
      <!-- çŠ¶æ…‹ãƒãƒ¼ï¼ˆä¸Šéƒ¨æ¨ªé•·ï¼‰ -->
      <div class="hud-status-bar">
        <div class="hud-status-left">
          <span class="hud-status-title">â–¶ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
          <div class="hud-status-list">
            <span class="hud-status-item active" id="statusReception">å—ä»˜ä¸­</span>
            <span class="hud-status-item" id="statusClosed">å—ä»˜çµ‚äº†</span>
            <span class="hud-status-item" id="statusProgress">é€²è¡Œä¸­</span>
            <span class="hud-status-item" id="statusEnd">çµ‚äº†</span>
          </div>
        </div>
        <div class="hud-next-event" id="hudNextEvent"></div>
        <div class="hud-system-notice" id="hudSystemNotice"></div>
      </div>
      <!-- è¡Œå‹•ãƒ­ã‚°ï¼ˆä¸‹éƒ¨ï¼‰ -->
      <div class="hud-log-area">
        <div class="hud-log-title">â–¶ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°</div>
        <div class="hud-log-list" id="hudLogList"></div>
      </div>
    </div>
  </div>
  
  <!-- BGM Audio -->
  <audio id="bgmAudio" loop preload="auto">
    <source src="./%E3%83%88%E3%83%BC%E3%83%8A%E3%83%A1%E3%83%B3%E3%83%88.mp3" type="audio/mpeg">
  </audio>
  <audio id="battleBgmAudio" loop preload="auto">
    <source src="./%E3%83%90%E3%83%88%E3%83%AB%E3%83%9E%E3%83%83%E3%83%81.mp3" type="audio/mpeg">
  </audio>
  <audio id="vsSoundAudio" preload="auto">
    <source src="./VS%E7%94%A8.mp3" type="audio/mpeg">
  </audio>
  
  <div class="calendar-modal" id="calendarModal">
    <div class="calendar-container">
      <button class="calendar-close" onclick="closeCalendar()">Ã—</button>
      <h3 class="calendar-title">ç· åˆ‡æ—¥æ™‚ã‚’é¸æŠ</h3>
      <div class="calendar-header">
        <button class="calendar-nav" onclick="changeMonth(-1)">â—€</button>
        <span class="calendar-month-year" id="calendarMonthYear"></span>
        <button class="calendar-nav" onclick="changeMonth(1)">â–¶</button>
      </div>
      <div class="calendar-weekdays"><div class="calendar-weekday">æ—¥</div><div class="calendar-weekday">æœˆ</div><div class="calendar-weekday">ç«</div><div class="calendar-weekday">æ°´</div><div class="calendar-weekday">æœ¨</div><div class="calendar-weekday">é‡‘</div><div class="calendar-weekday">åœŸ</div></div>
      <div class="calendar-days" id="calendarDays"></div>
      <div class="calendar-time">
        <input type="number" class="calendar-time-input" id="calendarHour" min="0" max="23" value="12">
        <span style="color:var(--text-dim);">:</span>
        <input type="number" class="calendar-time-input" id="calendarMinute" min="0" max="59" value="00" step="5">
      </div>
      <div class="calendar-selected-display" id="calendarSelectedDisplay">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      <button class="calendar-confirm" onclick="confirmCalendar()">ã“ã®æ—¥æ™‚ã§è¨­å®š</button>
    </div>
  </div>
  <script>
    const appState = {
      deviceId: localStorage.getItem('tournament_device_id') || (() => { const id = 'dev_' + Math.random().toString(36).substr(2,9) + Date.now().toString(36); localStorage.setItem('tournament_device_id', id); return id; })(),
      isAdmin: false,
      adminName: localStorage.getItem('tournament_admin_name') || null,
      tournament: null,
      entries: [],
      matches: [],
      selectedPlayer1: null,
      selectedPlayer2: null,
      isSpinning: false,
      pendingWinner: null,
      matchingIds: []
    };
    if (appState.adminName) appState.isAdmin = true;

    // BGM/SE State
    let bgmEnabled = true;
    let seEnabled = true;
    let bgmVolume = 0.3;
    let seVolume = 0.5;
    let currentBgm = 'normal'; // 'normal' or 'battle'
    const bgmAudio = document.getElementById('bgmAudio');
    const battleBgmAudio = document.getElementById('battleBgmAudio');
    const vsSoundAudio = document.getElementById('vsSoundAudio');

    function toggleBGM() {
      bgmEnabled = !bgmEnabled;
      const btn = document.getElementById('bgmBtn');
      if (bgmEnabled) {
        btn.classList.remove('off');
        btn.textContent = 'ğŸµ';
        if (currentBgm === 'normal') {
          bgmAudio.play().catch(e => {});
        } else {
          battleBgmAudio.play().catch(e => {});
        }
      } else {
        btn.classList.add('off');
        btn.textContent = 'ğŸ”‡';
        bgmAudio.pause();
        battleBgmAudio.pause();
      }
    }

    function setBGMVolume(val) {
      bgmVolume = val / 100;
      bgmAudio.volume = bgmVolume;
      battleBgmAudio.volume = bgmVolume;
    }

    function toggleSE() {
      seEnabled = !seEnabled;
      const btn = document.getElementById('seBtn');
      if (seEnabled) {
        btn.classList.remove('off');
        btn.textContent = 'ğŸ”Š';
      } else {
        btn.classList.add('off');
        btn.textContent = 'ğŸ”‡';
      }
    }

    function setSEVolume(val) {
      seVolume = val / 100;
      vsSoundAudio.volume = seVolume;
    }

    // BGMã‚’ãƒãƒˆãƒ«ç”¨ã«åˆ‡ã‚Šæ›¿ãˆ
    function switchToBattleBGM() {
      console.log('switchToBattleBGM called, currentBgm:', currentBgm, 'bgmEnabled:', bgmEnabled);
      currentBgm = 'battle';
      bgmAudio.pause();
      bgmAudio.currentTime = 0;
      battleBgmAudio.volume = bgmVolume;
      if (bgmEnabled) {
        battleBgmAudio.play().then(() => {
          console.log('Battle BGM playing');
        }).catch(e => {
          console.log('Battle BGM error:', e);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
          setTimeout(() => {
            battleBgmAudio.play().catch(e2 => console.log('Battle BGM retry failed:', e2));
          }, 100);
        });
      }
      appendLog('âš”ï¸ æŠ½é¸ä¼šå ´ã«å…¥å ´ï¼');
    }

    // BGMã‚’é€šå¸¸ã«æˆ»ã™
    function switchToNormalBGM() {
      if (currentBgm === 'normal') return;
      currentBgm = 'normal';
      battleBgmAudio.pause();
      battleBgmAudio.currentTime = 0;
      bgmAudio.volume = bgmVolume;
      if (bgmEnabled) {
        bgmAudio.play().catch(e => console.log('Normal BGM blocked'));
      }
    }

    // VSåŠ¹æœéŸ³ã‚’å†ç”Ÿ
    function playVsSound() {
      if (!seEnabled) return;
      vsSoundAudio.volume = seVolume;
      vsSoundAudio.currentTime = 0;
      vsSoundAudio.play().catch(e => console.log('VS sound blocked'));
    }
    
    // BGMç”¨ã®AudioContextï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
    let bgmContext = null;
    let bgmOscillators = [];
    let bgmGains = [];
    let bgmPlaying = false;
    
    // BGMãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆmp3ãŒãªã„å ´åˆï¼‰
    function startBgmFallback(isBattle = false) {
      if (!bgmEnabled) return;
      stopBgmFallback();
      
      try {
        bgmContext = new (window.AudioContext || window.webkitAudioContext)();
        bgmPlaying = true;
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆBGM
        const baseFreq = isBattle ? 110 : 65;
        const notes = isBattle ? [110, 138, 165, 138] : [65, 82, 98, 82];
        let noteIndex = 0;
        
        function playNote() {
          if (!bgmPlaying || !bgmContext) return;
          
          const osc = bgmContext.createOscillator();
          const gain = bgmContext.createGain();
          osc.connect(gain);
          gain.connect(bgmContext.destination);
          
          osc.type = isBattle ? 'sawtooth' : 'sine';
          osc.frequency.setValueAtTime(notes[noteIndex], bgmContext.currentTime);
          gain.gain.setValueAtTime(bgmVolume * 0.15, bgmContext.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, bgmContext.currentTime + 0.8);
          
          osc.start(bgmContext.currentTime);
          osc.stop(bgmContext.currentTime + 0.9);
          
          noteIndex = (noteIndex + 1) % notes.length;
          
          if (bgmPlaying) {
            setTimeout(playNote, 900);
          }
        }
        
        playNote();
      } catch(e) {
        console.log('BGM fallback error:', e);
      }
    }
    
    function stopBgmFallback() {
      bgmPlaying = false;
      if (bgmContext) {
        try {
          bgmContext.close();
        } catch(e) {}
        bgmContext = null;
      }
    }
    
    // VSåŠ¹æœéŸ³ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆWebAudioAPIï¼‰
    function playVsSoundFallback() {
      if (!seEnabled) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        
        // ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãªã€ŒVSã€åŠ¹æœéŸ³ã‚’ç”Ÿæˆ
        const duration = 0.8;
        
        // ä½éŸ³ã®ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ
        const osc1 = ctx.createOscillator();
        const gain1 = ctx.createGain();
        osc1.connect(gain1);
        gain1.connect(ctx.destination);
        osc1.type = 'sine';
        osc1.frequency.setValueAtTime(80, ctx.currentTime);
        osc1.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + duration);
        gain1.gain.setValueAtTime(seVolume * 0.6, ctx.currentTime);
        gain1.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
        osc1.start(ctx.currentTime);
        osc1.stop(ctx.currentTime + duration);
        
        // é«˜éŸ³ã®ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ
        const osc2 = ctx.createOscillator();
        const gain2 = ctx.createGain();
        osc2.connect(gain2);
        gain2.connect(ctx.destination);
        osc2.type = 'square';
        osc2.frequency.setValueAtTime(800, ctx.currentTime);
        osc2.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.3);
        gain2.gain.setValueAtTime(seVolume * 0.3, ctx.currentTime);
        gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc2.start(ctx.currentTime);
        osc2.stop(ctx.currentTime + 0.3);
        
      } catch(e) { console.log('VS fallback error:', e); }
    }

    // BGMã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆWeb Audio APIã§ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆéŸ³ã‚’ç”Ÿæˆï¼‰
    // æ³¨: startBgmFallbacké–¢æ•°ã‚’ä½¿ç”¨

    function initBGM() {
      bgmAudio.volume = bgmVolume;
      battleBgmAudio.volume = bgmVolume;
      vsSoundAudio.volume = seVolume;
      
      // è¤‡æ•°ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã§BGMã‚’é–‹å§‹
      const startBGM = () => {
        if (bgmEnabled && bgmAudio.paused && currentBgm === 'normal') {
          bgmAudio.play().catch(e => console.log('BGM start failed:', e));
        }
      };
      
      // ã‚¯ãƒªãƒƒã‚¯ã€ã‚¿ãƒƒãƒã€ã‚­ãƒ¼å…¥åŠ›ãªã©æ§˜ã€…ãªã‚¤ãƒ™ãƒ³ãƒˆã§é–‹å§‹
      ['click', 'touchstart', 'keydown'].forEach(event => {
        document.addEventListener(event, startBGM, { once: true });
      });
      
      // ãƒšãƒ¼ã‚¸ãŒæ—¢ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚‰å³åº§ã«è©¦è¡Œ
      if (document.visibilityState === 'visible') {
        setTimeout(startBGM, 100);
      }
    }

    function playClick() { if (!seEnabled) return; try { const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=800;o.type='sine';g.gain.setValueAtTime(seVolume*0.5,c.currentTime);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+0.1);o.start(c.currentTime);o.stop(c.currentTime+0.1);} catch(e){} }
    function playHover() { if (!seEnabled) return; try { const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=600;o.type='sine';g.gain.setValueAtTime(seVolume*0.12,c.currentTime);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+0.04);o.start(c.currentTime);o.stop(c.currentTime+0.04);} catch(e){} }
    function addSounds() { document.querySelectorAll('button').forEach(b => { b.addEventListener('mouseenter', () => { if(!b.disabled) playHover(); }); b.addEventListener('click', () => { if(!b.disabled) playClick(); }); }); }

    // HUD - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ç®¡ç†
    const hudLogs = [];
    const MAX_LOGS = 10;

    function appendLog(message) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      
      // ãƒ­ãƒ¼ã‚«ãƒ«é…åˆ—ã«è¿½åŠ ï¼ˆæ»å‹ï¼šæ–°ã—ã„ãƒ­ã‚°ãŒä¸Šï¼‰
      hudLogs.unshift({ time: timeStr, message: message });
      
      // ä¸Šé™è¶…éæ™‚ã¯æœ€ä¸‹æ®µã‹ã‚‰å‰Šé™¤
      if (hudLogs.length > MAX_LOGS) {
        hudLogs.pop();
      }
      
      renderLogs();
      
      // Firebaseã«ãƒ­ã‚°ã‚’ä¿å­˜ï¼ˆä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å…±æœ‰ï¼‰
      if (db) {
        db.collection('logs').add({
          time: timeStr,
          message: message,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          // å¤ã„ãƒ­ã‚°ã‚’å‰Šé™¤ï¼ˆ10ä»¶ã‚’è¶…ãˆãŸã‚‰ï¼‰
          cleanupOldLogs();
        }).catch(e => console.error('Log save error:', e));
      }
    }

    // å¤ã„ãƒ­ã‚°ã‚’å‰Šé™¤ï¼ˆMAX_LOGSä»¶ã‚’è¶…ãˆãŸåˆ†ï¼‰
    function cleanupOldLogs() {
      if (!db) return;
      
      db.collection('logs')
        .orderBy('timestamp', 'desc')
        .get()
        .then(snapshot => {
          if (snapshot.size > MAX_LOGS) {
            const batch = db.batch();
            let count = 0;
            snapshot.forEach(doc => {
              count++;
              // MAX_LOGSä»¶ã‚ˆã‚Šå¤ã„ã‚‚ã®ã‚’å‰Šé™¤
              if (count > MAX_LOGS) {
                batch.delete(doc.ref);
              }
            });
            batch.commit().catch(e => console.error('Log cleanup error:', e));
          }
        })
        .catch(e => console.error('Log count error:', e));
    }

    // Firebaseã‹ã‚‰ãƒ­ã‚°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—
    function initLogListener() {
      if (!db) return;
      
      db.collection('logs')
        .orderBy('timestamp', 'desc')
        .limit(MAX_LOGS)
        .onSnapshot(snapshot => {
          // ä»–ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®ãƒ­ã‚°ã‚’åæ˜ 
          const firebaseLogs = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.time && data.message) {
              firebaseLogs.push({ time: data.time, message: data.message });
            }
          });
          
          // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ã‚°ã‚’Firebaseãƒ­ã‚°ã§æ›´æ–°
          hudLogs.length = 0;
          firebaseLogs.forEach(log => hudLogs.push(log));
          
          renderLogs();
        }, err => console.error('Log listener error:', err));
    }

    function renderLogs() {
      const logList = document.getElementById('hudLogList');
      const logListMobile = document.getElementById('hudLogListMobile');
      
      const html = hudLogs.map((log, index) => {
        const fadeClass = index === 0 ? 'fade-in' : '';
        return '<div class="hud-log-item ' + fadeClass + '"><span class="log-time">' + log.time + '</span>' + escapeHtml(log.message) + '</div>';
      }).join('');
      
      if (logList) logList.innerHTML = html;
      if (logListMobile) logListMobile.innerHTML = html;
    }

    // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆçŠ¶æ…‹ã®æ›´æ–°
    function updateTournamentStatus(status) {
      const statuses = ['statusReception', 'statusClosed', 'statusProgress', 'statusEnd'];
      const statusesMobile = ['statusReceptionMobile', 'statusClosedMobile', 'statusProgressMobile', 'statusEndMobile'];
      
      statuses.forEach(id => {
        document.getElementById(id)?.classList.remove('active');
      });
      statusesMobile.forEach(id => {
        document.getElementById(id)?.classList.remove('active');
      });
      
      const statusMap = {
        'reception': 'statusReception',
        'closed': 'statusClosed',
        'progress': 'statusProgress',
        'end': 'statusEnd'
      };
      const statusMapMobile = {
        'reception': 'statusReceptionMobile',
        'closed': 'statusClosedMobile',
        'progress': 'statusProgressMobile',
        'end': 'statusEndMobile'
      };
      
      if (statusMap[status]) {
        document.getElementById(statusMap[status])?.classList.add('active');
        document.getElementById(statusMapMobile[status])?.classList.add('active');
      }
    }

    // æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆäºˆå‘Šã®æ›´æ–°
    function updateNextEvent(message) {
      const el = document.getElementById('hudNextEvent');
      const elMobile = document.getElementById('hudNextEventMobile');
      if (el) el.textContent = message || '';
      if (elMobile) elMobile.textContent = message || '';
    }

    // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ã®æ›´æ–°
    function updateSystemNotice(message) {
      const el = document.getElementById('hudSystemNotice');
      if (el) el.textContent = message || '';
    }

    // çŠ¶æ…‹åˆ¤å®šã¨æ›´æ–°
    function checkAndUpdateStatus() {
      const t = appState.tournament;
      const dl = t?.deadline;
      
      if (!dl) {
        updateTournamentStatus('none'); // æœªè¨­å®šæ™‚ã¯ä½•ã‚‚ç™ºå…‰ã•ã›ãªã„
        updateNextEvent('ç®¡ç†è€…ã®è¨­å®šã‚’å¾…ã£ã¦ã„ã¾ã™');
        updateLotteryVenueButton();
        return;
      }
      
      const deadline = dl.toDate ? dl.toDate() : new Date(dl);
      const now = new Date();
      
      if (now < deadline) {
        updateTournamentStatus('reception');
        const diff = deadline - now;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secs = Math.floor((diff % (1000 * 60)) / 1000);
        
        // 1æ™‚é–“ä»¥å†…ã¯ç§’æ•°ã‚‚è¡¨ç¤º
        if (hours === 0 && mins < 60) {
          if (mins === 0) {
            updateNextEvent('ç· åˆ‡ã¾ã§: ' + secs + 'ç§’');
          } else {
            updateNextEvent('ç· åˆ‡ã¾ã§: ' + mins + 'åˆ† ' + secs + 'ç§’');
          }
        } else {
          updateNextEvent('ç· åˆ‡ã¾ã§: ' + hours + 'æ™‚é–“ ' + mins + 'åˆ†');
        }
      } else {
        // ç· åˆ‡å¾Œ
        const activeCount = appState.entries.filter(e => e.status !== 'LOST').length;
        if (activeCount > 1) {
          updateTournamentStatus('progress');
          updateNextEvent('ç®¡ç†è€…ã®æ“ä½œã‚’å¾…ã£ã¦ã„ã¾ã™');
        } else if (activeCount === 1) {
          updateTournamentStatus('end');
          updateNextEvent('');
        } else {
          updateTournamentStatus('closed');
          updateNextEvent('');
        }
      }
      
      // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚‚æ›´æ–°
      updateLotteryVenueButton();
      updateEntryButton();
      updateCancelEntryButton();
    }
    
    // å®šæœŸçš„ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ1ç§’ã”ã¨ï¼‰
    setInterval(() => {
      checkAndUpdateStatus();
    }, 1000);

    function createMatrixBg() {
      const bg = document.getElementById('matrixBg');
      const chars = 'ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³0123456789ABCDEF';
      for (let i = 0; i < 35; i++) {
        const col = document.createElement('div');
        col.className = 'matrix-col';
        col.style.left = (i * 2.9 + Math.random()) + '%';
        col.style.animationDuration = (8 + Math.random() * 12) + 's';
        col.style.animationDelay = (Math.random() * -15) + 's';
        let text = '';
        for (let j = 0; j < 45; j++) text += chars[Math.floor(Math.random() * chars.length)] + '\n';
        col.textContent = text;
        bg.appendChild(col);
      }
    }
    createMatrixBg();

    let currentScreen = 'titleScreen';
    let screenHistory = [];

    function navigateTo(screenId, directToTitle = false) {
      if (screenId === 'entryScreen') { if (!appState.tournament?.deadline) { showToast('ç· åˆ‡æ—¥æ™‚ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error'); return; } updateEntryScreen(); }
      if (screenId === 'historyScreen') loadHistory();
      screenHistory.push(currentScreen);
      document.getElementById(currentScreen).classList.remove('active');
      document.getElementById(screenId).classList.add('active');
      currentScreen = screenId;
      const header = document.getElementById('mainHeader');
      const backBtn = document.getElementById('backBtn');
      if (screenId === 'titleScreen') { header.classList.remove('visible'); } else { header.classList.add('visible'); }
      if (directToTitle) { backBtn.textContent = 'â—€ ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹'; backBtn.onclick = goToTitle; } else { backBtn.textContent = 'â—€ æˆ»ã‚‹'; backBtn.onclick = goBack; }
      backBtn.classList.toggle('visible', screenId !== 'titleScreen');
      updateHudVisibility();
    }
    function goBack() { if (screenHistory.length > 0) { const prev = screenHistory.pop(); document.getElementById(currentScreen).classList.remove('active'); document.getElementById(prev).classList.add('active'); currentScreen = prev; const header = document.getElementById('mainHeader'); if (currentScreen === 'titleScreen') header.classList.remove('visible'); else header.classList.add('visible'); document.getElementById('backBtn').classList.toggle('visible', currentScreen !== 'titleScreen'); updateHudVisibility(); } }
    function goToTitle() { document.getElementById(currentScreen).classList.remove('active'); document.getElementById('titleScreen').classList.add('active'); currentScreen = 'titleScreen'; screenHistory = []; document.getElementById('mainHeader').classList.remove('visible'); updateHudVisibility(); }
    function updateHudVisibility() { const hud = document.getElementById('hudPanel'); if (hud) { if (currentScreen === 'titleScreen' && window.innerWidth >= 900) { hud.classList.add('title-active'); } else { hud.classList.remove('title-active'); } } }
    function showModal(id) { document.getElementById(id).classList.add('active'); }
    function hideModal(id) { document.getElementById(id).classList.remove('active'); }
    function showToast(msg, type = 'success') { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast ' + type + ' visible'; setTimeout(() => t.classList.remove('visible'), 3000); }
    function showGuide(type) { showModal(type === 'admin' ? 'adminGuideModal' : 'userGuideModal'); }
    function showMatchmakingInfo() { 
      const dl = appState.tournament?.deadline; 
      if (dl) { 
        const d = dl.toDate ? dl.toDate() : new Date(dl); 
        if (new Date() >= d) { 
          switchToBattleBGM(); 
          navigateTo('tournamentScreen'); 
          document.getElementById('lotteryEntrance').style.display = 'none'; 
          document.getElementById('preArenaList').style.display = 'none';
          document.getElementById('lotteryArena').classList.add('active');
          document.getElementById('rouletteAdminControls').style.display = 'flex'; 
          return; 
        } 
      } 
      showToast('ç· åˆ‡æ—¥æ™‚ä»¥é™ã«æœ‰åŠ¹åŒ–ã•ã‚Œã¾ã™', 'error'); 
    }
    function previewIcon(input) { if (input.files && input.files[0]) { const r = new FileReader(); r.onload = e => { document.getElementById('iconPreview').innerHTML = '<img src="' + e.target.result + '" style="width:100%;height:100%;object-fit:cover;">'; document.getElementById('iconDeleteBtn').style.display = 'block'; }; r.readAsDataURL(input.files[0]); } }
    function clearIcon() { document.getElementById('iconPreview').innerHTML = '<span style="color:var(--text-dim);font-size:1.3rem;">+</span>'; document.getElementById('iconInput').value = ''; document.getElementById('iconDeleteBtn').style.display = 'none'; }
    function escapeHtml(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }

    function updateTournamentDisplay() {
      const t = appState.tournament;
      const gn = t?.game_name || 'æœªè¨­å®š';
      const ad = t?.admin_name || '-';
      let dl = 'æœªè¨­å®š';
      if (t?.deadline) { const d = t.deadline.toDate ? t.deadline.toDate() : new Date(t.deadline); dl = d.toLocaleString('ja-JP', {year:'numeric',month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}); }
      document.getElementById('titleGameName').textContent = gn;
      document.getElementById('titleDeadline').textContent = dl;
      document.getElementById('titleDeadline').classList.toggle('warning', dl === 'æœªè¨­å®š');
      document.getElementById('titleAdmin').textContent = ad;
      document.getElementById('titleCount').textContent = appState.entries.length + 'å';
      document.getElementById('tournamentGameName').textContent = gn;
      document.getElementById('tournamentDeadline').textContent = dl;
      document.getElementById('tournamentDeadline').classList.toggle('warning', dl === 'æœªè¨­å®š');
      document.getElementById('tournamentAdmin').textContent = ad;
      document.getElementById('tournamentCount').textContent = appState.entries.length + 'å';
      const participantCountEl = document.getElementById('titleParticipantCount');
      if (participantCountEl) participantCountEl.textContent = appState.entries.length;
      updateEntryButton();
      updateCancelEntryButton();
      updateMatchmakingButton();
      updateLotteryVenueButton();
      updateAdminRegisterButton();
      checkAndUpdateStatus();
    }
    function updateAdminRegisterButton() {
      const btn = document.getElementById('adminRegisterBtn');
      if (!btn) return;
      // æ—¢ã«ç®¡ç†è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æŠ¼ã›ãªã„
      if (appState.tournament?.admin_device && appState.tournament.admin_device !== appState.deviceId) {
        btn.disabled = true;
        btn.style.opacity = '0.3';
        btn.style.cursor = 'not-allowed';
      } else {
        btn.disabled = false;
        btn.style.opacity = '';
        btn.style.cursor = '';
      }
    }
    
    // ç®¡ç†è€…ç”»é¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
    function goToAdminScreen() {
      // å¤§ä¼šãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆ â†’ ç®¡ç†è€…ç™»éŒ²ç”»é¢ã¸
      if (!appState.tournament?.admin_device) {
        navigateTo('adminScreen');
        return;
      }
      
      // å¤§ä¼šãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ â†’ ç™»éŒ²ã—ãŸç®¡ç†è€…ã®ãƒ‡ãƒã‚¤ã‚¹ã®ã¿
      if (appState.tournament.admin_device === appState.deviceId) {
        navigateTo('adminSetupScreen');
        return;
      }
      
      // ãã‚Œä»¥å¤– â†’ ã‚¨ãƒ©ãƒ¼
      showToast('ç®¡ç†è€…ä»¥å¤–ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“', 'error');
    }
    
    function updateEntryButton() { const b = document.getElementById('entryBtn'); if (!appState.tournament?.deadline) { b.disabled = true; } else { const d = appState.tournament.deadline.toDate ? appState.tournament.deadline.toDate() : new Date(appState.tournament.deadline); b.disabled = new Date() > d; } }
    function updateCancelEntryButton() { const b = document.getElementById('cancelEntryBtn'); if (!b) return; const my = appState.entries.find(e => e.device_id === appState.deviceId); let can = !!my; const dl = appState.tournament?.deadline; if (dl) { const d = dl.toDate ? dl.toDate() : new Date(dl); if (new Date() >= d) can = false; } b.disabled = !can; }
    function updateMatchmakingButton() { const b = document.getElementById('matchmakingBtn'); if (!b) return; const dl = appState.tournament?.deadline; if (dl) { const d = dl.toDate ? dl.toDate() : new Date(dl); if (new Date() >= d) { b.style.opacity = '1'; b.textContent = 'ğŸ² å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰æŠ½é¸ã‚’é–‹å§‹'; } } }
    
    // æŠ½é¸ä¼šå ´ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    function updateLotteryVenueButton() {
      const btn = document.getElementById('lotteryVenueBtn');
      const sub = document.getElementById('lotteryBtnSub');
      if (!btn) return;
      const dl = appState.tournament?.deadline;
      if (dl) {
        const d = dl.toDate ? dl.toDate() : new Date(dl);
        if (new Date() >= d) {
          btn.disabled = false;
          if (sub) sub.style.display = 'none';
        } else {
          btn.disabled = true;
          if (sub) sub.style.display = '';
        }
      } else {
        btn.disabled = true;
        if (sub) sub.style.display = '';
      }
    }
    
    // æŠ½é¸ä¼šå ´ã¸ç§»å‹•
    function enterLotteryVenue() {
      const dl = appState.tournament?.deadline;
      if (!dl) { showToast('å¤§ä¼šãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error'); return; }
      const d = dl.toDate ? dl.toDate() : new Date(dl);
      if (new Date() < d) { showToast('ç· åˆ‡æ—¥æ™‚ä»¥é™ã«è§£æ”¾ã•ã‚Œã¾ã™', 'error'); return; }
      
      // BGMã‚’ãƒãƒˆãƒ«ãƒãƒƒãƒã«åˆ‡ã‚Šæ›¿ãˆ
      switchToBattleBGM();
      
      // å…¥å ´ãƒœã‚¿ãƒ³ã¨äº‹å‰ãƒªã‚¹ãƒˆã‚’éè¡¨ç¤º
      document.getElementById('lotteryEntrance').style.display = 'none';
      document.getElementById('preArenaList').style.display = 'none';
      
      // æŠ½é¸ä¼šå ´ã‚’è¡¨ç¤º
      document.getElementById('lotteryArena').classList.add('active');
      
      // ç®¡ç†è€…ã®ã¿ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ“ä½œãƒœã‚¿ãƒ³è¡¨ç¤º
      if (appState.isAdmin || appState.tournament?.admin_device === appState.deviceId) {
        document.getElementById('rouletteAdminControls').style.display = 'flex';
      } else {
        document.getElementById('rouletteAdminControls').style.display = 'none';
      }
      
      // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ãƒœã‚¿ãƒ³ã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
      updateBracketControls();
      
      playClick();
      appendLog('æŠ½é¸ä¼šå ´ã«å…¥å ´ã—ã¾ã—ãŸ');
    }
    function updateEntriesDisplay() {
      const list = document.getElementById('participantList');
      const listPre = document.getElementById('participantListPre');
      const listCountEl = document.getElementById('listCount');
      const listCountPreEl = document.getElementById('listCountPre');
      
      if (listCountEl) listCountEl.textContent = appState.entries.length;
      if (listCountPreEl) listCountPreEl.textContent = appState.entries.length;
      
      const matchingIds = appState.matchingIds || [];
      
      const html = appState.entries.length === 0 
        ? '<div style="text-align:center;padding:1.5rem;color:var(--text-dim);">å‚åŠ è€…ã¯ã„ã¾ã›ã‚“</div>'
        : appState.entries.map(e => {
            const isMatching = matchingIds.includes(e.entry_id);
            const hasSeed = e.has_seed;
            const statusText = e.status === 'LOST' ? 'æ•—é€€' : (hasSeed ? 'ğŸ–ï¸ã‚·ãƒ¼ãƒ‰' : 'å‚åŠ ä¸­');
            const statusClass = e.status === 'LOST' ? 'status-lost' : (hasSeed ? 'status-seed' : 'status-active');
            return '<div class="participant-row' + (isMatching ? ' matching' : '') + '"><div class="participant-id">ID-' + String(e.entry_id).padStart(2,'0') + '</div><div class="participant-icon">' + (e.icon_url ? '<img src="' + e.icon_url + '">' : 'ğŸ‘¤') + '</div><div>' + escapeHtml(e.username) + (isMatching ? ' âš”ï¸' : '') + '</div><div><span class="status-badge ' + statusClass + '">' + statusText + '</span></div></div>';
          }).join('');
      
      if (list) list.innerHTML = html;
      if (listPre) listPre.innerHTML = html;
    }
    function updateEntryScreen() {
      const my = appState.entries.find(e => e.device_id === appState.deviceId);
      const dl = appState.tournament?.deadline;
      const past = dl && new Date() > (dl.toDate ? dl.toDate() : new Date(dl));
      if (my) { document.getElementById('myEntryDisplay').style.display = 'block'; document.getElementById('entryForm').style.display = 'none'; document.getElementById('myEntryName').textContent = my.username; document.getElementById('myEntryId').textContent = ' (ID-' + String(my.entry_id).padStart(2,'0') + ')'; }
      else { document.getElementById('myEntryDisplay').style.display = past ? 'block' : 'none'; document.getElementById('entryForm').style.display = past ? 'none' : 'block'; if (past) document.getElementById('myEntryDisplay').innerHTML = '<div class="my-entry-box"><p style="color:var(--hud-red);">ç· åˆ‡æ—¥æ™‚ã‚’éãã¦ã„ã¾ã™</p></div>'; }
    }
    function updateRouletteWheel() { 
      const w = document.getElementById('wheelInner'); 
      const a = appState.entries.filter(e => e.status !== 'LOST'); 
      if (a.length === 0) { w.innerHTML = ''; return; } 
      w.innerHTML = a.map((e,i) => {
        const hasSeed = e.has_seed;
        const style = hasSeed ? 'color:#ffa500;' : '';
        const seedMark = hasSeed ? 'ğŸ–ï¸' : '';
        return '<div class="wheel-segment" style="transform:rotate(' + ((360/a.length)*i) + 'deg);' + style + '">' + seedMark + 'ID-' + String(e.entry_id).padStart(2,'0') + '</div>';
      }).join(''); 
    }
    function updateVsDisplay(p1, p2) { 
      document.getElementById('vsPlayer1Id').textContent = p1 ? 'ID-' + String(p1.entry_id).padStart(2,'0') : '-'; 
      document.getElementById('vsPlayer1Name').textContent = p1 ? p1.username : '-'; 
      document.getElementById('vsPlayer1Icon').innerHTML = p1?.icon_url ? '<img src="' + p1.icon_url + '" style="width:100%;height:100%;object-fit:cover;">' : '<span>?</span>'; 
      document.getElementById('vsPlayer2Id').textContent = p2 ? 'ID-' + String(p2.entry_id).padStart(2,'0') : '-'; 
      document.getElementById('vsPlayer2Name').textContent = p2 ? p2.username : '-'; 
      document.getElementById('vsPlayer2Icon').innerHTML = p2?.icon_url ? '<img src="' + p2.icon_url + '" style="width:100%;height:100%;object-fit:cover;">' : '<span>?</span>'; 
      
      // å‹åˆ©ãƒœã‚¿ãƒ³ã®åå‰ã‚’æ›´æ–°
      const w1 = document.getElementById('winner1Name');
      const w2 = document.getElementById('winner2Name');
      if (w1) w1.textContent = p1 ? p1.username : '-';
      if (w2) w2.textContent = p2 ? p2.username : '-';
      
      // ç¾åœ¨ã®ãƒãƒƒãƒè¡¨ç¤ºã‚’æ›´æ–°
      const matchDisplay = document.getElementById('currentMatchDisplay');
      const match1 = document.getElementById('currentMatch1');
      const match2 = document.getElementById('currentMatch2');
      if (matchDisplay && match1 && match2) {
        if (p1 && p2) {
          matchDisplay.style.display = 'block';
          match1.textContent = p1.username;
          match2.textContent = p2.username;
        } else {
          matchDisplay.style.display = 'none';
        }
      }
      
      // å‚åŠ è€…ãƒªã‚¹ãƒˆã§ãƒãƒƒãƒãƒ³ã‚°ä¸­ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      appState.matchingIds = (p1 && p2) ? [p1.entry_id, p2.entry_id] : [];
      updateEntriesDisplay();
    }
    function filterParticipants(q) { document.querySelectorAll('#participantList .participant-row').forEach(r => { r.style.display = r.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none'; }); }

    let calendarDate = new Date(), calendarSelectedDate = null, calendarTarget = null;
    function openCalendar(target) { calendarTarget = target; calendarDate = new Date(); calendarSelectedDate = null; document.getElementById('calendarHour').value = '12'; document.getElementById('calendarMinute').value = '00'; renderCalendar(); updateCalendarDisplay(); document.getElementById('calendarModal').classList.add('active'); }
    function closeCalendar() { document.getElementById('calendarModal').classList.remove('active'); }
    function changeMonth(d) { calendarDate.setMonth(calendarDate.getMonth() + d); renderCalendar(); }
    function renderCalendar() {
      const y = calendarDate.getFullYear(), m = calendarDate.getMonth();
      document.getElementById('calendarMonthYear').textContent = y + 'å¹´ ' + (m + 1) + 'æœˆ';
      const c = document.getElementById('calendarDays'); c.innerHTML = '';
      const first = new Date(y, m, 1).getDay(), days = new Date(y, m + 1, 0).getDate(), today = new Date(); today.setHours(0,0,0,0);
      for (let i = 0; i < first; i++) { const e = document.createElement('div'); e.className = 'calendar-day empty'; c.appendChild(e); }
      for (let d = 1; d <= days; d++) {
        const cell = document.createElement('div'); cell.className = 'calendar-day'; cell.textContent = d;
        const cd = new Date(y, m, d); cd.setHours(0,0,0,0);
        if (cd < today) { cell.classList.add('disabled'); } else { cell.onclick = () => { calendarSelectedDate = new Date(y, m, d); renderCalendar(); updateCalendarDisplay(); playClick(); }; cell.onmouseenter = playHover; }
        if (cd.getTime() === today.getTime()) cell.classList.add('today');
        if (calendarSelectedDate && calendarSelectedDate.getFullYear() === y && calendarSelectedDate.getMonth() === m && calendarSelectedDate.getDate() === d) cell.classList.add('selected');
        c.appendChild(cell);
      }
    }
    function updateCalendarDisplay() { const disp = document.getElementById('calendarSelectedDisplay'); if (calendarSelectedDate) { const h = document.getElementById('calendarHour').value.padStart(2,'0'), mi = document.getElementById('calendarMinute').value.padStart(2,'0'); disp.textContent = calendarSelectedDate.getFullYear() + '/' + String(calendarSelectedDate.getMonth()+1).padStart(2,'0') + '/' + String(calendarSelectedDate.getDate()).padStart(2,'0') + ' ' + h + ':' + mi; } else { disp.textContent = 'æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„'; } }
    document.getElementById('calendarHour')?.addEventListener('input', updateCalendarDisplay);
    document.getElementById('calendarMinute')?.addEventListener('input', updateCalendarDisplay);
    function confirmCalendar() { if (!calendarSelectedDate) { showToast('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; } const h = parseInt(document.getElementById('calendarHour').value) || 0, mi = parseInt(document.getElementById('calendarMinute').value) || 0; const dt = new Date(calendarSelectedDate.getFullYear(), calendarSelectedDate.getMonth(), calendarSelectedDate.getDate(), h, mi); if (dt <= new Date()) { showToast('ç¾åœ¨ã‚ˆã‚Šå¾Œã®æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; } const str = dt.toLocaleString('ja-JP', {year:'numeric',month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}); if (calendarTarget === 'setup') { document.getElementById('setupDeadline').value = dt.toISOString(); document.getElementById('setupDeadlineBtn').textContent = str; } playClick(); closeCalendar(); }
    document.addEventListener('DOMContentLoaded', () => { setTimeout(addSounds, 100); initBGM(); initFirebase(); updateHudVisibility(); });
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = { apiKey: "AIzaSyCNGRa4DCOM595aM5Exor5BF6oPUvg1TIY", authDomain: "tournament-app-a0837.firebaseapp.com", projectId: "tournament-app-a0837", storageBucket: "tournament-app-a0837.firebasestorage.app", messagingSenderId: "514905483124", appId: "1:514905483124:web:1882493de273598b0a2e21" };
    let db = null;
    
    // ã‚¹ãƒ‘ãƒ å¯¾ç­–ï¼šã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç®¡ç†
    const COOLDOWN_TIME = 5 * 60 * 1000; // 5åˆ†ï¼ˆãƒŸãƒªç§’ï¼‰
    const COOLDOWN_THRESHOLD = 3; // 3å›
    const COOLDOWN_WINDOW = 5 * 60 * 1000; // 5åˆ†ä»¥å†…
    
    // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
    async function checkCooldown(type) {
      if (!db) return { blocked: false };
      const docId = type === 'user' ? appState.deviceId : 'admin_' + appState.deviceId;
      try {
        const doc = await db.collection('cooldowns').doc(docId).get();
        if (doc.exists) {
          const data = doc.data();
          const expiry = data.expiry?.toDate?.() || new Date(data.expiry);
          if (new Date() < expiry) {
            const remaining = Math.ceil((expiry - new Date()) / 1000 / 60);
            return { blocked: true, remaining: remaining };
          } else {
            // æœŸé™åˆ‡ã‚Œãªã‚‰å‰Šé™¤
            await db.collection('cooldowns').doc(docId).delete();
          }
        }
      } catch (e) { console.error('Cooldown check error:', e); }
      return { blocked: false };
    }
    
    // æ“ä½œãƒ­ã‚°ã‚’è¨˜éŒ²ã—ã¦ç•°å¸¸æ¤œçŸ¥
    async function recordAction(type, actionName) {
      if (!db) return false;
      const docId = type === 'user' ? appState.deviceId : 'admin_' + appState.deviceId;
      const now = new Date();
      const windowStart = new Date(now.getTime() - COOLDOWN_WINDOW);
      
      try {
        // æ“ä½œãƒ­ã‚°ã‚’è¿½åŠ 
        await db.collection('action_logs').add({
          device_id: appState.deviceId,
          type: type,
          action: actionName,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // 5åˆ†ä»¥å†…ã®æ“ä½œå›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        const snap = await db.collection('action_logs')
          .where('device_id', '==', appState.deviceId)
          .where('type', '==', type)
          .where('timestamp', '>=', windowStart)
          .get();
        
        if (snap.size >= COOLDOWN_THRESHOLD) {
          // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç™ºå‹•
          const expiry = new Date(now.getTime() + COOLDOWN_TIME);
          await db.collection('cooldowns').doc(docId).set({
            device_id: appState.deviceId,
            type: type,
            reason: actionName,
            expiry: expiry,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // ç•°å¸¸é€šçŸ¥ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ï¼ˆç®¡ç†è€…å‘ã‘ï¼‰
          await db.collection('spam_alerts').add({
            device_id: appState.deviceId,
            type: type,
            username: type === 'user' ? (appState.entries.find(e => e.device_id === appState.deviceId)?.username || 'ä¸æ˜') : appState.adminName,
            action_count: snap.size,
            cooldown_minutes: 5,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          appendLog('âš ï¸ ç•°å¸¸æ¤œçŸ¥: ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç™ºå‹•');
          return true; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç™ºå‹•
        }
      } catch (e) { console.error('Record action error:', e); }
      return false;
    }
    
    // å¤ã„æ“ä½œãƒ­ã‚°ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ5åˆ†ä»¥ä¸Šå‰ã®ã‚‚ã®ï¼‰
    async function cleanupOldActionLogs() {
      if (!db) return;
      const cutoff = new Date(Date.now() - COOLDOWN_WINDOW - 60000);
      try {
        const snap = await db.collection('action_logs')
          .where('timestamp', '<', cutoff)
          .limit(50)
          .get();
        if (!snap.empty) {
          const batch = db.batch();
          snap.forEach(doc => batch.delete(doc.ref));
          await batch.commit();
        }
      } catch (e) { console.error('Cleanup error:', e); }
    }
    
    function initFirebase() { try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); console.log('Firebase OK'); loadData(); initLogListener(); setInterval(cleanupOldActionLogs, 60000); } catch (e) { console.error('Firebase error:', e); updateTournamentDisplay(); } }
    function loadData() { 
      if (!db) return; 
      
      // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆæƒ…å ±ã®ç›£è¦–ï¼ˆãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆçŠ¶æ…‹å«ã‚€ï¼‰
      db.collection('tournaments').doc('current').onSnapshot(doc => { 
        if (doc.exists) { 
          const data = doc.data();
          const prevRouletteState = appState.tournament?.roulette_state;
          appState.tournament = data; 
          
          if (data.admin_device === appState.deviceId) { 
            appState.isAdmin = true; 
            appState.adminName = data.admin_name; 
          }
          
          // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆçŠ¶æ…‹ã®åŒæœŸï¼ˆç®¡ç†è€…ä»¥å¤–ã®ãƒ‡ãƒã‚¤ã‚¹ï¼‰
          if (data.roulette_state && data.admin_device !== appState.deviceId) {
            const newState = data.roulette_state;
            const prevTimestamp = prevRouletteState?.timestamp?.toMillis?.() || 0;
            const newTimestamp = newState.timestamp?.toMillis?.() || 0;
            
            if (newTimestamp > prevTimestamp) {
              handleRouletteSync(newState);
            }
          }
          
          updateTournamentDisplay(); 
        } 
      }); 
      
      // ã‚¨ãƒ³ãƒˆãƒªãƒ¼æƒ…å ±ã®ç›£è¦–
      db.collection('entries').orderBy('entry_id', 'asc').onSnapshot(snap => { 
        appState.entries = snap.docs.map(d => ({ id: d.id, ...d.data() })); 
        updateEntriesDisplay(); 
        updateRouletteWheel(); 
        updateTournamentDisplay(); 
        updateBracketControls(); 
        if (bracketMode) generateBracket(); 
      }); 
      
      // ãƒãƒƒãƒæƒ…å ±ã®ç›£è¦–
      db.collection('matches').orderBy('created_at', 'asc').onSnapshot(snap => { 
        appState.matches = snap.docs.map(d => ({ id: d.id, ...d.data() })); 
        if (bracketMode) generateBracket(); 
      }); 
    }
    async function registerAdmin() { 
      // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒã‚§ãƒƒã‚¯
      const cd = await checkCooldown('admin');
      if (cd.blocked) { showToast('çŸ­æ™‚é–“ã§ç™»éŒ²ãƒ»è§£é™¤ã‚’ç¹°ã‚Šè¿”ã—ãŸãŸã‚ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ï¼ˆæ®‹ã‚Š' + cd.remaining + 'åˆ†ï¼‰', 'error'); return; }
      
      const n = document.getElementById('adminNameInput').value.trim(); const e = document.getElementById('adminNameError'); if (!n) { e.textContent = 'ç®¡ç†è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; e.classList.add('visible'); return; } e.classList.remove('visible'); localStorage.setItem('tournament_admin_name', n); appState.adminName = n; appState.isAdmin = true; 
      
      // æ“ä½œè¨˜éŒ²
      await recordAction('admin', 'register_admin');
      
      appendLog(n + 'ãŒç®¡ç†è€…ã«ãªã‚Šã¾ã—ãŸ'); playClick(); screenHistory.push(currentScreen); document.getElementById(currentScreen).classList.remove('active'); document.getElementById('adminSetupScreen').classList.add('active'); currentScreen = 'adminSetupScreen'; document.getElementById('mainHeader').classList.add('visible'); document.getElementById('backBtn').classList.add('visible'); 
    }
    function saveTournamentSettings() { const gn = document.getElementById('setupGameName').value.trim(); const dl = document.getElementById('setupDeadline').value; const ge = document.getElementById('setupGameNameError'); const de = document.getElementById('setupDeadlineError'); ge.classList.remove('visible'); de.classList.remove('visible'); let err = false; if (!gn) { ge.textContent = 'ã‚²ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; ge.classList.add('visible'); err = true; } if (!dl) { de.textContent = 'ç· åˆ‡æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„'; de.classList.add('visible'); err = true; } if (err) return; playClick(); appState.tournament = { admin_name: appState.adminName, admin_device: appState.deviceId, game_name: gn, deadline: new Date(dl) }; appendLog(appState.adminName + 'ãŒãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã€Œ' + gn + 'ã€ã‚’ä½œæˆã—ã¾ã—ãŸ'); if (db) { db.collection('tournaments').doc('current').set({ admin_name: appState.adminName, admin_device: appState.deviceId, game_name: gn, deadline: new Date(dl), updated_at: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }).catch(e => console.error(e)); } updateTournamentDisplay(); showModal('settingsCompleteModal'); }
    async function submitEntry() { 
      // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒã‚§ãƒƒã‚¯
      const cd = await checkCooldown('user');
      if (cd.blocked) { showToast('çŸ­æ™‚é–“ã§ç™»éŒ²ãƒ»è§£é™¤ã‚’ç¹°ã‚Šè¿”ã—ãŸãŸã‚ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ï¼ˆæ®‹ã‚Š' + cd.remaining + 'åˆ†ï¼‰', 'error'); return; }
      
      if (!appState.tournament?.deadline) { showToast('ç· åˆ‡æ—¥æ™‚ãŒæœªè¨­å®šã§ã™', 'error'); return; } const d = appState.tournament.deadline.toDate ? appState.tournament.deadline.toDate() : new Date(appState.tournament.deadline); if (new Date() > d) { showToast('ç· åˆ‡ã‚’éãã¦ã„ã¾ã™', 'error'); return; } const n = document.getElementById('usernameInput').value.trim(); const e = document.getElementById('usernameError'); if (!n) { e.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; e.classList.add('visible'); return; } if (appState.entries.find(x => x.username === n)) { e.textContent = 'ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™'; e.classList.add('visible'); return; } if (appState.entries.find(x => x.device_id === appState.deviceId)) { e.textContent = 'ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™'; e.classList.add('visible'); return; } if (appState.entries.length >= 100) { updateSystemNotice('å‚åŠ ä¸Šé™ã«é”ã—ã¾ã—ãŸ'); showToast('å‚åŠ ä¸Šé™ã«é”ã—ã¾ã—ãŸ', 'error'); return; } e.classList.remove('visible'); 
      
      // æ“ä½œè¨˜éŒ²
      const triggered = await recordAction('user', 'entry');
      if (triggered) { showToast('çŸ­æ™‚é–“ã§ç™»éŒ²ãƒ»è§£é™¤ã‚’ç¹°ã‚Šè¿”ã—ãŸãŸã‚ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„', 'error'); return; }
      
      const id = appState.entries.length + 1; const ic = document.getElementById('iconPreview').querySelector('img'); playClick(); const ne = { id: appState.deviceId, entry_id: id, username: n, device_id: appState.deviceId, icon_url: ic ? ic.src : null, status: 'ACTIVE' }; appState.entries.push(ne); appendLog(n + 'ãŒã‚¨ãƒ³ãƒˆãƒªãƒ¼ã—ã¾ã—ãŸ'); if (db) { db.collection('entries').doc(appState.deviceId).set({ entry_id: id, username: n, device_id: appState.deviceId, icon_url: ic ? ic.src : null, status: 'ACTIVE', created_at: firebase.firestore.FieldValue.serverTimestamp() }).catch(x => console.error(x)); } updateEntriesDisplay(); updateTournamentDisplay(); document.getElementById('usernameInput').value = ''; clearIcon(); document.getElementById('entryCompleteInfo').textContent = n + ' (ID-' + String(id).padStart(2,'0') + ')'; showModal('entryCompleteModal'); 
    }
    function cancelEntry() { const my = appState.entries.find(e => e.device_id === appState.deviceId); if (!my) { showToast('ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã—ã¦ã„ã¾ã›ã‚“', 'error'); return; } const dl = appState.tournament?.deadline; if (dl) { const d = dl.toDate ? dl.toDate() : new Date(dl); if (new Date() >= d) { showToast('ç· åˆ‡æ—¥æ™‚ã‚’éãã¦ã„ã‚‹ãŸã‚è§£é™¤ã§ãã¾ã›ã‚“', 'error'); return; } } showModal('confirmCancelEntryModal'); }
    async function executeCancelEntry() { 
      // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒã‚§ãƒƒã‚¯
      const cd = await checkCooldown('user');
      if (cd.blocked) { hideModal('confirmCancelEntryModal'); showToast('çŸ­æ™‚é–“ã§ç™»éŒ²ãƒ»è§£é™¤ã‚’ç¹°ã‚Šè¿”ã—ãŸãŸã‚ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ï¼ˆæ®‹ã‚Š' + cd.remaining + 'åˆ†ï¼‰', 'error'); return; }
      
      // æ“ä½œè¨˜éŒ²
      const triggered = await recordAction('user', 'cancel_entry');
      if (triggered) { hideModal('confirmCancelEntryModal'); showToast('çŸ­æ™‚é–“ã§ç™»éŒ²ãƒ»è§£é™¤ã‚’ç¹°ã‚Šè¿”ã—ãŸãŸã‚ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„', 'error'); return; }
      
      playClick(); const myEntry = appState.entries.find(e => e.device_id === appState.deviceId); const username = myEntry ? myEntry.username : 'ä¸æ˜'; const i = appState.entries.findIndex(e => e.device_id === appState.deviceId); if (i !== -1) appState.entries.splice(i, 1); appendLog(username + 'ãŒç™»éŒ²è§£é™¤ã—ã¾ã—ãŸ'); if (db) db.collection('entries').doc(appState.deviceId).delete().catch(e => console.error(e)); updateEntriesDisplay(); updateTournamentDisplay(); updateEntryScreen(); updateCancelEntryButton(); hideModal('confirmCancelEntryModal'); showModal('cancelCompleteModal'); 
    }
    function spinRoulette() { 
      if (appState.isSpinning) return; 
      const a = appState.entries.filter(e => e.status !== 'LOST'); 
      
      // å„ªå‹è€…ãŒæ±ºã¾ã£ã¦ã„ã‚‹å ´åˆã¯å›ã›ãªã„
      if (a.length <= 1) {
        showToast('å¤§ä¼šã¯çµ‚äº†ã—ã¦ã„ã¾ã™', 'error');
        return;
      }
      
      // é€²è¡Œä¸­ã®è©¦åˆãŒã‚ã‚‹äººã‚’é™¤å¤–ï¼ˆã‚·ãƒ¼ãƒ‰ä¿æŒè€…ã‚‚å«ã‚€ï¼‰
      const inMatch = appState.matches.filter(m => !m.winner_id);
      const inMatchIds = inMatch.flatMap(m => [m.player1_id, m.player2_id]);
      
      // å¯¾æˆ¦å¯èƒ½ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆæ•—é€€ã—ã¦ãŠã‚‰ãšã€é€²è¡Œä¸­ã®è©¦åˆãŒãªã„ï¼‰
      const available = a.filter(e => !inMatchIds.includes(e.entry_id));
      
      // ã‚·ãƒ¼ãƒ‰æœªä½¿ç”¨ã®äººï¼ˆã¾ã ã‚·ãƒ¼ãƒ‰æŠ½é¸ãŒå¿…è¦ã‹ã©ã†ã‹åˆ¤å®šç”¨ï¼‰
      const needsSeedLottery = available.filter(e => !e.has_seed);
      
      // å¯¾æˆ¦å¯èƒ½ãªå‚åŠ è€…ãŒã„ãªã„ï¼ˆå…¨å“¡ãŒè©¦åˆä¸­ï¼‰
      if (available.length === 0) {
        showToast('å…¨å“¡ãŒè©¦åˆä¸­ã§ã™ã€‚çµæœã‚’ç¢ºå®šã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }
      
      // 1äººã ã‘ã®å ´åˆ
      if (available.length === 1) {
        showToast('å¯¾æˆ¦ç›¸æ‰‹ãŒã„ã¾ã›ã‚“ã€‚è©¦åˆçµæœã‚’ç¢ºå®šã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }
      
      // å¥‡æ•°ã®å ´åˆã‹ã¤ã‚·ãƒ¼ãƒ‰æœªä¿æŒè€…ãŒå¥‡æ•°ãªã‚‰ã‚·ãƒ¼ãƒ‰æŠ½é¸
      if (needsSeedLottery.length % 2 === 1 && needsSeedLottery.length >= 1 && available.length > 2) {
        showSeedLottery(needsSeedLottery);
        return;
      }
      
      if (available.length < 2) { showToast('å¯¾æˆ¦å¯èƒ½ãªå‚åŠ è€…ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error'); return; }
      
      // å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰ã‚’æ±ºå®šï¼ˆã‚·ãƒ¼ãƒ‰ä¿æŒè€…ã‚‚å«ã‚€ï¼‰
      const f = available; 
      appState.isSpinning = true; 
      document.getElementById('spinBtn').disabled = true; 
      const s = [...f].sort(() => Math.random() - 0.5); 
      appState.selectedPlayer1 = s[0]; 
      appState.selectedPlayer2 = s[1]; 
      
      const rotation = 1800 + Math.random() * 720;
      
      // Firestoreã«ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆçŠ¶æ…‹ã‚’ä¿å­˜ï¼ˆä»–ãƒ‡ãƒã‚¤ã‚¹ã«åŒæœŸï¼‰
      if (db) {
        db.collection('tournaments').doc('current').update({
          roulette_state: {
            spinning: true,
            rotation: rotation,
            player1_id: s[0].entry_id,
            player2_id: s[1].entry_id,
            seed_lottery: false,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          }
        }).catch(e => console.log('Roulette sync error:', e));
      }
      
      // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå›è»¢éŸ³
      playSpinSound();
      
      document.getElementById('wheelInner').style.transform = 'rotate(' + rotation + 'deg)'; 
      setTimeout(() => { 
        playVsSound(); 
        updateVsDisplay(appState.selectedPlayer1, appState.selectedPlayer2); 
        appendLog(appState.selectedPlayer1.username + ' VS ' + appState.selectedPlayer2.username); 
        document.getElementById('confirmMatchBtn').disabled = false; 
        appState.isSpinning = false; 
        document.getElementById('spinBtn').disabled = false;
        
        // å›è»¢å®Œäº†ã‚’åŒæœŸ
        if (db) {
          db.collection('tournaments').doc('current').update({
            'roulette_state.spinning': false
          }).catch(e => {});
        }
      }, 4000); 
    }
    
    // ã‚·ãƒ¼ãƒ‰æŠ½é¸ã‚’è¡¨ç¤º
    function showSeedLottery(players) {
      const count = players.length;
      document.getElementById('seedLotteryInfo').textContent = 
        `å¯¾æˆ¦å¯èƒ½ãªå‚åŠ è€…ãŒ${count}åï¼ˆå¥‡æ•°ï¼‰ã§ã™ã€‚1åã«ã‚·ãƒ¼ãƒ‰æ¨©ï¼ˆä¸æˆ¦å‹ï¼‰ã‚’ä¸ãˆã¾ã™ã€‚`;
      showModal('seedLotteryModal');
    }
    
    // ã‚·ãƒ¼ãƒ‰æŠ½é¸ã‚’å®Ÿè¡Œ
    function executeSeedLottery() {
      hideModal('seedLotteryModal');
      
      const a = appState.entries.filter(e => e.status !== 'LOST'); 
      const f = a.filter(e => !e.has_seed && !appState.matches.some(m => (m.player1_id === e.entry_id || m.player2_id === e.entry_id) && !m.winner_id)); 
      
      if (f.length === 0) {
        showToast('ã‚·ãƒ¼ãƒ‰å¯¾è±¡è€…ãŒã„ã¾ã›ã‚“', 'error');
        return;
      }
      
      appState.isSpinning = true;
      document.getElementById('spinBtn').disabled = true;
      
      // ãƒ©ãƒ³ãƒ€ãƒ ã«1åã‚’é¸ã¶
      const seedPlayer = f[Math.floor(Math.random() * f.length)];
      
      const rotation = 1800 + Math.random() * 720;
      
      // Firestoreã«ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆçŠ¶æ…‹ã‚’ä¿å­˜
      if (db) {
        db.collection('tournaments').doc('current').update({
          roulette_state: {
            spinning: true,
            rotation: rotation,
            seed_lottery: true,
            seed_player_id: seedPlayer.entry_id,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          }
        }).catch(e => console.log('Seed lottery sync error:', e));
      }
      
      playSpinSound();
      document.getElementById('wheelInner').style.transform = 'rotate(' + rotation + 'deg)';
      
      setTimeout(() => {
        // ã‚·ãƒ¼ãƒ‰æ¨©ã‚’ä»˜ä¸
        if (db) {
          db.collection('entries').doc(seedPlayer.id).update({ has_seed: true }).catch(e => {});
        }
        seedPlayer.has_seed = true;
        
        // VSè¡¨ç¤ºã‚’ã‚·ãƒ¼ãƒ‰ç”¨ã«
        document.getElementById('vsOverlay').style.display = 'flex';
        document.getElementById('vsPlayer1Id').textContent = 'ID-' + String(seedPlayer.entry_id).padStart(2, '0');
        document.getElementById('vsPlayer1Name').textContent = seedPlayer.username;
        document.getElementById('vsPlayer1Icon').innerHTML = seedPlayer.icon_url ? '<img src="' + seedPlayer.icon_url + '" style="width:100%;height:100%;object-fit:cover;">' : '<span>ğŸ‘‘</span>';
        document.getElementById('vsPlayer2Id').textContent = 'SEED';
        document.getElementById('vsPlayer2Name').textContent = 'ä¸æˆ¦å‹';
        document.getElementById('vsPlayer2Icon').innerHTML = '<span>ğŸ–ï¸</span>';
        
        playVsSound();
        appendLog('ğŸ–ï¸ ' + seedPlayer.username + ' ãŒã‚·ãƒ¼ãƒ‰æ¨©ã‚’ç²å¾—ï¼');
        showToast(seedPlayer.username + ' ãŒã‚·ãƒ¼ãƒ‰æ¨©ã‚’ç²å¾—ï¼', 'success');
        
        appState.isSpinning = false;
        document.getElementById('spinBtn').disabled = false;
        
        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ›´æ–°
        updateRouletteWheel();
        
        // å›è»¢å®Œäº†ã‚’åŒæœŸ
        if (db) {
          db.collection('tournaments').doc('current').update({
            'roulette_state.spinning': false
          }).catch(e => {});
        }
      }, 4000);
    }
    
    // ä»–ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆåŒæœŸã‚’å‡¦ç†
    function handleRouletteSync(state) {
      if (!state) return;
      
      // ã‚·ãƒ¼ãƒ‰æŠ½é¸ã®å ´åˆ
      if (state.seed_lottery) {
        const seedPlayer = appState.entries.find(e => e.entry_id === state.seed_player_id);
        
        if (state.spinning && !appState.isSpinning) {
          appState.isSpinning = true;
          playSpinSound();
          document.getElementById('wheelInner').style.transform = 'rotate(' + state.rotation + 'deg)';
          
          setTimeout(() => {
            if (seedPlayer) {
              document.getElementById('vsOverlay').style.display = 'flex';
              document.getElementById('vsPlayer1Id').textContent = 'ID-' + String(seedPlayer.entry_id).padStart(2, '0');
              document.getElementById('vsPlayer1Name').textContent = seedPlayer.username;
              document.getElementById('vsPlayer1Icon').innerHTML = seedPlayer.icon_url ? '<img src="' + seedPlayer.icon_url + '" style="width:100%;height:100%;object-fit:cover;">' : '<span>ğŸ‘‘</span>';
              document.getElementById('vsPlayer2Id').textContent = 'SEED';
              document.getElementById('vsPlayer2Name').textContent = 'ä¸æˆ¦å‹';
              document.getElementById('vsPlayer2Icon').innerHTML = '<span>ğŸ–ï¸</span>';
              playVsSound();
            }
            appState.isSpinning = false;
          }, 4000);
        }
        return;
      }
      
      // é€šå¸¸ã®å¯¾æˆ¦æŠ½é¸ã®å ´åˆ
      const p1 = appState.entries.find(e => e.entry_id === state.player1_id);
      const p2 = appState.entries.find(e => e.entry_id === state.player2_id);
      
      if (state.spinning && !appState.isSpinning) {
        // ä»–ãƒ‡ãƒã‚¤ã‚¹ã§å›è»¢é–‹å§‹
        appState.isSpinning = true;
        playSpinSound();
        document.getElementById('wheelInner').style.transform = 'rotate(' + state.rotation + 'deg)';
        
        setTimeout(() => {
          playVsSound();
          if (p1 && p2) {
            appState.selectedPlayer1 = p1;
            appState.selectedPlayer2 = p2;
            updateVsDisplay(p1, p2);
          }
          appState.isSpinning = false;
        }, 4000);
      } else if (!state.spinning && p1 && p2) {
        // å›è»¢å®Œäº†å¾Œã®çŠ¶æ…‹ã‚’åŒæœŸ
        appState.selectedPlayer1 = p1;
        appState.selectedPlayer2 = p2;
        updateVsDisplay(p1, p2);
      }
    }
    
    // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå›è»¢éŸ³
    function playSpinSound() {
      if (!seEnabled) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const duration = 3.5;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sine';
        // å‘¨æ³¢æ•°ã‚’ä¸Šã’ã¦ã„ã
        osc.frequency.setValueAtTime(200, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + duration);
        gain.gain.setValueAtTime(seVolume * 0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + duration);
      } catch(e) { console.log('Spin sound error:', e); }
    }
    
    // ========== ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨æ©Ÿèƒ½ ==========
    let bracketMode = false;
    
    // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function toggleBracketView() {
      bracketMode = !bracketMode;
      const rouletteMain = document.querySelector('.lottery-main');
      const bracketContainer = document.getElementById('bracketContainer');
      const lotterySidebar = document.querySelector('.lottery-sidebar');
      const lotteryArena = document.getElementById('lotteryArena');
      
      if (bracketMode) {
        // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚’å…¨ç”»é¢è¡¨ç¤º
        rouletteMain.style.display = 'none';
        if (lotterySidebar) lotterySidebar.style.display = 'none';
        if (lotteryArena) lotteryArena.style.gridTemplateColumns = '1fr';
        bracketContainer.classList.add('active');
        generateBracket();
      } else {
        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆç”»é¢ã«æˆ»ã™
        rouletteMain.style.display = 'flex';
        if (lotterySidebar) lotterySidebar.style.display = '';
        if (lotteryArena) lotteryArena.style.gridTemplateColumns = '';
        bracketContainer.classList.remove('active');
        // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
        updateBracketControls();
      }
    }
    
    // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚’ç”Ÿæˆ
    function generateBracket() {
      const container = document.getElementById('bracketContent');
      const allEntries = appState.entries;
      const matches = appState.matches || [];
      const isAdmin = appState.isAdmin || appState.tournament?.admin_device === appState.deviceId;
      
      if (allEntries.length === 0) {
        container.innerHTML = '<p style="color:var(--text-dim);text-align:center;">å‚åŠ è€…ãŒã„ã¾ã›ã‚“</p>';
        return;
      }
      
      // ãƒ–ãƒ©ã‚±ãƒƒãƒˆã‚µã‚¤ã‚ºã‚’è¨ˆç®—ï¼ˆ2ã®ã¹ãä¹—ï¼‰
      const totalPlayers = allEntries.length;
      const rounds = Math.ceil(Math.log2(Math.max(totalPlayers, 2)));
      const bracketSize = Math.pow(2, rounds);
      
      // 1å›æˆ¦ã®ã‚¹ãƒ­ãƒƒãƒˆé…ç½®
      const bracketSlots = new Array(bracketSize).fill(null);
      allEntries.forEach((p, i) => {
        if (i < bracketSize) {
          bracketSlots[i] = p;
        }
      });
      
      // å„ªå‹ãƒˆãƒ­ãƒ•ã‚£ãƒ¼
      const activeEntries = allEntries.filter(e => e.status !== 'LOST');
      const champion = activeEntries.length === 1 ? activeEntries[0] : null;
      
      // HTMLã‚’ç”Ÿæˆï¼ˆä¸‹ã‹ã‚‰ä¸Šã¸ï¼‰
      let html = '<div class="bracket-tree">';
      
      // 1å›æˆ¦ã‹ã‚‰æ±ºå‹ã¾ã§ï¼ˆä¸‹ã‹ã‚‰ä¸Šã¸è¡¨ç¤ºã™ã‚‹ãŸã‚é…åˆ—ã«è²¯ã‚ã‚‹ï¼‰
      const roundsHtml = [];
      
      for (let r = 0; r < rounds; r++) {
        const matchesInRound = Math.pow(2, rounds - 1 - r);
        const roundNames = ['1å›æˆ¦', '2å›æˆ¦', 'æº–ã€…æ±ºå‹', 'æº–æ±ºå‹', 'æ±ºå‹'];
        const roundName = r === rounds - 1 ? 'æ±ºå‹' : (r === rounds - 2 ? 'æº–æ±ºå‹' : (r === rounds - 3 ? 'æº–ã€…æ±ºå‹' : `${r + 1}å›æˆ¦`));
        
        let roundHtml = `<div class="bracket-round-row">`;
        
        for (let m = 0; m < matchesInRound; m++) {
          let player1 = null, player2 = null;
          
          if (r === 0) {
            // 1å›æˆ¦ã¯ç›´æ¥ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰
            player1 = bracketSlots[m * 2] || null;
            player2 = bracketSlots[m * 2 + 1] || null;
          } else {
            // ä¸Šã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¯å‹è€…ã‹ã‚‰æ¨æ¸¬
            const rangeSize = Math.pow(2, r + 1);
            const range1Start = m * rangeSize;
            const range2Start = m * rangeSize + rangeSize / 2;
            
            // å„ãƒ–ãƒ­ãƒƒã‚¯ã®activeå‚åŠ è€…ã‚’å–å¾—
            for (let i = range1Start; i < range1Start + rangeSize / 2 && i < bracketSlots.length; i++) {
              if (bracketSlots[i] && bracketSlots[i].status !== 'LOST') {
                player1 = bracketSlots[i];
                break;
              }
            }
            for (let i = range2Start; i < range2Start + rangeSize / 2 && i < bracketSlots.length; i++) {
              if (bracketSlots[i] && bracketSlots[i].status !== 'LOST') {
                player2 = bracketSlots[i];
                break;
              }
            }
          }
          
          // ã“ã®è©¦åˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          const registeredMatch = matches.find(match => 
            (match.player1_id === player1?.entry_id && match.player2_id === player2?.entry_id) ||
            (match.player2_id === player1?.entry_id && match.player1_id === player2?.entry_id)
          );
          
          const isPending = registeredMatch && !registeredMatch.winner_id;
          const winnerId = registeredMatch?.winner_id;
          
          roundHtml += `<div class="bracket-match-box ${isPending ? 'pending' : ''}">`;
          roundHtml += renderBracketPlayer(player1, player2, winnerId, isPending, isAdmin, 'left');
          roundHtml += renderBracketPlayer(player2, player1, winnerId, isPending, isAdmin, 'right');
          roundHtml += `</div>`;
        }
        
        roundHtml += `</div>`;
        roundsHtml.push(roundHtml);
      }
      
      // å„ªå‹æ 
      html += `
        <div class="bracket-champion-box ${champion ? '' : 'empty'}">
          <div class="champion-trophy">ğŸ†</div>
          <div class="champion-label">å„ªå‹</div>
          <div class="champion-name">${champion ? escapeHtml(champion.username) : '???'}</div>
        </div>
      `;
      
      // æ±ºå‹ã‹ã‚‰1å›æˆ¦ã®é †ã§è¡¨ç¤ºï¼ˆä¸Šã‹ã‚‰ä¸‹ï¼‰
      for (let i = roundsHtml.length - 1; i >= 0; i--) {
        html += roundsHtml[i];
      }
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // ãƒ–ãƒ©ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderBracketPlayer(player, opponent, winnerId, isPending, isAdmin, side) {
      if (!player) {
        return `<div class="bracket-player-box empty ${side}"><span class="player-name-v">BYE</span></div>`;
      }
      
      const isWinner = winnerId === player.entry_id;
      const isLoser = winnerId && winnerId !== player.entry_id;
      const hasSeed = player.has_seed;
      const canClick = isAdmin && isPending && opponent;
      
      const classes = [
        'bracket-player-box',
        side,
        isWinner ? 'winner' : '',
        isLoser ? 'loser' : '',
        hasSeed ? 'seed' : '',
        canClick ? 'clickable' : '',
        isPending ? 'active' : ''
      ].filter(Boolean).join(' ');
      
      return `
        <div class="${classes}"
          ${canClick ? `onclick="selectBracketWinner(${player.entry_id}, ${opponent.entry_id}, '${escapeHtml(player.username)}', '${escapeHtml(opponent.username)}')"` : ''}>
          ${isWinner ? '<span class="winner-mark">ğŸ†</span>' : ''}
          ${hasSeed ? '<span class="seed-mark">ğŸ–ï¸</span>' : ''}
          <span class="player-name-v">${escapeHtml(player.username)}</span>
          <span class="player-id-v">${String(player.entry_id).padStart(2, '0')}</span>
        </div>
      `;
    }
    
    // æ—§é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
    function renderSlotVertical(player, opponent, winnerId, isPending, isAdmin) {
      return renderBracketPlayer(player, opponent, winnerId, isPending, isAdmin, 'left');
    }
    function renderSlot(player, opponent, winnerId, isPending, isAdmin, position, isByeMatch = false) {
      return renderBracketPlayer(player, opponent, winnerId, isPending, isAdmin, 'left');
    }
    
    // è©¦åˆã®HTMLã‚’ç”Ÿæˆ
    function generateMatchHtml(match, p1, p2, canDecide) {
      const isAdmin = appState.isAdmin || appState.tournament?.admin_device === appState.deviceId;
      const isWinner1 = match.winner_id === p1?.entry_id;
      const isWinner2 = match.winner_id === p2?.entry_id;
      const hasWinner = !!match.winner_id;
      
      const clickable = canDecide && isAdmin && !hasWinner;
      
      let html = `<div class="bracket-match${canDecide ? ' deciding' : ''}">`;
      
      if (p1) {
        const statusLabel = isWinner1 ? '<span style="color:var(--hud-gold);font-size:0.75rem;margin-left:auto;">ğŸ† å‹è€…</span>' : (hasWinner ? '<span style="color:#666;font-size:0.75rem;margin-left:auto;">æ•—é€€</span>' : '');
        html += `<div class="bracket-player ${isWinner1 ? 'winner' : (hasWinner ? 'loser' : '')} ${clickable ? 'clickable' : ''}" 
          ${clickable ? `onclick="selectBracketWinner(${match.player1_id}, ${match.player2_id}, '${escapeHtml(p1.username)}', '${escapeHtml(p2?.username || '')}')"` : ''}>
          <span class="bracket-player-id">ID-${String(p1.entry_id).padStart(2,'0')}</span>
          <span class="bracket-player-name">${escapeHtml(p1.username)}</span>
          ${statusLabel}
        </div>`;
      }
      
      if (p2) {
        const statusLabel = isWinner2 ? '<span style="color:var(--hud-gold);font-size:0.75rem;margin-left:auto;">ğŸ† å‹è€…</span>' : (hasWinner ? '<span style="color:#666;font-size:0.75rem;margin-left:auto;">æ•—é€€</span>' : '');
        html += `<div class="bracket-player ${isWinner2 ? 'winner' : (hasWinner ? 'loser' : '')} ${clickable ? 'clickable' : ''}"
          ${clickable ? `onclick="selectBracketWinner(${match.player2_id}, ${match.player1_id}, '${escapeHtml(p2.username)}', '${escapeHtml(p1?.username || '')}')"` : ''}>
          <span class="bracket-player-id">ID-${String(p2.entry_id).padStart(2,'0')}</span>
          <span class="bracket-player-name">${escapeHtml(p2.username)}</span>
          ${statusLabel}
        </div>`;
      }
      
      html += '</div>';
      return html;
    }
    
    // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‹ã‚‰å‹è€…ã‚’é¸æŠ
    function selectBracketWinner(winnerId, loserId, winnerName, loserName) {
      // ç®¡ç†è€…ã®ã¿æ“ä½œå¯èƒ½
      const isAdmin = appState.isAdmin || appState.tournament?.admin_device === appState.deviceId;
      if (!isAdmin) {
        return; // ä½•ã‚‚åå¿œã—ãªã„
      }
      
      const winner = appState.entries.find(e => e.entry_id === winnerId);
      const loser = appState.entries.find(e => e.entry_id === loserId);
      
      if (!winner || !loser) {
        showToast('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      appState.pendingWinner = { winner, loser };
      document.getElementById('confirmWinnerText').textContent = winnerName + ' ã‚’å‹è€…ã«ã—ã¾ã™ã‹ï¼Ÿ';
      showModal('confirmWinnerModal');
    }
    
    // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
    function updateBracketControls() {
      const controls = document.getElementById('bracketControls');
      if (!controls) return;
      
      const activeCount = appState.entries.filter(e => e.status !== 'LOST').length;
      
      // 20åä»¥ä¸‹ã§å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºï¼ˆæ“ä½œæ¨©é™ã¯åˆ¥ã§åˆ¶å¾¡ï¼‰
      if (activeCount <= 20 && activeCount >= 2) {
        controls.style.display = 'flex';
      } else {
        controls.style.display = 'none';
      }
    }
    
    
    function confirmMatch() { if (!appState.selectedPlayer1 || !appState.selectedPlayer2) return; document.getElementById('confirmMatchText').textContent = appState.selectedPlayer1.username + ' VS ' + appState.selectedPlayer2.username; showModal('confirmMatchModal'); }
    function executeConfirmMatch() { if (!db) return; playClick(); appendLog(appState.selectedPlayer1.username + ' VS ' + appState.selectedPlayer2.username + ' ã®å¯¾æˆ¦ãŒç¢ºå®š'); db.collection('matches').add({ player1_id: appState.selectedPlayer1.entry_id, player1_name: appState.selectedPlayer1.username, player2_id: appState.selectedPlayer2.entry_id, player2_name: appState.selectedPlayer2.username, winner_id: null, round: 1, created_at: firebase.firestore.FieldValue.serverTimestamp() }).then(() => { hideModal('confirmMatchModal'); document.getElementById('matchResultControls').style.display = 'flex'; document.getElementById('confirmMatchBtn').disabled = true; showToast('å¯¾æˆ¦ã‚’ç¢ºå®šã—ã¾ã—ãŸ', 'success'); }).catch(e => showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error')); }
    function declareWinner(n) { appState.pendingWinner = { winner: n === 1 ? appState.selectedPlayer1 : appState.selectedPlayer2, loser: n === 1 ? appState.selectedPlayer2 : appState.selectedPlayer1 }; document.getElementById('confirmWinnerText').textContent = appState.pendingWinner.winner.username; showModal('confirmWinnerModal'); }
    async function executeWinner() { 
      if (!db) return; 
      
      // ç®¡ç†è€…ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒã‚§ãƒƒã‚¯
      const cd = await checkCooldown('admin');
      if (cd.blocked) { hideModal('confirmWinnerModal'); showToast('çŸ­æ™‚é–“ã§ç™»éŒ²ãƒ»è§£é™¤ã‚’ç¹°ã‚Šè¿”ã—ãŸãŸã‚ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ï¼ˆæ®‹ã‚Š' + cd.remaining + 'åˆ†ï¼‰', 'error'); return; }
      
      const { winner, loser } = appState.pendingWinner; 
      playClick(); 
      appendLog(winner.username + 'ãŒå‹åˆ©ï¼ˆ' + loser.username + 'æ•—é€€ï¼‰'); 
      
      // ãƒãƒƒãƒã‚’æ¢ã™ï¼ˆãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆçµŒç”± or ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨çµŒç”±ï¼‰
      let m = null;
      if (appState.selectedPlayer1 && appState.selectedPlayer2) {
        m = appState.matches.find(x => x.player1_id === appState.selectedPlayer1.entry_id && x.player2_id === appState.selectedPlayer2.entry_id && !x.winner_id);
      } else {
        // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‹ã‚‰é¸ã‚“ã å ´åˆ
        m = appState.matches.find(x => ((x.player1_id === winner.entry_id && x.player2_id === loser.entry_id) || (x.player1_id === loser.entry_id && x.player2_id === winner.entry_id)) && !x.winner_id);
      }
      
      if (m) db.collection('matches').doc(m.id).update({ winner_id: winner.entry_id, winner_name: winner.username }); 
      const le = appState.entries.find(e => e.entry_id === loser.entry_id); 
      if (le) db.collection('entries').doc(le.id).update({ status: 'LOST' }); 
      
      hideModal('confirmWinnerModal'); 
      document.getElementById('matchResultControls').style.display = 'none'; 
      appState.selectedPlayer1 = null; 
      appState.selectedPlayer2 = null; 
      updateVsDisplay(null, null); 
      document.getElementById('wheelInner').style.transform = 'rotate(0deg)'; 
      showToast('å‹è€…ã‚’ç¢ºå®šã—ã¾ã—ãŸ', 'success'); 
      checkAndUpdateStatus();
      updateBracketControls(); // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
      
      // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚’æ›´æ–°
      if (bracketMode) generateBracket();
    }

    // å¤§ä¼šçµ‚äº†ç¢ºèª
    function confirmEndTournament() {
      const select = document.getElementById('championSelect');
      select.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
      const active = appState.entries.filter(e => e.status !== 'LOST');
      active.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.entry_id;
        opt.textContent = e.username + ' (ID-' + String(e.entry_id).padStart(2,'0') + ')';
        select.appendChild(opt);
      });
      showModal('endTournamentModal');
    }

    // å¤§ä¼šçµ‚äº†å®Ÿè¡Œ
    function executeEndTournament() {
      const select = document.getElementById('championSelect');
      const championId = select.value;
      if (!championId) {
        showToast('å„ªå‹è€…ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      const champion = appState.entries.find(e => e.entry_id === parseInt(championId));
      if (!champion) {
        showToast('å„ªå‹è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      playClick();
      appendLog('ğŸ† ' + champion.username + 'ãŒå„ªå‹ï¼å¤§ä¼šçµ‚äº†');
      
      // å±¥æ­´ã«ä¿å­˜
      if (db) {
        db.collection('history').add({
          game_name: appState.tournament?.game_name || 'ä¸æ˜',
          admin_name: appState.tournament?.admin_name || 'ä¸æ˜',
          champion_name: champion.username,
          champion_id: champion.entry_id,
          total_participants: appState.entries.length,
          date: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          // ç¾åœ¨ã®å¤§ä¼šãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
          db.collection('tournaments').doc('current').delete();
          db.collection('entries').get().then(snap => {
            const batch = db.batch();
            snap.forEach(doc => batch.delete(doc.ref));
            batch.commit();
          });
          db.collection('matches').get().then(snap => {
            const batch = db.batch();
            snap.forEach(doc => batch.delete(doc.ref));
            batch.commit();
          });
        });
      }
      
      // BGMã‚’é€šå¸¸ã«æˆ»ã™
      switchToNormalBGM();
      updateTournamentStatus('end');
      
      hideModal('endTournamentModal');
      showToast('å¤§ä¼šãŒçµ‚äº†ã—ã¾ã—ãŸï¼å„ªå‹: ' + champion.username, 'success');
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹
      setTimeout(() => {
        goToTitle();
        // ã‚¢ãƒ—ãƒªçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        appState.tournament = null;
        appState.entries = [];
        appState.matches = [];
        updateTournamentDisplay();
      }, 2000);
    }
    function loadHistory() { if (!db) { document.getElementById('historyList').innerHTML = '<p style="text-align:center;color:var(--text-dim);">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœªæ¥ç¶š</p>'; return; } db.collection('history').orderBy('date', 'desc').get().then(snap => { const l = document.getElementById('historyList'); if (snap.empty) { l.innerHTML = '<p style="text-align:center;color:var(--text-dim);">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>'; return; } l.innerHTML = snap.docs.map(d => { const x = d.data(); const dt = x.date?.toDate?.() || new Date(); return '<div class="history-card"><div class="history-date">' + dt.toLocaleDateString('ja-JP') + '</div><div class="history-game">' + escapeHtml(x.game_name || 'ä¸æ˜') + '</div><div class="history-winner">ğŸ‘‘ å„ªå‹: ' + escapeHtml(x.champion_name || 'ä¸æ˜') + '</div><div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.4rem;">ç®¡ç†è€…: ' + escapeHtml(x.admin_name || 'ä¸æ˜') + ' / å‚åŠ è€…: ' + (x.total_participants || 0) + 'å</div></div>'; }).join(''); }); }
    
    // ãƒªã‚»ãƒƒãƒˆç¢ºèª
    function confirmResetTournament() {
      // ç· åˆ‡å¾Œã‹ã¤å¤§ä¼šé€²è¡Œä¸­ã¯ãƒªã‚»ãƒƒãƒˆä¸å¯
      const dl = appState.tournament?.deadline;
      if (dl) {
        const d = dl.toDate ? dl.toDate() : new Date(dl);
        if (new Date() >= d) {
          showToast('ç· åˆ‡æ—¥æ™‚ä»¥é™ã¯å¤§ä¼šçµ‚äº†ã¾ã§ãƒªã‚»ãƒƒãƒˆã§ãã¾ã›ã‚“', 'error');
          return;
        }
      }
      showModal('resetTournamentModal');
    }
    
    // ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
    async function executeResetTournament() {
      playClick();
      appendLog('âš ï¸ ç®¡ç†è€…ãŒå¤§ä¼šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
      
      if (db) {
        // å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        try {
          await db.collection('tournaments').doc('current').delete();
          const entriesSnap = await db.collection('entries').get();
          const entriesBatch = db.batch();
          entriesSnap.forEach(doc => entriesBatch.delete(doc.ref));
          await entriesBatch.commit();
          
          const matchesSnap = await db.collection('matches').get();
          const matchesBatch = db.batch();
          matchesSnap.forEach(doc => matchesBatch.delete(doc.ref));
          await matchesBatch.commit();
        } catch (e) { console.error('Reset error:', e); }
      }
      
      // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      localStorage.removeItem('tournament_admin_name');
      appState.tournament = null;
      appState.entries = [];
      appState.matches = [];
      appState.isAdmin = false;
      appState.adminName = null;
      
      hideModal('resetTournamentModal');
      showToast('å¤§ä¼šãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ', 'success');
      
      setTimeout(() => {
        goToTitle();
        updateTournamentDisplay();
      }, 1000);
    }
    
    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    function updateResetButton() {
      const btn = document.getElementById('resetTournamentBtn');
      if (!btn) return;
      const dl = appState.tournament?.deadline;
      if (dl) {
        const d = dl.toDate ? dl.toDate() : new Date(dl);
        if (new Date() >= d) {
          btn.disabled = true;
          btn.style.opacity = '0.3';
        } else {
          btn.disabled = false;
          btn.style.opacity = '';
        }
      }
    }
  </script>
</body>
</html>
