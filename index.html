<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --matrix-green: #00ff41;
      --matrix-green-dim: #00aa2a;
      --matrix-green-dark: #003300;
      --matrix-gold: #ffcc00;
      --bg-dark: #0a120a;
      --bg-card: rgba(0, 15, 5, 0.9);
      --text-primary: #c0ffc0;
      --text-dim: #4a8a4a;
      --border-glow: 0 0 10px rgba(0,255,65,0.3);
      --error-red: #ff3333;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: linear-gradient(180deg, #0a140a 0%, #061006 50%, #040804 100%);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Matrix Background - katakana + code + numbers */
    .matrix-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -1;
      pointer-events: none;
      overflow: hidden;
      background: radial-gradient(ellipse at 50% 50%, rgba(0,40,10,0.3) 0%, transparent 70%);
    }
    .matrix-col {
      position: absolute;
      top: -120%;
      font-family: 'MS Gothic', 'Courier New', monospace;
      font-size: 15px;
      line-height: 1.3;
      color: var(--matrix-green);
      writing-mode: vertical-rl;
      text-orientation: mixed;
      white-space: nowrap;
      text-shadow: 0 0 8px rgba(0,255,65,0.6);
      animation: matrixFall linear infinite;
      opacity: 0.6;
    }
    /* 25 columns with katakana + hex + binary + symbols */
    .matrix-col:nth-child(1) { left: 2%; animation-duration: 9s; animation-delay: 0s; }
    .matrix-col:nth-child(1)::before { content: "ï½± 0xF3 ï½² 1010 ï½³ ï½´ 0xAB ï½µ 0110"; }
    .matrix-col:nth-child(2) { left: 6%; animation-duration: 11s; animation-delay: -3s; opacity: 0.5; }
    .matrix-col:nth-child(2)::before { content: "ï½¶ C0DE ï½· 1101 ï½¸ {} ï½¹ ï½º =="; }
    .matrix-col:nth-child(3) { left: 10%; animation-duration: 8s; animation-delay: -5s; opacity: 0.7; }
    .matrix-col:nth-child(3)::before { content: "ï½» 0xFF ï½¼ ï½½ 1001 ï½¾ ï½¿ DEAD"; }
    .matrix-col:nth-child(4) { left: 14%; animation-duration: 12s; animation-delay: -1s; opacity: 0.45; }
    .matrix-col:nth-child(4)::before { content: "ï¾€ [] ï¾ BEEF ï¾‚ ï¾ƒ 0x00 ï¾„"; }
    .matrix-col:nth-child(5) { left: 18%; animation-duration: 10s; animation-delay: -6s; opacity: 0.55; }
    .matrix-col:nth-child(5)::before { content: "ï¾… 1111 ï¾† ï¾‡ CAFE ï¾ˆ ï¾‰ 0xE7"; }
    .matrix-col:nth-child(6) { left: 22%; animation-duration: 9s; animation-delay: -2s; opacity: 0.5; }
    .matrix-col:nth-child(6)::before { content: "ï¾Š => ï¾‹ 0011 ï¾Œ ï¾ ++ ï¾ DATA"; }
    .matrix-col:nth-child(7) { left: 26%; animation-duration: 11s; animation-delay: -4s; opacity: 0.65; }
    .matrix-col:nth-child(7)::before { content: "ï¾ 0xD4 ï¾ ï¾‘ NULL ï¾’ 1000 ï¾“"; }
    .matrix-col:nth-child(8) { left: 30%; animation-duration: 8s; animation-delay: -7s; opacity: 0.5; }
    .matrix-col:nth-child(8)::before { content: "ï¾” VOID ï¾• ï¾– 0x9C ï¾— 0100 ï¾˜"; }
    .matrix-col:nth-child(9) { left: 34%; animation-duration: 10s; animation-delay: -1s; opacity: 0.6; }
    .matrix-col:nth-child(9)::before { content: "ï¾™ -- ï¾š ï¾› EXEC ï¾œ 0xB8 ï¾"; }
    .matrix-col:nth-child(10) { left: 38%; animation-duration: 12s; animation-delay: -5s; opacity: 0.45; }
    .matrix-col:nth-child(10)::before { content: "ï½¦ 1110 ï½° ï½§ INIT ï½¨ 0x5A ï½©"; }
    .matrix-col:nth-child(11) { left: 42%; animation-duration: 9s; animation-delay: -3s; opacity: 0.55; }
    .matrix-col:nth-child(11)::before { content: "ï½ª && ï½« 0xFE ï½¬ LOAD ï½­ 0101"; }
    .matrix-col:nth-child(12) { left: 46%; animation-duration: 11s; animation-delay: -6s; opacity: 0.7; }
    .matrix-col:nth-child(12)::before { content: "ï½® RUN ï½¯ 0x2F ï½° || 1011 ï½±"; }
    .matrix-col:nth-child(13) { left: 50%; animation-duration: 8s; animation-delay: -2s; opacity: 0.5; }
    .matrix-col:nth-child(13)::before { content: "ï½² 0xC1 ï½³ CALL ï½´ != 0111 ï½µ"; }
    .matrix-col:nth-child(14) { left: 54%; animation-duration: 10s; animation-delay: -4s; opacity: 0.6; }
    .matrix-col:nth-child(14)::before { content: "ï½¶ PUSH ï½· 0x8D ï½¸ << 1100 ï½¹"; }
    .matrix-col:nth-child(15) { left: 58%; animation-duration: 12s; animation-delay: -7s; opacity: 0.45; }
    .matrix-col:nth-child(15)::before { content: "ï½º 0xA0 ï½» POP ï½¼ >> 0010 ï½½"; }
    .matrix-col:nth-child(16) { left: 62%; animation-duration: 9s; animation-delay: -1s; opacity: 0.55; }
    .matrix-col:nth-child(16)::before { content: "ï½¾ JMP ï½¿ 0x6B ï¾€ ^^ 1010 ï¾"; }
    .matrix-col:nth-child(17) { left: 66%; animation-duration: 11s; animation-delay: -5s; opacity: 0.65; }
    .matrix-col:nth-child(17)::before { content: "ï¾‚ 0xEE ï¾ƒ RET ï¾„ %% 0001 ï¾…"; }
    .matrix-col:nth-child(18) { left: 70%; animation-duration: 8s; animation-delay: -3s; opacity: 0.5; }
    .matrix-col:nth-child(18)::before { content: "ï¾† MOV ï¾‡ 0x3C ï¾ˆ :: 1101 ï¾‰"; }
    .matrix-col:nth-child(19) { left: 74%; animation-duration: 10s; animation-delay: -6s; opacity: 0.6; }
    .matrix-col:nth-child(19)::before { content: "ï¾Š 0x77 ï¾‹ ADD ï¾Œ ?? 0110 ï¾"; }
    .matrix-col:nth-child(20) { left: 78%; animation-duration: 12s; animation-delay: -2s; opacity: 0.45; }
    .matrix-col:nth-child(20)::before { content: "ï¾ SUB ï¾ 0x4E ï¾ $$ 1000 ï¾‘"; }
    .matrix-col:nth-child(21) { left: 82%; animation-duration: 9s; animation-delay: -4s; opacity: 0.55; }
    .matrix-col:nth-child(21)::before { content: "ï¾’ 0xB2 ï¾“ XOR ï¾” @@ 0011 ï¾•"; }
    .matrix-col:nth-child(22) { left: 86%; animation-duration: 11s; animation-delay: -7s; opacity: 0.7; }
    .matrix-col:nth-child(22)::before { content: "ï¾– AND ï¾— 0x91 ï¾˜ ## 1111 ï¾™"; }
    .matrix-col:nth-child(23) { left: 90%; animation-duration: 8s; animation-delay: -1s; opacity: 0.5; }
    .matrix-col:nth-child(23)::before { content: "ï¾š 0xDA ï¾› NOT ï¾œ ** 0100 ï¾"; }
    .matrix-col:nth-child(24) { left: 94%; animation-duration: 10s; animation-delay: -5s; opacity: 0.6; }
    .matrix-col:nth-child(24)::before { content: "ï½¦ SHL ï½° 0x65 ï½§ // 1001 ï½¨"; }
    .matrix-col:nth-child(25) { left: 98%; animation-duration: 12s; animation-delay: -3s; opacity: 0.45; }
    .matrix-col:nth-child(25)::before { content: "ï½© 0xF8 ï½ª END ï½« \\\\ 0111 ï½¬"; }

    @keyframes matrixFall {
      0% { transform: translateY(0); }
      100% { transform: translateY(240vh); }
    }

    /* Header */
    .header {
      background: linear-gradient(180deg, rgba(5,20,8,0.95), rgba(3,12,5,0.9));
      border-bottom: 2px solid var(--matrix-green);
      box-shadow: 0 0 15px rgba(0,255,65,0.2);
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--matrix-green);
      text-shadow: 0 0 5px rgba(0,255,65,0.5);
      letter-spacing: 3px;
    }
    .back-btn {
      background: transparent;
      border: 1px solid var(--matrix-green);
      color: var(--matrix-green);
      padding: 0.5rem 1rem;
      cursor: pointer;
      display: none;
    }
    .back-btn:hover { background: rgba(0,255,65,0.15); }
    .back-btn.visible { display: block; }

    /* Audio Controls */
    .audio-controls { display: flex; align-items: center; gap: 0.5rem; }
    .audio-btn {
      background: transparent;
      border: 1px solid var(--matrix-green-dim);
      color: var(--matrix-green);
      width: 36px; height: 36px;
      cursor: pointer;
      font-size: 1rem;
    }
    .audio-btn:hover { background: rgba(0,255,65,0.1); }
    .audio-btn.muted { color: var(--text-dim); }
    .volume-slider {
      width: 60px; height: 4px;
      -webkit-appearance: none;
      background: var(--matrix-green-dark);
    }
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 10px; height: 10px;
      background: var(--matrix-green);
      border-radius: 50%;
      cursor: pointer;
    }
    .volume-control { display: none; }
    .volume-control.visible { display: flex; align-items: center; gap: 0.5rem; }

    /* Container */
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
    .screen { display: none; }
    .screen.active { display: block; }

    /* Title Screen */
    .title-screen {
      text-align: center;
      padding: 2rem 1rem;
      min-height: calc(100vh - 150px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    /* Matrix Style Title - Serif with vertical lines */
    .matrix-title {
      font-family: 'Noto Serif JP', serif;
      font-size: clamp(3.5rem, 12vw, 6rem);
      font-weight: 900;
      color: #20c050;
      background: linear-gradient(180deg, 
        #40ff80 0%, 
        #20d060 20%,
        #10a040 40%,
        #20c050 60%,
        #30e070 80%,
        #50ff90 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 0.15em;
      margin-bottom: 0.5rem;
      text-shadow: none;
      filter: drop-shadow(0 0 3px rgba(0,255,65,0.4));
      position: relative;
    }
    .title-sub {
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 0.85rem;
      color: var(--matrix-green-dim);
      margin-bottom: 2.5rem;
      letter-spacing: 0.4em;
    }

    /* HUD Frame - Green Only */
    .hud-frame {
      position: relative;
      padding: 2rem;
      background: rgba(5,15,8,0.92);
      border: 2px solid var(--matrix-green);
      box-shadow: 0 0 20px rgba(0,255,65,0.25), inset 0 0 30px rgba(0,255,65,0.03);
      max-width: 450px;
      margin: 0 auto;
    }
    .hud-corner {
      position: absolute;
      width: 12px; height: 12px;
      border: 2px solid var(--matrix-green);
    }
    .hud-corner.tl { top: -2px; left: -2px; border-right: none; border-bottom: none; }
    .hud-corner.tr { top: -2px; right: -2px; border-left: none; border-bottom: none; }
    .hud-corner.bl { bottom: -2px; left: -2px; border-right: none; border-top: none; }
    .hud-corner.br { bottom: -2px; right: -2px; border-left: none; border-top: none; }

    /* Menu Buttons */
    .menu-buttons { display: flex; flex-direction: column; gap: 0.8rem; }
    .menu-btn {
      background: rgba(0,25,10,0.85);
      border: 1px solid var(--matrix-green);
      color: var(--matrix-green);
      padding: 1rem 1.5rem;
      font-size: 1rem;
      font-family: 'Noto Sans JP', sans-serif;
      cursor: pointer;
      transition: all 0.2s;
    }
    .menu-btn:hover {
      background: rgba(0,255,65,0.12);
      box-shadow: 0 0 12px rgba(0,255,65,0.3);
    }

    /* Info Icons */
    .info-icons { display: flex; justify-content: center; gap: 1.5rem; margin-top: 1.5rem; }
    .info-btn {
      background: transparent;
      border: 1px solid var(--matrix-green-dim);
      color: var(--matrix-green-dim);
      width: 40px; height: 40px;
      cursor: pointer;
      font-size: 1.2rem;
    }
    .info-btn:hover {
      border-color: var(--matrix-green);
      color: var(--matrix-green);
      box-shadow: 0 0 8px rgba(0,255,65,0.3);
    }

    /* Form Styles */
    .form-container {
      max-width: 500px;
      margin: 0 auto;
      background: rgba(5,15,8,0.95);
      border: 2px solid var(--matrix-green);
      padding: 2rem;
      box-shadow: 0 0 15px rgba(0,255,65,0.2);
    }
    .form-title {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.2rem;
      color: var(--matrix-green);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .form-group { margin-bottom: 1.5rem; }
    .form-label { display: block; margin-bottom: 0.5rem; color: var(--text-dim); font-size: 0.9rem; }
    .form-input {
      width: 100%;
      background: rgba(0,0,0,0.5);
      border: 1px solid var(--matrix-green-dim);
      color: var(--text-primary);
      padding: 0.8rem;
      font-size: 1rem;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--matrix-green);
      box-shadow: 0 0 8px rgba(0,255,65,0.25);
    }
    .error-message {
      color: var(--error-red);
      font-size: 0.85rem;
      margin-top: 0.5rem;
      display: none;
    }
    .error-message.visible { display: block; }
    .deadline-info {
      background: rgba(0,255,65,0.08);
      border: 1px solid var(--matrix-green-dim);
      padding: 1rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .deadline-label { font-size: 0.85rem; color: var(--text-dim); }
    .deadline-value { font-family: 'Noto Serif JP', serif; font-size: 1.1rem; color: var(--matrix-green); }
    .participant-count { text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(0,255,65,0.3); }
    .count-value { font-family: 'Noto Serif JP', serif; font-size: 2rem; color: var(--matrix-green); }
    .count-label { font-size: 0.85rem; color: var(--text-dim); }
    .submit-btn {
      width: 100%;
      background: linear-gradient(180deg, var(--matrix-green-dim), #004400);
      border: 2px solid var(--matrix-green);
      color: #fff;
      padding: 1rem;
      font-size: 1rem;
      cursor: pointer;
    }
    .submit-btn:hover:not(:disabled) { background: linear-gradient(180deg, var(--matrix-green), var(--matrix-green-dim)); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* My Entry Info */
    .my-entry-info {
      background: rgba(0,255,65,0.08);
      border: 1px solid var(--matrix-green);
      padding: 1rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .my-entry-label { font-size: 0.85rem; color: var(--text-dim); }
    .my-entry-id { font-family: 'Noto Serif JP', serif; font-size: 1.5rem; color: var(--matrix-green); }
    .cancel-entry-btn {
      background: transparent;
      border: 1px solid var(--error-red);
      color: var(--error-red);
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      cursor: pointer;
      margin-top: 0.5rem;
    }

    /* Icon Upload */
    .icon-upload { display: flex; align-items: center; gap: 1rem; }
    .icon-preview-wrapper { position: relative; }
    .icon-preview {
      width: 60px; height: 60px;
      border-radius: 50%;
      background: rgba(0,255,65,0.1);
      border: 2px solid var(--matrix-green-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .icon-preview img { width: 100%; height: 100%; object-fit: cover; }
    .icon-cancel-btn {
      position: absolute;
      top: -5px; right: -5px;
      width: 20px; height: 20px;
      background: var(--error-red);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .icon-cancel-btn.visible { display: flex; }
    .icon-upload-btn {
      flex: 1;
      background: transparent;
      border: 1px dashed var(--matrix-green-dim);
      color: var(--text-dim);
      padding: 0.8rem;
      cursor: pointer;
    }
    .icon-upload-btn:hover { border-color: var(--matrix-green); color: var(--matrix-green); }

    /* Participant List */
    .participant-list {
      background: rgba(5,15,8,0.95);
      border: 2px solid var(--matrix-green);
      box-shadow: 0 0 12px rgba(0,255,65,0.2);
    }
    .list-header {
      background: rgba(0,255,65,0.08);
      padding: 1rem;
      border-bottom: 1px solid var(--matrix-green);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .list-title { font-family: 'Noto Serif JP', serif; font-size: 1rem; color: var(--matrix-green); }
    .list-search {
      background: rgba(0,0,0,0.5);
      border: 1px solid var(--matrix-green-dim);
      color: var(--text-primary);
      padding: 0.5rem;
      width: 180px;
    }
    .list-table { width: 100%; border-collapse: collapse; }
    .list-table th {
      background: rgba(0,20,8,0.8);
      padding: 0.8rem;
      text-align: left;
      font-size: 0.85rem;
      color: var(--text-dim);
      border-bottom: 1px solid rgba(0,255,65,0.3);
    }
    .list-table td { padding: 0.8rem; border-bottom: 1px solid rgba(0,255,65,0.1); }
    .list-table tr:hover { background: rgba(0,255,65,0.05); }
    .list-table tr.lost { opacity: 0.4; }
    .participant-icon {
      width: 32px; height: 32px;
      border-radius: 50%;
      background: rgba(0,255,65,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .participant-icon img { width: 100%; height: 100%; object-fit: cover; }
    .status-badge { padding: 0.2rem 0.4rem; font-size: 0.7rem; border-radius: 2px; }
    .status-active { background: rgba(0,255,65,0.15); color: var(--matrix-green); border: 1px solid var(--matrix-green); }
    .status-lost { background: rgba(255,51,51,0.15); color: #ff6666; border: 1px solid #ff3333; }
    .status-seed { background: rgba(255,204,0,0.15); color: var(--matrix-gold); border: 1px solid var(--matrix-gold); }

    /* Admin Panel */
    .admin-panel {
      background: rgba(5,20,10,0.9);
      border: 2px solid var(--matrix-green);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    .admin-title {
      font-family: 'Noto Serif JP', serif;
      font-size: 1rem;
      color: var(--matrix-green);
      margin-bottom: 1rem;
    }
    .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.8rem; }
    .admin-btn {
      background: rgba(0,255,65,0.08);
      border: 1px solid var(--matrix-green);
      color: var(--matrix-green);
      padding: 0.7rem;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .admin-btn:hover { background: rgba(0,255,65,0.15); }

    /* Roulette */
    .roulette-container { display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center; }
    .roulette-wheel { width: 300px; height: 300px; position: relative; margin: 2rem 0; }
    .wheel-outer {
      width: 100%; height: 100%;
      border-radius: 50%;
      border: 3px solid var(--matrix-green);
      box-shadow: 0 0 15px rgba(0,255,65,0.3);
      background: radial-gradient(circle, rgba(0,35,15,0.9), rgba(0,8,3,0.95));
    }
    .wheel-inner {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 80%; height: 80%;
      border-radius: 50%;
      border: 2px solid var(--matrix-green-dim);
      transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
    }
    .wheel-id {
      position: absolute;
      font-family: monospace;
      font-size: 0.65rem;
      color: var(--matrix-green);
    }
    .wheel-pointer {
      position: absolute;
      top: -12px; left: 50%;
      transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 20px solid var(--matrix-green);
      filter: drop-shadow(0 0 4px var(--matrix-green));
      z-index: 10;
    }
    .vs-display {
      background: rgba(5,15,8,0.95);
      border: 2px solid var(--matrix-green);
      padding: 1.5rem;
      text-align: center;
      min-width: 280px;
    }
    .vs-title { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1rem; }
    .vs-players { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
    .vs-player { text-align: center; }
    .vs-player-icon {
      width: 60px; height: 60px;
      border-radius: 50%;
      background: rgba(0,255,65,0.1);
      border: 2px solid var(--matrix-green);
      margin: 0 auto 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .vs-player-icon img { width: 100%; height: 100%; object-fit: cover; }
    .vs-player-name { font-size: 0.9rem; color: var(--text-primary); }
    .vs-player-id { font-size: 0.75rem; color: var(--matrix-green); }
    .vs-text { font-family: 'Noto Serif JP', serif; font-size: 1.5rem; color: var(--matrix-green); }
    .roulette-controls { display: flex; gap: 0.8rem; flex-wrap: wrap; justify-content: center; margin-top: 1rem; }
    .roulette-btn {
      background: rgba(0,25,10,0.85);
      border: 2px solid var(--matrix-green);
      color: var(--matrix-green);
      padding: 0.7rem 1.2rem;
      cursor: pointer;
    }
    .roulette-btn:hover:not(:disabled) { background: rgba(0,255,65,0.12); }
    .roulette-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .roulette-btn.primary { background: linear-gradient(180deg, var(--matrix-green-dim), #003300); color: #fff; }

    /* History */
    .history-card {
      background: rgba(5,15,8,0.95);
      border: 1px solid var(--matrix-green-dim);
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .history-card:hover { border-color: var(--matrix-green); }
    .history-date { font-size: 0.85rem; color: var(--text-dim); }
    .history-game { font-size: 1.1rem; margin: 0.5rem 0; }
    .history-winner { color: var(--matrix-gold); }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,5,2,0.92);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: rgba(5,15,8,0.98);
      border: 2px solid var(--matrix-green);
      padding: 2rem;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 0 25px rgba(0,255,65,0.3);
    }
    .modal-title { font-family: 'Noto Serif JP', serif; font-size: 1.1rem; color: var(--matrix-green); margin-bottom: 1rem; }
    .modal-content { margin-bottom: 1.5rem; line-height: 1.6; }
    .modal-buttons { display: flex; gap: 1rem; justify-content: flex-end; }
    .modal-btn {
      padding: 0.7rem 1.2rem;
      border: 1px solid var(--matrix-green);
      background: transparent;
      color: var(--matrix-green);
      cursor: pointer;
    }
    .modal-btn:hover { background: rgba(0,255,65,0.1); }
    .modal-btn.confirm { background: var(--matrix-green); color: #000; }
    .modal-btn.danger { border-color: var(--error-red); color: var(--error-red); }

    /* Toast */
    .toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 1001; }
    .toast {
      background: rgba(5,15,8,0.98);
      border: 1px solid var(--matrix-green);
      padding: 1rem;
      margin-top: 0.5rem;
      box-shadow: 0 0 12px rgba(0,255,65,0.3);
    }
    .toast.error { border-color: var(--error-red); }

    @media (max-width: 768px) {
      .matrix-title { font-size: 2.2rem; }
      .roulette-wheel { width: 250px; height: 250px; }
      .roulette-container { flex-direction: column; }
      .vs-display { min-width: auto; width: 100%; }
    }
  </style>
</head>
<body>
  <div class="matrix-bg">
    <div class="matrix-col"></div><div class="matrix-col"></div><div class="matrix-col"></div>
    <div class="matrix-col"></div><div class="matrix-col"></div><div class="matrix-col"></div>
    <div class="matrix-col"></div><div class="matrix-col"></div><div class="matrix-col"></div>
    <div class="matrix-col"></div><div class="matrix-col"></div><div class="matrix-col"></div>
    <div class="matrix-col"></div><div class="matrix-col"></div><div class="matrix-col"></div>
    <div class="matrix-col"></div><div class="matrix-col"></div><div class="matrix-col"></div>
    <div class="matrix-col"></div><div class="matrix-col"></div><div class="matrix-col"></div>
    <div class="matrix-col"></div><div class="matrix-col"></div><div class="matrix-col"></div>
    <div class="matrix-col"></div>
  </div>

  <header class="header">
    <div class="header-content">
      <button class="back-btn" id="backBtn" onclick="goBack()">ï¼œ æˆ»ã‚‹</button>
      <h1 class="logo">ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</h1>
      <div class="audio-controls">
        <button class="audio-btn" id="bgmToggle" onclick="toggleBGM()">â™ª</button>
        <div class="volume-control" id="volumeControl">
          <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="30" oninput="setVolume(this.value)">
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Title Screen -->
    <div class="screen active" id="titleScreen">
      <div class="title-screen">
        <h1 class="matrix-title">ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</h1>
        <p class="title-sub">ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
        <div class="hud-frame">
          <div class="hud-corner tl"></div>
          <div class="hud-corner tr"></div>
          <div class="hud-corner bl"></div>
          <div class="hud-corner br"></div>
          <div class="menu-buttons">
            <button class="menu-btn" onclick="navigateTo('entryScreen')">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç™»éŒ²ã™ã‚‹</button>
            <button class="menu-btn" onclick="navigateTo('tournamentScreen')">ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹</button>
            <button class="menu-btn" onclick="navigateTo('historyScreen')">éå»ã®å¤§ä¼šè¨˜éŒ²ã‚’è¦‹ã‚‹</button>
            <button class="menu-btn" onclick="navigateTo('adminScreen')">ç®¡ç†è€…ç™»éŒ²ã‚’ã™ã‚‹</button>
          </div>
          <div class="info-icons">
            <button class="info-btn" onclick="showModal('appInfoModal')">?</button>
            <button class="info-btn" onclick="showModal('adminInfoModal')">âš™</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Entry Screen -->
    <div class="screen" id="entryScreen">
      <div class="form-container">
        <h2 class="form-title">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç™»éŒ²</h2>
        <div id="myEntryInfo" class="my-entry-info" style="display: none;">
          <div class="my-entry-label">ã‚ãªãŸã®å‚åŠ ID</div>
          <div class="my-entry-id" id="myEntryId">-</div>
          <div id="myEntryName">-</div>
          <button class="cancel-entry-btn" id="cancelEntryBtn" onclick="cancelEntry()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div class="deadline-info">
          <div class="deadline-label">ç· åˆ‡æ—¥æ™‚</div>
          <div class="deadline-value" id="deadlineDisplay">æœªè¨­å®š</div>
        </div>
        <div id="entryFormFields">
          <div class="form-group">
            <label class="form-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ </label>
            <input type="text" class="form-input" id="usernameInput" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›" maxlength="20">
            <div class="error-message" id="usernameError"></div>
          </div>
          <div class="form-group">
            <label class="form-label">ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆä»»æ„ï¼‰</label>
            <div class="icon-upload">
              <div class="icon-preview-wrapper">
                <div class="icon-preview" id="iconPreview"><span>ğŸ‘¤</span></div>
                <button class="icon-cancel-btn" id="iconCancelBtn" onclick="cancelIcon()">âœ•</button>
              </div>
              <button class="icon-upload-btn" onclick="document.getElementById('iconInput').click()">ç”»åƒã‚’é¸æŠ</button>
              <input type="file" id="iconInput" accept="image/*" style="display:none" onchange="handleIconUpload(event)">
            </div>
          </div>
          <button class="submit-btn" id="entrySubmitBtn" onclick="submitEntry()" disabled>ç· åˆ‡æ—¥æ™‚ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</button>
        </div>
        <div class="participant-count">
          <div class="count-value"><span id="participantCount">0</span>/100</div>
          <div class="count-label">å‚åŠ è€…æ•°</div>
        </div>
      </div>
    </div>

    <!-- Tournament Screen -->
    <div class="screen" id="tournamentScreen">
      <div id="adminPanelTournament" class="admin-panel" style="display: none;">
        <div class="admin-title">[ ç®¡ç†è€…ãƒ‘ãƒãƒ« ]</div>
        <div class="admin-grid">
          <button class="admin-btn" onclick="showModal('setDeadlineModal')">ç· åˆ‡æ—¥æ™‚è¨­å®š</button>
          <button class="admin-btn" onclick="showModal('setGameNameModal')">ã‚²ãƒ¼ãƒ åè¨­å®š</button>
          <button class="admin-btn" onclick="startRoulette()">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹</button>
          <button class="admin-btn" onclick="showModal('confirmRecordModal')">è¨˜éŒ²ã—ã¦çµ‚äº†</button>
        </div>
      </div>
      
      <!-- å¤§ä¼šæƒ…å ± -->
      <div class="tournament-info-panel" style="background: rgba(5,20,10,0.9); border: 1px solid var(--matrix-green-dim); padding: 1rem; margin-bottom: 1.5rem;">
        <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
          <div>
            <div style="font-size: 0.8rem; color: var(--text-dim);">å¤§ä¼šç®¡ç†è€…</div>
            <div id="tournamentAdminNames" style="color: var(--matrix-green); font-size: 1rem;">-</div>
          </div>
          <div>
            <div style="font-size: 0.8rem; color: var(--text-dim);">ç· åˆ‡æ—¥æ™‚</div>
            <div id="tournamentDeadlineInfo" style="color: var(--matrix-green); font-size: 1rem;">æœªè¨­å®š</div>
          </div>
          <div>
            <div style="font-size: 0.8rem; color: var(--text-dim);">å‚åŠ è€…æ•°</div>
            <div id="tournamentParticipantCount" style="color: var(--matrix-green); font-size: 1rem;">0å</div>
          </div>
        </div>
      </div>
      
      <div class="roulette-container" id="rouletteContainer" style="display: none;">
        <div>
          <div class="roulette-wheel">
            <div class="wheel-pointer"></div>
            <div class="wheel-outer">
              <div class="wheel-inner" id="wheelInner"></div>
            </div>
          </div>
          <div class="roulette-controls">
            <button class="roulette-btn primary" id="spinBtn" onclick="spinRoulette()">å›ã™</button>
            <button class="roulette-btn" id="confirmMatchBtn" onclick="confirmMatch()" disabled>å¯¾æˆ¦ç¢ºå®š</button>
          </div>
        </div>
        <div class="vs-display">
          <div class="vs-title">ç¾åœ¨ã®å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰</div>
          <div class="vs-players">
            <div class="vs-player">
              <div class="vs-player-icon" id="vsPlayer1Icon"><span>?</span></div>
              <div class="vs-player-id" id="vsPlayer1Id">-</div>
              <div class="vs-player-name" id="vsPlayer1Name">-</div>
            </div>
            <div class="vs-text">VS</div>
            <div class="vs-player">
              <div class="vs-player-icon" id="vsPlayer2Icon"><span>?</span></div>
              <div class="vs-player-id" id="vsPlayer2Id">-</div>
              <div class="vs-player-name" id="vsPlayer2Name">-</div>
            </div>
          </div>
          <div class="roulette-controls" id="matchResultControls" style="display: none;">
            <button class="roulette-btn" onclick="declareWinner(1)">â† å‹åˆ©</button>
            <button class="roulette-btn" onclick="declareWinner(2)">å‹åˆ© â†’</button>
          </div>
        </div>
      </div>
      <div class="participant-list" style="margin-top: 2rem;">
        <div class="list-header">
          <h3 class="list-title">å‚åŠ è€…ãƒªã‚¹ãƒˆ</h3>
          <input type="text" class="list-search" placeholder="æ¤œç´¢..." oninput="filterParticipants(this.value)">
        </div>
        <table class="list-table">
          <thead>
            <tr><th>ID</th><th>Icon</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th><th>çŠ¶æ…‹</th></tr>
          </thead>
          <tbody id="participantTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- History Screen -->
    <div class="screen" id="historyScreen">
      <h2 class="form-title" style="margin-bottom: 2rem;">éå»ã®å¤§ä¼šè¨˜éŒ²</h2>
      <div id="historyList"></div>
    </div>

    <!-- Admin Screen -->
    <div class="screen" id="adminScreen">
      <div class="form-container">
        <h2 class="form-title">ç®¡ç†è€…ç™»éŒ²</h2>
        <div id="adminStatus"></div>
        <div id="adminLoginForm">
          <p style="margin-bottom: 1.5rem; color: var(--text-dim);">ç®¡ç†è€…ç™»éŒ²ã™ã‚‹ã¨ã€ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆç®¡ç†ã‚„ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ“ä½œãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚<br>â€»ç®¡ç†è€…ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚</p>
          <div class="form-group">
            <label class="form-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ï¼ˆç®¡ç†è€…åï¼‰</label>
            <input type="text" class="form-input" id="adminUsernameInput" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›" maxlength="20">
            <div class="error-message" id="adminUsernameError"></div>
          </div>
          <button class="submit-btn" id="adminRegisterBtn" onclick="registerAsAdmin()">ç®¡ç†è€…ã¨ã—ã¦ç™»éŒ²</button>
        </div>
      </div>
    </div>
  </main>

  <div class="toast-container" id="toastContainer"></div>

  <!-- Modals -->
  <div class="modal-overlay" id="appInfoModal">
    <div class="modal">
      <h3 class="modal-title">ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</h3>
      <div class="modal-content">
        <p><strong>ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆç®¡ç†ã‚¢ãƒ—ãƒª</strong></p>
        <p>ã‚ã‚‰ã‚†ã‚‹å¯¾æˆ¦ã‚²ãƒ¼ãƒ ã«å¯¾å¿œã—ãŸã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚</p>
        <br>
        <p><strong>å‚åŠ æ–¹æ³•</strong></p>
        <p>ã€Œã‚¨ãƒ³ãƒˆãƒªãƒ¼ç™»éŒ²ã™ã‚‹ã€ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn" onclick="hideModal('appInfoModal')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="adminInfoModal">
    <div class="modal">
      <h3 class="modal-title">ç®¡ç†è€…å‘ã‘èª¬æ˜</h3>
      <div class="modal-content">
        <p><strong>ç®¡ç†è€…ãŒã§ãã‚‹ã“ã¨</strong></p>
        <ul style="margin-left: 1.5rem;">
          <li>ã‚²ãƒ¼ãƒ åãƒ»ç· åˆ‡æ—¥æ™‚ã®è¨­å®š</li>
          <li>ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ“ä½œ</li>
          <li>å‹æ•—ç¢ºå®šãƒ»å–æ¶ˆ</li>
          <li>å¤§ä¼šè¨˜éŒ²ã®ä¿å­˜</li>
        </ul>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn" onclick="hideModal('adminInfoModal')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="setDeadlineModal">
    <div class="modal">
      <h3 class="modal-title">ç· åˆ‡æ—¥æ™‚è¨­å®š</h3>
      <div class="modal-content">
        <div class="form-group">
          <label class="form-label">ç· åˆ‡æ—¥æ™‚</label>
          <input type="datetime-local" class="form-input" id="deadlineInput">
        </div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn" onclick="hideModal('setDeadlineModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn confirm" onclick="setDeadline()">è¨­å®š</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="setGameNameModal">
    <div class="modal">
      <h3 class="modal-title">ã‚²ãƒ¼ãƒ åè¨­å®š</h3>
      <div class="modal-content">
        <div class="form-group">
          <label class="form-label">ã‚²ãƒ¼ãƒ å</label>
          <input type="text" class="form-input" id="gameNameInput" placeholder="ä¾‹: ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ã‚¿ãƒ¼6">
        </div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn" onclick="hideModal('setGameNameModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn confirm" onclick="setGameName()">è¨­å®š</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="confirmMatchModal">
    <div class="modal">
      <h3 class="modal-title">å¯¾æˆ¦ç¢ºå®š</h3>
      <div class="modal-content">
        <p>ã“ã®å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ</p>
        <p id="confirmMatchText" style="margin-top: 1rem; color: var(--matrix-green);"></p>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn" onclick="hideModal('confirmMatchModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn confirm" onclick="executeConfirmMatch()">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="confirmWinnerModal">
    <div class="modal">
      <h3 class="modal-title">å‹è€…ç¢ºå®š</h3>
      <div class="modal-content">
        <p>ã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‹è€…ã¨ã—ã¦ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ</p>
        <p id="confirmWinnerText" style="margin-top: 1rem; color: var(--matrix-gold);"></p>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn" onclick="hideModal('confirmWinnerModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn confirm" onclick="executeWinner()">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="confirmRecordModal">
    <div class="modal">
      <h3 class="modal-title">å¤§ä¼šã‚’è¨˜éŒ²ã—ã¦çµ‚äº†</h3>
      <div class="modal-content">
        <p>å¤§ä¼šçµæœã‚’è¨˜éŒ²ã—ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚</p>
        <p style="color: var(--error-red);">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã—ã§ãã¾ã›ã‚“ã€‚</p>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn" onclick="hideModal('confirmRecordModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn danger" onclick="recordAndReset()">è¨˜éŒ²ã—ã¦çµ‚äº†</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="tournamentEndModal">
    <div class="modal">
      <h3 class="modal-title">å¤§ä¼šçµ‚äº†</h3>
      <div class="modal-content">
        <p style="text-align: center;">ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚<br>å¤§ä¼šã¯çµ‚äº†ã—ã¾ã—ãŸã€‚</p>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn confirm" onclick="hideModal('tournamentEndModal'); navigateTo('titleScreen');">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="errorPopupModal">
    <div class="modal" style="border-color: var(--error-red);">
      <h3 class="modal-title" id="errorPopupTitle" style="color: var(--error-red);">ã‚¨ãƒ©ãƒ¼</h3>
      <div class="modal-content">
        <p id="errorPopupMessage"></p>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn" style="border-color: var(--error-red); color: var(--error-red);" onclick="hideModal('errorPopupModal')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    // Audio
    let audioCtx = null;
    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playClickSound() {
      initAudio();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.frequency.value = 1000; osc.type = 'square';
      gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
      osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }
    let bgmPlaying = false, bgmGain = null;
    function toggleBGM() {
      const btn = document.getElementById('bgmToggle');
      const vol = document.getElementById('volumeControl');
      if (bgmPlaying) {
        if (bgmGain) bgmGain.gain.setValueAtTime(0, audioCtx.currentTime);
        btn.classList.add('muted'); btn.textContent = 'â™ª';
        vol.classList.remove('visible');
        bgmPlaying = false;
      } else {
        initAudio();
        bgmGain = audioCtx.createGain();
        bgmGain.gain.value = 0.02;
        bgmGain.connect(audioCtx.destination);
        playBGMNote();
        btn.classList.remove('muted'); btn.textContent = 'â™«';
        vol.classList.add('visible');
        bgmPlaying = true;
      }
    }
    function playBGMNote() {
      if (!bgmPlaying || !bgmGain) return;
      const notes = [130.81, 164.81, 196.00, 146.83];
      const osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.value = notes[Math.floor(Math.random() * notes.length)];
      osc.connect(bgmGain);
      osc.start(); osc.stop(audioCtx.currentTime + 0.6);
      setTimeout(playBGMNote, 700);
    }
    function setVolume(v) { if (bgmGain) bgmGain.gain.value = v / 2000; }
    document.addEventListener('click', e => { if (e.target.matches('button')) playClickSound(); });

    // App State
    const appState = {
      currentUser: null, isAdmin: false, deviceId: null, tournament: null,
      entries: [], matches: [], currentScreen: 'titleScreen', screenHistory: ['titleScreen'],
      selectedPlayer1: null, selectedPlayer2: null, pendingWinner: null, isSpinning: false
    };
    function getDeviceId() {
      let id = localStorage.getItem('tournament_device_id');
      if (!id) { id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2,9); localStorage.setItem('tournament_device_id', id); }
      return id;
    }
    appState.deviceId = getDeviceId();

    function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    function showToast(msg, type='info') {
      const c = document.getElementById('toastContainer');
      const t = document.createElement('div');
      t.className = 'toast ' + type; t.textContent = msg;
      c.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }
    function showModal(id) { document.getElementById(id).classList.add('active'); }
    function hideModal(id) { document.getElementById(id).classList.remove('active'); }
    function navigateTo(id) {
      // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç”»é¢ã¯ç· åˆ‡æ—¥ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
      if (id === 'entryScreen') {
        if (!appState.tournament?.deadline) {
          showErrorPopup('ç· åˆ‡æ—¥æ™‚ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'ç®¡ç†è€…ãŒç· åˆ‡æ—¥æ™‚ã‚’è¨­å®šã™ã‚‹ã¾ã§ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç™»éŒ²ã¯ã§ãã¾ã›ã‚“ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
          return;
        }
      }
      
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      appState.screenHistory.push(id);
      appState.currentScreen = id;
      document.getElementById('backBtn').classList.toggle('visible', id !== 'titleScreen');
      if (id === 'historyScreen') loadHistory();
      if (id === 'tournamentScreen') updateAdminUI();
    }
    
    function showErrorPopup(title, message) {
      document.getElementById('errorPopupTitle').textContent = title;
      document.getElementById('errorPopupMessage').textContent = message;
      document.getElementById('errorPopupModal').classList.add('active');
    }
    function goBack() {
      if (appState.screenHistory.length > 1) {
        appState.screenHistory.pop();
        navigateTo(appState.screenHistory[appState.screenHistory.length - 1]);
        appState.screenHistory.pop();
      }
    }
    function handleIconUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        document.getElementById('iconPreview').innerHTML = '<img src="' + ev.target.result + '">';
        document.getElementById('iconCancelBtn').classList.add('visible');
      };
      reader.readAsDataURL(file);
    }
    function cancelIcon() {
      document.getElementById('iconPreview').innerHTML = '<span>ğŸ‘¤</span>';
      document.getElementById('iconCancelBtn').classList.remove('visible');
      document.getElementById('iconInput').value = '';
    }
    function filterParticipants(term) {
      document.querySelectorAll('#participantTableBody tr').forEach(r => 
        r.style.display = r.textContent.toLowerCase().includes(term.toLowerCase()) ? '' : 'none'
      );
    }
    function updateAdminUI() {
      document.querySelectorAll('[id^="adminPanel"]').forEach(p => p.style.display = appState.isAdmin ? 'block' : 'none');
      const s = document.getElementById('adminStatus');
      if (s) {
        if (appState.isAdmin) {
          s.innerHTML = '<div class="my-entry-info"><div class="my-entry-label">ç®¡ç†è€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div><div class="my-entry-id">âœ“ ç™»éŒ²æ¸ˆã¿</div></div>';
          document.getElementById('adminLoginForm').style.display = 'none';
        } else {
          s.innerHTML = '';
          document.getElementById('adminLoginForm').style.display = 'block';
        }
      }
    }
    function updateTournamentDisplay() {
      const t = appState.tournament;
      const dd = document.getElementById('deadlineDisplay');
      const submitBtn = document.getElementById('entrySubmitBtn');
      const formFields = document.getElementById('entryFormFields');
      
      if (!t || !t.deadline) { 
        dd.textContent = 'æœªè¨­å®šï¼ˆç®¡ç†è€…ã®è¨­å®šã‚’ãŠå¾…ã¡ãã ã•ã„ï¼‰';
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'ç· åˆ‡æ—¥æ™‚ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
        }
        return; 
      }
      
      if (t.deadline) {
        const d = t.deadline.toDate ? t.deadline.toDate() : new Date(t.deadline);
        dd.textContent = d.toLocaleString('ja-JP');
        
        const now = new Date();
        if (now > d) {
          // ç· åˆ‡ã‚’éãã¦ã„ã‚‹
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'ç· åˆ‡æ—¥æ™‚ã‚’éãã¦ã„ã¾ã™';
          }
          if (appState.isAdmin) document.getElementById('rouletteContainer').style.display = 'flex';
        } else {
          // ç· åˆ‡å‰ - ã‚¨ãƒ³ãƒˆãƒªãƒ¼å¯èƒ½
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç™»éŒ²';
          }
        }
      }
      if (t.game_name) document.querySelector('.logo').textContent = t.game_name;
    }
    function updateEntriesDisplay() {
      document.getElementById('participantCount').textContent = appState.entries.length;
      document.getElementById('participantTableBody').innerHTML = appState.entries.map(e =>
        '<tr class="' + (e.status==='LOST'?'lost':'') + '">' +
        '<td style="color:var(--matrix-green)">ID-' + String(e.entry_id).padStart(2,'0') + '</td>' +
        '<td><div class="participant-icon">' + (e.icon_url ? '<img src="'+e.icon_url+'">' : 'ğŸ‘¤') + '</div></td>' +
        '<td>' + escapeHtml(e.username) + (e.is_admin ? ' <span style="color:var(--matrix-gold);font-size:0.75rem;">[ç®¡ç†è€…]</span>' : '') + '</td>' +
        '<td><span class="status-badge status-' + (e.status||'active').toLowerCase() + '">' + (e.status||'ACTIVE') + '</span></td></tr>'
      ).join('');
      checkMyEntry();
      updateTournamentInfo();
    }
    
    function updateTournamentInfo() {
      // ç®¡ç†è€…åã‚’æ›´æ–°
      const admins = appState.entries.filter(e => e.is_admin);
      const adminNamesEl = document.getElementById('tournamentAdminNames');
      if (adminNamesEl) {
        if (admins.length > 0) {
          adminNamesEl.textContent = admins.map(a => a.username).join(', ');
        } else {
          adminNamesEl.textContent = 'æœªç™»éŒ²';
        }
      }
      
      // å‚åŠ è€…æ•°ã‚’æ›´æ–°
      const countEl = document.getElementById('tournamentParticipantCount');
      if (countEl) {
        countEl.textContent = appState.entries.length + 'å';
      }
      
      // ç· åˆ‡æ—¥æ™‚ã‚’æ›´æ–°
      const deadlineEl = document.getElementById('tournamentDeadlineInfo');
      if (deadlineEl && appState.tournament?.deadline) {
        const d = appState.tournament.deadline.toDate ? appState.tournament.deadline.toDate() : new Date(appState.tournament.deadline);
        deadlineEl.textContent = d.toLocaleString('ja-JP');
      } else if (deadlineEl) {
        deadlineEl.textContent = 'æœªè¨­å®š';
      }
    }
    function checkMyEntry() {
      const my = appState.entries.find(e => e.device_id === appState.deviceId);
      const info = document.getElementById('myEntryInfo');
      const form = document.getElementById('entryFormFields');
      if (my) {
        info.style.display = 'block';
        document.getElementById('myEntryId').textContent = 'ID-' + String(my.entry_id).padStart(2,'0');
        document.getElementById('myEntryName').textContent = my.username;
        form.style.display = 'none';
      } else {
        info.style.display = 'none';
        form.style.display = 'block';
      }
    }
    function updateRouletteWheel() {
      const active = appState.entries.filter(e => e.status === 'ACTIVE' || !e.status);
      const wheel = document.getElementById('wheelInner');
      if (!active.length) { wheel.innerHTML = ''; return; }
      const step = 360 / active.length, r = 90;
      wheel.innerHTML = active.map((e,i) => {
        const a = (i * step) * Math.PI / 180;
        return '<div class="wheel-id" style="left:calc(50%+'+r*Math.cos(a-Math.PI/2)+'px);top:calc(50%+'+r*Math.sin(a-Math.PI/2)+'px);transform:translate(-50%,-50%)">ID-'+String(e.entry_id).padStart(2,'0')+'</div>';
      }).join('');
    }
    function updateVsDisplay(p1, p2) {
      document.getElementById('vsPlayer1Id').textContent = p1 ? 'ID-'+String(p1.entry_id).padStart(2,'0') : '-';
      document.getElementById('vsPlayer1Name').textContent = p1 ? p1.username : '-';
      document.getElementById('vsPlayer1Icon').innerHTML = p1?.icon_url ? '<img src="'+p1.icon_url+'">' : '<span>?</span>';
      document.getElementById('vsPlayer2Id').textContent = p2 ? 'ID-'+String(p2.entry_id).padStart(2,'0') : '-';
      document.getElementById('vsPlayer2Name').textContent = p2 ? p2.username : '-';
      document.getElementById('vsPlayer2Icon').innerHTML = p2?.icon_url ? '<img src="'+p2.icon_url+'">' : '<span>?</span>';
    }
    function loadHistory() { document.getElementById('historyList').innerHTML = '<p style="text-align:center;color:var(--text-dim)">èª­ã¿è¾¼ã¿ä¸­...</p>'; }

  </script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCNGRa4DCOM595aM5Exor5BF6oPUvg1TIY",
      authDomain: "tournament-app-a0837.firebaseapp.com",
      projectId: "tournament-app-a0837",
      storageBucket: "tournament-app-a0837.firebasestorage.app",
      messagingSenderId: "514905483124",
      appId: "1:514905483124:web:1882493de273598b0a2e21"
    };

    let db = null;

    // FirebaseåˆæœŸåŒ–
    function initFirebase() {
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log('Firebase initialized successfully');
        loadData();
        return true;
      } catch (e) { 
        console.error('Firebase init error:', e);
        alert('Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + e.message);
        return false;
      }
    }

    // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
    async function checkAdmin() {
      if (!db) return;
      try {
        const d = await db.collection('tournaments').doc('current').get();
        if (d.exists) {
          const adminDevices = d.data().admin_devices || [];
          appState.isAdmin = adminDevices.includes(appState.deviceId);
        }
        updateAdminUI();
      } catch (e) { console.error('checkAdmin error:', e); }
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadData() {
      if (!db) return;
      
      db.collection('tournaments').doc('current').onSnapshot(d => {
        if (d.exists) { 
          appState.tournament = d.data(); 
          updateTournamentDisplay();
          checkAdmin();
        }
      }, e => console.error('tournaments error:', e));
      
      db.collection('entries').orderBy('entry_id', 'asc').onSnapshot(snap => {
        appState.entries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        updateEntriesDisplay();
        updateRouletteWheel();
      }, e => console.error('entries error:', e));
      
      db.collection('matches').orderBy('created_at', 'asc').onSnapshot(snap => {
        appState.matches = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }, e => console.error('matches error:', e));
    }

    // ç®¡ç†è€…ç™»éŒ²
    window.registerAsAdmin = async function() {
      console.log('=== registerAsAdmin START ===');
      
      // DBæ¥ç¶šç¢ºèª
      if (!db) { 
        alert('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœªæ¥ç¶šã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚'); 
        return; 
      }
      console.log('DB connected');
      
      const usernameInput = document.getElementById('adminUsernameInput');
      const err = document.getElementById('adminUsernameError');
      
      if (!usernameInput) {
        alert('å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      const username = usernameInput.value.trim();
      console.log('Username:', username);
      
      if (!username) {
        err.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        err.classList.add('visible');
        return;
      }
      if (appState.entries.find(e => e.username === username)) {
        err.textContent = 'ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã¯ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™';
        err.classList.add('visible');
        return;
      }
      if (appState.entries.find(e => e.device_id === appState.deviceId)) {
        err.textContent = 'ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯ç™»éŒ²æ¸ˆã¿ã§ã™';
        err.classList.add('visible');
        return;
      }
      err.classList.remove('visible');
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const btn = document.getElementById('adminRegisterBtn');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'ç™»éŒ²ä¸­...';
      }
      
      console.log('DeviceId:', appState.deviceId);
      
      try {
        // 1. ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç™»éŒ²
        const entryId = appState.entries.length + 1;
        console.log('Creating entry with ID:', entryId);
        
        await db.collection('entries').doc(appState.deviceId).set({
          entry_id: entryId,
          username: username,
          device_id: appState.deviceId,
          icon_url: null,
          status: 'ACTIVE',
          is_admin: true,
          created_at: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log('Entry created');
        
        // 2. ç®¡ç†è€…ç™»éŒ²
        const tournamentDoc = await db.collection('tournaments').doc('current').get();
        let adminDevices = tournamentDoc.exists ? (tournamentDoc.data().admin_devices || []) : [];
        if (!adminDevices.includes(appState.deviceId)) {
          adminDevices.push(appState.deviceId);
        }
        
        await db.collection('tournaments').doc('current').set({ 
          admin_devices: adminDevices, 
          updated_at: firebase.firestore.FieldValue.serverTimestamp() 
        }, { merge: true });
        console.log('Admin registered');
        
        appState.isAdmin = true;
        updateAdminUI();
        
        alert('ç®¡ç†è€…ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼\næ¬¡ã®ç”»é¢ã§ç· åˆ‡æ—¥æ™‚ã¨ã‚²ãƒ¼ãƒ åã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        
        // è¨­å®šç”»é¢ã«é·ç§»
        navigateTo('tournamentScreen');
        
      } catch (e) { 
        console.error('Registration error:', e);
        alert('ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + e.message + '\n\nFirebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'ç®¡ç†è€…ã¨ã—ã¦ç™»éŒ²';
        }
      }
      
      console.log('=== registerAsAdmin END ===');
    };

    // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç™»éŒ²
    window.submitEntry = async function() {
      if (!db) { showToast('æ¥ç¶šä¸­...', 'info'); return; }
      if (!appState.tournament?.deadline) {
        showToast('ç· åˆ‡æ—¥æ™‚ãŒæœªè¨­å®šã§ã™', 'error');
        return;
      }
      const dl = appState.tournament.deadline.toDate ? appState.tournament.deadline.toDate() : new Date(appState.tournament.deadline);
      if (new Date() > dl) {
        showToast('ç· åˆ‡ã‚’éãã¦ã„ã¾ã™', 'error');
        return;
      }
      
      const name = document.getElementById('usernameInput').value.trim();
      const err = document.getElementById('usernameError');
      if (!name) { err.textContent = 'å…¥åŠ›ã—ã¦ãã ã•ã„'; err.classList.add('visible'); return; }
      if (appState.entries.find(e => e.username === name)) { err.textContent = 'åŒåç¦æ­¢'; err.classList.add('visible'); return; }
      if (appState.entries.find(e => e.device_id === appState.deviceId)) { err.textContent = 'ç™»éŒ²æ¸ˆã¿'; err.classList.add('visible'); return; }
      err.classList.remove('visible');
      
      try {
        const id = appState.entries.length + 1;
        const icon = document.getElementById('iconPreview').querySelector('img');
        await db.collection('entries').doc(appState.deviceId).set({
          entry_id: id, username: name, device_id: appState.deviceId,
          icon_url: icon ? icon.src : null, status: 'ACTIVE', 
          created_at: firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast('ç™»éŒ²å®Œäº†ï¼', 'success');
        document.getElementById('usernameInput').value = '';
      } catch (e) { showToast('å¤±æ•—: ' + e.message, 'error'); }
    };

    window.cancelEntry = async function() {
      if (!db || !confirm('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try { 
        await db.collection('entries').doc(appState.deviceId).delete(); 
        showToast('ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†', 'success'); 
      } catch (e) { showToast('å¤±æ•—', 'error'); }
    };

    window.setDeadline = async function() {
      if (!db) return;
      const v = document.getElementById('deadlineInput').value;
      if (!v) { showToast('æ—¥æ™‚ã‚’å…¥åŠ›', 'error'); return; }
      try {
        await db.collection('tournaments').doc('current').set({ 
          deadline: new Date(v), 
          updated_at: firebase.firestore.FieldValue.serverTimestamp() 
        }, { merge: true });
        hideModal('setDeadlineModal'); 
        showToast('ç· åˆ‡æ—¥æ™‚ã‚’è¨­å®šã—ã¾ã—ãŸ', 'success');
      } catch (e) { showToast('å¤±æ•—', 'error'); }
    };

    window.setGameName = async function() {
      if (!db) return;
      const v = document.getElementById('gameNameInput').value.trim();
      if (!v) { showToast('å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
      try {
        await db.collection('tournaments').doc('current').set({ 
          game_name: v, 
          updated_at: firebase.firestore.FieldValue.serverTimestamp() 
        }, { merge: true });
        hideModal('setGameNameModal'); 
        showToast('ã‚²ãƒ¼ãƒ åã‚’è¨­å®šã—ã¾ã—ãŸ', 'success');
      } catch (e) { showToast('å¤±æ•—', 'error'); }
    };

    window.startRoulette = function() {
      const dl = appState.tournament?.deadline;
      if (!dl) { showToast('ç· åˆ‡æ—¥æ™‚ã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error'); return; }
      if (new Date() < (dl.toDate ? dl.toDate() : new Date(dl))) { 
        showToast('ç· åˆ‡å¾Œã«ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå¯èƒ½', 'error'); return; 
      }
      document.getElementById('rouletteContainer').style.display = 'flex';
    };

    window.spinRoulette = function() {
      if (appState.isSpinning) return;
      const active = appState.entries.filter(e => e.status === 'ACTIVE' || !e.status);
      const free = active.filter(e => !appState.matches.some(m => (m.player1_id === e.entry_id || m.player2_id === e.entry_id) && !m.winner_id));
      if (free.length < 2) { showToast('å‚åŠ è€…ä¸è¶³', 'error'); return; }
      appState.isSpinning = true;
      document.getElementById('spinBtn').disabled = true;
      const sh = [...free].sort(() => Math.random() - 0.5);
      appState.selectedPlayer1 = sh[0];
      appState.selectedPlayer2 = sh[1];
      document.getElementById('wheelInner').style.transform = 'rotate(' + (1800 + Math.random()*720) + 'deg)';
      setTimeout(() => {
        updateVsDisplay(appState.selectedPlayer1, appState.selectedPlayer2);
        document.getElementById('confirmMatchBtn').disabled = false;
        appState.isSpinning = false;
        document.getElementById('spinBtn').disabled = false;
      }, 4000);
    };

    window.confirmMatch = function() {
      if (!appState.selectedPlayer1 || !appState.selectedPlayer2) return;
      document.getElementById('confirmMatchText').textContent = appState.selectedPlayer1.username + ' VS ' + appState.selectedPlayer2.username;
      showModal('confirmMatchModal');
    };

    window.executeConfirmMatch = async function() {
      if (!db) return;
      try {
        await db.collection('matches').add({
          player1_id: appState.selectedPlayer1.entry_id, player1_name: appState.selectedPlayer1.username,
          player2_id: appState.selectedPlayer2.entry_id, player2_name: appState.selectedPlayer2.username,
          winner_id: null, round: 1, created_at: firebase.firestore.FieldValue.serverTimestamp()
        });
        hideModal('confirmMatchModal');
        document.getElementById('matchResultControls').style.display = 'flex';
        document.getElementById('confirmMatchBtn').disabled = true;
        showToast('å¯¾æˆ¦ç¢ºå®š', 'success');
      } catch (e) { showToast('å¤±æ•—', 'error'); }
    };

    window.declareWinner = function(n) {
      appState.pendingWinner = { n: n, w: n === 1 ? appState.selectedPlayer1 : appState.selectedPlayer2 };
      document.getElementById('confirmWinnerText').textContent = appState.pendingWinner.w.username;
      showModal('confirmWinnerModal');
    };

    window.executeWinner = async function() {
      if (!db) return;
      try {
        const { n, w } = appState.pendingWinner;
        const loser = n === 1 ? appState.selectedPlayer2 : appState.selectedPlayer1;
        const m = appState.matches.find(x => x.player1_id === appState.selectedPlayer1.entry_id && x.player2_id === appState.selectedPlayer2.entry_id && !x.winner_id);
        if (m) await db.collection('matches').doc(m.id).update({ winner_id: w.entry_id, winner_name: w.username });
        const le = appState.entries.find(e => e.entry_id === loser.entry_id);
        if (le) await db.collection('entries').doc(le.id).update({ status: 'LOST' });
        hideModal('confirmWinnerModal');
        document.getElementById('matchResultControls').style.display = 'none';
        appState.selectedPlayer1 = null; appState.selectedPlayer2 = null;
        updateVsDisplay(null, null);
        document.getElementById('wheelInner').style.transform = 'rotate(0deg)';
        showToast('å‹è€…ç¢ºå®š', 'success');
      } catch (e) { showToast('å¤±æ•—', 'error'); }
    };

    window.recordAndReset = async function() {
      if (!db) return;
      try {
        const t = appState.tournament;
        const champ = appState.entries.find(e => e.status === 'ACTIVE' || !e.status);
        const admins = appState.entries.filter(e => e.is_admin);
        
        await db.collection('history').add({
          year: new Date().getFullYear(), 
          date: firebase.firestore.FieldValue.serverTimestamp(),
          game_name: t?.game_name || 'æœªè¨­å®š', 
          champion_name: champ?.username || 'æœªç¢ºå®š',
          admin_names: admins.map(a => a.username),
          participants: appState.entries.map(e => ({ entry_id: e.entry_id, username: e.username, status: e.status, is_admin: e.is_admin || false })),
          total_participants: appState.entries.length
        });
        
        const batch = db.batch();
        appState.entries.forEach(e => batch.delete(db.collection('entries').doc(e.id)));
        appState.matches.forEach(m => batch.delete(db.collection('matches').doc(m.id)));
        batch.set(db.collection('tournaments').doc('current'), { admin_devices: [], game_name: null, deadline: null, updated_at: firebase.firestore.FieldValue.serverTimestamp() });
        await batch.commit();
        
        hideModal('confirmRecordModal');
        showModal('tournamentEndModal');
        appState.isAdmin = false;
        updateAdminUI();
      } catch (e) { showToast('å¤±æ•—', 'error'); }
    };

    window.loadHistory = async function() {
      if (!db) return;
      try {
        const snap = await db.collection('history').orderBy('date', 'desc').get();
        const list = document.getElementById('historyList');
        if (snap.empty) { list.innerHTML = '<p style="text-align:center;color:var(--text-dim)">è¨˜éŒ²ãªã—</p>'; return; }
        list.innerHTML = snap.docs.map(d => {
          const data = d.data();
          const date = data.date?.toDate?.() || new Date();
          return '<div class="history-card">' +
            '<div class="history-date">' + date.toLocaleDateString('ja-JP') + '</div>' +
            '<div class="history-game">' + escapeHtml(data.game_name||'ä¸æ˜') + '</div>' +
            '<div class="history-winner">ğŸ‘‘ å„ªå‹: ' + escapeHtml(data.champion_name||'ä¸æ˜') + '</div>' +
            '<div style="font-size:0.85rem;color:var(--text-dim);">ç®¡ç†è€…: ' + escapeHtml((data.admin_names||[]).join(', ')||'ä¸æ˜') + '</div>' +
            '</div>';
        }).join('');
      } catch (e) { console.error(e); }
    };

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded');
      initFirebase();
    });
  </script>
</body>
</html>
