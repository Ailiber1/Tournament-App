<!DOCTYPE html>
<!-- Tournament App v2.1 -->
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>„Éà„Éº„Éä„É°„É≥„Éà</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --hud-green: #00ff41;
      --hud-green-dim: #00aa2a;
      --hud-green-glow: rgba(0, 255, 65, 0.6);
      --hud-gold: #ffcc00;
      --hud-red: #ff3366;
      --bg-dark: #000a04;
      --bg-panel: rgba(0, 20, 10, 0.85);
      --text-primary: #c0ffc0;
      --text-dim: #4a8a4a;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: #000a04;
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .matrix-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .matrix-col {
      position: absolute;
      top: -100%;
      font-family: 'MS Gothic', monospace;
      font-size: 14px;
      line-height: 1.2;
      color: #00ff41;
      writing-mode: vertical-rl;
      animation: matrix-fall linear infinite;
      opacity: 0.12;
      text-shadow: 0 0 3px #00ff41;
    }
    @keyframes matrix-fall {
      0% { transform: translateY(0); }
      100% { transform: translateY(220vh); }
    }
    .header {
      position: relative;
      z-index: 10;
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      background: linear-gradient(180deg, rgba(0,30,15,0.95) 0%, rgba(0,15,8,0.9) 100%);
      border-bottom: 2px solid var(--hud-green);
      box-shadow: 0 0 20px var(--hud-green-glow);
    }
    .header.visible { display: flex; }
    .back-btn {
      background: transparent;
      border: 2px solid var(--hud-green);
      color: var(--hud-green);
      padding: 0.5rem 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      visibility: hidden;
    }
    .back-btn.visible { visibility: visible; }
    .back-btn:hover { background: var(--hud-green); color: var(--bg-dark); box-shadow: 0 0 15px var(--hud-green-glow); }
    .app-title {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1.3rem, 4vw, 1.8rem);
      font-weight: 900;
      color: var(--hud-green);
      text-shadow: 0 0 10px var(--hud-green-glow);
      letter-spacing: 0.15em;
    }
    .header-icons { display: flex; gap: 0.8rem; }
    .info-btn {
      background: transparent;
      border: 2px solid var(--hud-green);
      color: var(--hud-green);
      width: 38px; height: 38px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .info-btn:hover { background: var(--hud-green); color: var(--bg-dark); box-shadow: 0 0 15px var(--hud-green-glow); transform: scale(1.1); }
    .info-btn.admin-info { border-color: var(--hud-gold); color: var(--hud-gold); }
    .info-btn.admin-info:hover { background: var(--hud-gold); box-shadow: 0 0 15px rgba(255,204,0,0.5); }
    .main-container { position: relative; z-index: 5; min-height: 100vh; padding: 1rem; }
    .screen { display: none; }
    .screen.active { display: block; }
    .title-screen { min-height: 100vh; display: flex; flex-direction: column; }
    @media (min-width: 900px) {
      .title-screen { flex-direction: row; padding: 2rem; }
    }
    .title-left-menu { display: flex; flex-direction: column; gap: 0.4rem; padding: 1rem; }
    @media (min-width: 900px) {
      .title-left-menu { width: 280px; padding-top: 4rem; }
    }
    .title-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem 1rem; }
    .title-right-info { padding: 1rem; }
    @media (min-width: 900px) {
      .title-right-info { width: 300px; padding-top: 4rem; }
    }
    .main-title {
      font-family: 'Times New Roman', 'Georgia', serif;
      font-size: clamp(2.5rem, 10vw, 4.5rem);
      font-weight: bold;
      letter-spacing: 0.25em;
      position: relative;
      display: inline-block;
      color: #b8e6c8;
      background: linear-gradient(
        180deg,
        #3a6a50 0%,
        #5a9a70 10%,
        #8cd4a8 25%,
        #c8f0d8 40%,
        #e8fff0 48%,
        #ffffff 50%,
        #e8fff0 52%,
        #c8f0d8 60%,
        #8cd4a8 75%,
        #5a9a70 90%,
        #3a6a50 100%
      );
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: none;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.8)) drop-shadow(0 0 20px rgba(100, 255, 150, 0.3));
      margin-bottom: 0;
    }
    .title-wrapper {
      text-align: center;
      padding: 1.5rem 1rem 1rem;
    }
    .title-guide-icons { position: fixed; top: 1.2rem; right: 1.5rem; display: flex; gap: 0.6rem; z-index: 20; }
    
    /* PC Layout */
    .title-layout {
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 100px);
    }
    @media (min-width: 900px) {
      .title-layout {
        flex-direction: row;
        padding: 0 2rem;
      }
      .title-layout .left-menu {
        width: 280px;
        flex-shrink: 0;
        padding: 1rem 1rem 1rem 0;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      .title-layout .center-content {
        flex: 1;
        padding: 1rem 2rem;
        display: flex;
        flex-direction: column;
      }
    }
    @media (max-width: 899px) {
      .title-layout .left-menu {
        order: 2;
        max-width: 400px;
        margin: 0 auto;
        padding: 0 1rem;
        width: 100%;
      }
      .title-layout .center-content {
        order: 1;
      }
    }
    .hud-panel {
      background: var(--bg-panel);
      border: 2px solid var(--hud-green);
      position: relative;
      padding: 1.2rem;
      clip-path: polygon(0 0, calc(100% - 12px) 0, 100% 12px, 100% 100%, 12px 100%, 0 calc(100% - 12px));
      box-shadow: 0 0 15px var(--hud-green-glow), inset 0 0 30px rgba(0,255,65,0.05);
    }
    .hud-panel-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      color: var(--hud-green);
      letter-spacing: 0.08em;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--hud-green-dim);
    }
    .menu-btn {
      display: block;
      width: 100%;
      background: linear-gradient(90deg, rgba(0,40,20,0.9) 0%, rgba(0,60,30,0.8) 100%);
      border: 2px solid var(--hud-green);
      border-left: 4px solid var(--hud-green);
      color: var(--hud-green);
      padding: 0.9rem 1rem;
      font-size: 0.95rem;
      font-weight: bold;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .menu-btn:hover:not(:disabled) {
      background: linear-gradient(90deg, var(--hud-green) 0%, rgba(0,255,65,0.7) 100%);
      color: var(--bg-dark);
      box-shadow: 0 0 20px var(--hud-green-glow);
      transform: translateX(5px);
    }
    .menu-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: var(--text-dim); color: var(--text-dim); }
    .menu-btn.cancel-btn { 
      background: linear-gradient(90deg, rgba(40,10,20,0.9) 0%, rgba(60,15,30,0.8) 100%);
      border: 2px solid var(--hud-red); 
      border-left: 4px solid var(--hud-red); 
      color: var(--hud-red);
      margin-top: 1rem;
    }
    .menu-btn.cancel-btn:hover:not(:disabled) { background: linear-gradient(90deg, var(--hud-red) 0%, rgba(255,50,100,0.7) 100%); color: white; box-shadow: 0 0 20px rgba(255,50,100,0.5); }
    .info-display { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.8rem; margin-bottom: 1rem; }
    @media (max-width: 700px) { .info-display { grid-template-columns: repeat(2, 1fr); } }
    .info-item { background: rgba(0,30,15,0.6); border: 1px solid var(--hud-green-dim); padding: 0.6rem; text-align: center; }
    .info-label { font-size: 0.7rem; color: var(--text-dim); margin-bottom: 0.2rem; }
    .info-value { font-family: 'Orbitron', sans-serif; font-size: 0.9rem; color: var(--hud-green); }
    .info-value.warning { color: var(--hud-red); }
    .title-info-panel {
      max-width: 100%;
      margin: 0 0 1.5rem 0;
      background: var(--bg-panel);
      border: 2px solid var(--hud-green);
      padding: 1rem 1.5rem;
    }
    @media (max-width: 899px) {
      .title-info-panel {
        max-width: 800px;
        margin: 0 auto 1.5rem;
      }
    }
    .title-info-panel .hud-panel-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      color: var(--hud-green);
      letter-spacing: 0.08em;
      margin-bottom: 0.8rem;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid var(--hud-green-dim);
      text-align: center;
    }
    .title-info-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
    }
    @media (max-width: 600px) {
      .title-info-grid { grid-template-columns: repeat(2, 1fr); }
    }
    .title-info-item {
      background: rgba(0,40,20,0.5);
      border: 1px solid var(--hud-green-dim);
      padding: 0.8rem;
      text-align: center;
    }
    .title-info-label { font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.3rem; }
    .title-info-value { font-family: 'Orbitron', sans-serif; font-size: 1rem; color: var(--hud-green); }
    .title-info-value.warning { color: var(--hud-red); }
    .sound-controls {
      position: fixed;
      bottom: 1.5rem;
      left: 1.5rem;
      display: flex;
      gap: 0.5rem;
      z-index: 100;
    }
    .sound-btn {
      background: rgba(0, 20, 10, 0.9);
      border: 1px solid var(--hud-green);
      color: var(--hud-green);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .sound-btn:hover { background: var(--hud-green); color: var(--bg-dark); }
    .sound-btn.off { border-color: var(--text-dim); color: var(--text-dim); opacity: 0.5; }
    .sound-btn.off:hover { background: var(--text-dim); color: white; }
    @media (max-width: 600px) {
      .sound-controls { bottom: 1rem; left: 1rem; }
      .sound-btn { width: 40px; height: 40px; font-size: 1rem; }
    }
    /* ÁÆ°ÁêÜËÄÖË®≠ÂÆö2„Ç´„É©„É†„É¨„Ç§„Ç¢„Ç¶„Éà */
    .admin-setup-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      max-width: 900px;
      margin: 1.5rem auto;
      padding: 0 0.8rem;
      align-items: start;
    }
    .admin-setup-col { padding: 1rem; }
    .admin-setup-right { display: flex; flex-direction: column; }
    @media (max-width: 700px) {
      .admin-setup-grid { grid-template-columns: 1fr; max-width: 480px; }
    }
    .form-group { margin-bottom: 1.2rem; }
    .form-label { display: block; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.4rem; }
    .form-input {
      width: 100%;
      padding: 0.7rem 0.9rem;
      background: rgba(0, 20, 10, 0.9);
      border: 2px solid var(--hud-green-dim);
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.2s;
    }
    .form-input:focus { outline: none; border-color: var(--hud-green); box-shadow: 0 0 10px var(--hud-green-glow); }
    .error-message {
      background: rgba(255,50,100,0.2);
      border: 1px solid var(--hud-red);
      color: var(--hud-red);
      padding: 0.4rem;
      margin-top: 0.4rem;
      font-size: 0.8rem;
      display: none;
    }
    .error-message.visible { display: block; }
    .submit-btn {
      width: 100%;
      padding: 0.9rem;
      background: linear-gradient(180deg, rgba(0,60,30,0.9) 0%, rgba(0,40,20,0.95) 100%);
      border: 2px solid var(--hud-green);
      color: var(--hud-green);
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .submit-btn::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--hud-green); box-shadow: 0 0 10px var(--hud-green-glow); }
    .submit-btn:hover:not(:disabled) { background: var(--hud-green); color: var(--bg-dark); box-shadow: 0 0 25px var(--hud-green-glow); }
    .submit-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .participant-panel { background: var(--bg-panel); border: 2px solid var(--hud-green); }
    .lottery-sidebar .participant-panel { height: 100%; display: flex; flex-direction: column; }
    .lottery-sidebar .participant-list { flex: 1; max-height: none; overflow-y: auto; }
    @media (min-width: 900px) {
      .lottery-sidebar .participant-list { max-height: 450px; }
    }
    .participant-header { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1rem; border-bottom: 1px solid var(--hud-green-dim); }
    .participant-title { font-family: 'Orbitron', sans-serif; color: var(--hud-green); font-size: 0.9rem; }
    .participant-search { padding: 0.4rem 0.6rem; background: rgba(0,20,10,0.8); border: 1px solid var(--hud-green-dim); color: var(--text-primary); font-size: 0.85rem; width: 140px; }
    .participant-list { max-height: 350px; overflow-y: auto; }
    .participant-row { display: grid; grid-template-columns: 55px 35px 1fr 70px; align-items: center; padding: 0.5rem 0.8rem; border-bottom: 1px solid rgba(0,255,65,0.1); font-size: 0.85rem; }
    .participant-row:hover { background: rgba(0,255,65,0.05); }
    .participant-row.header { background: rgba(0,40,20,0.5); font-size: 0.75rem; color: var(--text-dim); }
    .participant-id { font-family: 'Orbitron', sans-serif; color: var(--hud-green); font-size: 0.8rem; }
    .participant-icon { width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--hud-green); background: var(--bg-dark); display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 0.8rem; }
    .participant-icon img { width: 100%; height: 100%; object-fit: cover; }
    .status-badge { padding: 0.15rem 0.4rem; font-size: 0.7rem; font-weight: bold; }
    .status-active { background: rgba(0,255,65,0.2); border: 1px solid var(--hud-green); color: var(--hud-green); }
    .status-lost { background: rgba(100,100,100,0.2); border: 1px solid #666; color: #666; }
    .status-seed { background: rgba(255,165,0,0.2); border: 1px solid #ffa500; color: #ffa500; }
    .participant-count { padding: 0.6rem 0.8rem; text-align: right; color: var(--text-dim); font-size: 0.8rem; border-top: 1px solid var(--hud-green-dim); }
    .participant-count span { color: var(--hud-gold); font-weight: bold; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 5, 2, 0.92); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-panel); border: 2px solid var(--hud-green); padding: 1.5rem; max-width: 450px; width: 90%; position: relative; clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 15px, 100% 100%, 15px 100%, 0 calc(100% - 15px)); box-shadow: 0 0 30px var(--hud-green-glow); }
    .modal-content.guide-modal { max-width: 700px; width: 95%; }
    @media (max-width: 750px) {
      .modal-content.guide-modal { max-width: 95%; }
      .guide-content h4, .guide-content p, .guide-content li { white-space: normal; }
    }
    .modal-close-btn { position: absolute; top: 8px; right: 12px; background: transparent; border: none; color: var(--text-dim); font-size: 1.5rem; cursor: pointer; }
    .modal-close-btn:hover { color: var(--hud-green); }
    .modal-title { font-family: 'Orbitron', sans-serif; color: var(--hud-green); font-size: 1.1rem; text-align: center; margin-bottom: 1.2rem; }
    .modal-buttons { display: flex; gap: 0.8rem; margin-top: 1.2rem; }
    .modal-btn { flex: 1; padding: 0.7rem; font-weight: bold; cursor: pointer; transition: all 0.2s; }
    .modal-btn-cancel { background: transparent; border: 1px solid var(--text-dim); color: var(--text-dim); }
    .modal-btn-cancel:hover { border-color: var(--hud-green); color: var(--hud-green); }
    .modal-btn-confirm { background: var(--hud-green); border: none; color: var(--bg-dark); }
    .modal-btn-confirm:hover { box-shadow: 0 0 20px var(--hud-green-glow); }
    .guide-content { color: var(--text-primary); line-height: 1.7; max-height: 55vh; overflow-y: auto; font-size: 0.9rem; }
    .guide-content h4 { color: var(--hud-green); margin: 1rem 0 0.4rem; font-size: 0.95rem; white-space: nowrap; }
    .guide-content p { color: var(--text-dim); margin-bottom: 0.4rem; white-space: nowrap; }
    .guide-content ul { margin-left: 1rem; color: var(--text-dim); }
    .guide-content li { margin-bottom: 0.3rem; white-space: nowrap; }
    .calendar-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 5, 2, 0.95); z-index: 2000; align-items: center; justify-content: center; }
    .calendar-modal.active { display: flex; }
    .calendar-container { background: var(--bg-panel); border: 2px solid var(--hud-green); padding: 1.2rem; max-width: 340px; width: 95%; box-shadow: 0 0 30px var(--hud-green-glow); position: relative; }
    .calendar-close { position: absolute; top: 8px; right: 10px; background: transparent; border: none; color: var(--text-dim); font-size: 1.3rem; cursor: pointer; }
    .calendar-title { font-family: 'Orbitron', sans-serif; color: var(--hud-green); text-align: center; margin-bottom: 0.8rem; font-size: 1rem; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
    .calendar-nav { background: transparent; border: 1px solid var(--hud-green); color: var(--hud-green); width: 32px; height: 32px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
    .calendar-nav:hover { background: var(--hud-green); color: var(--bg-dark); }
    .calendar-month-year { font-family: 'Orbitron', sans-serif; color: var(--hud-green); font-size: 0.95rem; }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 0.3rem; }
    .calendar-weekday { text-align: center; color: var(--text-dim); font-size: 0.75rem; padding: 0.2rem; }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
    .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: rgba(0,30,15,0.5); border: 1px solid transparent; color: var(--text-primary); cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
    .calendar-day:hover:not(.disabled):not(.empty) { border-color: var(--hud-green); background: rgba(0,255,65,0.2); }
    .calendar-day.selected { background: var(--hud-green) !important; color: var(--bg-dark) !important; font-weight: bold; box-shadow: 0 0 10px var(--hud-green-glow); }
    .calendar-day.today:not(.selected) { border-color: var(--hud-gold); }
    .calendar-day.disabled { color: #333; cursor: not-allowed; }
    .calendar-day.empty { background: transparent; cursor: default; }
    .calendar-time { display: flex; justify-content: center; align-items: center; gap: 0.4rem; margin-top: 0.8rem; }
    .calendar-time-input { width: 55px; padding: 0.4rem; background: rgba(0,20,10,0.8); border: 1px solid var(--hud-green-dim); color: var(--text-primary); text-align: center; font-size: 1rem; }
    .calendar-selected-display { text-align: center; color: var(--hud-gold); margin-top: 0.8rem; padding: 0.4rem; background: rgba(255,204,0,0.1); border: 1px solid var(--hud-gold); font-size: 0.9rem; }
    .calendar-confirm { width: 100%; margin-top: 0.8rem; padding: 0.7rem; background: var(--hud-green); border: none; color: var(--bg-dark); font-weight: bold; cursor: pointer; }
    .calendar-confirm:hover { box-shadow: 0 0 20px var(--hud-green-glow); }
    .toast { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%) translateY(100px); padding: 0.8rem 1.5rem; font-weight: bold; z-index: 3000; transition: transform 0.3s; border: 2px solid; font-size: 0.9rem; }
    .toast.visible { transform: translateX(-50%) translateY(0); }
    .toast.success { background: rgba(0,40,20,0.95); border-color: var(--hud-green); color: var(--hud-green); }
    .toast.error { background: rgba(40,10,20,0.95); border-color: var(--hud-red); color: var(--hud-red); }
    .my-entry-box { background: rgba(0,255,65,0.1); border: 2px solid var(--hud-green); padding: 1.2rem; text-align: center; }
    .my-entry-title { color: var(--hud-green); font-size: 1rem; margin-bottom: 0.8rem; }
    .my-entry-info { font-size: 1.1rem; color: var(--text-primary); }
    .my-entry-id { color: var(--hud-gold); font-weight: bold; }
    /* ÊäΩÈÅ∏‰ºöÂ†¥„Å∏„Éú„Çø„É≥ */
    .lottery-venue-btn {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      padding: 1.2rem 2.5rem;
      background: rgba(0, 40, 20, 0.9);
      border: 2px solid var(--hud-green-dim);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .lottery-venue-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .lottery-venue-btn:not(:disabled) {
      border-color: var(--hud-green);
      box-shadow: 0 0 20px var(--hud-green-glow), inset 0 0 20px rgba(0, 255, 65, 0.1);
      animation: lottery-pulse 2s infinite;
    }
    .lottery-venue-btn:not(:disabled):hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px var(--hud-green-glow), inset 0 0 30px rgba(0, 255, 65, 0.2);
    }
    @keyframes lottery-pulse {
      0%, 100% { box-shadow: 0 0 20px var(--hud-green-glow); }
      50% { box-shadow: 0 0 35px var(--hud-green-glow), 0 0 50px rgba(0, 255, 65, 0.3); }
    }
    .lottery-icon { font-size: 2rem; }
    .lottery-text { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; color: var(--hud-green); font-weight: bold; }
    .lottery-sub { font-size: 0.75rem; color: var(--text-dim); }
    .lottery-venue-btn:not(:disabled) .lottery-sub { display: none; }
    
    /* ÊäΩÈÅ∏‰ºöÂ†¥„É¨„Ç§„Ç¢„Ç¶„Éà */
    .lottery-arena {
      display: none;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    .lottery-arena.active { display: block; }
    
    @media (min-width: 900px) {
      .lottery-arena {
        display: none;
        grid-template-columns: 1fr 350px;
        gap: 1.5rem;
      }
      .lottery-arena.active { display: grid; }
    }
    
    /* Â∑¶ÂÅ¥Ôºö„É´„Éº„É¨„ÉÉ„ÉàÔºãVS */
    .lottery-main {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .roulette-container { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      position: relative;
    }
    .roulette-wheel { 
      width: 280px; 
      height: 280px; 
      border: 4px solid var(--hud-green); 
      border-radius: 50%; 
      position: relative; 
      background: radial-gradient(circle, rgba(0,60,30,0.9) 0%, rgba(0,20,10,0.95) 70%, var(--bg-dark) 100%); 
      box-shadow: 0 0 40px var(--hud-green-glow), inset 0 0 60px rgba(0,255,65,0.1);
    }
    @media (min-width: 900px) {
      .roulette-wheel { 
        width: 420px; 
        height: 420px; 
        border-width: 5px;
      }
    }
    .wheel-inner { width: 100%; height: 100%; transition: transform 4s cubic-bezier(0.17,0.67,0.12,0.99); }
    .wheel-segment { 
      position: absolute; 
      width: 100%; 
      height: 100%; 
      display: flex; 
      align-items: flex-start; 
      justify-content: center; 
      padding-top: 15px; 
      font-family: 'Orbitron', sans-serif; 
      font-size: 0.85rem; 
      color: var(--hud-green); 
      text-shadow: 0 0 8px var(--hud-green-glow);
    }
    @media (min-width: 900px) {
      .wheel-segment { font-size: 1rem; padding-top: 20px; }
    }
    
    /* VSË°®Á§∫Ôºà„É´„Éº„É¨„ÉÉ„Éà‰∏≠Â§Æ„Å´Èáç„Å≠„ÇãÔºâ */
    .vs-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      text-align: center;
      pointer-events: none;
    }
    .vs-display { 
      background: rgba(0, 20, 10, 0.95); 
      border: 3px solid var(--hud-green); 
      border-radius: 12px;
      padding: 1rem 1.5rem; 
      text-align: center;
      box-shadow: 0 0 30px rgba(0,0,0,0.8);
    }
    @media (min-width: 900px) {
      .vs-display { padding: 1.5rem 2rem; }
    }
    .vs-title { color: var(--hud-gold); font-size: 0.9rem; margin-bottom: 0.8rem; font-weight: bold; }
    .vs-players { display: flex; align-items: center; justify-content: center; gap: 1rem; }
    @media (min-width: 900px) {
      .vs-players { gap: 1.5rem; }
    }
    .vs-player { text-align: center; transition: all 0.3s; }
    .vs-player.clickable { cursor: pointer; }
    .vs-player.clickable:hover { 
      transform: scale(1.1); 
      filter: drop-shadow(0 0 10px var(--hud-gold));
    }
    .vs-player.winner-selected {
      background: rgba(0, 255, 65, 0.3);
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
    }
    .vs-player-icon { 
      width: 60px; 
      height: 60px; 
      border-radius: 50%; 
      border: 3px solid var(--hud-green); 
      margin: 0 auto 0.5rem; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: var(--bg-dark); 
      overflow: hidden;
      font-size: 1.5rem;
    }
    @media (min-width: 900px) {
      .vs-player-icon { width: 80px; height: 80px; font-size: 2rem; }
    }
    .silhouette-icon { width: 60%; height: 60%; }
    .silhouette-icon circle, .silhouette-icon path { fill: var(--hud-green); opacity: 0.5; }
    .vs-player-id { color: var(--text-dim); font-size: 0.8rem; font-family: 'Orbitron', sans-serif; }
    .vs-player-name { 
      color: var(--hud-green); 
      font-weight: bold; 
      font-size: 1rem; 
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    @media (min-width: 900px) {
      .vs-player-name { font-size: 1.2rem; max-width: 120px; }
    }
    .vs-text { 
      font-family: 'Orbitron', sans-serif; 
      font-size: 2rem; 
      color: var(--hud-gold); 
      text-shadow: 0 0 15px rgba(255,204,0,0.7);
      animation: vs-pulse 1.5s infinite;
    }
    @media (min-width: 900px) {
      .vs-text { font-size: 2.5rem; }
    }
    @keyframes vs-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    /* Êìç‰Ωú„Éú„Çø„É≥ */
    .roulette-controls { 
      display: flex; 
      gap: 0.8rem; 
      flex-wrap: wrap; 
      justify-content: center; 
      margin-top: 1.5rem;
    }
    .roulette-btn { 
      padding: 0.9rem 1.5rem; 
      font-weight: bold; 
      cursor: pointer; 
      transition: all 0.2s; 
      font-size: 1rem;
      border-radius: 6px;
    }
    .roulette-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #spinBtn { background: var(--hud-green); border: none; color: var(--bg-dark); }
    #spinBtn:hover:not(:disabled) { box-shadow: 0 0 20px var(--hud-green-glow); }
    
    /* ÂãùËÄÖÈÅ∏Êäû„Éú„Çø„É≥ */
    .winner-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      padding: 1rem 1.5rem !important;
      min-width: 140px;
    }
    .winner-btn:hover { box-shadow: 0 0 20px var(--hud-green-glow); transform: scale(1.05); }
    .winner-label { font-size: 0.8rem; color: var(--hud-gold); }
    .winner-name { font-size: 1.1rem; font-weight: bold; color: var(--hud-green); }
    
    /* „Éû„ÉÉ„ÉÅ„É≥„Ç∞‰∏≠„ÅÆ„Éè„Ç§„É©„Ç§„Éà */
    .participant-row.matching {
      background: rgba(0, 255, 65, 0.15) !important;
      border-left: 3px solid var(--hud-green);
      animation: matching-pulse 1.5s infinite;
    }
    @keyframes matching-pulse {
      0%, 100% { background: rgba(0, 255, 65, 0.1); }
      50% { background: rgba(0, 255, 65, 0.2); }
    }
    
    /* ÁèæÂú®„ÅÆ„Éû„ÉÉ„ÉÅË°®Á§∫ */
    .current-match-display {
      background: rgba(0, 40, 20, 0.9);
      border: 2px solid var(--hud-gold);
      padding: 1rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    .current-match-title { color: var(--hud-gold); font-size: 0.85rem; margin-bottom: 0.5rem; }
    .current-match-vs { 
      font-family: 'Orbitron', sans-serif; 
      color: var(--hud-green); 
      font-size: 1rem;
    }
    .current-match-vs span { color: var(--hud-gold); margin: 0 0.5rem; }
    
    /* „Éà„Éº„Éä„É°„É≥„ÉàË°® - „ÉÑ„É™„ÉºÂûã„Éñ„É©„Ç±„ÉÉ„Éà */
    .bracket-container {
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 1rem 0.5rem;
      overflow-x: auto;
      overflow-y: auto;
      width: 100%;
      min-height: 60vh;
      -webkit-overflow-scrolling: touch;
    }
    @media (min-width: 900px) {
      .bracket-container { padding: 1.5rem 1rem; }
    }
    .bracket-container.active { display: flex; }

    .bracket-title {
      font-family: 'Orbitron', sans-serif;
      color: var(--hud-gold);
      font-size: 1.1rem;
      margin-bottom: 1rem;
      text-align: center;
      text-shadow: 0 0 10px rgba(255,204,0,0.5);
    }
    @media (min-width: 900px) {
      .bracket-title { font-size: 1.3rem; margin-bottom: 1.5rem; }
    }
    
    /* „Çπ„ÇØ„É≠„Éº„É´„Éí„É≥„ÉàÔºà„Çπ„Éû„ÉõÁî®Ôºâ */
    .bracket-scroll-hint {
      display: none;
      text-align: center;
      color: var(--text-dim);
      font-size: 0.7rem;
      margin-bottom: 0.5rem;
      animation: hint-fade 2s infinite;
    }
    @keyframes hint-fade {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }
    /* „Ç∞„É´„Éº„Éó„Çø„Éñ */
    .group-tabs-container {
      padding: 0.5rem;
      border-bottom: 1px solid rgba(0,255,65,0.15);
      margin-bottom: 0.5rem;
    }
    .group-tabs {
      display: flex;
      gap: 0.4rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .group-tab {
      padding: 0.4rem 0.8rem;
      border: 1px solid var(--hud-green-dim);
      background: rgba(0, 20, 10, 0.6);
      color: var(--hud-green-dim);
      cursor: pointer;
      font-family: 'Orbitron', monospace;
      font-size: 0.7rem;
      transition: all 0.3s;
      border-radius: 2px;
    }
    .group-tab:hover {
      border-color: var(--hud-green);
      color: var(--hud-green);
    }
    .group-tab.active {
      border-color: var(--hud-green);
      color: var(--hud-green);
      background: rgba(0, 255, 65, 0.1);
      box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
    }
    .group-tab.completed {
      border-color: var(--hud-gold);
      color: var(--hud-gold);
    }
    .group-tab.finals-tab {
      border-color: var(--hud-gold);
      color: var(--hud-gold);
      font-weight: 700;
    }
    .group-tab.finals-tab.active {
      background: rgba(255, 204, 0, 0.1);
      box-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
    }
    .group-info-text {
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-top: 0.4rem;
    }
    .bulk-match-btn {
      display: inline-block;
      padding: 0.5rem 1.5rem;
      border: 1px solid var(--hud-green);
      background: rgba(0, 40, 20, 0.8);
      color: var(--hud-green);
      font-family: 'Orbitron', monospace;
      font-size: 0.8rem;
      cursor: pointer;
      margin-top: 0.5rem;
      transition: all 0.3s;
    }
    .bulk-match-btn:hover {
      background: rgba(0, 255, 65, 0.15);
      box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
    }

    /* „Éà„Éº„Éä„É°„É≥„Éà„Éñ„É©„Ç±„ÉÉ„Éà - ‰ºùÁµ±ÁöÑ„Å™ÂΩ¢Âºè */
    .bracket-tree {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5rem;
      min-width: fit-content;
      position: relative;
    }
    @media (min-width: 900px) {
      .bracket-tree { padding: 1rem; }
    }
    
    /* SVGÁ∑ö„ÅÆ„Ç≥„É≥„ÉÜ„Éä */
    .bracket-lines {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    .bracket-line {
      stroke: var(--hud-green-dim);
      stroke-width: 2;
      fill: none;
      opacity: 0.3;
    }

    .bracket-line.winner {
      stroke: var(--hud-green);
      stroke-width: 3;
      opacity: 1;
      filter: drop-shadow(0 0 6px var(--hud-green-glow));
      animation: line-glow 2s infinite;
    }

    @keyframes line-glow {
      0%, 100% { filter: drop-shadow(0 0 6px var(--hud-green-glow)); }
      50% { filter: drop-shadow(0 0 12px rgba(0, 255, 65, 1)); }
    }
    
    /* ÂÑ™ÂãùÊû†ÔºàÊúÄ‰∏äÈÉ®Ôºâ */
    .bracket-champion-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.8rem 1.5rem;
      border: 3px solid var(--hud-gold);
      background: rgba(255, 204, 0, 0.15);
      animation: champion-glow 2s infinite;
      margin-bottom: 0;
      z-index: 10;
      position: relative;
    }
    @keyframes champion-glow {
      0%, 100% { box-shadow: 0 0 15px rgba(255,204,0,0.3); }
      50% { box-shadow: 0 0 30px rgba(255,204,0,0.6); }
    }
    .bracket-champion-box.empty {
      border-style: dashed;
      animation: none;
      opacity: 0.6;
    }
    .champion-trophy { font-size: 1.5rem; }
    .champion-label { font-size: 0.7rem; color: var(--hud-gold); }
    .champion-name {
      font-family: 'Orbitron', sans-serif;
      font-size: 1rem;
      color: var(--hud-gold);
    }
    .bracket-champion-box.empty .champion-name { color: var(--text-dim); }
    
    /* „É©„Ç¶„É≥„Éâ„ÅÆ„Ç≥„É≥„ÉÜ„Éä */
    .bracket-rounds {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
      width: 100%;
      position: relative;
      z-index: 5;
    }
    
    /* „É©„Ç¶„É≥„ÉâË°å */
    .bracket-round-row {
      display: flex;
      justify-content: center;
      gap: 15px;
      position: relative;
    }
    
    /* „Éó„É¨„Ç§„É§„Éº„Éú„ÉÉ„ÇØ„ÇπÔºà‰∏ãÈÉ®„Å´Ê®™‰∏¶„Å≥Ôºâ */
    .bracket-player-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 50px;
      min-height: 80px;
      padding: 8px 4px;
      background: rgba(0, 30, 15, 0.9);
      border: 2px solid var(--hud-green-dim);
      cursor: default;
      transition: all 0.3s;
      position: relative;
      z-index: 10;
    }
    @media (min-width: 900px) {
      .bracket-player-box { width: 60px; min-height: 100px; }
    }
    
    .bracket-player-box.clickable { cursor: pointer; }
    .bracket-player-box.clickable:hover {
      background: rgba(0, 255, 65, 0.2);
      transform: scale(1.05);
    }
    .bracket-player-box.winner {
      background: rgba(0, 255, 65, 0.15);
      border-color: var(--hud-green);
      box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
    }
    .bracket-player-box.loser {
      opacity: 0.4;
      border-color: #333;
    }
    .bracket-player-box.seed {
      border-left: 3px solid #ffa500;
    }
    .bracket-player-box.active {
      animation: pulse-active 1.5s infinite;
    }
    @keyframes pulse-active {
      0%, 100% { box-shadow: 0 0 5px rgba(255, 204, 0, 0.3); }
      50% { box-shadow: 0 0 15px rgba(255, 204, 0, 0.6); }
    }
    
    .bracket-player-box.empty {
      border-style: dashed;
      opacity: 0.5;
    }
    .bracket-vs-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 204, 0, 0.15);
      border: 2px solid var(--hud-gold);
      border-radius: 50%;
      color: var(--hud-gold);
      font-weight: bold;
      transition: all 0.2s;
      animation: pulse-active 1.5s infinite;
    }
    .bracket-vs-btn:hover {
      background: rgba(255, 204, 0, 0.4);
      transform: scale(1.15);
    }
    .bracket-player-box.empty .player-name-v {
      color: var(--text-dim);
    }
    
    /* ÂêçÂâçÁ∏¶Êõ∏„Åç */
    .player-name-v {
      writing-mode: vertical-rl;
      text-orientation: upright;
      font-size: 0.7rem;
      color: var(--hud-green);
      letter-spacing: 2px;
      max-height: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    @media (min-width: 900px) {
      .player-name-v { font-size: 0.8rem; max-height: 80px; }
    }
    .bracket-player-box.loser .player-name-v {
      color: #555;
      text-decoration: line-through;
    }
    .bracket-player-box.winner .player-name-v {
      color: var(--hud-gold);
    }

    /* ‰∏ä‰Ωç„É©„Ç¶„É≥„Éâ„ÅÆÂØæÊà¶„Éú„ÉÉ„ÇØ„Çπ */
    .bracket-upper-match {
      display: flex;
      gap: 4px;
      align-items: stretch;
      z-index: 15;
      pointer-events: auto;
    }
    .bracket-upper-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 30, 15, 0.95);
      border: 2px solid var(--hud-green-dim);
      padding: 2px 3px;
      transition: all 0.3s;
      cursor: default;
      position: relative;
    }
    .bracket-upper-box .upper-name {
      writing-mode: vertical-rl;
      text-orientation: upright;
      font-size: 0.6rem;
      color: var(--hud-green);
      letter-spacing: 1px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bracket-upper-box.clickable { cursor: pointer; }
    .bracket-upper-box.clickable:hover {
      background: rgba(0, 255, 65, 0.25);
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
    }
    .bracket-upper-box.winner {
      background: rgba(0, 255, 65, 0.15);
      border-color: var(--hud-green);
      box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
    }
    .bracket-upper-box.winner .upper-name {
      color: var(--hud-gold);
    }
    .bracket-upper-box.loser {
      opacity: 0.4;
      border-color: #333;
    }
    .bracket-upper-box.loser .upper-name {
      color: #555;
      text-decoration: line-through;
    }
    .bracket-upper-box.active {
      animation: pulse-active 1.5s infinite;
    }
    .bracket-upper-box.empty .upper-name {
      color: var(--text-dim);
    }

    .player-id-v {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.5rem;
      color: var(--text-dim);
      margin-top: 5px;
    }
    
    .winner-mark, .seed-mark {
      font-size: 0.6rem;
      margin-bottom: 3px;
    }
    
    /* „É©„Ç¶„É≥„Éâ„É©„Éô„É´ */
    .bracket-round-label {
      position: absolute;
      left: -80px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.7rem;
      color: var(--text-dim);
      white-space: nowrap;
    }
    
    /* „Éà„Éº„Éä„É°„É≥„ÉàË°®„Å∏„Éú„Çø„É≥ */
    .bracket-view-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.6rem 1rem;
      background: rgba(0, 40, 20, 0.9);
      border: 2px solid var(--hud-gold);
      color: var(--hud-gold);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.8rem;
      margin: 0.3rem;
    }
    @media (min-width: 900px) {
      .bracket-view-btn { padding: 0.8rem 1.5rem; font-size: 0.9rem; gap: 0.5rem; margin: 0.5rem; }
    }
    .bracket-view-btn:hover { box-shadow: 0 0 15px rgba(255,204,0,0.4); }
    .bracket-view-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ÂØæÊà¶„Ç´„Éº„ÉâÊäΩÈÅ∏„Éú„Çø„É≥ - ÊúâÂäπÂåñÊôÇ */
    .matchmaking-active {
      background: linear-gradient(180deg, rgba(0,60,30,0.9) 0%, rgba(0,40,20,0.95) 100%) !important;
      border: 2px solid var(--hud-green) !important;
      color: var(--hud-green) !important;
      font-weight: bold;
      animation: matchmaking-glow 1.5s ease-in-out infinite;
      box-shadow: 0 0 15px var(--hud-green-glow), inset 0 0 15px rgba(0, 255, 65, 0.1);
    }
    .matchmaking-active:hover {
      background: var(--hud-green) !important;
      color: var(--bg-dark) !important;
      box-shadow: 0 0 30px var(--hud-green-glow);
    }
    @keyframes matchmaking-glow {
      0%, 100% { box-shadow: 0 0 15px var(--hud-green-glow), inset 0 0 15px rgba(0, 255, 65, 0.1); }
      50% { box-shadow: 0 0 30px var(--hud-green-glow), 0 0 50px rgba(0, 255, 65, 0.2), inset 0 0 20px rgba(0, 255, 65, 0.15); }
    }
    
    /* Âè≥ÂÅ¥ÔºöÂèÇÂä†ËÄÖ„É™„Çπ„Éà */
    .lottery-sidebar {
      margin-top: 1.5rem;
    }
    @media (min-width: 900px) {
      .lottery-sidebar { margin-top: 0; }
    }
    
    .history-card { background: var(--bg-panel); border: 1px solid var(--hud-green-dim); padding: 1rem; margin-bottom: 0.8rem; }
    .history-date { color: var(--text-dim); font-size: 0.8rem; }
    .history-game { color: var(--hud-green); font-size: 1.1rem; font-weight: bold; margin: 0.4rem 0; }
    .history-winner { color: var(--hud-gold); }
    .participant-status {
      text-align: center;
      padding: 2rem 1rem;
      margin-top: 1.5rem;
    }
    @media (min-width: 900px) {
      .participant-status {
        text-align: left;
        padding: 1rem 0;
      }
    }
    .participant-status-main {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.2rem;
      color: var(--hud-green);
      margin-bottom: 0.3rem;
    }
    @media (min-width: 900px) {
      .participant-status-main { font-size: 1.1rem; }
    }
    .participant-status-main span {
      color: var(--hud-gold);
      font-weight: bold;
    }
    .participant-status-sub {
      font-size: 0.7rem;
      color: var(--text-dim);
      line-height: 1.5;
    }
    
    /* HUD - „É™„Ç¢„É´„Çø„Ç§„É†ÊÉÖÂ†±„Ç®„É™„Ç¢ */
    .hud-info-panel {
      position: fixed;
      bottom: 1.5rem;
      left: 320px;
      right: 2rem;
      background: rgba(0, 15, 8, 0.85);
      border: 1px solid var(--hud-green-dim);
      border-radius: 8px;
      padding: 1.2rem 1.5rem;
      z-index: 50;
      display: none;
    }
    /* „Çø„Ç§„Éà„É´ÁîªÈù¢„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™ÊôÇ„ÅÆ„ÅøPCË°®Á§∫ */
    @media (min-width: 900px) {
      #titleScreen.active ~ .hud-info-panel,
      .hud-info-panel.title-active { display: block; }
    }
    .hud-info-panel::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      border-radius: 8px;
      box-shadow: inset 0 0 20px rgba(0, 255, 65, 0.05);
      pointer-events: none;
    }
    .hud-content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    /* Áä∂ÊÖã„Éê„ÉºÔºà‰∏äÈÉ®Ê®™Èï∑Ôºâ */
    .hud-status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0, 30, 15, 0.6);
      border: 1px solid var(--hud-green);
      border-radius: 4px;
      padding: 0.8rem 1.5rem;
    }
    .hud-status-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }
    .hud-status-title {
      font-size: 0.8rem;
      color: var(--text-dim);
      letter-spacing: 0.05em;
    }
    .hud-status-list {
      display: flex;
      gap: 0.6rem;
    }
    .hud-status-item {
      font-size: 0.85rem;
      padding: 0.4rem 1rem;
      border: 1px solid var(--text-dim);
      color: var(--text-dim);
      border-radius: 3px;
      transition: all 0.3s;
    }
    .hud-status-item.active {
      border-color: var(--hud-green);
      color: var(--hud-green);
      box-shadow: 0 0 8px var(--hud-green-glow);
      text-shadow: 0 0 5px var(--hud-green-glow);
    }
    .hud-next-event {
      font-size: 0.9rem;
      color: var(--hud-gold);
    }
    .hud-system-notice {
      font-size: 0.8rem;
      color: var(--hud-red);
      margin-left: 1rem;
    }
    /* „É≠„Ç∞„Ç®„É™„Ç¢Ôºà‰∏ãÈÉ®Ôºâ */
    .hud-log-area {
      flex: 1;
      min-width: 0;
    }
    .hud-log-title {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-bottom: 0.6rem;
      letter-spacing: 0.05em;
    }
    .hud-log-list {
      height: 250px;
      overflow: hidden;
      font-size: 0.9rem;
      line-height: 1.6;
    }
    .hud-log-item {
      color: var(--text-primary);
      padding: 0.2rem 0;
      opacity: 1;
      transition: opacity 0.3s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .hud-log-item.fade-in {
      animation: logFadeIn 0.3s ease;
    }
    .hud-log-item.fade-out {
      opacity: 0;
    }
    .hud-log-item .log-time {
      color: var(--text-dim);
      margin-right: 0.6rem;
      font-size: 0.8rem;
    }
    @keyframes logFadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* „Çπ„Éû„ÉõÁî®HUD */
    .hud-mobile {
      display: none;
      background: rgba(0, 15, 8, 0.9);
      border: 1px solid var(--hud-green-dim);
      border-radius: 6px;
      padding: 0.8rem 1rem;
      margin-top: 1rem;
    }
    @media (max-width: 899px) {
      .hud-mobile { display: block; }
    }
    .hud-mobile .hud-status-bar {
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.5rem 0.8rem;
      margin-bottom: 0.8rem;
    }
    .hud-mobile .hud-status-left {
      flex-direction: column;
      gap: 0.5rem;
    }
    .hud-mobile .hud-status-list {
      justify-content: center;
      flex-wrap: wrap;
    }
    .hud-mobile .hud-next-event {
      text-align: center;
      font-size: 0.75rem;
    }
    .hud-mobile .hud-log-list {
      height: 60px;
      font-size: 0.7rem;
    }
    .hud-mobile .hud-log-title {
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="matrix-bg" id="matrixBg"></div>
  <header class="header" id="mainHeader">
    <button class="back-btn" id="backBtn" onclick="goBack()">‚óÄ Êàª„Çã</button>
    <h1 class="app-title">„Éà„Éº„Éä„É°„É≥„Éà</h1>
    <div class="header-icons">
      <button class="info-btn" onclick="showGuide('user')">?</button>
      <button class="info-btn admin-info" onclick="showGuide('admin')">üëë</button>
    </div>
  </header>
  <div class="main-container">
    <div class="screen active" id="titleScreen">
      <div class="title-guide-icons">
        <button class="info-btn" onclick="showGuide('user')">?</button>
        <button class="info-btn admin-info" onclick="showGuide('admin')">üëë</button>
      </div>
      
      <!-- „Çø„Ç§„Éà„É´Ôºà‰∏äÈÉ®Ôºâ -->
      <div class="title-wrapper">
        <h1 class="main-title">„Éà„Éº„Éä„É°„É≥„Éà</h1>
      </div>
      
      <!-- PC: Â∑¶„É°„Éã„É•„Éº + ‰∏≠Â§Æ„Ç≥„É≥„ÉÜ„É≥„ÉÑ / „Çπ„Éû„Éõ: Á∏¶Á©ç„Åø -->
      <div class="title-layout">
        <!-- Â∑¶„É°„Éã„É•„ÉºÔºàPCÊôÇÔºâ/ ‰∏ãÈÉ®„É°„Éã„É•„ÉºÔºà„Çπ„Éû„ÉõÊôÇÔºâ -->
        <div class="left-menu">
          <button class="menu-btn" id="entryBtn" onclick="navigateTo('entryScreen')" disabled>„Ç®„É≥„Éà„É™„ÉºÁôªÈå≤„Åô„Çã</button>
          <button class="menu-btn" id="viewTournamentBtn" onclick="navigateTo('tournamentScreen')">„Éà„Éº„Éä„É°„É≥„Éà„ÇíË¶ã„Çã</button>
          <button class="menu-btn" onclick="navigateTo('historyScreen')">ÈÅéÂéª„ÅÆÂ§ß‰ºöË®òÈå≤„ÇíË¶ã„Çã</button>
          <button class="menu-btn" id="adminRegisterBtn" onclick="goToAdminScreen()">ÁÆ°ÁêÜËÄÖÁôªÈå≤„Çí„Åô„Çã</button>
          <button class="menu-btn cancel-btn" id="cancelEntryBtn" onclick="cancelEntry()" disabled>ÁôªÈå≤Ëß£Èô§</button>
          
          <!-- ÂèÇÂä†ËÄÖÊï∞Ë°®Á§∫Ôºà„É°„Éã„É•„Éº‰∏ãÔºâ -->
          <div class="participant-status" style="margin-top:1.5rem;padding:1rem 0;">
            <div class="participant-status-main">ÂèÇÂä†ËÄÖÊï∞Ôºö<span id="titleParticipantCount">0</span>/100</div>
            <div class="participant-status-sub">‚ÄªÊúÄÂ§ß100‰∫∫„Éª‰∏äÈôê„ÅßÁ∑†Âàá</div>
          </div>
        </div>
        
        <!-- ‰∏≠Â§Æ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div class="center-content">
          <!-- Â§ß‰ºöÊÉÖÂ†±ÔºàÊ®™Èï∑Ôºâ -->
          <div class="title-info-panel">
            <div class="hud-panel-title">‚óÜ Â§ß‰ºöÊÉÖÂ†±</div>
            <div class="title-info-grid">
              <div class="title-info-item"><div class="title-info-label">„Ç≤„Éº„É†Âêç</div><div class="title-info-value" id="titleGameName">Êú™Ë®≠ÂÆö</div></div>
              <div class="title-info-item"><div class="title-info-label">Á∑†ÂàáÊó•ÊôÇ</div><div class="title-info-value" id="titleDeadline">Êú™Ë®≠ÂÆö</div></div>
              <div class="title-info-item"><div class="title-info-label">ÁÆ°ÁêÜËÄÖ</div><div class="title-info-value" id="titleAdmin">-</div></div>
              <div class="title-info-item"><div class="title-info-label">ÂèÇÂä†ËÄÖ</div><div class="title-info-value" id="titleCount">0Âêç</div></div>
            </div>
          </div>
          
          <!-- „Çπ„Éû„ÉõÁî®HUDÔºà„É¢„Éê„Ç§„É´ÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ -->
          <div class="hud-mobile" id="hudMobile">
            <div class="hud-status-bar">
              <div class="hud-status-left">
                <span class="hud-status-title">‚ñ∂ „Çπ„ÉÜ„Éº„Çø„Çπ</span>
                <div class="hud-status-list">
                  <span class="hud-status-item active" id="statusReceptionMobile">Âèó‰ªò‰∏≠</span>
                  <span class="hud-status-item" id="statusClosedMobile">Âèó‰ªòÁµÇ‰∫Ü</span>
                  <span class="hud-status-item" id="statusProgressMobile">ÈÄ≤Ë°å‰∏≠</span>
                  <span class="hud-status-item" id="statusEndMobile">ÁµÇ‰∫Ü</span>
                </div>
              </div>
              <div class="hud-next-event" id="hudNextEventMobile"></div>
            </div>
            <div class="hud-log-title">‚ñ∂ „É™„Ç¢„É´„Çø„Ç§„É†„É≠„Ç∞</div>
            <div class="hud-log-list" id="hudLogListMobile"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="screen" id="adminScreen">
      <div class="hud-panel" style="max-width:480px;margin:2rem auto;">
        <div class="hud-panel-title">‚óÜ ÁÆ°ÁêÜËÄÖÁôªÈå≤</div>
        <p style="margin-bottom:1.2rem;color:var(--text-dim);font-size:0.9rem;">ÁÆ°ÁêÜËÄÖ„Å®„Åó„Å¶ÁôªÈå≤„Åô„Çã„Å®„ÄÅÂ§ß‰ºö„ÅÆË®≠ÂÆö„ÉªÈÅãÂñ∂„ÅåÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô„ÄÇ</p>
        <div class="form-group">
          <label class="form-label">ÁÆ°ÁêÜËÄÖÂêç</label>
          <input type="text" class="form-input" id="adminNameInput" placeholder="ÁÆ°ÁêÜËÄÖÂêç„ÇíÂÖ•Âäõ" maxlength="20">
          <div class="error-message" id="adminNameError"></div>
        </div>
        <button class="submit-btn" onclick="registerAdmin()">ÁÆ°ÁêÜËÄÖ„Å®„Åó„Å¶ÁôªÈå≤</button>
      </div>
    </div>
    <div class="screen" id="adminSetupScreen">
      <div class="admin-setup-grid">
        <!-- Â∑¶„Ç´„É©„É†ÔºöÂ§ß‰ºöË®≠ÂÆö -->
        <div class="hud-panel admin-setup-col">
          <div class="hud-panel-title">‚óÜ Â§ß‰ºöË®≠ÂÆö</div>
          <p style="margin-bottom:0.8rem;color:var(--text-dim);font-size:0.85rem;">Á∑†ÂàáÊó•ÊôÇ„ÇíË®≠ÂÆö„Åô„Çã„Å®„ÄÅÂèÇÂä†ËÄÖ„Åå„Ç®„É≥„Éà„É™„Éº„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô„ÄÇ</p>
          <div class="form-group">
            <label class="form-label">„Ç≤„Éº„É†ÂêçÔºàÂ§ß‰ºöÂêçÔºâ<span style="color:var(--hud-red);"> *ÂøÖÈ†à</span></label>
            <input type="text" class="form-input" id="setupGameName" placeholder="‰æã: „Çπ„Éû„Éñ„É©SPÂ§ß‰ºö">
            <div class="error-message" id="setupGameNameError"></div>
          </div>
          <div class="form-group">
            <label class="form-label">„Ç®„É≥„Éà„É™„ÉºÁ∑†ÂàáÊó•ÊôÇ <span style="color:var(--hud-red);">*ÂøÖÈ†à</span></label>
            <button type="button" class="form-input" id="setupDeadlineBtn" onclick="openCalendar('setup')" style="text-align:left;cursor:pointer;">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Êó•ÊôÇ„ÇíÈÅ∏Êäû</button>
            <input type="hidden" id="setupDeadline">
            <div class="error-message" id="setupDeadlineError"></div>
          </div>
          <div class="form-group">
            <label class="form-label">ÂØæÊà¶Áõ∏Êâã„ÇíÊ±∫„ÇÅ„Çã</label>
            <button type="button" class="form-input" id="matchmakingBtn" onclick="showMatchmakingInfo()" style="text-align:center;cursor:pointer;opacity:0.5;">üé≤ ÂØæÊà¶„Ç´„Éº„ÉâÊäΩÈÅ∏ÔºàÁ∑†ÂàáÂæå„Å´ÊúâÂäπÂåñÔºâ</button>
            <p style="font-size:0.75rem;color:var(--text-dim);margin-top:0.4rem;">‚ÄªÁ∑†ÂàáÊó•ÊôÇ‰ª•Èôç„Å´ÊúâÂäπÂåñ„Åï„Çå„Åæ„Åô</p>
          </div>
          <button class="submit-btn" onclick="saveTournamentSettings()">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
          <div style="margin-top:1.2rem;padding-top:1rem;border-top:1px solid var(--hud-green-dim);margin-bottom:0.5rem;">
            <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:0.6rem;">‚ö†Ô∏è ÁÆ°ÁêÜËÄÖÂ∞ÇÁî®</p>
            <button id="resetTournamentBtn" onclick="confirmResetTournament()" style="width:100%;padding:0.9rem;background:rgba(40,10,20,0.8);border:2px solid var(--hud-red);color:var(--hud-red);font-size:1rem;font-weight:bold;cursor:pointer;transition:all 0.2s;">ÁÆ°ÁêÜËÄÖÁôªÈå≤Ëß£Èô§„ÉªÂ§ß‰ºö„É™„Çª„ÉÉ„Éà</button>
            <p style="font-size:0.7rem;color:var(--text-dim);margin-top:0.4rem;">‚ÄªÁ∑†ÂàáÊó•ÊôÇ‰ª•Èôç„ÅØÂ§ß‰ºöÁµÇ‰∫Ü„Åæ„Åß‰ΩøÁî®‰∏çÂèØ</p>
          </div>
        </div>

        <!-- Âè≥„Ç´„É©„É†Ôºö„Ç≤„Éº„É†ÁôªÈå≤ -->
        <div class="admin-setup-right">
          <div class="hud-panel admin-setup-col">
            <div class="hud-panel-title" style="font-size:0.95rem;">‚óá „Ç≤„Éº„É†ÁôªÈå≤</div>
            <p style="font-size:0.75rem;color:var(--hud-green);margin-bottom:0.3rem;">‚ÄªÂ§ß‰ºö„ÇíÈñã„Åã„Å™„Åè„Å¶„ÇÇ„ÄÅ„ÅÑ„Å§„Åß„ÇÇ„Ç≤„Éº„É†„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô</p>
            <p style="font-size:0.7rem;color:var(--text-dim);margin-bottom:0.6rem;">ÁôªÈå≤„Åó„Åü„Ç≤„Éº„É†„ÅØÊäΩÈÅ∏‰ºöÂ†¥„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</p>
            <div class="form-group">
              <label class="form-label">„Ç≤„Éº„É†Âêç</label>
              <input type="text" class="form-input" id="gameRegName" placeholder="‰æã: „Çπ„Éû„Éñ„É©SP" maxlength="30">
            </div>
            <div class="form-group">
              <label class="form-label">URL</label>
              <input type="url" class="form-input" id="gameRegUrl" placeholder="https://example.com/game">
            </div>
            <div class="form-group">
              <label class="form-label">Ë™çË®ºID <span style="color:var(--hud-red);font-size:0.75rem;">‚ÄªID„ÇíÁü•„Å£„Å¶„ÅÑ„Çã‰∫∫„ÅÆ„ÅøÁôªÈå≤ÂèØ</span></label>
              <input type="password" class="form-input" id="gameRegAuthId" placeholder="Ë™çË®ºID„ÇíÂÖ•Âäõ" maxlength="30">
            </div>
            <div class="error-message" id="gameRegError" style="margin-bottom:0.5rem;"></div>
            <button class="submit-btn" onclick="registerGame()" style="margin-bottom:0.8rem;">„Ç≤„Éº„É†„ÇíËøΩÂä†</button>
            <div id="gameListAdmin"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="screen" id="entryScreen">
      <div class="hud-panel" style="max-width:480px;margin:2rem auto;">
        <div class="hud-panel-title">‚óÜ „Ç®„É≥„Éà„É™„ÉºÁôªÈå≤</div>
        <div id="myEntryDisplay" style="display:none;">
          <div class="my-entry-box">
            <div class="my-entry-title">‚úì „Ç®„É≥„Éà„É™„ÉºÊ∏à„Åø</div>
            <div class="my-entry-info"><span id="myEntryName"></span><span class="my-entry-id" id="myEntryId"></span></div>
            <p style="font-size:0.75rem;color:var(--text-dim);margin-top:0.8rem;">‚ÄªËß£Èô§„ÅØ„Çø„Ç§„Éà„É´ÁîªÈù¢„ÅÆ„ÄåÁôªÈå≤Ëß£Èô§„Äç„Åã„Çâ</p>
          </div>
        </div>
        <div id="entryForm">
          <div class="form-group">
            <label class="form-label">„É¶„Éº„Ç∂„Éº„Éç„Éº„É†</label>
            <input type="text" class="form-input" id="usernameInput" placeholder="„É¶„Éº„Ç∂„Éº„Éç„Éº„É†„ÇíÂÖ•Âäõ" maxlength="20">
            <div class="error-message" id="usernameError"></div>
          </div>
          <div class="form-group">
            <label class="form-label">„Ç¢„Ç§„Ç≥„É≥Ôºà‰ªªÊÑèÔºâ</label>
            <input type="file" accept="image/*" onchange="previewIcon(this)" style="display:none" id="iconInput">
            <div style="display:flex;align-items:center;gap:0.8rem;">
              <div style="position:relative;">
                <div id="iconPreview" style="width:55px;height:55px;border-radius:50%;border:2px solid var(--hud-green-dim);background:var(--bg-dark);display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;" onclick="document.getElementById('iconInput').click()"><span style="color:var(--text-dim);font-size:1.3rem;">+</span></div>
                <button type="button" id="iconDeleteBtn" onclick="clearIcon()" style="display:none;position:absolute;top:-5px;right:-5px;width:20px;height:20px;border-radius:50%;background:var(--hud-red);border:none;color:white;font-size:0.8rem;cursor:pointer;line-height:1;">√ó</button>
              </div>
              <span style="color:var(--text-dim);font-size:0.8rem;">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁîªÂÉè„ÇíÈÅ∏Êäû</span>
            </div>
          </div>
          <button class="submit-btn" onclick="submitEntry()">„Ç®„É≥„Éà„É™„ÉºÁôªÈå≤</button>
        </div>
      </div>
    </div>
    <div class="screen" id="tournamentScreen">
      <div class="info-display" style="max-width:1200px;margin:1rem auto;">
        <div class="info-item"><div class="info-label">„Ç≤„Éº„É†Âêç</div><div class="info-value" id="tournamentGameName">Êú™Ë®≠ÂÆö</div></div>
        <div class="info-item"><div class="info-label">ÁÆ°ÁêÜËÄÖ</div><div class="info-value" id="tournamentAdmin">-</div></div>
        <div class="info-item"><div class="info-label">Á∑†ÂàáÊó•ÊôÇ</div><div class="info-value" id="tournamentDeadline">Êú™Ë®≠ÂÆö</div></div>
        <div class="info-item"><div class="info-label">ÂèÇÂä†ËÄÖ</div><div class="info-value" id="tournamentCount">0Âêç</div></div>
      </div>
      
      <!-- ÊäΩÈÅ∏‰ºöÂ†¥„Å∏„Éú„Çø„É≥ -->
      <div id="lotteryEntrance" style="max-width:700px;margin:1rem auto;text-align:center;">
        <button class="lottery-venue-btn" id="lotteryVenueBtn" onclick="enterLotteryVenue()" disabled>
          <span class="lottery-icon">‚öîÔ∏è</span>
          <span class="lottery-text">ÊäΩÈÅ∏‰ºöÂ†¥„Å∏</span>
          <span class="lottery-sub" id="lotteryBtnSub">ÔºàÁ∑†ÂàáÂæå„Å´Ëß£ÊîæÔºâ</span>
        </button>
      </div>

      <!-- „Ç≤„Éº„É†„É™„É≥„ÇØÔºàlotteryArena„ÅÆÂ§ñ„Å´ÈÖçÁΩÆÔºâ -->
      <div id="gameDropdownArea" style="max-width:700px;margin:0 auto 0.8rem;display:none;">
        <div style="display:flex;align-items:center;gap:0.6rem;justify-content:center;">
          <label style="color:var(--hud-green);font-size:0.85rem;white-space:nowrap;">üéÆ „Ç≤„Éº„É†ÈÅ∏Êäû:</label>
          <select id="gameDropdown" onchange="openSelectedGame()" style="flex:1;max-width:300px;padding:0.5rem 0.8rem;background:var(--bg-dark);color:var(--hud-green);border:1px solid var(--hud-green-dim);border-radius:4px;font-size:0.85rem;cursor:pointer;">
            <option value="">-- „Ç≤„Éº„É†„ÇíÈÅ∏Êäû --</option>
          </select>
        </div>
        <a id="gameHiddenLink" href="#" target="_blank" rel="noopener" style="display:none;"></a>
      </div>

      <!-- ÊäΩÈÅ∏‰ºöÂ†¥ÔºàÂ∑¶Ôºö„É´„Éº„É¨„ÉÉ„Éà„ÄÅÂè≥Ôºö„É™„Çπ„ÉàÔºâ -->
      <div class="lottery-arena" id="lotteryArena">
        <!-- „Ç∞„É´„Éº„Éó„Çø„ÉñÔºà22‰∫∫‰ª•‰∏ä„ÅÆÂ†¥ÂêàË°®Á§∫Ôºâ -->
        <div class="group-tabs-container" id="groupTabsContainer" style="display:none;grid-column:1/-1;">
          <div class="group-tabs" id="groupTabs"></div>
          <div class="group-info-text" id="groupInfoText"></div>
          <div id="groupBulkMatch" style="display:none;text-align:center;">
            <button class="bulk-match-btn" onclick="bulkMatchGroup()">‚ö° ‰∏ÄÊã¨„Éû„ÉÉ„ÉÅ„É°„Ç§„ÇØ</button>
          </div>
        </div>
        <!-- Â∑¶ÂÅ¥Ôºö„É´„Éº„É¨„ÉÉ„ÉàÔºãVS -->
        <div class="lottery-main">
          <div class="roulette-container" id="rouletteContainer">
            <div class="roulette-wheel">
              <div class="wheel-inner" id="wheelInner"></div>
              <!-- VSË°®Á§∫Ôºà‰∏≠Â§Æ„Å´Èáç„Å≠„ÇãÔºâ -->
              <div class="vs-overlay">
                <div class="vs-display">
                  <div class="vs-title">‚öîÔ∏è ÂØæÊà¶„Ç´„Éº„Éâ</div>
                  <div class="vs-players">
                    <div class="vs-player" id="vsPlayer1Box" onclick="selectWinnerFromCard(1)">
                      <div class="vs-player-icon" id="vsPlayer1Icon"><svg class="silhouette-icon" viewBox="0 0 100 120"><circle cx="50" cy="30" r="22"/><path d="M10 120 Q10 70 50 65 Q90 70 90 120Z"/></svg></div>
                      <div class="vs-player-id" id="vsPlayer1Id">-</div>
                      <div class="vs-player-name" id="vsPlayer1Name">-</div>
                    </div>
                    <div class="vs-text">VS</div>
                    <div class="vs-player" id="vsPlayer2Box" onclick="selectWinnerFromCard(2)">
                      <div class="vs-player-icon" id="vsPlayer2Icon"><svg class="silhouette-icon" viewBox="0 0 100 120"><circle cx="50" cy="30" r="22"/><path d="M10 120 Q10 70 50 65 Q90 70 90 120Z"/></svg></div>
                      <div class="vs-player-id" id="vsPlayer2Id">-</div>
                      <div class="vs-player-name" id="vsPlayer2Name">-</div>
                    </div>
                  </div>
                  <div class="vs-help" id="vsHelp" style="display:none;font-size:0.7rem;color:var(--hud-gold);margin-top:0.5rem;">‚Äª ÂãùËÄÖ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                </div>
              </div>
            </div>
          </div>
          <!-- Êìç‰Ωú„Éú„Çø„É≥ -->
          <div class="roulette-controls" id="rouletteAdminControls" style="display:none;">
            <button class="roulette-btn" id="spinBtn" onclick="spinRoulette()">„É´„Éº„É¨„ÉÉ„ÉàÂõûËª¢</button>
            <button class="roulette-btn" id="endTournamentBtn" onclick="confirmEndTournament()" style="background:rgba(40,10,20,0.8);border-color:var(--hud-red);color:var(--hud-red);">Â§ß‰ºöÁµÇ‰∫Ü„ÉªË®òÈå≤</button>
          </div>
          <!-- „Éà„Éº„Éä„É°„É≥„ÉàË°®Âàá„ÇäÊõø„Åà„Éú„Çø„É≥ÔºàÁÆ°ÁêÜËÄÖÁî®Ôºâ -->
          <div class="roulette-controls" id="bracketControls" style="display:none;margin-top:1rem;">
            <button class="bracket-view-btn" id="showBracketBtn" onclick="toggleBracketView()">
              üìä „Éà„Éº„Éä„É°„É≥„ÉàË°®„ÇíË¶ã„Çã
            </button>
          </div>
        </div>
        
        <!-- „Éà„Éº„Éä„É°„É≥„ÉàË°®Ôºà20Âêç‰ª•‰∏ã„ÅßË°®Á§∫ÂèØËÉΩÔºâ -->
        <div class="bracket-container" id="bracketContainer">
          <h3 class="bracket-title" id="bracketTitle">üèÜ „Éà„Éº„Éä„É°„É≥„ÉàË°®</h3>
          <div id="bracketContent"></div>
          <div style="margin-top:1rem;display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
            <button class="bracket-view-btn" id="bracketBackBtn" onclick="toggleBracketView()">üé≤ „É´„Éº„É¨„ÉÉ„Éà„Å´Êàª„Çã</button>
            <button class="bracket-view-btn" id="bracketEndBtn" onclick="confirmEndTournament()" style="display:none;background:rgba(40,10,20,0.8);border-color:var(--hud-red);color:var(--hud-red);">üèÜ Â§ß‰ºöÁµÇ‰∫Ü„ÉªË®òÈå≤</button>
          </div>
        </div>
        
        <!-- Âè≥ÂÅ¥ÔºöÂèÇÂä†ËÄÖ„É™„Çπ„Éà -->
        <div class="lottery-sidebar">
          <!-- ÁèæÂú®„ÅÆ„Éû„ÉÉ„ÉÅË°®Á§∫ -->
          <div class="current-match-display" id="currentMatchDisplay" style="display:none;">
            <div class="current-match-title">‚öîÔ∏è ÁèæÂú®„ÅÆÂØæÊà¶</div>
            <div class="current-match-vs">
              <span id="currentMatch1">-</span>
              <span>VS</span>
              <span id="currentMatch2">-</span>
            </div>
          </div>
          <div class="participant-panel">
            <div class="participant-header">
              <h3 class="participant-title">‚óÜ ÂèÇÂä†ËÄÖ„É™„Çπ„Éà</h3>
              <input type="text" class="participant-search" placeholder="üîç Ê§úÁ¥¢" oninput="filterParticipants(this.value)">
            </div>
            <div class="participant-row header"><div>ID</div><div>Icon</div><div>„É¶„Éº„Ç∂„ÉºÂêç</div><div>Áä∂ÊÖã</div></div>
            <div class="participant-list" id="participantList"></div>
            <div class="participant-count">ÂèÇÂä†ËÄÖÊï∞: <span id="listCount">0</span>/100</div>
          </div>
        </div>
      </div>
      
      <!-- ÊäΩÈÅ∏‰ºöÂ†¥ÂÖ•Â†¥Ââç„ÅÆÂèÇÂä†ËÄÖ„É™„Çπ„Éà -->
      <div class="participant-panel" id="preArenaList" style="max-width:700px;margin:1rem auto;">
        <div class="participant-header">
          <h3 class="participant-title">‚óÜ ÂèÇÂä†ËÄÖ„É™„Çπ„Éà</h3>
          <input type="text" class="participant-search" placeholder="üîç Ê§úÁ¥¢" oninput="filterParticipants(this.value)">
        </div>
        <div class="participant-row header"><div>ID</div><div>Icon</div><div>„É¶„Éº„Ç∂„ÉºÂêç</div><div>Áä∂ÊÖã</div></div>
        <div class="participant-list" id="participantListPre"></div>
        <div class="participant-count">ÂèÇÂä†ËÄÖÊï∞: <span id="listCountPre">0</span>/100ÔºàÊúÄÂ§ß100‰∫∫Ôºâ</div>
      </div>
    </div>
    <div class="screen" id="historyScreen">
      <div class="hud-panel" style="max-width:600px;margin:2rem auto;">
        <div class="hud-panel-title">‚óÜ ÈÅéÂéª„ÅÆÂ§ß‰ºöË®òÈå≤</div>
        <div id="historyList"></div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="userGuideModal">
    <div class="modal-content guide-modal">
      <button class="modal-close-btn" onclick="hideModal('userGuideModal')">√ó</button>
      <h3 class="modal-title">‚óÜ ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</h3>
      <div class="guide-content">
        <h4>üéÆ „Éà„Éº„Éä„É°„É≥„Éà„Ç¢„Éó„É™„Å®„ÅØ</h4><p>ÂèÇÂä†ËÄÖÂêåÂ£´„Çí„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åï„Åõ„ÄÅÂãù„Å°ÊÆã„Å£„Åü‰∫∫„ÅåÂÑ™Âãù„Åô„ÇãÂ§ß‰ºöÂΩ¢Âºè„Çí‰ΩúÊàê„ÉªÈÅãÂñ∂„Åß„Åç„Çã„Ç¢„Éó„É™„Åß„Åô„ÄÇ</p>
        <h4>üìù „Ç®„É≥„Éà„É™„ÉºÊñπÊ≥ï</h4><ul><li>ÁÆ°ÁêÜËÄÖ„ÅåÁ∑†ÂàáÊó•ÊôÇ„ÇíË®≠ÂÆö„Åô„Çã„Å®„Äå„Ç®„É≥„Éà„É™„ÉºÁôªÈå≤„Åô„Çã„Äç„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åô</li><li>„É¶„Éº„Ç∂„Éº„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶ÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li><li>Á∑†ÂàáÊó•ÊôÇ„Åæ„Åß„Å™„Çâ„ÄåÁôªÈå≤Ëß£Èô§„Äç„ÅßËß£Èô§ÂèØËÉΩ„Åß„Åô</li></ul>
        <h4>‚öîÔ∏è ÊäΩÈÅ∏‰ºöÂ†¥</h4><ul><li>Á∑†ÂàáÊôÇÈñì„ÅåÈÅé„Åé„Çã„Å®„ÄåÊäΩÈÅ∏‰ºöÂ†¥„Å∏„Äç„Éú„Çø„É≥„ÅåËß£Êîæ„Åï„Çå„Åæ„Åô</li><li>„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÊäΩÈÅ∏‰ºöÂ†¥„Å∏ÁßªÂãï„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li><li>ÁÆ°ÁêÜËÄÖ„Åå„É´„Éº„É¨„ÉÉ„Éà„ÅßÂØæÊà¶„Ç´„Éº„Éâ„ÇíÊ±∫ÂÆö„Åó„Åæ„Åô</li></ul>
        <h4>üéÆ „Ç≤„Éº„É†ÈÅ∏Êäû</h4><ul><li>ÊäΩÈÅ∏‰ºöÂ†¥„Å´„Ç≤„Éº„É†ÈÅ∏Êäû„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</li><li>„Ç≤„Éº„É†Âêç„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅÂØæÂøú„Åô„Çã„Ç≤„Éº„É†ÁîªÈù¢„Å∏ÁßªÂãï„Åß„Åç„Åæ„Åô</li></ul>
        <h4>üëÄ „Éà„Éº„Éä„É°„É≥„Éà„ÇíË¶ã„Çã</h4><p>Â§ß‰ºöÊÉÖÂ†±„ÇÑÂèÇÂä†ËÄÖ„É™„Çπ„Éà„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ</p>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="adminGuideModal">
    <div class="modal-content guide-modal">
      <button class="modal-close-btn" onclick="hideModal('adminGuideModal')">√ó</button>
      <h3 class="modal-title" style="color:var(--hud-gold);">‚óÜ ÁÆ°ÁêÜËÄÖ„Ç¨„Ç§„Éâ</h3>
      <div class="guide-content">
        <h4>üîê ÁÆ°ÁêÜËÄÖÁôªÈå≤</h4><p>„ÄåÁÆ°ÁêÜËÄÖÁôªÈå≤„Çí„Åô„Çã„Äç„Åã„ÇâÁÆ°ÁêÜËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶ÁôªÈå≤„Åó„Åæ„Åô„ÄÇ</p>
        <h4>‚öôÔ∏è Â§ß‰ºöË®≠ÂÆö</h4><ul><li>„Ç≤„Éº„É†ÂêçÔºàÂ§ß‰ºöÂêçÔºâ„ÇíÂÖ•Âäõ</li><li>„Ç®„É≥„Éà„É™„ÉºÁ∑†ÂàáÊó•ÊôÇ„ÇíË®≠ÂÆö</li><li>Ë®≠ÂÆö‰øùÂ≠ò„Åß„Ç®„É≥„Éà„É™„ÉºÁôªÈå≤„ÅåÊúâÂäπÂåñ„Åï„Çå„Åæ„Åô</li></ul>
        <h4>üéÆ „Ç≤„Éº„É†ÁôªÈå≤</h4><ul><li>Â§ß‰ºöË®≠ÂÆöÁîªÈù¢„ÅÆ„Äå„Ç≤„Éº„É†ÁôªÈå≤„Äç„Çª„ÇØ„Ç∑„Éß„É≥„Åã„Çâ„Ç≤„Éº„É†Âêç„Å®URL„ÇíÁôªÈå≤„Åß„Åç„Åæ„Åô</li><li>ÁôªÈå≤„Åó„Åü„Ç≤„Éº„É†„ÅØÊäΩÈÅ∏‰ºöÂ†¥„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</li><li>„Éó„É¨„Ç§„É§„Éº„Åå„Ç≤„Éº„É†Âêç„ÇíÈÅ∏Êäû„Åô„Çã„Å®URL„Å∏ÁßªÂãï„Åó„Åæ„Åô</li><li>„ÅÑ„Å§„Åß„ÇÇ„Ç≤„Éº„É†„ÅÆËøΩÂä†„ÉªÂâäÈô§„ÅåÂèØËÉΩ„Åß„Åô</li></ul>
        <h4>üé≤ ÂØæÊà¶„Ç´„Éº„ÉâÊäΩÈÅ∏</h4><ul><li>Á∑†ÂàáÊó•ÊôÇ„ÅåÈÅé„Åé„Çã„Å®„ÄåÊäΩÈÅ∏‰ºöÂ†¥„Å∏„Äç„ÅåËß£Êîæ„Åï„Çå„Åæ„Åô</li><li>„Éó„É¨„Ç§„É§„Éº„Å´ÊäΩÈÅ∏‰ºöÂ†¥„Å∏ÁßªÂãï„Åô„Çã„Çà„ÅÜÊ°àÂÜÖ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li><li>„É´„Éº„É¨„ÉÉ„Éà„ÅßÂØæÊà¶„Ç´„Éº„Éâ„ÇíÊ±∫ÂÆö„Åó„Åæ„Åô</li></ul>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="confirmCancelEntryModal">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="hideModal('confirmCancelEntryModal')">√ó</button>
      <h3 class="modal-title">‚óÜ „Ç®„É≥„Éà„É™„ÉºËß£Èô§</h3>
      <p style="text-align:center;margin:0.8rem 0;">„Ç®„É≥„Éà„É™„Éº„ÇíËß£Èô§„Åó„Åæ„Åô„ÅãÔºü</p>
      <p style="text-align:center;color:var(--text-dim);font-size:0.85rem;">ÂèÇÂä†ËÄÖ„É™„Çπ„Éà„Åã„ÇâÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ</p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('confirmCancelEntryModal')">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="modal-btn modal-btn-confirm" style="background:var(--hud-red);" onclick="executeCancelEntry()">Ëß£Èô§„Åô„Çã</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="cancelCompleteModal">
    <div class="modal-content">
      <h3 class="modal-title">‚úÖ Ëß£Èô§ÂÆå‰∫Ü</h3>
      <p style="text-align:center;margin:0.8rem 0;">„Ç®„É≥„Éà„É™„Éº„ÇíËß£Èô§„Åó„Åæ„Åó„Åü„ÄÇ</p>
      <div class="modal-buttons"><button class="modal-btn modal-btn-confirm" onclick="hideModal('cancelCompleteModal')">OK</button></div>
    </div>
  </div>
  <div class="modal-overlay" id="settingsCompleteModal">
    <div class="modal-content">
      <h3 class="modal-title">‚úÖ Ë®≠ÂÆöÂÆå‰∫Ü</h3>
      <p style="text-align:center;margin:0.8rem 0;">Â§ß‰ºöË®≠ÂÆö„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇ</p>
      <p style="text-align:center;color:var(--text-dim);font-size:0.85rem;">Á∑†ÂàáÊó•ÊôÇ„Åæ„Åß„ÄÅÂèÇÂä†ËÄÖ„ÅÆ„Ç®„É≥„Éà„É™„Éº„ÇíÂæÖ„Å°„Åæ„Åó„Çá„ÅÜ„ÄÇ</p>
      <div class="modal-buttons"><button class="modal-btn modal-btn-confirm" onclick="hideModal('settingsCompleteModal');navigateTo('tournamentScreen',true)">Á¢∫Ë™ç„Åô„Çã</button></div>
    </div>
  </div>
  <div class="modal-overlay" id="entryCompleteModal">
    <div class="modal-content">
      <h3 class="modal-title">üéâ „Ç®„É≥„Éà„É™„ÉºÂÆå‰∫Ü</h3>
      <p style="text-align:center;margin:0.8rem 0;">„Ç®„É≥„Éà„É™„Éº„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ</p>
      <p style="text-align:center;color:var(--hud-gold);font-size:1rem;" id="entryCompleteInfo"></p>
      <div class="modal-buttons"><button class="modal-btn modal-btn-confirm" onclick="hideModal('entryCompleteModal');navigateTo('tournamentScreen',true)">Á¢∫Ë™ç„Åô„Çã</button></div>
    </div>
  </div>
  <!-- „Ç∑„Éº„ÉâÊäΩÈÅ∏Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-overlay" id="seedLotteryModal">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="hideModal('seedLotteryModal')">√ó</button>
      <h3 class="modal-title" style="color:var(--hud-gold);">üéñÔ∏è „Ç∑„Éº„ÉâÊäΩÈÅ∏</h3>
      <p style="text-align:center;margin:0.8rem 0;color:var(--text-dim);" id="seedLotteryInfo"></p>
      <p style="text-align:center;margin:0.5rem 0;color:var(--hud-green);font-size:0.9rem;">„Ç∑„Éº„ÉâÊ®©„ÇíÁç≤Âæó„Åó„ÅüÈÅ∏Êâã„ÅØÊ¨°„ÅÆ„É©„Ç¶„É≥„Éâ„Å´Ëá™ÂãïÈÄ≤Âá∫„Åó„Åæ„Åô</p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('seedLotteryModal')">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="modal-btn modal-btn-confirm" onclick="executeSeedLottery()" style="background:var(--hud-gold);border-color:var(--hud-gold);color:#000;">„Ç∑„Éº„ÉâÊäΩÈÅ∏„ÇíÈñãÂßã</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="confirmWinnerModal">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="hideModal('confirmWinnerModal')">√ó</button>
      <h3 class="modal-title">ÂãùËÄÖ„ÇíÁ¢∫ÂÆö„Åó„Åæ„Åô„ÅãÔºü</h3>
      <p style="text-align:center;margin:0.8rem 0;color:var(--hud-gold);font-size:1.2rem;" id="confirmWinnerText"></p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('confirmWinnerModal')">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="modal-btn modal-btn-confirm" onclick="executeWinner()">Á¢∫ÂÆö</button>
      </div>
    </div>
  </div>
  <!-- Â§ß‰ºöÁµÇ‰∫ÜÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-overlay" id="endTournamentModal">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="hideModal('endTournamentModal')">√ó</button>
      <h3 class="modal-title" style="color:var(--hud-red);">Â§ß‰ºö„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô„ÅãÔºü</h3>
      <p id="endTournamentDesc" style="text-align:center;color:var(--text-dim);margin:0.8rem 0;font-size:0.9rem;">ÂÑ™ÂãùËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åô</p>
      <div class="form-group" id="championSelectGroup">
        <label class="form-label" id="championSelectLabel">ÂÑ™ÂãùËÄÖ„ÇíÈÅ∏Êäû</label>
        <select id="championSelect" class="form-input" style="width:100%;padding:0.8rem;">
          <option value="">-- ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ --</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('endTournamentModal')">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="modal-btn modal-btn-confirm" onclick="executeEndTournament()" style="background:var(--hud-red);border-color:var(--hud-red);">Â§ß‰ºöÁµÇ‰∫Ü„ÉªË®òÈå≤</button>
      </div>
    </div>
  </div>
  <!-- „É™„Çª„ÉÉ„ÉàÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-overlay" id="resetTournamentModal">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="hideModal('resetTournamentModal')">√ó</button>
      <h3 class="modal-title" style="color:var(--hud-red);">‚ö†Ô∏è Â§ß‰ºö„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü</h3>
      <p style="text-align:center;color:var(--text-dim);margin:0.8rem 0;font-size:0.9rem;">ÁÆ°ÁêÜËÄÖÁôªÈå≤„ÅåËß£Èô§„Åï„Çå„ÄÅÂ§ß‰ºöË®≠ÂÆö„Éª„Ç®„É≥„Éà„É™„ÉºÊÉÖÂ†±„ÅåÂÖ®„Å¶ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ</p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal('resetTournamentModal')">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="modal-btn modal-btn-confirm" onclick="executeResetTournament()" style="background:var(--hud-red);border-color:var(--hud-red);">„É™„Çª„ÉÉ„ÉàÂÆüË°å</button>
      </div>
    </div>
  </div>
  <div class="toast" id="toast"></div>
  
  <!-- BGM/SE Controls -->
  <div class="sound-controls" id="soundControls">
    <button class="sound-btn" id="bgmBtn" onclick="toggleBGM()" title="BGM ON/OFF">üéµ</button>
    <button class="sound-btn" id="seBtn" onclick="toggleSE()" title="SE ON/OFF">üîä</button>
  </div>
  
  <!-- HUD - „É™„Ç¢„É´„Çø„Ç§„É†ÊÉÖÂ†±„Éë„Éç„É´ÔºàPCÂ∞ÇÁî®Ôºâ -->
  <div class="hud-info-panel" id="hudPanel">
    <div class="hud-content">
      <!-- Áä∂ÊÖã„Éê„ÉºÔºà‰∏äÈÉ®Ê®™Èï∑Ôºâ -->
      <div class="hud-status-bar">
        <div class="hud-status-left">
          <span class="hud-status-title">‚ñ∂ „Çπ„ÉÜ„Éº„Çø„Çπ</span>
          <div class="hud-status-list">
            <span class="hud-status-item active" id="statusReception">Âèó‰ªò‰∏≠</span>
            <span class="hud-status-item" id="statusClosed">Âèó‰ªòÁµÇ‰∫Ü</span>
            <span class="hud-status-item" id="statusProgress">ÈÄ≤Ë°å‰∏≠</span>
            <span class="hud-status-item" id="statusEnd">ÁµÇ‰∫Ü</span>
          </div>
        </div>
        <div class="hud-next-event" id="hudNextEvent"></div>
        <div class="hud-system-notice" id="hudSystemNotice"></div>
      </div>
      <!-- Ë°åÂãï„É≠„Ç∞Ôºà‰∏ãÈÉ®Ôºâ -->
      <div class="hud-log-area">
        <div class="hud-log-title">‚ñ∂ „É™„Ç¢„É´„Çø„Ç§„É†„É≠„Ç∞</div>
        <div class="hud-log-list" id="hudLogList"></div>
      </div>
    </div>
  </div>
  
  <!-- BGM Audio -->
  <audio id="bgmAudio" loop preload="auto">
    <source src="./tournament.mp3" type="audio/mpeg">
  </audio>
  <audio id="battleBgmAudio" loop preload="auto">
    <source src="./Battle Match.mp3" type="audio/mpeg">
  </audio>
  <audio id="vsSoundAudio" preload="auto">
    <source src="./VSÁî®.mp3" type="audio/mpeg">
  </audio>
  
  <div class="calendar-modal" id="calendarModal">
    <div class="calendar-container">
      <button class="calendar-close" onclick="closeCalendar()">√ó</button>
      <h3 class="calendar-title">Á∑†ÂàáÊó•ÊôÇ„ÇíÈÅ∏Êäû</h3>
      <div class="calendar-header">
        <button class="calendar-nav" onclick="changeMonth(-1)">‚óÄ</button>
        <span class="calendar-month-year" id="calendarMonthYear"></span>
        <button class="calendar-nav" onclick="changeMonth(1)">‚ñ∂</button>
      </div>
      <div class="calendar-weekdays"><div class="calendar-weekday">Êó•</div><div class="calendar-weekday">Êúà</div><div class="calendar-weekday">ÁÅ´</div><div class="calendar-weekday">Ê∞¥</div><div class="calendar-weekday">Êú®</div><div class="calendar-weekday">Èáë</div><div class="calendar-weekday">Âúü</div></div>
      <div class="calendar-days" id="calendarDays"></div>
      <div class="calendar-time">
        <input type="number" class="calendar-time-input" id="calendarHour" min="0" max="23" value="12">
        <span style="color:var(--text-dim);">:</span>
        <input type="number" class="calendar-time-input" id="calendarMinute" min="0" max="59" value="00" step="5">
      </div>
      <div class="calendar-selected-display" id="calendarSelectedDisplay">Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
      <button class="calendar-confirm" onclick="confirmCalendar()">„Åì„ÅÆÊó•ÊôÇ„ÅßË®≠ÂÆö</button>
    </div>
  </div>
  <script>
    const appState = {
      deviceId: localStorage.getItem('tournament_device_id') || (() => { const id = 'dev_' + Math.random().toString(36).substr(2,9) + Date.now().toString(36); localStorage.setItem('tournament_device_id', id); return id; })(),
      isAdmin: false,
      adminName: localStorage.getItem('tournament_admin_name') || null,
      tournament: null,
      entries: [],
      matches: [],
      games: [],
      gameAuthHash: null,
      selectedPlayer1: null,
      selectedPlayer2: null,
      isSpinning: false,
      pendingWinner: null,
      matchingIds: [],
      activeGroup: null,
      groupPhase: null
    };
    if (appState.adminName) appState.isAdmin = true;

    // BGM/SE State
    let bgmEnabled = true;
    let seEnabled = true;
    let bgmVolume = 0.3;
    let seVolume = 0.5;
    let currentBgm = 'normal'; // 'normal' or 'battle'
    const bgmAudio = document.getElementById('bgmAudio');
    const battleBgmAudio = document.getElementById('battleBgmAudio');
    const vsSoundAudio = document.getElementById('vsSoundAudio');

    function toggleBGM() {
      bgmEnabled = !bgmEnabled;
      const btn = document.getElementById('bgmBtn');
      if (bgmEnabled) {
        btn.classList.remove('off');
        btn.textContent = 'üéµ';
        if (currentBgm === 'normal') {
          bgmAudio.play().catch(e => {});
        } else {
          battleBgmAudio.play().catch(e => {});
        }
      } else {
        btn.classList.add('off');
        btn.textContent = 'üîá';
        bgmAudio.pause();
        battleBgmAudio.pause();
      }
    }

    function setBGMVolume(val) {
      bgmVolume = val / 100;
      bgmAudio.volume = bgmVolume;
      battleBgmAudio.volume = bgmVolume;
    }

    function toggleSE() {
      seEnabled = !seEnabled;
      const btn = document.getElementById('seBtn');
      if (seEnabled) {
        btn.classList.remove('off');
        btn.textContent = 'üîä';
      } else {
        btn.classList.add('off');
        btn.textContent = 'üîá';
      }
    }

    function setSEVolume(val) {
      seVolume = val / 100;
      vsSoundAudio.volume = seVolume;
    }

    // BGM„Çí„Éê„Éà„É´Áî®„Å´Âàá„ÇäÊõø„Åà
    function switchToBattleBGM() {
      console.log('switchToBattleBGM called, currentBgm:', currentBgm, 'bgmEnabled:', bgmEnabled);
      currentBgm = 'battle';
      bgmAudio.pause();
      bgmAudio.currentTime = 0;
      battleBgmAudio.volume = bgmVolume;
      if (bgmEnabled) {
        battleBgmAudio.play().then(() => {
          console.log('Battle BGM playing');
        }).catch(e => {
          console.log('Battle BGM error:', e);
          // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å
          setTimeout(() => {
            battleBgmAudio.play().catch(e2 => console.log('Battle BGM retry failed:', e2));
          }, 100);
        });
      }
    }

    // BGM„ÇíÈÄöÂ∏∏„Å´Êàª„Åô
    function switchToNormalBGM() {
      if (currentBgm === 'normal') return;
      currentBgm = 'normal';
      battleBgmAudio.pause();
      battleBgmAudio.currentTime = 0;
      bgmAudio.volume = bgmVolume;
      if (bgmEnabled) {
        bgmAudio.play().catch(e => console.log('Normal BGM blocked'));
      }
    }

    // VSÂäπÊûúÈü≥„ÇíÂÜçÁîü
    function playVsSound() {
      if (!seEnabled) return;
      vsSoundAudio.volume = seVolume;
      vsSoundAudio.currentTime = 0;
      vsSoundAudio.play().catch(e => console.log('VS sound blocked'));
    }
    
    // BGMÁî®„ÅÆAudioContextÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®Ôºâ
    let bgmContext = null;
    let bgmOscillators = [];
    let bgmGains = [];
    let bgmPlaying = false;
    
    // BGM„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàmp3„Åå„Å™„ÅÑÂ†¥ÂêàÔºâ
    function startBgmFallback(isBattle = false) {
      if (!bgmEnabled) return;
      stopBgmFallback();
      
      try {
        bgmContext = new (window.AudioContext || window.webkitAudioContext)();
        bgmPlaying = true;
        
        // „Ç∑„É≥„Éó„É´„Å™„Ç¢„É≥„Éì„Ç®„É≥„ÉàBGM
        const baseFreq = isBattle ? 110 : 65;
        const notes = isBattle ? [110, 138, 165, 138] : [65, 82, 98, 82];
        let noteIndex = 0;
        
        function playNote() {
          if (!bgmPlaying || !bgmContext) return;
          
          const osc = bgmContext.createOscillator();
          const gain = bgmContext.createGain();
          osc.connect(gain);
          gain.connect(bgmContext.destination);
          
          osc.type = isBattle ? 'sawtooth' : 'sine';
          osc.frequency.setValueAtTime(notes[noteIndex], bgmContext.currentTime);
          gain.gain.setValueAtTime(bgmVolume * 0.15, bgmContext.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, bgmContext.currentTime + 0.8);
          
          osc.start(bgmContext.currentTime);
          osc.stop(bgmContext.currentTime + 0.9);
          
          noteIndex = (noteIndex + 1) % notes.length;
          
          if (bgmPlaying) {
            setTimeout(playNote, 900);
          }
        }
        
        playNote();
      } catch(e) {
        console.log('BGM fallback error:', e);
      }
    }
    
    function stopBgmFallback() {
      bgmPlaying = false;
      if (bgmContext) {
        try {
          bgmContext.close();
        } catch(e) {}
        bgmContext = null;
      }
    }
    
    // VSÂäπÊûúÈü≥„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàWebAudioAPIÔºâ
    function playVsSoundFallback() {
      if (!seEnabled) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        
        // „Éâ„É©„Éû„ÉÅ„ÉÉ„ÇØ„Å™„ÄåVS„ÄçÂäπÊûúÈü≥„ÇíÁîüÊàê
        const duration = 0.8;
        
        // ‰ΩéÈü≥„ÅÆ„Ç§„É≥„Éë„ÇØ„Éà
        const osc1 = ctx.createOscillator();
        const gain1 = ctx.createGain();
        osc1.connect(gain1);
        gain1.connect(ctx.destination);
        osc1.type = 'sine';
        osc1.frequency.setValueAtTime(80, ctx.currentTime);
        osc1.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + duration);
        gain1.gain.setValueAtTime(seVolume * 0.6, ctx.currentTime);
        gain1.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
        osc1.start(ctx.currentTime);
        osc1.stop(ctx.currentTime + duration);
        
        // È´òÈü≥„ÅÆ„Ç¢„ÇØ„Çª„É≥„Éà
        const osc2 = ctx.createOscillator();
        const gain2 = ctx.createGain();
        osc2.connect(gain2);
        gain2.connect(ctx.destination);
        osc2.type = 'square';
        osc2.frequency.setValueAtTime(800, ctx.currentTime);
        osc2.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.3);
        gain2.gain.setValueAtTime(seVolume * 0.3, ctx.currentTime);
        gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc2.start(ctx.currentTime);
        osc2.stop(ctx.currentTime + 0.3);
        
      } catch(e) { console.log('VS fallback error:', e); }
    }

    // BGM„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàWeb Audio API„Åß„Ç¢„É≥„Éì„Ç®„É≥„ÉàÈü≥„ÇíÁîüÊàêÔºâ
    // Ê≥®: startBgmFallbackÈñ¢Êï∞„Çí‰ΩøÁî®

    function initBGM() {
      bgmAudio.volume = bgmVolume;
      battleBgmAudio.volume = bgmVolume;
      vsSoundAudio.volume = seVolume;
      document.addEventListener('click', () => {
        if (bgmEnabled && bgmAudio.paused && currentBgm === 'normal') {
          bgmAudio.play().catch(e => {});
        }
      }, { once: true });
    }

    function playClick() { if (!seEnabled) return; try { const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=800;o.type='sine';g.gain.setValueAtTime(seVolume*0.5,c.currentTime);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+0.1);o.start(c.currentTime);o.stop(c.currentTime+0.1);} catch(e){} }
    function playHover() { if (!seEnabled) return; try { const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=600;o.type='sine';g.gain.setValueAtTime(seVolume*0.12,c.currentTime);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+0.04);o.start(c.currentTime);o.stop(c.currentTime+0.04);} catch(e){} }
    function addSounds() { document.querySelectorAll('button').forEach(b => { b.addEventListener('mouseenter', () => { if(!b.disabled) playHover(); }); b.addEventListener('click', () => { if(!b.disabled) playClick(); }); }); }

    // HUD - „É™„Ç¢„É´„Çø„Ç§„É†„É≠„Ç∞ÁÆ°ÁêÜ
    const hudLogs = [];
    const MAX_LOGS = 10;

    function appendLog(message) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      
      // „É≠„Éº„Ç´„É´ÈÖçÂàó„Å´ËøΩÂä†ÔºàÊªùÂûãÔºöÊñ∞„Åó„ÅÑ„É≠„Ç∞„Åå‰∏äÔºâ
      hudLogs.unshift({ time: timeStr, message: message });
      
      // ‰∏äÈôêË∂ÖÈÅéÊôÇ„ÅØÊúÄ‰∏ãÊÆµ„Åã„ÇâÂâäÈô§
      if (hudLogs.length > MAX_LOGS) {
        hudLogs.pop();
      }
      
      renderLogs();
      
      // Firebase„Å´„É≠„Ç∞„Çí‰øùÂ≠òÔºà‰ªñ„É¶„Éº„Ç∂„Éº„Å®ÂÖ±ÊúâÔºâ
      if (db) {
        db.collection('logs').add({
          time: timeStr,
          message: message,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          // Âè§„ÅÑ„É≠„Ç∞„ÇíÂâäÈô§Ôºà10‰ª∂„ÇíË∂Ö„Åà„Åü„ÇâÔºâ
          cleanupOldLogs();
        }).catch(e => console.error('Log save error:', e));
      }
    }

    // Âè§„ÅÑ„É≠„Ç∞„ÇíÂâäÈô§ÔºàMAX_LOGS‰ª∂„ÇíË∂Ö„Åà„ÅüÂàÜÔºâ
    function cleanupOldLogs() {
      if (!db) return;
      
      db.collection('logs')
        .orderBy('timestamp', 'desc')
        .get()
        .then(snapshot => {
          if (snapshot.size > MAX_LOGS) {
            const batch = db.batch();
            let count = 0;
            snapshot.forEach(doc => {
              count++;
              // MAX_LOGS‰ª∂„Çà„ÇäÂè§„ÅÑ„ÇÇ„ÅÆ„ÇíÂâäÈô§
              if (count > MAX_LOGS) {
                batch.delete(doc.ref);
              }
            });
            batch.commit().catch(e => console.error('Log cleanup error:', e));
          }
        })
        .catch(e => console.error('Log count error:', e));
    }

    // Firebase„Åã„Çâ„É≠„Ç∞„Çí„É™„Ç¢„É´„Çø„Ç§„É†ÂèñÂæó
    function initLogListener() {
      if (!db) return;
      
      db.collection('logs')
        .orderBy('timestamp', 'desc')
        .limit(MAX_LOGS)
        .onSnapshot(snapshot => {
          // ‰ªñ„Éá„Éê„Ç§„Çπ„Åã„Çâ„ÅÆ„É≠„Ç∞„ÇíÂèçÊò†
          const firebaseLogs = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.time && data.message) {
              firebaseLogs.push({ time: data.time, message: data.message });
            }
          });
          
          // „É≠„Éº„Ç´„É´„É≠„Ç∞„ÇíFirebase„É≠„Ç∞„ÅßÊõ¥Êñ∞
          hudLogs.length = 0;
          firebaseLogs.forEach(log => hudLogs.push(log));
          
          renderLogs();
        }, err => console.error('Log listener error:', err));
    }

    function renderLogs() {
      const logList = document.getElementById('hudLogList');
      const logListMobile = document.getElementById('hudLogListMobile');
      
      const html = hudLogs.map((log, index) => {
        const fadeClass = index === 0 ? 'fade-in' : '';
        return '<div class="hud-log-item ' + fadeClass + '"><span class="log-time">' + log.time + '</span>' + escapeHtml(log.message) + '</div>';
      }).join('');
      
      if (logList) logList.innerHTML = html;
      if (logListMobile) logListMobile.innerHTML = html;
    }

    // „Éà„Éº„Éä„É°„É≥„ÉàÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
    function updateTournamentStatus(status) {
      const statuses = ['statusReception', 'statusClosed', 'statusProgress', 'statusEnd'];
      const statusesMobile = ['statusReceptionMobile', 'statusClosedMobile', 'statusProgressMobile', 'statusEndMobile'];
      
      statuses.forEach(id => {
        document.getElementById(id)?.classList.remove('active');
      });
      statusesMobile.forEach(id => {
        document.getElementById(id)?.classList.remove('active');
      });
      
      const statusMap = {
        'reception': 'statusReception',
        'closed': 'statusClosed',
        'progress': 'statusProgress',
        'end': 'statusEnd'
      };
      const statusMapMobile = {
        'reception': 'statusReceptionMobile',
        'closed': 'statusClosedMobile',
        'progress': 'statusProgressMobile',
        'end': 'statusEndMobile'
      };
      
      if (statusMap[status]) {
        document.getElementById(statusMap[status])?.classList.add('active');
        document.getElementById(statusMapMobile[status])?.classList.add('active');
      }
    }

    // Ê¨°„ÅÆ„Ç§„Éô„É≥„Éà‰∫àÂëä„ÅÆÊõ¥Êñ∞
    function updateNextEvent(message) {
      const el = document.getElementById('hudNextEvent');
      const elMobile = document.getElementById('hudNextEventMobile');
      if (el) el.textContent = message || '';
      if (elMobile) elMobile.textContent = message || '';
    }

    // „Ç∑„Çπ„ÉÜ„É†ÈÄöÁü•„ÅÆÊõ¥Êñ∞
    function updateSystemNotice(message) {
      const el = document.getElementById('hudSystemNotice');
      if (el) el.textContent = message || '';
    }

    // Áä∂ÊÖãÂà§ÂÆö„Å®Êõ¥Êñ∞
    function checkAndUpdateStatus() {
      const t = appState.tournament;
      const dl = t?.deadline;
      
      if (!dl) {
        updateTournamentStatus('none'); // Êú™Ë®≠ÂÆöÊôÇ„ÅØ‰Ωï„ÇÇÁô∫ÂÖâ„Åï„Åõ„Å™„ÅÑ
        updateNextEvent('ÁÆ°ÁêÜËÄÖ„ÅÆË®≠ÂÆö„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô');
        updateLotteryVenueButton();
        return;
      }
      
      const deadline = dl.toDate ? dl.toDate() : new Date(dl);
      const now = new Date();
      
      if (now < deadline) {
        updateTournamentStatus('reception');
        const diff = deadline - now;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secs = Math.floor((diff % (1000 * 60)) / 1000);
        
        // 1ÊôÇÈñì‰ª•ÂÜÖ„ÅØÁßíÊï∞„ÇÇË°®Á§∫
        if (hours === 0 && mins < 60) {
          if (mins === 0) {
            updateNextEvent('Á∑†Âàá„Åæ„Åß: ' + secs + 'Áßí');
          } else {
            updateNextEvent('Á∑†Âàá„Åæ„Åß: ' + mins + 'ÂàÜ ' + secs + 'Áßí');
          }
        } else {
          updateNextEvent('Á∑†Âàá„Åæ„Åß: ' + hours + 'ÊôÇÈñì ' + mins + 'ÂàÜ');
        }
      } else {
        // Á∑†ÂàáÂæå
        const activeCount = appState.entries.filter(e => e.status !== 'LOST').length;
        if (activeCount > 1) {
          updateTournamentStatus('progress');
          updateNextEvent('ÁÆ°ÁêÜËÄÖ„ÅÆÊìç‰Ωú„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô');
        } else if (activeCount === 1) {
          updateTournamentStatus('end');
          updateNextEvent('');
        } else {
          updateTournamentStatus('closed');
          updateNextEvent('');
        }
      }
      
      // „Éú„Çø„É≥Áä∂ÊÖã„ÇÇÊõ¥Êñ∞
      updateLotteryVenueButton();
      updateEntryButton();
      updateCancelEntryButton();
      updateMatchmakingButton();
    }
    
    // ÂÆöÊúüÁöÑ„Å´„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºà1Áßí„Åî„Å®Ôºâ
    setInterval(() => {
      checkAndUpdateStatus();
    }, 1000);

    function createMatrixBg() {
      const bg = document.getElementById('matrixBg');
      const chars = '„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥0123456789ABCDEF';
      for (let i = 0; i < 35; i++) {
        const col = document.createElement('div');
        col.className = 'matrix-col';
        col.style.left = (i * 2.9 + Math.random()) + '%';
        col.style.animationDuration = (8 + Math.random() * 12) + 's';
        col.style.animationDelay = (Math.random() * -15) + 's';
        let text = '';
        for (let j = 0; j < 45; j++) text += chars[Math.floor(Math.random() * chars.length)] + '\n';
        col.textContent = text;
        bg.appendChild(col);
      }
    }
    createMatrixBg();

    let currentScreen = 'titleScreen';
    let screenHistory = [];

    function navigateTo(screenId, directToTitle = false) {
      if (screenId === 'entryScreen') { if (!appState.tournament?.deadline) { showToast('Á∑†ÂàáÊó•ÊôÇ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error'); return; } updateEntryScreen(); }
      if (screenId === 'historyScreen') loadHistory();
      if (screenId === 'tournamentScreen') { initTournamentScreen(); }
      screenHistory.push(currentScreen);
      document.getElementById(currentScreen).classList.remove('active');
      document.getElementById(screenId).classList.add('active');
      currentScreen = screenId;
      const header = document.getElementById('mainHeader');
      const backBtn = document.getElementById('backBtn');
      if (screenId === 'titleScreen') { header.classList.remove('visible'); } else { header.classList.add('visible'); }
      if (directToTitle) { backBtn.textContent = '‚óÄ „Çø„Ç§„Éà„É´„Å´Êàª„Çã'; backBtn.onclick = goToTitle; } else { backBtn.textContent = '‚óÄ Êàª„Çã'; backBtn.onclick = goBack; }
      backBtn.classList.toggle('visible', screenId !== 'titleScreen');
      updateHudVisibility();
    }
    
    // „Éà„Éº„Éä„É°„É≥„ÉàÁîªÈù¢„ÅÆÂàùÊúüÂåñÔºàÂ§ß‰ºö„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„É™„Çª„ÉÉ„ÉàÔºâ
    function initTournamentScreen() {
      // Â§ß‰ºö„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØ„É™„Çª„ÉÉ„Éà„Åó„Å™„ÅÑ
      if (appState.tournament) {
        // „Éú„Çø„É≥Áä∂ÊÖã„Å†„ÅëÊõ¥Êñ∞
        updateLotteryVenueButton();
        return;
      }
      
      // Â§ß‰ºö„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„ÄÅÊäΩÈÅ∏‰ºöÂ†¥Èñ¢ÈÄ£„ÇíÂàùÊúüÁä∂ÊÖã„Å´Êàª„Åô
      const lotteryArena = document.getElementById('lotteryArena');
      const lotteryEntrance = document.getElementById('lotteryEntrance');
      const preArenaList = document.getElementById('preArenaList');
      const bracketContainer = document.getElementById('bracketContainer');
      const rouletteMain = document.querySelector('.lottery-main');
      const lotterySidebar = document.querySelector('.lottery-sidebar');
      const rouletteAdminControls = document.getElementById('rouletteAdminControls');
      const bracketControls = document.getElementById('bracketControls');
      
      // ÊäΩÈÅ∏‰ºöÂ†¥„ÇíÈùûË°®Á§∫„ÄÅÂÖ•Âè£„Éú„Çø„É≥„ÇíË°®Á§∫
      if (lotteryArena) {
        lotteryArena.classList.remove('active');
        lotteryArena.style.display = '';
        lotteryArena.style.gridTemplateColumns = '';
      }
      if (lotteryEntrance) lotteryEntrance.style.display = '';
      if (preArenaList) preArenaList.style.display = '';
      if (bracketContainer) bracketContainer.classList.remove('active');
      if (rouletteMain) rouletteMain.style.display = 'flex';
      if (lotterySidebar) lotterySidebar.style.display = '';
      if (rouletteAdminControls) rouletteAdminControls.style.display = 'none';
      if (bracketControls) bracketControls.style.display = 'none';
      
      // bracketMode„Çí„É™„Çª„ÉÉ„Éà
      bracketMode = false;
      
      // VSË°®Á§∫„Çí„É™„Çª„ÉÉ„ÉàÔºàÈñ¢Êï∞„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
      if (typeof updateVsDisplay === 'function') updateVsDisplay(null, null);
      if (typeof disableWinnerSelection === 'function') disableWinnerSelection();
      
      // „Éú„Çø„É≥Áä∂ÊÖã„ÇíÊõ¥Êñ∞
      updateLotteryVenueButton();
    }
    function goBack() { if (screenHistory.length > 0) { const prev = screenHistory.pop(); document.getElementById(currentScreen).classList.remove('active'); document.getElementById(prev).classList.add('active'); currentScreen = prev; const header = document.getElementById('mainHeader'); if (currentScreen === 'titleScreen') header.classList.remove('visible'); else header.classList.add('visible'); document.getElementById('backBtn').classList.toggle('visible', currentScreen !== 'titleScreen'); updateHudVisibility(); } }
    function goToTitle() { document.getElementById(currentScreen).classList.remove('active'); document.getElementById('titleScreen').classList.add('active'); currentScreen = 'titleScreen'; screenHistory = []; document.getElementById('mainHeader').classList.remove('visible'); updateHudVisibility(); }
    function updateHudVisibility() { const hud = document.getElementById('hudPanel'); if (hud) { if (currentScreen === 'titleScreen' && window.innerWidth >= 900) { hud.classList.add('title-active'); } else { hud.classList.remove('title-active'); } } }
    function showModal(id) { document.getElementById(id).classList.add('active'); }
    function hideModal(id) { document.getElementById(id).classList.remove('active'); }
    function showToast(msg, type = 'success') { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast ' + type + ' visible'; setTimeout(() => t.classList.remove('visible'), 3000); }
    function showGuide(type) { showModal(type === 'admin' ? 'adminGuideModal' : 'userGuideModal'); }
    function showMatchmakingInfo() {
      const dl = appState.tournament?.deadline;
      if (dl) {
        const d = dl.toDate ? dl.toDate() : new Date(dl);
        if (new Date() >= d) {
          switchToBattleBGM();
          navigateTo('tournamentScreen');
          document.getElementById('lotteryEntrance').style.display = 'none';
          document.getElementById('preArenaList').style.display = 'none';
          const lotteryArena = document.getElementById('lotteryArena');
          lotteryArena.style.display = '';
          lotteryArena.classList.add('active');
          document.getElementById('rouletteAdminControls').style.display = 'flex';

          // 22‰∫∫‰ª•‰∏ä„Åß„Ç∞„É´„Éº„ÉóÊú™Ââ≤„ÇäÂΩì„Å¶„Å™„ÇâËá™Âãï„Ç∞„É´„Éº„ÉóÂàÜ„Åë
          if (appState.entries.length >= 22 && !appState.tournament?.groups_assigned) {
            assignGroups();
          }
          if (appState.tournament?.group_phase) {
            appState.activeGroup = appState.tournament.active_group || 'A';
            appState.groupPhase = appState.tournament.group_phase;
            renderGroupTabs();
          }

          updateBracketControls();
          return;
        }
      }
      showToast('Á∑†ÂàáÊó•ÊôÇ‰ª•Èôç„Å´ÊúâÂäπÂåñ„Åï„Çå„Åæ„Åô', 'error');
    }
    function previewIcon(input) { if (input.files && input.files[0]) { const r = new FileReader(); r.onload = e => { document.getElementById('iconPreview').innerHTML = '<img src="' + e.target.result + '" style="width:100%;height:100%;object-fit:cover;">'; document.getElementById('iconDeleteBtn').style.display = 'block'; }; r.readAsDataURL(input.files[0]); } }
    function clearIcon() { document.getElementById('iconPreview').innerHTML = '<span style="color:var(--text-dim);font-size:1.3rem;">+</span>'; document.getElementById('iconInput').value = ''; document.getElementById('iconDeleteBtn').style.display = 'none'; }
    function escapeHtml(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }

    function updateTournamentDisplay() {
      const t = appState.tournament;
      const gn = t?.game_name || 'Êú™Ë®≠ÂÆö';
      const ad = t?.admin_name || '-';
      let dl = 'Êú™Ë®≠ÂÆö';
      if (t?.deadline) { const d = t.deadline.toDate ? t.deadline.toDate() : new Date(t.deadline); dl = d.toLocaleString('ja-JP', {year:'numeric',month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}); }
      document.getElementById('titleGameName').textContent = gn;
      document.getElementById('titleDeadline').textContent = dl;
      document.getElementById('titleDeadline').classList.toggle('warning', dl === 'Êú™Ë®≠ÂÆö');
      document.getElementById('titleAdmin').textContent = ad;
      document.getElementById('titleCount').textContent = appState.entries.length + 'Âêç';
      document.getElementById('tournamentGameName').textContent = gn;
      document.getElementById('tournamentDeadline').textContent = dl;
      document.getElementById('tournamentDeadline').classList.toggle('warning', dl === 'Êú™Ë®≠ÂÆö');
      document.getElementById('tournamentAdmin').textContent = ad;
      document.getElementById('tournamentCount').textContent = appState.entries.length + 'Âêç';
      const participantCountEl = document.getElementById('titleParticipantCount');
      if (participantCountEl) participantCountEl.textContent = appState.entries.length;
      updateEntryButton();
      updateCancelEntryButton();
      updateMatchmakingButton();
      updateLotteryVenueButton();
      updateAdminRegisterButton();
      updateTournamentViewButton();
      checkAndUpdateStatus();
    }
    function updateAdminRegisterButton() {
      const btn = document.getElementById('adminRegisterBtn');
      if (!btn) return;
      // Êó¢„Å´ÁÆ°ÁêÜËÄÖ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ‰ªñ„É¶„Éº„Ç∂„Éº„ÅØÊäº„Åõ„Å™„ÅÑ
      if (appState.tournament?.admin_device && appState.tournament.admin_device !== appState.deviceId) {
        btn.disabled = true;
        btn.style.opacity = '0.3';
        btn.style.cursor = 'not-allowed';
      } else {
        btn.disabled = false;
        btn.style.opacity = '';
        btn.style.cursor = '';
      }
    }
    
    // ÁÆ°ÁêÜËÄÖÁîªÈù¢„Å∏„ÅÆ„Ç¢„ÇØ„Çª„ÇπÂà∂Âæ°
    function goToAdminScreen() {
      // Â§ß‰ºö„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà ‚Üí ÁÆ°ÁêÜËÄÖÁôªÈå≤ÁîªÈù¢„Å∏
      if (!appState.tournament?.admin_device) {
        navigateTo('adminScreen');
        return;
      }
      
      // Â§ß‰ºö„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà ‚Üí ÁôªÈå≤„Åó„ÅüÁÆ°ÁêÜËÄÖ„ÅÆ„Éá„Éê„Ç§„Çπ„ÅÆ„Åø
      if (appState.tournament.admin_device === appState.deviceId) {
        navigateTo('adminSetupScreen');
        return;
      }
      
      // „Åù„Çå‰ª•Â§ñ ‚Üí „Ç®„É©„Éº
      showToast('ÁÆ°ÁêÜËÄÖ‰ª•Â§ñ„ÅØ„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì', 'error');
    }
    
    function updateEntryButton() { const b = document.getElementById('entryBtn'); if (!appState.tournament?.deadline) { b.disabled = true; } else { const d = appState.tournament.deadline.toDate ? appState.tournament.deadline.toDate() : new Date(appState.tournament.deadline); b.disabled = new Date() > d; } }
    function updateCancelEntryButton() { const b = document.getElementById('cancelEntryBtn'); if (!b) return; const my = appState.entries.find(e => e.device_id === appState.deviceId); let can = !!my; const dl = appState.tournament?.deadline; if (dl) { const d = dl.toDate ? dl.toDate() : new Date(dl); if (new Date() >= d) can = false; } b.disabled = !can; }
    function updateMatchmakingButton() { const b = document.getElementById('matchmakingBtn'); if (!b) return; const dl = appState.tournament?.deadline; if (!dl) { b.style.opacity = '0.5'; b.textContent = 'üé≤ ÂØæÊà¶„Ç´„Éº„ÉâÊäΩÈÅ∏ÔºàÁ∑†ÂàáÂæå„Å´ÊúâÂäπÂåñÔºâ'; b.classList.remove('matchmaking-active'); return; } const d = dl.toDate ? dl.toDate() : new Date(dl); if (new Date() >= d) { b.style.opacity = '1'; b.textContent = 'üé≤ ÂØæÊà¶„Ç´„Éº„ÉâÊäΩÈÅ∏„ÇíÈñãÂßã'; b.classList.add('matchmaking-active'); } else { b.style.opacity = '0.5'; b.textContent = 'üé≤ ÂØæÊà¶„Ç´„Éº„ÉâÊäΩÈÅ∏ÔºàÁ∑†ÂàáÂæå„Å´ÊúâÂäπÂåñÔºâ'; b.classList.remove('matchmaking-active'); } }
    
    // ÊäΩÈÅ∏‰ºöÂ†¥„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
    function updateLotteryVenueButton() {
      const btn = document.getElementById('lotteryVenueBtn');
      const sub = document.getElementById('lotteryBtnSub');
      const entrance = document.getElementById('lotteryEntrance');
      const lotteryArena = document.getElementById('lotteryArena');
      if (!btn) return;
      
      // Â§ß‰ºö„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éú„Çø„É≥„Ç®„É™„Ç¢„Åî„Å®ÈùûË°®Á§∫
      if (!appState.tournament) {
        if (entrance) entrance.style.display = 'none';
        btn.disabled = true;
        return;
      }
      
      // Êó¢„Å´ÊäΩÈÅ∏‰ºöÂ†¥ÂÜÖ„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄåÊäΩÈÅ∏‰ºöÂ†¥„Å∏„Äç„Éú„Çø„É≥„ÇíÈùûË°®Á§∫„ÅÆ„Åæ„Åæ
      if (lotteryArena && lotteryArena.classList.contains('active')) {
        if (entrance) entrance.style.display = 'none';
        return;
      }
      
      // ÊäΩÈÅ∏‰ºöÂ†¥„Å´ÂÖ•„Å£„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„Éú„Çø„É≥„ÇíË°®Á§∫
      if (entrance) entrance.style.display = '';
      
      const dl = appState.tournament?.deadline;
      if (dl) {
        const d = dl.toDate ? dl.toDate() : new Date(dl);
        if (new Date() >= d) {
          btn.disabled = false;
          if (sub) sub.style.display = 'none';
        } else {
          btn.disabled = true;
          if (sub) sub.style.display = '';
        }
      } else {
        btn.disabled = true;
        if (sub) sub.style.display = '';
      }
    }
    
    // ÊäΩÈÅ∏‰ºöÂ†¥„Å∏ÁßªÂãï
    function enterLotteryVenue() {
      const dl = appState.tournament?.deadline;
      if (!dl) { showToast('Â§ß‰ºö„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error'); return; }
      const d = dl.toDate ? dl.toDate() : new Date(dl);
      if (new Date() < d) { showToast('Á∑†ÂàáÊó•ÊôÇ‰ª•Èôç„Å´Ëß£Êîæ„Åï„Çå„Åæ„Åô', 'error'); return; }

      // BGM„Çí„Éê„Éà„É´„Éû„ÉÉ„ÉÅ„Å´Âàá„ÇäÊõø„Åà
      switchToBattleBGM();

      // ÂÖ•Â†¥„Éú„Çø„É≥„Å®‰∫ãÂâç„É™„Çπ„Éà„ÇíÈùûË°®Á§∫
      document.getElementById('lotteryEntrance').style.display = 'none';
      document.getElementById('preArenaList').style.display = 'none';

      // ÊäΩÈÅ∏‰ºöÂ†¥„ÇíË°®Á§∫Ôºàstyle.display„Çí„ÇØ„É™„Ç¢„Åó„Å¶CSS„ÅÆactive„ÇØ„É©„Çπ„ÇíÊúâÂäπ„Å´„Åô„ÇãÔºâ
      const lotteryArena = document.getElementById('lotteryArena');
      lotteryArena.style.display = '';
      lotteryArena.classList.add('active');

      // „Ç≤„Éº„É†„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥Ë°®Á§∫
      showGameDropdown();

      // ÁÆ°ÁêÜËÄÖ„ÅÆ„Åø„É´„Éº„É¨„ÉÉ„ÉàÊìç‰Ωú„Éú„Çø„É≥Ë°®Á§∫
      const isAdmin = appState.isAdmin || appState.tournament?.admin_device === appState.deviceId;
      if (isAdmin) {
        document.getElementById('rouletteAdminControls').style.display = 'flex';
      } else {
        document.getElementById('rouletteAdminControls').style.display = 'none';
      }

      // 22‰∫∫‰ª•‰∏ä„Åß„Ç∞„É´„Éº„ÉóÊú™Ââ≤„ÇäÂΩì„Å¶„ÅÆÂ†¥Âêà„ÄÅÁÆ°ÁêÜËÄÖ„Å™„ÇâËá™Âãï„Åß„Ç∞„É´„Éº„ÉóÂàÜ„Åë
      if (isAdmin && appState.entries.length >= 22 && !appState.tournament?.groups_assigned) {
        assignGroups();
      }

      // „Ç∞„É´„Éº„Éó„Éï„Çß„Éº„Ç∫„ÅÆÂ†¥Âêà„ÅØ„Çø„Éñ„Å®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç∞„É´„Éº„Éó„ÇíË®≠ÂÆö
      if (appState.tournament?.group_phase) {
        appState.activeGroup = appState.tournament.active_group || 'A';
        appState.groupPhase = appState.tournament.group_phase;
        renderGroupTabs();
      }

      // „Éà„Éº„Éä„É°„É≥„ÉàË°®„Éú„Çø„É≥„ÅØÂÖ®„É¶„Éº„Ç∂„Éº„Å´Ë°®Á§∫
      updateBracketControls();

      playClick();
      appendLog('ÊäΩÈÅ∏‰ºöÂ†¥„Å´ÂÖ•Â†¥„Åó„Åæ„Åó„Åü');
    }
    function updateEntriesDisplay() {
      const list = document.getElementById('participantList');
      const listPre = document.getElementById('participantListPre');
      const listCountEl = document.getElementById('listCount');
      const listCountPreEl = document.getElementById('listCountPre');

      if (listCountPreEl) listCountPreEl.textContent = appState.entries.length;

      const matchingIds = appState.matchingIds || [];

      // Arena list: filter by active group
      const arenaEntries = getGroupFilteredEntries();
      if (listCountEl) listCountEl.textContent = arenaEntries.length;

      const buildRow = (e) => {
        const isMatching = matchingIds.includes(e.entry_id);
        const hasSeed = e.has_seed;
        const statusText = e.status === 'LOST' ? 'ÊïóÈÄÄ' : (hasSeed ? 'üéñÔ∏è„Ç∑„Éº„Éâ' : 'ÂèÇÂä†‰∏≠');
        const statusClass = e.status === 'LOST' ? 'status-lost' : (hasSeed ? 'status-seed' : 'status-active');
        const groupLabel = e.group ? ' [' + e.group + ']' : '';
        return '<div class="participant-row' + (isMatching ? ' matching' : '') + '"><div class="participant-id">ID-' + String(e.entry_id).padStart(2,'0') + '</div><div class="participant-icon">' + (e.icon_url ? '<img src="' + e.icon_url + '">' : 'üë§') + '</div><div>' + escapeHtml(e.username) + groupLabel + (isMatching ? ' ‚öîÔ∏è' : '') + '</div><div><span class="status-badge ' + statusClass + '">' + statusText + '</span></div></div>';
      };

      const arenaHtml = arenaEntries.length === 0
        ? '<div style="text-align:center;padding:1.5rem;color:var(--text-dim);">ÂèÇÂä†ËÄÖ„ÅØ„ÅÑ„Åæ„Åõ„Çì</div>'
        : arenaEntries.map(buildRow).join('');

      const preHtml = appState.entries.length === 0
        ? '<div style="text-align:center;padding:1.5rem;color:var(--text-dim);">ÂèÇÂä†ËÄÖ„ÅØ„ÅÑ„Åæ„Åõ„Çì</div>'
        : appState.entries.map(buildRow).join('');

      if (list) list.innerHTML = arenaHtml;
      if (listPre) listPre.innerHTML = preHtml;

      // Update group tabs if visible
      renderGroupTabs();
    }
    function updateEntryScreen() {
      const my = appState.entries.find(e => e.device_id === appState.deviceId);
      const dl = appState.tournament?.deadline;
      const past = dl && new Date() > (dl.toDate ? dl.toDate() : new Date(dl));
      if (my) { document.getElementById('myEntryDisplay').style.display = 'block'; document.getElementById('entryForm').style.display = 'none'; document.getElementById('myEntryName').textContent = my.username; document.getElementById('myEntryId').textContent = ' (ID-' + String(my.entry_id).padStart(2,'0') + ')'; }
      else { document.getElementById('myEntryDisplay').style.display = past ? 'block' : 'none'; document.getElementById('entryForm').style.display = past ? 'none' : 'block'; if (past) document.getElementById('myEntryDisplay').innerHTML = '<div class="my-entry-box"><p style="color:var(--hud-red);">Á∑†ÂàáÊó•ÊôÇ„ÇíÈÅé„Åé„Å¶„ÅÑ„Åæ„Åô</p></div>'; }
    }
    function updateRouletteWheel() {
      const w = document.getElementById('wheelInner');
      const a = getGroupFilteredEntries().filter(e => e.status !== 'LOST');
      if (a.length === 0) { w.innerHTML = ''; return; }
      w.innerHTML = a.map((e,i) => {
        const hasSeed = e.has_seed;
        const style = hasSeed ? 'color:#ffa500;' : '';
        const seedMark = hasSeed ? 'üéñÔ∏è' : '';
        return '<div class="wheel-segment" style="transform:rotate(' + ((360/a.length)*i) + 'deg);' + style + '">' + seedMark + 'ID-' + String(e.entry_id).padStart(2,'0') + '</div>';
      }).join('');
    }
    function updateVsDisplay(p1, p2) { 
      document.getElementById('vsPlayer1Id').textContent = p1 ? 'ID-' + String(p1.entry_id).padStart(2,'0') : '-'; 
      document.getElementById('vsPlayer1Name').textContent = p1 ? p1.username : '-'; 
      document.getElementById('vsPlayer1Icon').innerHTML = p1?.icon_url ? '<img src="' + p1.icon_url + '" style="width:100%;height:100%;object-fit:cover;">' : '<svg class="silhouette-icon" viewBox="0 0 100 120"><circle cx="50" cy="30" r="22"/><path d="M10 120 Q10 70 50 65 Q90 70 90 120Z"/></svg>';
      document.getElementById('vsPlayer2Id').textContent = p2 ? 'ID-' + String(p2.entry_id).padStart(2,'0') : '-';
      document.getElementById('vsPlayer2Name').textContent = p2 ? p2.username : '-';
      document.getElementById('vsPlayer2Icon').innerHTML = p2?.icon_url ? '<img src="' + p2.icon_url + '" style="width:100%;height:100%;object-fit:cover;">' : '<svg class="silhouette-icon" viewBox="0 0 100 120"><circle cx="50" cy="30" r="22"/><path d="M10 120 Q10 70 50 65 Q90 70 90 120Z"/></svg>'; 
      
      // ÂãùÂà©„Éú„Çø„É≥„ÅÆÂêçÂâç„ÇíÊõ¥Êñ∞
      const w1 = document.getElementById('winner1Name');
      const w2 = document.getElementById('winner2Name');
      if (w1) w1.textContent = p1 ? p1.username : '-';
      if (w2) w2.textContent = p2 ? p2.username : '-';
      
      // ÁèæÂú®„ÅÆ„Éû„ÉÉ„ÉÅË°®Á§∫„ÇíÊõ¥Êñ∞
      const matchDisplay = document.getElementById('currentMatchDisplay');
      const match1 = document.getElementById('currentMatch1');
      const match2 = document.getElementById('currentMatch2');
      if (matchDisplay && match1 && match2) {
        if (p1 && p2) {
          matchDisplay.style.display = 'block';
          match1.textContent = p1.username;
          match2.textContent = p2.username;
        } else {
          matchDisplay.style.display = 'none';
        }
      }
      
      // ÂèÇÂä†ËÄÖ„É™„Çπ„Éà„Åß„Éû„ÉÉ„ÉÅ„É≥„Ç∞‰∏≠„Çí„Éè„Ç§„É©„Ç§„Éà
      appState.matchingIds = (p1 && p2) ? [p1.entry_id, p2.entry_id] : [];
      updateEntriesDisplay();
    }
    function filterParticipants(q) { document.querySelectorAll('#participantList .participant-row').forEach(r => { r.style.display = r.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none'; }); }

    let calendarDate = new Date(), calendarSelectedDate = null, calendarTarget = null;
    function openCalendar(target) { calendarTarget = target; calendarDate = new Date(); calendarSelectedDate = null; document.getElementById('calendarHour').value = '12'; document.getElementById('calendarMinute').value = '00'; renderCalendar(); updateCalendarDisplay(); document.getElementById('calendarModal').classList.add('active'); }
    function closeCalendar() { document.getElementById('calendarModal').classList.remove('active'); }
    function changeMonth(d) { calendarDate.setMonth(calendarDate.getMonth() + d); renderCalendar(); }
    function renderCalendar() {
      const y = calendarDate.getFullYear(), m = calendarDate.getMonth();
      document.getElementById('calendarMonthYear').textContent = y + 'Âπ¥ ' + (m + 1) + 'Êúà';
      const c = document.getElementById('calendarDays'); c.innerHTML = '';
      const first = new Date(y, m, 1).getDay(), days = new Date(y, m + 1, 0).getDate(), today = new Date(); today.setHours(0,0,0,0);
      for (let i = 0; i < first; i++) { const e = document.createElement('div'); e.className = 'calendar-day empty'; c.appendChild(e); }
      for (let d = 1; d <= days; d++) {
        const cell = document.createElement('div'); cell.className = 'calendar-day'; cell.textContent = d;
        const cd = new Date(y, m, d); cd.setHours(0,0,0,0);
        if (cd < today) { cell.classList.add('disabled'); } else { cell.onclick = () => { calendarSelectedDate = new Date(y, m, d); renderCalendar(); updateCalendarDisplay(); playClick(); }; cell.onmouseenter = playHover; }
        if (cd.getTime() === today.getTime()) cell.classList.add('today');
        if (calendarSelectedDate && calendarSelectedDate.getFullYear() === y && calendarSelectedDate.getMonth() === m && calendarSelectedDate.getDate() === d) cell.classList.add('selected');
        c.appendChild(cell);
      }
    }
    function updateCalendarDisplay() { const disp = document.getElementById('calendarSelectedDisplay'); if (calendarSelectedDate) { const h = document.getElementById('calendarHour').value.padStart(2,'0'), mi = document.getElementById('calendarMinute').value.padStart(2,'0'); disp.textContent = calendarSelectedDate.getFullYear() + '/' + String(calendarSelectedDate.getMonth()+1).padStart(2,'0') + '/' + String(calendarSelectedDate.getDate()).padStart(2,'0') + ' ' + h + ':' + mi; } else { disp.textContent = 'Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; } }
    document.getElementById('calendarHour')?.addEventListener('input', updateCalendarDisplay);
    document.getElementById('calendarMinute')?.addEventListener('input', updateCalendarDisplay);
    function confirmCalendar() { if (!calendarSelectedDate) { showToast('Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; } const h = parseInt(document.getElementById('calendarHour').value) || 0, mi = parseInt(document.getElementById('calendarMinute').value) || 0; const dt = new Date(calendarSelectedDate.getFullYear(), calendarSelectedDate.getMonth(), calendarSelectedDate.getDate(), h, mi); if (dt <= new Date()) { showToast('ÁèæÂú®„Çà„ÇäÂæå„ÅÆÊó•ÊôÇ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; } const str = dt.toLocaleString('ja-JP', {year:'numeric',month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}); if (calendarTarget === 'setup') { document.getElementById('setupDeadline').value = dt.toISOString(); document.getElementById('setupDeadlineBtn').textContent = str; } playClick(); closeCalendar(); }
    document.addEventListener('DOMContentLoaded', () => { setTimeout(addSounds, 100); initBGM(); initFirebase(); updateHudVisibility(); });
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = { apiKey: "AIzaSyCNGRa4DCOM595aM5Exor5BF6oPUvg1TIY", authDomain: "tournament-app-a0837.firebaseapp.com", projectId: "tournament-app-a0837", storageBucket: "tournament-app-a0837.firebasestorage.app", messagingSenderId: "514905483124", appId: "1:514905483124:web:1882493de273598b0a2e21" };
    let db = null;
    
    // „Çπ„Éë„É†ÂØæÁ≠ñÔºö„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥ÁÆ°ÁêÜ
    const COOLDOWN_TIME = 5 * 60 * 1000; // 5ÂàÜÔºà„Éü„É™ÁßíÔºâ
    const COOLDOWN_THRESHOLD = 3; // 3Âõû
    const COOLDOWN_WINDOW = 5 * 60 * 1000; // 5ÂàÜ‰ª•ÂÜÖ
    
    // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
    async function checkCooldown(type) {
      if (!db) return { blocked: false };
      const docId = type === 'user' ? appState.deviceId : 'admin_' + appState.deviceId;
      try {
        const doc = await db.collection('cooldowns').doc(docId).get();
        if (doc.exists) {
          const data = doc.data();
          const expiry = data.expiry?.toDate?.() || new Date(data.expiry);
          if (new Date() < expiry) {
            const remaining = Math.ceil((expiry - new Date()) / 1000 / 60);
            return { blocked: true, remaining: remaining };
          } else {
            // ÊúüÈôêÂàá„Çå„Å™„ÇâÂâäÈô§
            await db.collection('cooldowns').doc(docId).delete();
          }
        }
      } catch (e) { console.error('Cooldown check error:', e); }
      return { blocked: false };
    }
    
    // Êìç‰Ωú„É≠„Ç∞„ÇíË®òÈå≤„Åó„Å¶Áï∞Â∏∏Ê§úÁü•
    async function recordAction(type, actionName) {
      if (!db) return false;
      const docId = type === 'user' ? appState.deviceId : 'admin_' + appState.deviceId;
      const now = new Date();
      const windowStart = new Date(now.getTime() - COOLDOWN_WINDOW);
      
      try {
        // Êìç‰Ωú„É≠„Ç∞„ÇíËøΩÂä†
        await db.collection('action_logs').add({
          device_id: appState.deviceId,
          type: type,
          action: actionName,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // 5ÂàÜ‰ª•ÂÜÖ„ÅÆÊìç‰ΩúÂõûÊï∞„Çí„Ç´„Ç¶„É≥„Éà
        const snap = await db.collection('action_logs')
          .where('device_id', '==', appState.deviceId)
          .where('type', '==', type)
          .where('timestamp', '>=', windowStart)
          .get();
        
        if (snap.size >= COOLDOWN_THRESHOLD) {
          // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥Áô∫Âãï
          const expiry = new Date(now.getTime() + COOLDOWN_TIME);
          await db.collection('cooldowns').doc(docId).set({
            device_id: appState.deviceId,
            type: type,
            reason: actionName,
            expiry: expiry,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Áï∞Â∏∏ÈÄöÁü•„Çí„É≠„Ç∞„Å´Ë®òÈå≤ÔºàÁÆ°ÁêÜËÄÖÂêë„ÅëÔºâ
          await db.collection('spam_alerts').add({
            device_id: appState.deviceId,
            type: type,
            username: type === 'user' ? (appState.entries.find(e => e.device_id === appState.deviceId)?.username || '‰∏çÊòé') : appState.adminName,
            action_count: snap.size,
            cooldown_minutes: 5,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          appendLog('‚ö†Ô∏è Áï∞Â∏∏Ê§úÁü•: „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥Áô∫Âãï');
          return true; // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥Áô∫Âãï
        }
      } catch (e) { console.error('Record action error:', e); }
      return false;
    }
    
    // Âè§„ÅÑÊìç‰Ωú„É≠„Ç∞„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÔºà5ÂàÜ‰ª•‰∏äÂâç„ÅÆ„ÇÇ„ÅÆÔºâ
    async function cleanupOldActionLogs() {
      if (!db) return;
      const cutoff = new Date(Date.now() - COOLDOWN_WINDOW - 60000);
      try {
        const snap = await db.collection('action_logs')
          .where('timestamp', '<', cutoff)
          .limit(50)
          .get();
        if (!snap.empty) {
          const batch = db.batch();
          snap.forEach(doc => batch.delete(doc.ref));
          await batch.commit();
        }
      } catch (e) { console.error('Cleanup error:', e); }
    }
    
    function initFirebase() { try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); console.log('Firebase OK'); loadData(); initLogListener(); setInterval(cleanupOldActionLogs, 60000); } catch (e) { console.error('Firebase error:', e); updateTournamentDisplay(); } }
    function loadData() { 
      if (!db) return; 
      
      // „Éà„Éº„Éä„É°„É≥„ÉàÊÉÖÂ†±„ÅÆÁõ£Ë¶ñÔºà„É´„Éº„É¨„ÉÉ„ÉàÁä∂ÊÖãÂê´„ÇÄÔºâ
      db.collection('tournaments').doc('current').onSnapshot(doc => { 
        if (doc.exists) { 
          const data = doc.data();
          const prevRouletteState = appState.tournament?.roulette_state;
          appState.tournament = data; 
          
          if (data.admin_device === appState.deviceId) { 
            appState.isAdmin = true; 
            appState.adminName = data.admin_name; 
          }
          
          // „É´„Éº„É¨„ÉÉ„ÉàÁä∂ÊÖã„ÅÆÂêåÊúüÔºàÁÆ°ÁêÜËÄÖ‰ª•Â§ñ„ÅÆ„Éá„Éê„Ç§„ÇπÔºâ
          if (data.roulette_state && data.admin_device !== appState.deviceId) {
            const newState = data.roulette_state;
            const prevTimestamp = prevRouletteState?.timestamp?.toMillis?.() || 0;
            const newTimestamp = newState.timestamp?.toMillis?.() || 0;

            if (newTimestamp > prevTimestamp) {
              handleRouletteSync(newState);
            }
          }

          // „Ç∞„É´„Éº„ÉóÁä∂ÊÖã„ÅÆÂêåÊúü
          if (data.group_phase) {
            appState.groupPhase = data.group_phase;
            if (data.group_phase === 'merged') {
              appState.activeGroup = null;
            } else {
              appState.activeGroup = data.active_group || appState.activeGroup;
            }
            renderGroupTabs();
          }

          updateTournamentDisplay(); 
        } else {
          // Â§ß‰ºö„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà
          const hadTournament = appState.tournament !== null;
          appState.tournament = null;
          
          // ‰ª•Ââç„ÅØÂ§ß‰ºö„Åå„ÅÇ„Å£„Åü„Åå‰ªä„ÅØ„Å™„ÅÑ ‚Üí „É™„Çª„ÉÉ„ÉàÔºàÂ§ß‰ºöÁµÇ‰∫ÜÔºâ
          if (hadTournament) {
            resetAfterTournamentEnd();
          } else {
            // ÂàùÊúüÁä∂ÊÖãÔºàÂ§ß‰ºö„Åå„Å™„ÅÑÁä∂ÊÖãÔºâ- Ë°®Á§∫„Å†„ÅëÊõ¥Êñ∞
            updateTournamentDisplay();
          }
        }
      }); 
      
      // „Ç®„É≥„Éà„É™„ÉºÊÉÖÂ†±„ÅÆÁõ£Ë¶ñ
      db.collection('entries').orderBy('entry_id', 'asc').onSnapshot(snap => { 
        appState.entries = snap.docs.map(d => ({ id: d.id, ...d.data() })); 
        updateEntriesDisplay(); 
        updateRouletteWheel(); 
        updateTournamentDisplay(); 
        updateBracketControls(); 
        if (bracketMode) generateBracket(); 
      }); 
      
      // „Éû„ÉÉ„ÉÅÊÉÖÂ†±„ÅÆÁõ£Ë¶ñ
      db.collection('matches').orderBy('created_at', 'asc').onSnapshot(snap => {
        appState.matches = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        updateBracketControls();
        if (bracketMode) generateBracket();
        // ÂÖ®ÂØæÊà¶„Ç´„Éº„ÉâÁ¢∫ÂÆö„ÉÅ„Çß„ÉÉ„ÇØÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÔºâ
        if (appState.isAdmin) checkAllMatchupsDecided();
      });

      // „Ç≤„Éº„É†ÊÉÖÂ†±„ÅÆÁõ£Ë¶ñÔºàtournaments/games_registry„Å´‰øùÂ≠òÔºâ
      db.collection('tournaments').doc('games_registry').onSnapshot(doc => {
        if (doc.exists) {
          const data = doc.data();
          appState.gameAuthHash = data._auth_hash || null;
          appState.games = Object.entries(data).filter(([id]) => !id.startsWith('_')).map(([id, g]) => ({ id, ...g })).sort((a, b) => {
            const ta = a.created_at || '';
            const tb = b.created_at || '';
            return ta < tb ? -1 : ta > tb ? 1 : 0;
          });
          // Ë™çË®ºID„ÅåÊú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà„ÄÅÁÆ°ÁêÜËÄÖ„Å™„ÇâËá™ÂãïË®≠ÂÆö
          if (!data._auth_hash && appState.isAdmin) {
            hashString('GmReg847').then(hash => {
              db.collection('tournaments').doc('games_registry').set({ _auth_hash: hash }, { merge: true });
            });
          }
        } else {
          appState.games = [];
          appState.gameAuthHash = null;
        }
        renderGameList();
        renderGameDropdown();
      });
    }
    
    // Â§ß‰ºöÁµÇ‰∫ÜÂæå„ÅÆ„É™„Çª„ÉÉ„ÉàÂá¶ÁêÜÔºàÂÖ®Á´ØÊú´ÂÖ±ÈÄöÔºâ
    function resetAfterTournamentEnd() {
      console.log('Â§ß‰ºö„Éá„Éº„Çø„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü„ÄÇ„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÄÇ');

      // ÁÆ°ÁêÜËÄÖ„ÅåËá™ÂàÜ„ÅßÁµÇ‰∫Ü„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅÁÆ°ÁêÜËÄÖÂÅ¥„ÅÆÁîªÈù¢ÈÅ∑Áßª„ÇíË°å„Çè„Å™„ÅÑ
      if (tournamentEndedLocally) return;

      // BGM„ÇíÈÄöÂ∏∏„Å´Êàª„Åô
      switchToNormalBGM();
      
      // „É≠„Éº„Ç´„É´Áä∂ÊÖã„ÇíÂÆåÂÖ®„É™„Çª„ÉÉ„Éà
      appState.tournament = null;
      appState.entries = [];
      appState.matches = [];
      appState.selectedPlayer1 = null;
      appState.selectedPlayer2 = null;
      appState.matchingIds = [];
      appState.activeGroup = null;
      appState.groupPhase = null;
      appState.isAdmin = false;
      appState.adminName = null;
      bracketMode = false;

      // ÁÆ°ÁêÜËÄÖÊÉÖÂ†±„ÇílocalStorage„Åã„ÇâÂâäÈô§
      localStorage.removeItem('tournament_admin_name');

      // „Ç∞„É´„Éº„Éó„Çø„Éñ„ÇíÈùûË°®Á§∫
      const groupTabsContainer = document.getElementById('groupTabsContainer');
      if (groupTabsContainer) groupTabsContainer.style.display = 'none';

      // HUD„É≠„Ç∞„Çí„ÇØ„É™„Ç¢
      hudLogs.length = 0;
      
      // ÁîªÈù¢„ÇíÊõ¥Êñ∞
      updateTournamentDisplay();
      updateEntriesDisplay();
      updateHudVisibility();

      // „Éà„Éº„Çπ„ÉàË°®Á§∫
      showToast('Â§ß‰ºö„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü', 'info');
      
      // ÁîªÈù¢Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢
      screenHistory = [];
      
      // „Åô„Åπ„Å¶„ÅÆÁîªÈù¢„ÇíÈùûË°®Á§∫
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById('titleScreen').classList.add('active');
      currentScreen = 'titleScreen';
      
      // „Éò„ÉÉ„ÉÄ„Éº„ÇíÈùûË°®Á§∫
      document.getElementById('mainHeader').classList.remove('visible');
      document.getElementById('backBtn').classList.remove('visible');
      
      // ÊäΩÈÅ∏‰ºöÂ†¥„ÅÆÁä∂ÊÖã„ÇíÂÆåÂÖ®„É™„Çª„ÉÉ„Éà
      const bracketContainer = document.getElementById('bracketContainer');
      if (bracketContainer) bracketContainer.classList.remove('active');
      
      const lotteryArena = document.getElementById('lotteryArena');
      if (lotteryArena) {
        lotteryArena.style.display = 'none';
        lotteryArena.style.gridTemplateColumns = '';
      }
      
      const lotteryEntrance = document.getElementById('lotteryEntrance');
      if (lotteryEntrance) lotteryEntrance.style.display = '';
      
      const preArenaList = document.getElementById('preArenaList');
      if (preArenaList) preArenaList.style.display = '';
      
      const rouletteMain = document.querySelector('.lottery-main');
      if (rouletteMain) rouletteMain.style.display = 'flex';
      
      const lotterySidebar = document.querySelector('.lottery-sidebar');
      if (lotterySidebar) lotterySidebar.style.display = '';
      
      // „É´„Éº„É¨„ÉÉ„ÉàÈñ¢ÈÄ£„Çí„É™„Çª„ÉÉ„Éà
      const rouletteAdminControls = document.getElementById('rouletteAdminControls');
      if (rouletteAdminControls) rouletteAdminControls.style.display = 'none';
      
      const bracketControls = document.getElementById('bracketControls');
      if (bracketControls) bracketControls.style.display = 'none';
      
      const wheelInner = document.getElementById('wheelInner');
      if (wheelInner) wheelInner.style.transform = 'rotate(0deg)';
      
      // VSË°®Á§∫„Çí„É™„Çª„ÉÉ„Éà
      if (typeof updateVsDisplay === 'function') updateVsDisplay(null, null);
      if (typeof disableWinnerSelection === 'function') disableWinnerSelection();

      // ÂØæÊà¶„Ç´„Éº„ÉâÊäΩÈÅ∏„Éú„Çø„É≥„Çí„É™„Çª„ÉÉ„Éà
      updateMatchmakingButton();

      // HUDË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞
      updateHudVisibility();
      
      // „Éú„Çø„É≥Áä∂ÊÖã„ÇíÊõ¥Êñ∞
      updateTournamentViewButton();
      updateLotteryVenueButton();
    }
    async function registerAdmin() { 
      const btn = document.querySelector('#adminScreen .submit-btn');
      if (btn) btn.disabled = true; // ‰∫åÈáç„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢
      
      try {
        // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥„ÉÅ„Çß„ÉÉ„ÇØ
        const cd = await checkCooldown('admin');
        if (cd.blocked) { 
          showToast('Áü≠ÊôÇÈñì„ÅßÁôªÈå≤„ÉªËß£Èô§„ÇíÁπ∞„ÇäËøî„Åó„Åü„Åü„ÇÅ„ÄÅ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑÔºàÊÆã„Çä' + cd.remaining + 'ÂàÜÔºâ', 'error'); 
          if (btn) btn.disabled = false;
          return; 
        }
        
        const n = document.getElementById('adminNameInput').value.trim(); 
        const e = document.getElementById('adminNameError'); 
        if (!n) { 
          e.textContent = 'ÁÆ°ÁêÜËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; 
          e.classList.add('visible'); 
          if (btn) btn.disabled = false;
          return; 
        } 
        e.classList.remove('visible'); 
        localStorage.setItem('tournament_admin_name', n); 
        appState.adminName = n; 
        appState.isAdmin = true; 
        
        // ÁîªÈù¢ÈÅ∑ÁßªÔºà„É≠„Ç∞„ÅØÂ§ß‰ºöË®≠ÂÆöÂÆå‰∫ÜÊôÇ„Å´Âá∫„ÅôÔºâ
        screenHistory.push(currentScreen); 
        document.getElementById(currentScreen).classList.remove('active'); 
        document.getElementById('adminSetupScreen').classList.add('active'); 
        currentScreen = 'adminSetupScreen'; 
        document.getElementById('mainHeader').classList.add('visible'); 
        document.getElementById('backBtn').classList.add('visible');
        if (btn) btn.disabled = false; // ÊàêÂäüÂæå„Å´ÂÜçÊúâÂäπÂåñ
      } catch (err) {
        console.error('registerAdmin error:', err);
        if (btn) btn.disabled = false;
      }
    }
    // „Ç≤„Éº„É†ÁôªÈå≤„ÉªÁÆ°ÁêÜ
    async function hashString(str) {
      const data = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    async function registerGame() {
      if (!db) { showToast('„Éá„Éº„Çø„Éô„Éº„Çπ„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error'); return; }
      if (!appState.isAdmin) { showToast('ÁÆ°ÁêÜËÄÖ„Å®„Åó„Å¶ÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; }
      const nameEl = document.getElementById('gameRegName');
      const urlEl = document.getElementById('gameRegUrl');
      const authEl = document.getElementById('gameRegAuthId');
      const errEl = document.getElementById('gameRegError');
      const name = nameEl.value.trim();
      const url = urlEl.value.trim();
      const authId = authEl.value.trim();
      errEl.classList.remove('visible');
      if (!name) { errEl.textContent = '„Ç≤„Éº„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; errEl.classList.add('visible'); return; }
      if (!url) { errEl.textContent = 'URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; errEl.classList.add('visible'); return; }
      try { new URL(url); } catch { errEl.textContent = 'ÊúâÂäπ„Å™URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; errEl.classList.add('visible'); return; }
      if (!authId) { errEl.textContent = 'Ë™çË®ºID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; errEl.classList.add('visible'); return; }
      if (appState.games.find(g => g.name === name)) { errEl.textContent = '„Åì„ÅÆ„Ç≤„Éº„É†Âêç„ÅØÊó¢„Å´ÁôªÈå≤Ê∏à„Åø„Åß„Åô'; errEl.classList.add('visible'); return; }
      if (appState.games.find(g => g.url === url)) { errEl.textContent = '„Åì„ÅÆURL„ÅØÊó¢„Å´ÁôªÈå≤Ê∏à„Åø„Åß„Åô'; errEl.classList.add('visible'); return; }
      // Ë™çË®ºID„ÅÆÊ§úË®º
      const inputHash = await hashString(authId);
      if (appState.gameAuthHash) {
        // Êó¢„Å´Ë™çË®ºID„ÅåË®≠ÂÆöÊ∏à„Åø ‚Üí ‰∏ÄËá¥„ÉÅ„Çß„ÉÉ„ÇØ
        if (inputHash !== appState.gameAuthHash) {
          errEl.textContent = 'Ë™çË®ºID„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì'; errEl.classList.add('visible'); return;
        }
      }
      try {
        const gameId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        const gameData = {};
        gameData[gameId] = { name, url, admin_device: appState.deviceId, created_at: new Date().toISOString() };
        if (!appState.gameAuthHash) {
          // ÂàùÂõûÔºöË™çË®ºID„Éè„ÉÉ„Ç∑„É•„ÇÇ‰∏ÄÁ∑í„Å´‰øùÂ≠ò
          gameData._auth_hash = inputHash;
        }
        await db.collection('tournaments').doc('games_registry').set(gameData, { merge: true });
        nameEl.value = ''; urlEl.value = ''; authEl.value = '';
        showToast('„Ç≤„Éº„É†„Äå' + name + '„Äç„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü');
      } catch (e) { console.error('Game register error:', e); showToast('ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message, 'error'); }
    }
    async function removeGame(gameId, gameName) {
      if (!db || !appState.isAdmin) return;
      if (!confirm('„Äå' + gameName + '„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
      try {
        const deleteData = {};
        deleteData[gameId] = firebase.firestore.FieldValue.delete();
        await db.collection('tournaments').doc('games_registry').update(deleteData);
        showToast('„Äå' + gameName + '„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
      } catch (e) { console.error(e); showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error'); }
    }
    function renderGameList() {
      const container = document.getElementById('gameListAdmin');
      if (!container) return;
      if (appState.games.length === 0) { container.innerHTML = '<p style="color:var(--text-dim);font-size:0.8rem;text-align:center;">ÁôªÈå≤„Åï„Çå„Åü„Ç≤„Éº„É†„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>'; return; }
      let html = '<div style="font-size:0.8rem;color:var(--text-dim);margin-bottom:0.4rem;">ÁôªÈå≤Ê∏à„Åø„Ç≤„Éº„É† (' + appState.games.length + '‰ª∂):</div>';
      html += '<div style="display:flex;align-items:center;gap:0.5rem;">';
      html += '<select id="gameListSelect" class="form-input" style="flex:1;cursor:pointer;">';
      appState.games.forEach(g => {
        html += '<option value="' + escapeHtml(g.id) + '" data-name="' + escapeHtml(g.name) + '">' + escapeHtml(g.name) + '</option>';
      });
      html += '</select>';
      html += '<button onclick="removeSelectedGame()" style="background:none;border:1px solid var(--hud-red);color:var(--hud-red);padding:0.4rem 0.8rem;border-radius:3px;cursor:pointer;font-size:0.75rem;flex-shrink:0;white-space:nowrap;">ÂâäÈô§</button>';
      html += '</div>';
      container.innerHTML = html;
    }
    function removeSelectedGame() {
      const sel = document.getElementById('gameListSelect');
      if (!sel || !sel.value) return;
      const gameId = sel.value;
      const gameName = sel.options[sel.selectedIndex].dataset.name;
      removeGame(gameId, gameName);
    }
    // „Ç≤„Éº„É†„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞ÔºàË°®Á§∫/ÈùûË°®Á§∫„ÅØÂà∂Âæ°„Åó„Å™„ÅÑÔºâ
    function updateGameDropdownOptions() {
      const dropdown = document.getElementById('gameDropdown');
      if (!dropdown) return;
      const tournamentGame = appState.tournament?.game_name || '';
      const normalize = s => s.replace(/\s/g, '').toLowerCase();
      const matchedGame = appState.games.find(g => normalize(g.name) === normalize(tournamentGame));
      let html = '';
      if (matchedGame) {
        html += '<option value="">-- „Ç≤„Éº„É†„ÇíÈÅ∏Êäû --</option>';
        appState.games.forEach(g => {
          if (normalize(g.name) === normalize(tournamentGame)) {
            html += '<option value="' + escapeHtml(g.url) + '">' + escapeHtml(g.name) + '</option>';
          } else {
            html += '<option value="" disabled style="color:gray;">' + escapeHtml(g.name) + 'ÔºàÂØæË±°Â§ñÔºâ</option>';
          }
        });
      } else {
        html += '<option value="">-- ÂØæË±°„Ç≤„Éº„É†„Å™„Åó --</option>';
        appState.games.forEach(g => {
          html += '<option value="" disabled style="color:gray;">' + escapeHtml(g.name) + 'ÔºàÂØæË±°Â§ñÔºâ</option>';
        });
      }
      dropdown.innerHTML = html;
    }
    // ÊäΩÈÅ∏‰ºöÂ†¥„Åß„Ç≤„Éº„É†„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíË°®Á§∫„Åô„Çã
    function showGameDropdown() {
      var area = document.getElementById('gameDropdownArea');
      if (!area) return;
      if (appState.games.length === 0) { area.style.display = 'none'; return; }
      updateGameDropdownOptions();
      area.style.display = 'block';
    }
    // „Ç≤„Éº„É†ÈÅ∏ÊäûÊôÇÔºöÈö†„Åó<a>„Çø„Ç∞ÁµåÁî±„ÅßÊñ∞„Çø„Éñ„ÇíÈñã„Åè
    function openSelectedGame() {
      var dropdown = document.getElementById('gameDropdown');
      var link = document.getElementById('gameHiddenLink');
      if (!dropdown || !link || !dropdown.value) return;
      link.href = dropdown.value;
      link.click();
      dropdown.value = '';
    }
    // ÂæåÊñπ‰∫íÊèõÁî®
    function renderGameDropdown() {
      var arenaActive = document.getElementById('lotteryArena')?.classList.contains('active');
      if (arenaActive) { showGameDropdown(); }
    }

    function saveTournamentSettings() { const gn = document.getElementById('setupGameName').value.trim(); const dl = document.getElementById('setupDeadline').value; const ge = document.getElementById('setupGameNameError'); const de = document.getElementById('setupDeadlineError'); ge.classList.remove('visible'); de.classList.remove('visible'); let err = false; if (!gn) { ge.textContent = '„Ç≤„Éº„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; ge.classList.add('visible'); err = true; } if (!dl) { de.textContent = 'Á∑†ÂàáÊó•ÊôÇ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; de.classList.add('visible'); err = true; } if (err) return; appState.tournament = { admin_name: appState.adminName, admin_device: appState.deviceId, game_name: gn, deadline: new Date(dl) }; appendLog(appState.adminName + '„ÅåÁÆ°ÁêÜËÄÖ„Å´„Å™„Çä„ÄÅ„Éà„Éº„Éä„É°„É≥„Éà„Äå' + gn + '„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü'); if (db) { db.collection('tournaments').doc('current').set({ admin_name: appState.adminName, admin_device: appState.deviceId, game_name: gn, deadline: new Date(dl), updated_at: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }).catch(e => console.error(e)); } updateTournamentDisplay(); showModal('settingsCompleteModal'); }
    async function submitEntry() { 
      // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥„ÉÅ„Çß„ÉÉ„ÇØ
      const cd = await checkCooldown('user');
      if (cd.blocked) { showToast('Áü≠ÊôÇÈñì„ÅßÁôªÈå≤„ÉªËß£Èô§„ÇíÁπ∞„ÇäËøî„Åó„Åü„Åü„ÇÅ„ÄÅ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑÔºàÊÆã„Çä' + cd.remaining + 'ÂàÜÔºâ', 'error'); return; }
      
      if (!appState.tournament?.deadline) { showToast('Á∑†ÂàáÊó•ÊôÇ„ÅåÊú™Ë®≠ÂÆö„Åß„Åô', 'error'); return; } const d = appState.tournament.deadline.toDate ? appState.tournament.deadline.toDate() : new Date(appState.tournament.deadline); if (new Date() > d) { showToast('Á∑†Âàá„ÇíÈÅé„Åé„Å¶„ÅÑ„Åæ„Åô', 'error'); return; } const n = document.getElementById('usernameInput').value.trim(); const e = document.getElementById('usernameError'); if (!n) { e.textContent = '„É¶„Éº„Ç∂„Éº„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; e.classList.add('visible'); return; } if (appState.entries.find(x => x.username === n)) { e.textContent = '„Åì„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô'; e.classList.add('visible'); return; } if (appState.entries.find(x => x.device_id === appState.deviceId)) { e.textContent = '„Åì„ÅÆ„Éá„Éê„Ç§„Çπ„ÅØÊó¢„Å´ÁôªÈå≤Ê∏à„Åø„Åß„Åô'; e.classList.add('visible'); return; } if (appState.entries.length >= 100) { updateSystemNotice('ÂèÇÂä†‰∏äÈôê„Å´ÈÅî„Åó„Åæ„Åó„Åü'); showToast('ÂèÇÂä†‰∏äÈôê„Å´ÈÅî„Åó„Åæ„Åó„Åü', 'error'); return; } e.classList.remove('visible'); 
      
      // Êìç‰ΩúË®òÈå≤
      const triggered = await recordAction('user', 'entry');
      if (triggered) { showToast('Áü≠ÊôÇÈñì„ÅßÁôªÈå≤„ÉªËß£Èô§„ÇíÁπ∞„ÇäËøî„Åó„Åü„Åü„ÇÅ„ÄÅ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ', 'error'); return; }
      
      const id = appState.entries.length + 1; const ic = document.getElementById('iconPreview').querySelector('img'); playClick(); const ne = { id: appState.deviceId, entry_id: id, username: n, device_id: appState.deviceId, icon_url: ic ? ic.src : null, status: 'ACTIVE' }; appState.entries.push(ne); appendLog(n + '„Åå„Ç®„É≥„Éà„É™„Éº„Åó„Åæ„Åó„Åü'); if (db) { db.collection('entries').doc(appState.deviceId).set({ entry_id: id, username: n, device_id: appState.deviceId, icon_url: ic ? ic.src : null, status: 'ACTIVE', created_at: firebase.firestore.FieldValue.serverTimestamp() }).catch(x => console.error(x)); } updateEntriesDisplay(); updateTournamentDisplay(); document.getElementById('usernameInput').value = ''; clearIcon(); document.getElementById('entryCompleteInfo').textContent = n + ' (ID-' + String(id).padStart(2,'0') + ')'; showModal('entryCompleteModal'); 
    }
    function cancelEntry() { const my = appState.entries.find(e => e.device_id === appState.deviceId); if (!my) { showToast('„Ç®„É≥„Éà„É™„Éº„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error'); return; } const dl = appState.tournament?.deadline; if (dl) { const d = dl.toDate ? dl.toDate() : new Date(dl); if (new Date() >= d) { showToast('Á∑†ÂàáÊó•ÊôÇ„ÇíÈÅé„Åé„Å¶„ÅÑ„Çã„Åü„ÇÅËß£Èô§„Åß„Åç„Åæ„Åõ„Çì', 'error'); return; } } showModal('confirmCancelEntryModal'); }
    async function executeCancelEntry() { 
      // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥„ÉÅ„Çß„ÉÉ„ÇØ
      const cd = await checkCooldown('user');
      if (cd.blocked) { hideModal('confirmCancelEntryModal'); showToast('Áü≠ÊôÇÈñì„ÅßÁôªÈå≤„ÉªËß£Èô§„ÇíÁπ∞„ÇäËøî„Åó„Åü„Åü„ÇÅ„ÄÅ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑÔºàÊÆã„Çä' + cd.remaining + 'ÂàÜÔºâ', 'error'); return; }
      
      // Êìç‰ΩúË®òÈå≤
      const triggered = await recordAction('user', 'cancel_entry');
      if (triggered) { hideModal('confirmCancelEntryModal'); showToast('Áü≠ÊôÇÈñì„ÅßÁôªÈå≤„ÉªËß£Èô§„ÇíÁπ∞„ÇäËøî„Åó„Åü„Åü„ÇÅ„ÄÅ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ', 'error'); return; }
      
      playClick(); const myEntry = appState.entries.find(e => e.device_id === appState.deviceId); const username = myEntry ? myEntry.username : '‰∏çÊòé'; const i = appState.entries.findIndex(e => e.device_id === appState.deviceId); if (i !== -1) appState.entries.splice(i, 1); appendLog(username + '„ÅåÁôªÈå≤Ëß£Èô§„Åó„Åæ„Åó„Åü'); if (db) db.collection('entries').doc(appState.deviceId).delete().catch(e => console.error(e)); updateEntriesDisplay(); updateTournamentDisplay(); updateEntryScreen(); updateCancelEntryButton(); hideModal('confirmCancelEntryModal'); showModal('cancelCompleteModal'); 
    }
    // ===== „Ç∞„É´„Éº„Éó„Ç∑„Çπ„ÉÜ„É† =====
    function getGroupFilteredEntries() {
      if (!appState.tournament?.group_phase) return appState.entries;
      // Áµ±Âêà„Éï„Çß„Éº„Ç∫: ÂÖ®„Ç®„É≥„Éà„É™„Éº„ÇíËøî„ÅôÔºà„Ç∞„É´„Éº„ÉóÂå∫ÂàÜ„Å™„ÅóÔºâ
      if (appState.tournament.group_phase === 'merged') return appState.entries;
      if (appState.activeGroup === 'finals') {
        const winners = appState.tournament?.group_winners || {};
        const winnerIds = Object.values(winners).map(w => w.entry_id);
        return appState.entries.filter(e => winnerIds.includes(e.entry_id));
      }
      if (appState.activeGroup) {
        return appState.entries.filter(e => e.group === appState.activeGroup);
      }
      return appState.entries;
    }
    function getGroupFilteredMatches() {
      if (!appState.tournament?.group_phase) return appState.matches;
      // Áµ±Âêà„Éï„Çß„Éº„Ç∫: „Ç∞„É´„Éº„Éó„Å™„Åó„ÅÆ„Éû„ÉÉ„ÉÅÔºàÁµ±ÂêàÂæå„Å´‰Ωú„Çâ„Çå„Åü„ÇÇ„ÅÆÔºâ„ÇíËøî„Åô
      if (appState.tournament.group_phase === 'merged') {
        return appState.matches.filter(m => !m.group || m.group === 'merged');
      }
      if (appState.activeGroup === 'finals') {
        return appState.matches.filter(m => m.group === 'finals');
      }
      if (appState.activeGroup) {
        return appState.matches.filter(m => m.group === appState.activeGroup);
      }
      return appState.matches;
    }

    function assignGroups() {
      if (!db) return Promise.resolve();
      const entries = appState.entries;
      if (entries.length <= 21) return Promise.resolve();

      const count = entries.length;
      const numGroups = Math.min(5, Math.ceil(count / 20));
      const groupNames = ['A', 'B', 'C', 'D', 'E'].slice(0, numGroups);

      const shuffled = [...entries].sort(() => Math.random() - 0.5);
      const batch = db.batch();
      shuffled.forEach((entry, i) => {
        const group = groupNames[i % numGroups];
        batch.update(db.collection('entries').doc(entry.id), { group: group });
      });
      batch.update(db.collection('tournaments').doc('current'), {
        groups_assigned: true,
        group_phase: 'group',
        active_group: groupNames[0],
        group_winners: {}
      });
      return batch.commit().then(() => {
        appState.activeGroup = groupNames[0];
        appState.groupPhase = 'group';
        showToast(numGroups + '„Ç∞„É´„Éº„Éó„Å´ÂàÜ„Åë„Åæ„Åó„Åü', 'success');
        appendLog('„Ç∞„É´„Éº„ÉóÂàÜ„ÅëÂÆå‰∫Ü: ' + numGroups + '„Ç∞„É´„Éº„ÉóÔºàÂêÑÊúÄÂ§ß20‰∫∫Ôºâ');
      });
    }

    function renderGroupTabs() {
      const container = document.getElementById('groupTabsContainer');
      const tabs = document.getElementById('groupTabs');
      const infoText = document.getElementById('groupInfoText');
      const bulkBtn = document.getElementById('groupBulkMatch');
      if (!container || !tabs) return;

      const phase = appState.tournament?.group_phase;
      if (!phase || phase === 'merged') {
        container.style.display = 'none';
        return;
      }

      container.style.display = '';
      const groups = [...new Set(appState.entries.map(e => e.group).filter(Boolean))].sort();
      if (groups.length === 0) { container.style.display = 'none'; return; }

      const activeGroup = appState.activeGroup || appState.tournament?.active_group || groups[0];
      const winners = appState.tournament?.group_winners || {};

      let html = '';
      groups.forEach(g => {
        const groupEntries = appState.entries.filter(e => e.group === g);
        const activeCount = groupEntries.filter(e => e.status !== 'LOST').length;
        const hasWinner = !!winners[g];
        const isActive = (phase === 'group' && g === activeGroup);
        html += '<div class="group-tab' + (isActive ? ' active' : '') + (hasWinner ? ' completed' : '') + '" onclick="selectGroup(\'' + g + '\')">';
        html += 'G-' + g + ' (' + activeCount + '/' + groupEntries.length + ')';
        if (hasWinner) html += ' ‚úì';
        html += '</div>';
      });

      // Ê±∫Âãù„Çø„Éñ
      const allGroupsDone = groups.length > 0 && Object.keys(winners).length === groups.length;
      if (phase === 'finals' || allGroupsDone) {
        const isFinalsActive = activeGroup === 'finals';
        html += '<div class="group-tab finals-tab' + (isFinalsActive ? ' active' : '') + '" onclick="selectGroup(\'finals\')">Ê±∫Âãù</div>';
      }

      tabs.innerHTML = html;
      appState.activeGroup = activeGroup;

      // info text
      if (infoText) {
        if (activeGroup === 'finals') {
          const winnerCount = Object.keys(winners).length;
          infoText.textContent = 'Ê±∫Âãù: ' + winnerCount + 'Âêç„ÅÆ„Ç∞„É´„Éº„ÉóÂãùËÄÖ';
        } else {
          const ge = appState.entries.filter(e => e.group === activeGroup);
          const ac = ge.filter(e => e.status !== 'LOST').length;
          infoText.textContent = '„Ç∞„É´„Éº„Éó' + activeGroup + ': ÊÆã„Çä' + ac + 'Âêç';
          if (winners[activeGroup]) {
            infoText.textContent += ' (ÂãùËÄÖ: ' + winners[activeGroup].username + ')';
          }
        }
      }

      // bulk match button (admin only, group phase, not completed group)
      if (bulkBtn) {
        const isAdmin = appState.isAdmin || appState.tournament?.admin_device === appState.deviceId;
        if (isAdmin && activeGroup !== 'finals' && !winners[activeGroup]) {
          bulkBtn.style.display = '';
        } else if (isAdmin && activeGroup === 'finals' && phase === 'finals') {
          bulkBtn.style.display = '';
        } else {
          bulkBtn.style.display = 'none';
        }
      }
    }

    function selectGroup(group) {
      appState.activeGroup = group;
      if (db && appState.isAdmin) {
        db.collection('tournaments').doc('current').update({
          active_group: group,
          group_phase: group === 'finals' ? 'finals' : (appState.tournament?.group_phase || 'group')
        }).catch(e => {});
      }
      renderGroupTabs();
      updateEntriesDisplay();
      updateRouletteWheel();
      updateBracketControls();
      if (bracketMode) generateBracket();
    }

    async function bulkMatchGroup() {
      const isAdmin = appState.isAdmin || appState.tournament?.admin_device === appState.deviceId;
      if (!isAdmin || !db) return;

      const entries = getGroupFilteredEntries();
      const active = entries.filter(e => e.status !== 'LOST');
      const inMatch = getGroupFilteredMatches().filter(m => !m.winner_id);
      const inMatchIds = inMatch.flatMap(m => [m.player1_id, m.player2_id]);
      const available = active.filter(e => !inMatchIds.includes(e.entry_id) && !e.has_seed);

      if (available.length < 2) {
        showToast('„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂèØËÉΩ„Å™ÂèÇÂä†ËÄÖ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô', 'error');
        return;
      }

      const shuffled = [...available].sort(() => Math.random() - 0.5);
      const batch = db.batch();
      let matchCount = 0;
      const groupTag = appState.activeGroup || null;

      for (let i = 0; i + 1 < shuffled.length; i += 2) {
        const ref = db.collection('matches').doc();
        batch.set(ref, {
          player1_id: shuffled[i].entry_id,
          player1_name: shuffled[i].username,
          player2_id: shuffled[i + 1].entry_id,
          player2_name: shuffled[i + 1].username,
          winner_id: null,
          round: 1,
          group: groupTag,
          created_at: firebase.firestore.FieldValue.serverTimestamp()
        });
        matchCount++;
      }

      if (shuffled.length % 2 === 1) {
        const lastPlayer = shuffled[shuffled.length - 1];
        batch.update(db.collection('entries').doc(lastPlayer.id), { has_seed: true });
      }

      await batch.commit();
      showToast(matchCount + 'ÁµÑ„ÅÆÂØæÊà¶„Ç´„Éº„Éâ„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü', 'success');
      appendLog('‰∏ÄÊã¨„Éû„ÉÉ„ÉÅ„É°„Ç§„ÇØ: ' + matchCount + 'ÁµÑ');
    }
    // ===== „Ç∞„É´„Éº„Éó„Ç∑„Çπ„ÉÜ„É†„Åì„Åì„Åæ„Åß =====

    function spinRoulette() {
      if (appState.isSpinning) return;
      const a = getGroupFilteredEntries().filter(e => e.status !== 'LOST');

      // ÂÑ™ÂãùËÄÖ„ÅåÊ±∫„Åæ„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂõû„Åõ„Å™„ÅÑ
      if (a.length <= 1) {
        showToast('„Åì„ÅÆ„Ç∞„É´„Éº„Éó„ÅØÁµÇ‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åô', 'error');
        return;
      }

      // ÈÄ≤Ë°å‰∏≠„ÅÆË©¶Âêà„Åå„ÅÇ„Çã‰∫∫„ÇíÈô§Â§ñÔºà„Ç∞„É´„Éº„Éó„Éï„Ç£„É´„ÇøÔºâ
      const inMatch = getGroupFilteredMatches().filter(m => !m.winner_id);
      const inMatchIds = inMatch.flatMap(m => [m.player1_id, m.player2_id]);

      // ÂØæÊà¶ÂèØËÉΩ„Å™„Éó„É¨„Ç§„É§„ÉºÔºàÊïóÈÄÄ„Åõ„Åö„ÄÅÈÄ≤Ë°å‰∏≠„ÅÆË©¶Âêà„Åå„Å™„Åè„ÄÅ„Ç∑„Éº„ÉâÊ®©„ÇÇ„Å™„ÅÑÔºâ
      const available = a.filter(e => !inMatchIds.includes(e.entry_id) && !e.has_seed);

      // ÂØæÊà¶ÂèØËÉΩ„Å™ÂèÇÂä†ËÄÖ„Åå„ÅÑ„Å™„ÅÑ
      if (available.length === 0) {
        showToast('ÂÖ®„Å¶„ÅÆÂØæÊà¶„Ç´„Éº„Éâ„ÅåÁ¢∫ÂÆöÊ∏à„Åø„Åß„Åô', 'info');
        return;
      }

      // 1‰∫∫„Å†„ÅëÊÆã„Å£„ÅüÂ†¥Âêà ‚Üí Ëá™Âãï„Ç∑„Éº„Éâ
      if (available.length === 1) {
        autoAssignSeed(available[0]);
        return;
      }

      if (available.length < 2) { showToast('ÂØæÊà¶ÂèØËÉΩ„Å™ÂèÇÂä†ËÄÖ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô', 'error'); return; }

      // ÂØæÊà¶„Ç´„Éº„Éâ„ÇíÊ±∫ÂÆö
      appState.isSpinning = true;
      document.getElementById('spinBtn').disabled = true;
      const s = [...available].sort(() => Math.random() - 0.5);
      appState.selectedPlayer1 = s[0];
      appState.selectedPlayer2 = s[1];

      const rotation = 1800 + Math.random() * 720;

      // Firestore„Å´„É´„Éº„É¨„ÉÉ„ÉàÁä∂ÊÖã„Çí‰øùÂ≠òÔºà‰ªñ„Éá„Éê„Ç§„Çπ„Å´ÂêåÊúüÔºâ
      if (db) {
        db.collection('tournaments').doc('current').update({
          roulette_state: {
            spinning: true,
            rotation: rotation,
            player1_id: s[0].entry_id,
            player2_id: s[1].entry_id,
            seed_lottery: false,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          }
        }).catch(e => console.log('Roulette sync error:', e));
      }

      playSpinSound();

      document.getElementById('wheelInner').style.transform = 'rotate(' + rotation + 'deg)';
      setTimeout(() => {
        playVsSound();
        updateVsDisplay(appState.selectedPlayer1, appState.selectedPlayer2);
        appendLog(appState.selectedPlayer1.username + ' VS ' + appState.selectedPlayer2.username + ' „ÅÆÂØæÊà¶„ÅåÁ¢∫ÂÆö');

        // „É´„Éº„É¨„ÉÉ„ÉàÂÆå‰∫Ü ‚Üí Ëá™Âãï„ÅßÂØæÊà¶Á¢∫ÂÆöÔºàFirestore‰øùÂ≠òÔºâ
        if (db) {
          db.collection('matches').add({
            player1_id: appState.selectedPlayer1.entry_id,
            player1_name: appState.selectedPlayer1.username,
            player2_id: appState.selectedPlayer2.entry_id,
            player2_name: appState.selectedPlayer2.username,
            winner_id: null,
            round: 1,
            group: appState.activeGroup || null,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
          }).then(() => {
            enableWinnerSelection();
            showToast('ÂØæÊà¶Á¢∫ÂÆöÔºÅÂãùËÄÖ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'success');
            setTimeout(() => { checkAllMatchupsDecided(); }, 500);
          }).catch(e => showToast('„Ç®„É©„Éº: ' + e.message, 'error'));

          db.collection('tournaments').doc('current').update({
            'roulette_state.spinning': false
          }).catch(e => {});
        }

        appState.isSpinning = false;
        document.getElementById('spinBtn').disabled = false;
      }, 4000);
    }

    // ÊúÄÂæå„ÅÆ1‰∫∫„Å´Ëá™Âãï„Åß„Ç∑„Éº„ÉâÊ®©„Çí‰ªò‰∏é
    function autoAssignSeed(player) {
      appState.isSpinning = true;
      document.getElementById('spinBtn').disabled = true;

      const rotation = 1800 + Math.random() * 720;

      // Firestore„Å´„É´„Éº„É¨„ÉÉ„ÉàÁä∂ÊÖã„Çí‰øùÂ≠ò
      if (db) {
        db.collection('tournaments').doc('current').update({
          roulette_state: {
            spinning: true,
            rotation: rotation,
            seed_lottery: true,
            seed_player_id: player.entry_id,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          }
        }).catch(e => console.log('Seed sync error:', e));
      }

      playSpinSound();
      document.getElementById('wheelInner').style.transform = 'rotate(' + rotation + 'deg)';

      setTimeout(() => {
        // „Ç∑„Éº„ÉâÊ®©„Çí‰ªò‰∏é
        if (db) {
          db.collection('entries').doc(player.id).update({ has_seed: true }).catch(e => {});
        }
        player.has_seed = true;

        // VSË°®Á§∫„Çí„Ç∑„Éº„ÉâÁî®„Å´
        document.getElementById('vsOverlay').style.display = 'flex';
        document.getElementById('vsPlayer1Id').textContent = 'ID-' + String(player.entry_id).padStart(2, '0');
        document.getElementById('vsPlayer1Name').textContent = player.username;
        document.getElementById('vsPlayer1Icon').innerHTML = player.icon_url ? '<img src="' + player.icon_url + '" style="width:100%;height:100%;object-fit:cover;">' : '<svg class="silhouette-icon" viewBox="0 0 100 120"><circle cx="50" cy="30" r="22"/><path d="M10 120 Q10 70 50 65 Q90 70 90 120Z"/></svg>';
        document.getElementById('vsPlayer2Id').textContent = 'SEED';
        document.getElementById('vsPlayer2Name').textContent = '‰∏çÊà¶Âãù';
        document.getElementById('vsPlayer2Icon').innerHTML = '<span>üéñÔ∏è</span>';

        playVsSound();
        appendLog('üéñÔ∏è ' + player.username + ' „Åå„Ç∑„Éº„ÉâÊ®©„ÇíÁç≤ÂæóÔºÅÔºàÊúÄÂæå„ÅÆ1‰∫∫Ôºâ');
        showToast(player.username + ' „Åå„Ç∑„Éº„ÉâÊ®©„ÇíÁç≤ÂæóÔºÅ', 'success');

        appState.isSpinning = false;
        document.getElementById('spinBtn').disabled = false;

        updateRouletteWheel();
        updateEntriesDisplay();

        // ÂõûËª¢ÂÆå‰∫Ü„ÇíÂêåÊúü
        if (db) {
          db.collection('tournaments').doc('current').update({
            'roulette_state.spinning': false
          }).catch(e => {});
        }

        // ÂÖ®ÂØæÊà¶„Ç´„Éº„ÉâÁ¢∫ÂÆö„ÉÅ„Çß„ÉÉ„ÇØ
        checkAllMatchupsDecided();
      }, 4000);
    }
    
    // ‰ªñ„Éá„Éê„Ç§„Çπ„Åã„Çâ„ÅÆ„É´„Éº„É¨„ÉÉ„ÉàÂêåÊúü„ÇíÂá¶ÁêÜ
    function handleRouletteSync(state) {
      if (!state) return;
      
      // „Ç∑„Éº„ÉâÊäΩÈÅ∏„ÅÆÂ†¥Âêà
      if (state.seed_lottery) {
        const seedPlayer = appState.entries.find(e => e.entry_id === state.seed_player_id);
        
        if (state.spinning && !appState.isSpinning) {
          appState.isSpinning = true;
          playSpinSound();
          document.getElementById('wheelInner').style.transform = 'rotate(' + state.rotation + 'deg)';
          
          setTimeout(() => {
            if (seedPlayer) {
              document.getElementById('vsOverlay').style.display = 'flex';
              document.getElementById('vsPlayer1Id').textContent = 'ID-' + String(seedPlayer.entry_id).padStart(2, '0');
              document.getElementById('vsPlayer1Name').textContent = seedPlayer.username;
              document.getElementById('vsPlayer1Icon').innerHTML = seedPlayer.icon_url ? '<img src="' + seedPlayer.icon_url + '" style="width:100%;height:100%;object-fit:cover;">' : '<svg class="silhouette-icon" viewBox="0 0 100 120"><circle cx="50" cy="30" r="22"/><path d="M10 120 Q10 70 50 65 Q90 70 90 120Z"/></svg>';
              document.getElementById('vsPlayer2Id').textContent = 'SEED';
              document.getElementById('vsPlayer2Name').textContent = '‰∏çÊà¶Âãù';
              document.getElementById('vsPlayer2Icon').innerHTML = '<span>üéñÔ∏è</span>';
              playVsSound();
            }
            appState.isSpinning = false;
          }, 4000);
        }
        return;
      }
      
      // ÈÄöÂ∏∏„ÅÆÂØæÊà¶ÊäΩÈÅ∏„ÅÆÂ†¥Âêà
      const p1 = appState.entries.find(e => e.entry_id === state.player1_id);
      const p2 = appState.entries.find(e => e.entry_id === state.player2_id);
      
      if (state.spinning && !appState.isSpinning) {
        // ‰ªñ„Éá„Éê„Ç§„Çπ„ÅßÂõûËª¢ÈñãÂßã
        appState.isSpinning = true;
        playSpinSound();
        document.getElementById('wheelInner').style.transform = 'rotate(' + state.rotation + 'deg)';
        
        setTimeout(() => {
          playVsSound();
          if (p1 && p2) {
            appState.selectedPlayer1 = p1;
            appState.selectedPlayer2 = p2;
            updateVsDisplay(p1, p2);
          }
          appState.isSpinning = false;
        }, 4000);
      } else if (!state.spinning && p1 && p2) {
        // ÂõûËª¢ÂÆå‰∫ÜÂæå„ÅÆÁä∂ÊÖã„ÇíÂêåÊúü
        appState.selectedPlayer1 = p1;
        appState.selectedPlayer2 = p2;
        updateVsDisplay(p1, p2);
      }
    }
    
    // „É´„Éº„É¨„ÉÉ„ÉàÂõûËª¢Èü≥
    function playSpinSound() {
      if (!seEnabled) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const duration = 3.5;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sine';
        // Âë®Ê≥¢Êï∞„Çí‰∏ä„Åí„Å¶„ÅÑ„Åè
        osc.frequency.setValueAtTime(200, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + duration);
        gain.gain.setValueAtTime(seVolume * 0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + duration);
      } catch(e) { console.log('Spin sound error:', e); }
    }
    
    // ========== „Éà„Éº„Éä„É°„É≥„ÉàË°®Ê©üËÉΩ ==========
    let bracketMode = false;
    let tournamentEndedLocally = false;
    let bracketResizeTimer = null;
    window.addEventListener('resize', function() {
      if (!bracketMode) return;
      clearTimeout(bracketResizeTimer);
      bracketResizeTimer = setTimeout(function() { generateBracket(); }, 200);
    });

    // „Éà„Éº„Éä„É°„É≥„ÉàË°®„ÅÆË°®Á§∫/ÈùûË°®Á§∫Âàá„ÇäÊõø„Åà
    function toggleBracketView() {
      bracketMode = !bracketMode;
      const rouletteMain = document.querySelector('.lottery-main');
      const bracketContainer = document.getElementById('bracketContainer');
      const lotterySidebar = document.querySelector('.lottery-sidebar');
      const lotteryArena = document.getElementById('lotteryArena');
      const lotteryEntrance = document.getElementById('lotteryEntrance');
      
      if (bracketMode) {
        // „Éà„Éº„Éä„É°„É≥„ÉàË°®„ÇíÂÖ®ÁîªÈù¢Ë°®Á§∫
        rouletteMain.style.display = 'none';
        if (lotterySidebar) lotterySidebar.style.display = 'none';
        if (lotteryArena) lotteryArena.style.gridTemplateColumns = '1fr';
        if (lotteryEntrance) lotteryEntrance.style.display = 'none';
        bracketContainer.classList.add('active');
        generateBracket();
      } else {
        // „É´„Éº„É¨„ÉÉ„ÉàÁîªÈù¢„Å´Êàª„Åô
        rouletteMain.style.display = 'flex';
        if (lotterySidebar) lotterySidebar.style.display = '';
        if (lotteryArena) lotteryArena.style.gridTemplateColumns = '';
        if (lotteryEntrance) lotteryEntrance.style.display = 'none'; // ÊäΩÈÅ∏‰ºöÂ†¥ÂÜÖ„Åß„ÅØÂ∏∏„Å´ÈùûË°®Á§∫
        bracketContainer.classList.remove('active');
        // „Éà„Éº„Éä„É°„É≥„ÉàË°®„Éú„Çø„É≥„ÇíÂÜçË°®Á§∫
        updateBracketControls();
      }
    }
    
    // „Éà„Éº„Éä„É°„É≥„ÉàË°®„ÇíÁîüÊàêÔºàÁ∑ö„ÅßÂãù„Å°‰∏ä„Åå„ÇãÂΩ¢ÂºèÔºâ
    function generateBracket() {
      const container = document.getElementById('bracketContent');
      const allEntries = getGroupFilteredEntries();
      const matches = getGroupFilteredMatches();
      const isAdmin = appState.isAdmin || appState.tournament?.admin_device === appState.deviceId;

      // „Çø„Ç§„Éà„É´Êõ¥Êñ∞
      const bracketTitleEl = document.getElementById('bracketTitle');
      if (bracketTitleEl) {
        if (appState.activeGroup === 'finals') {
          bracketTitleEl.textContent = 'üèÜ Ê±∫Âãù„Éà„Éº„Éä„É°„É≥„Éà';
        } else if (appState.activeGroup && appState.tournament?.group_phase) {
          bracketTitleEl.textContent = 'üèÜ „Ç∞„É´„Éº„Éó' + appState.activeGroup + ' „Éà„Éº„Éä„É°„É≥„ÉàË°®';
        } else {
          bracketTitleEl.textContent = 'üèÜ „Éà„Éº„Éä„É°„É≥„ÉàË°®';
        }
      }

      if (allEntries.length === 0) {
        container.innerHTML = '<p style="color:var(--text-dim);text-align:center;">ÂèÇÂä†ËÄÖ„Åå„ÅÑ„Åæ„Åõ„Çì</p>';
        return;
      }
      
      // „Éñ„É©„Ç±„ÉÉ„Éà„Çµ„Ç§„Ç∫„ÇíË®àÁÆóÔºà2„ÅÆ„Åπ„Åç‰πóÔºâ
      const totalPlayers = allEntries.length;
      const rounds = Math.ceil(Math.log2(Math.max(totalPlayers, 2)));
      const bracketSize = Math.pow(2, rounds);
      
      // 1ÂõûÊà¶„ÅÆ„Çπ„É≠„ÉÉ„ÉàÈÖçÁΩÆÔºà„É´„Éº„É¨„ÉÉ„ÉàÁµêÊûú„ÅÆÂØæÊà¶„Éö„Ç¢„Å®„Ç∑„Éº„ÉâÊ®©„ÇíÂèçÊò†Ôºâ
      const bracketSlots = new Array(bracketSize).fill(null);
      const placedIds = new Set();
      let slotIdx = 0;

      // matches„ÅØcreated_atÊòáÈ†Ü„ÄÇÂêÑ„Éó„É¨„Ç§„É§„Éº„ÅÆÂàùÂõûË©¶Âêà„Éö„Ç¢„ÇíÈö£Êé•„Çπ„É≠„ÉÉ„Éà„Å´ÈÖçÁΩÆ
      matches.forEach(m => {
        if (placedIds.has(m.player1_id) || placedIds.has(m.player2_id)) return;
        const p1 = allEntries.find(e => e.entry_id === m.player1_id);
        const p2 = allEntries.find(e => e.entry_id === m.player2_id);
        if (p1 && p2 && slotIdx + 1 < bracketSize) {
          bracketSlots[slotIdx] = p1;
          bracketSlots[slotIdx + 1] = p2;
          placedIds.add(p1.entry_id);
          placedIds.add(p2.entry_id);
          slotIdx += 2;
        }
      });

      // „Ç∑„Éº„ÉâÈÅ∏Êâã„ÇíBYE„Çπ„É≠„ÉÉ„Éà„ÅÆÈö£„Å´ÈÖçÁΩÆÔºàÂÅ∂Êï∞„Çπ„É≠„ÉÉ„Éà„Å´ÈÖçÁΩÆ„ÄÅÂ•áÊï∞„Çπ„É≠„ÉÉ„Éà„ÅåBYEÔºâ
      allEntries.filter(p => p.has_seed && !placedIds.has(p.entry_id)).forEach(p => {
        if (slotIdx < bracketSize) {
          bracketSlots[slotIdx] = p;
          placedIds.add(p.entry_id);
          slotIdx += 2;
        }
      });

      // ÊÆã„Çä„ÅÆÊú™ÈÖçÁΩÆ„Éó„É¨„Ç§„É§„ÉºÔºàÈÄöÂ∏∏„ÅØ„Å™„ÅÑ„ÅåÂÆâÂÖ®Á≠ñÔºâ
      allEntries.filter(p => !placedIds.has(p.entry_id)).forEach(p => {
        for (let i = 0; i < bracketSize; i++) {
          if (!bracketSlots[i]) {
            bracketSlots[i] = p;
            break;
          }
        }
      });
      
      // ÂÑ™ÂãùËÄÖ
      const activeEntries = allEntries.filter(e => e.status !== 'LOST');
      const champion = activeEntries.length === 1 ? activeEntries[0] : null;
      
      // ÂêÑ„É©„Ç¶„É≥„Éâ„ÅÆÂãùËÄÖ„ÇíËøΩË∑°
      const roundWinners = [];
      for (let r = 0; r < rounds; r++) {
        roundWinners.push([]);
      }
      
      // ÂãùËÄÖ„ÇíËøΩË∑°„Åô„Çã„Åü„ÇÅ„ÅÆÊÉÖÂ†±„ÇíÊßãÁØâ
      const playerProgress = {}; // entry_id -> { rounds: [true/false for each round] }
      allEntries.forEach(p => {
        playerProgress[p.entry_id] = { rounds: [], slotIndex: bracketSlots.indexOf(p) };
      });
      
      // ÂêÑ„É©„Ç¶„É≥„Éâ„ÅÆÂãùËÄÖ„ÇíÁâπÂÆö
      for (let r = 0; r < rounds; r++) {
        const matchesInRound = Math.pow(2, rounds - 1 - r);

        for (let m = 0; m < matchesInRound; m++) {
          let player1 = null, player2 = null;

          if (r === 0) {
            player1 = bracketSlots[m * 2] || null;
            player2 = bracketSlots[m * 2 + 1] || null;

            // BYEÂá¶ÁêÜÔºöÁâáÊñπ„Åånull„Å™„Çâ„ÇÇ„ÅÜÁâáÊñπ„ÅåËá™ÂãïÂãùÂà©Ôºà„Ç∑„Éº„ÉâËá™ÂãïÈÄ≤Âá∫Ôºâ
            if (player1 && !player2) {
              roundWinners[r].push({
                matchIndex: m,
                winnerId: player1.entry_id,
                player1: player1,
                player2: null,
                isBye: true
              });
              if (playerProgress[player1.entry_id]) {
                playerProgress[player1.entry_id].rounds[r] = true;
              }
              continue;
            }
            if (!player1 && player2) {
              roundWinners[r].push({
                matchIndex: m,
                winnerId: player2.entry_id,
                player1: null,
                player2: player2,
                isBye: true
              });
              if (playerProgress[player2.entry_id]) {
                playerProgress[player2.entry_id].rounds[r] = true;
              }
              continue;
            }
          } else {
            const rangeSize = Math.pow(2, r + 1);
            const range1Start = m * rangeSize;
            const range2Start = m * rangeSize + rangeSize / 2;

            // Ââç„É©„Ç¶„É≥„Éâ„ÅßÂãùÂà©„Åó„Åü‰∫∫„ÇíÊé¢„ÅôÔºàBYEÂãùÂà©Âê´„ÇÄÔºâ
            const prevRoundWinnersLeft = roundWinners[r - 1].filter(w => {
              const gs = w.matchIndex * Math.pow(2, r);
              return gs >= range1Start && gs < range1Start + rangeSize / 2;
            });
            const prevRoundWinnersRight = roundWinners[r - 1].filter(w => {
              const gs = w.matchIndex * Math.pow(2, r);
              return gs >= range2Start && gs < range2Start + rangeSize / 2;
            });

            if (prevRoundWinnersLeft.length > 0) {
              const wId = prevRoundWinnersLeft[prevRoundWinnersLeft.length - 1].winnerId;
              player1 = allEntries.find(e => e.entry_id === wId) || null;
            } else {
              for (let i = range1Start; i < range1Start + rangeSize / 2 && i < bracketSlots.length; i++) {
                if (bracketSlots[i] && bracketSlots[i].status !== 'LOST') {
                  player1 = bracketSlots[i];
                  break;
                }
              }
            }
            if (prevRoundWinnersRight.length > 0) {
              const wId = prevRoundWinnersRight[prevRoundWinnersRight.length - 1].winnerId;
              player2 = allEntries.find(e => e.entry_id === wId) || null;
            } else {
              for (let i = range2Start; i < range2Start + rangeSize / 2 && i < bracketSlots.length; i++) {
                if (bracketSlots[i] && bracketSlots[i].status !== 'LOST') {
                  player2 = bracketSlots[i];
                  break;
                }
              }
            }

            // ‰∏ä‰Ωç„É©„Ç¶„É≥„Éâ„ÅÆBYEÂá¶ÁêÜÔºöÁâáÊñπ„Åå‰∏çÂú®„Å™„ÇâËá™ÂãïÈÄ≤Âá∫
            if (player1 && !player2) {
              roundWinners[r].push({
                matchIndex: m, winnerId: player1.entry_id,
                player1: player1, player2: null, isBye: true
              });
              if (playerProgress[player1.entry_id]) playerProgress[player1.entry_id].rounds[r] = true;
              continue;
            }
            if (!player1 && player2) {
              roundWinners[r].push({
                matchIndex: m, winnerId: player2.entry_id,
                player1: null, player2: player2, isBye: true
              });
              if (playerProgress[player2.entry_id]) playerProgress[player2.entry_id].rounds[r] = true;
              continue;
            }
            if (!player1 && !player2) continue;
          }

          const registeredMatch = matches.find(match =>
            (match.player1_id === player1?.entry_id && match.player2_id === player2?.entry_id) ||
            (match.player2_id === player1?.entry_id && match.player1_id === player2?.entry_id)
          );

          if (registeredMatch?.winner_id) {
            roundWinners[r].push({
              matchIndex: m,
              winnerId: registeredMatch.winner_id,
              player1: player1,
              player2: player2
            });

            if (playerProgress[registeredMatch.winner_id]) {
              playerProgress[registeredMatch.winner_id].rounds[r] = true;
            }
          }
        }
      }
      
      // ÁîªÈù¢ÂπÖ„ÇíÂèñÂæóÔºà„Éñ„É©„Ç±„ÉÉ„Éà„Ç≥„É≥„ÉÜ„Éä„ÅÆÂà©Áî®ÂèØËÉΩÂπÖÔºâ
      const containerEl = document.getElementById('bracketContainer');
      const availableWidth = (containerEl ? containerEl.clientWidth : window.innerWidth) - 32; // paddingÂàÜ„ÇíÂºï„Åè

      // „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÂü∫Ê∫ñ„ÅÆ„Çµ„Ç§„Ç∫Ôºà‰∫∫Êï∞„Å´Âøú„Åò„Å¶Ôºâ
      let baseBoxW, baseBoxH, baseGap, baseRoundH;
      if (bracketSize <= 2) {
        baseBoxW = 100; baseBoxH = 140; baseGap = 50; baseRoundH = 130;
      } else if (bracketSize <= 4) {
        baseBoxW = 80; baseBoxH = 120; baseGap = 30; baseRoundH = 120;
      } else if (bracketSize <= 8) {
        baseBoxW = 70; baseBoxH = 110; baseGap = 20; baseRoundH = 110;
      } else if (bracketSize <= 16) {
        baseBoxW = 60; baseBoxH = 100; baseGap = 15; baseRoundH = 100;
      } else {
        baseBoxW = 50; baseBoxH = 90; baseGap = 10; baseRoundH = 70;
      }

      // „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÂü∫Ê∫ñÂπÖ„Å®ÁîªÈù¢ÂπÖ„ÇíÊØîËºÉ„Åó„Å¶Á∏ÆÂ∞èÁéá„ÇíË®àÁÆó
      const desktopWidth = bracketSize * (baseBoxW + baseGap);
      const scale = Math.min(1, availableWidth / desktopWidth);

      // ÊúÄÂ∞è„Çµ„Ç§„Ç∫„ÅÆ‰∏ãÈôê„ÇíË®≠ÂÆöÔºàË™≠„ÇÅ„Å™„ÅÑ„Åª„Å©Â∞è„Åï„Åè„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ
      const boxWidth = Math.max(28, Math.round(baseBoxW * scale));
      const boxHeight = Math.max(50, Math.round(baseBoxH * scale));
      const boxGap = Math.max(4, Math.round(baseGap * scale));
      const roundHeight = Math.max(40, Math.round(baseRoundH * scale));

      const svgWidth = bracketSize * (boxWidth + boxGap);
      const lineAreaHeight = rounds * roundHeight + 30;

      // „Éò„É´„Éë„Éº: „Çπ„É≠„ÉÉ„Éài„ÅÆX‰∏≠ÂøÉÂ∫ßÊ®ô
      function slotXPos(idx) { return idx * (boxWidth + boxGap) + boxWidth / 2; }
      // „Éò„É´„Éë„Éº: „Çπ„É≠„ÉÉ„ÉàÁØÑÂõ≤„ÅÆ‰∏≠ÂøÉXÂ∫ßÊ®ô
      function groupCenterX(start, end) { return (slotXPos(start) + slotXPos(end)) / 2; }

      // HTML„ÇíÁîüÊàê
      const needsScroll = svgWidth > availableWidth;
      let html = '';
      if (needsScroll) {
        html += '<div class="bracket-scroll-hint" style="display:block;">‚Üê „Çπ„ÉØ„Ç§„Éó„Åß„Çπ„ÇØ„É≠„Éº„É´ ‚Üí</div>';
      }
      html += '<div class="bracket-tree" style="display:flex;flex-direction:column;align-items:center;">';

      // ÂÑ™ÂãùÊû†„Çµ„Ç§„Ç∫Ôºà‰∫∫Êï∞„Å®„Çπ„Ç±„Éº„É´„Å´Âøú„Åò„Å¶Êã°Á∏ÆÔºâ
      const champScale = Math.max(0.6, scale);
      const champPadV = Math.max(0.4, 0.8 * champScale);
      const champPadH = Math.max(0.6, 1.5 * champScale);
      const champPad = champPadV + 'rem ' + champPadH + 'rem';
      const champTrophy = Math.max(1, (bracketSize <= 4 ? 2 : 1.5) * champScale) + 'rem';
      const champNameSize = Math.max(0.7, (bracketSize <= 4 ? 1.2 : 1) * champScale) + 'rem';

      // ÂÑ™ÂãùÊû†ÔºàÊúÄ‰∏äÈÉ®Ôºâ
      html += `
        <div class="bracket-champion-box ${champion ? '' : 'empty'}" style="padding:${champPad};">
          <div class="champion-trophy" style="font-size:${champTrophy};">üèÜ</div>
          <div class="champion-label">ÂÑ™Âãù</div>
          <div class="champion-name" style="writing-mode:horizontal-tb;text-orientation:mixed;font-size:${champNameSize};">${champion ? escapeHtml(champion.username) : '???'}</div>
        </div>
      `;

      // SVG„Å®„Éó„É¨„Ç§„É§„Éº„ÇíÂê´„ÇÄ„Ç≥„É≥„ÉÜ„Éä
      html += `<div style="position:relative;width:${svgWidth}px;height:${lineAreaHeight + boxHeight}px;">`;

      // SVG„ÅÆÁ∑öÂπÖ„ÇÇ„Çπ„Ç±„Éº„É´
      const strokeW = Math.max(1, Math.round(2 * Math.max(0.5, scale)));
      const strokeWWin = Math.max(1.5, Math.round(3 * Math.max(0.5, scale)));

      // SVGÁ∑ö„Ç®„É™„Ç¢Ôºà„Éó„É¨„Ç§„É§„Éº„Éú„ÉÉ„ÇØ„Çπ„Å®Èáç„Å™„Çâ„Å™„ÅÑÈ´ò„ÅïÔºâ
      html += `<svg class="bracket-lines" width="${svgWidth}" height="${lineAreaHeight}" style="position:absolute;top:0;left:0;" overflow="hidden">`;

      // === „Éë„Çπ1: ÂÖ®„Éà„Éº„Éä„É°„É≥„ÉàÁµåË∑Ø„ÅÆÈ™®Ê†ºÁ∑öÔºàËñÑ„ÅÑÁ∑ëÔºâ ===
      for (let r = 0; r < rounds; r++) {
        const numMatches = Math.pow(2, rounds - 1 - r);
        for (let m = 0; m < numMatches; m++) {
          const groupSize = Math.pow(2, r + 1);
          const halfSize = Math.pow(2, r);
          const groupStart = m * groupSize;

          let leftX, rightX;
          if (r === 0) {
            leftX = slotXPos(groupStart);
            rightX = slotXPos(groupStart + 1);
          } else {
            leftX = groupCenterX(groupStart, groupStart + halfSize - 1);
            rightX = groupCenterX(groupStart + halfSize, groupStart + groupSize - 1);
          }

          const bottomY = lineAreaHeight - r * roundHeight;
          const topY = lineAreaHeight - (r + 1) * roundHeight;

          // Â∑¶ÂÅ¥ÂûÇÁõ¥Á∑ö
          html += `<line x1="${leftX}" y1="${bottomY}" x2="${leftX}" y2="${topY}" class="bracket-line" style="stroke-width:${strokeW};" />`;
          // Âè≥ÂÅ¥ÂûÇÁõ¥Á∑ö
          html += `<line x1="${rightX}" y1="${bottomY}" x2="${rightX}" y2="${topY}" class="bracket-line" style="stroke-width:${strokeW};" />`;
          // ‰∏äÈÉ®Ê∞¥Âπ≥Á∑ö
          html += `<line x1="${leftX}" y1="${topY}" x2="${rightX}" y2="${topY}" class="bracket-line" style="stroke-width:${strokeW};" />`;
        }
      }

      // Ê±∫Âãù‚ÜíÂÑ™Âãù„Å∏„ÅÆ‰∏≠Â§ÆÁ∑öÔºàÈ™®Ê†ºÔºâ
      const finalHalf = Math.pow(2, rounds - 1);
      const finalLeftX = rounds === 1 ? slotXPos(0) : groupCenterX(0, finalHalf - 1);
      const finalRightX = rounds === 1 ? slotXPos(1) : groupCenterX(finalHalf, bracketSize - 1);
      const finalCenterX = (finalLeftX + finalRightX) / 2;
      const finalTopY = lineAreaHeight - rounds * roundHeight;
      html += `<line x1="${finalCenterX}" y1="${finalTopY}" x2="${finalCenterX}" y2="0" class="bracket-line" style="stroke-width:${strokeW};" />`;

      // === „Éë„Çπ2: ÂãùËÄÖ„ÅÆÁµåË∑ØÔºàÊòé„Çã„ÅÑÁ∑ë„ÅßÁô∫ÂÖâÔºâ ===
      for (let r = 0; r < rounds; r++) {
        const numMatches = Math.pow(2, rounds - 1 - r);
        for (let m = 0; m < numMatches; m++) {
          const rw = roundWinners[r].find(w => w.matchIndex === m);
          if (!rw) continue;

          const groupSize = Math.pow(2, r + 1);
          const halfSize = Math.pow(2, r);
          const groupStart = m * groupSize;

          let leftX, rightX;
          if (r === 0) {
            leftX = slotXPos(groupStart);
            rightX = slotXPos(groupStart + 1);
          } else {
            leftX = groupCenterX(groupStart, groupStart + halfSize - 1);
            rightX = groupCenterX(groupStart + halfSize, groupStart + groupSize - 1);
          }

          const bottomY = lineAreaHeight - r * roundHeight;
          const topY = lineAreaHeight - (r + 1) * roundHeight;
          const centerX = (leftX + rightX) / 2;

          // ÂãùËÄÖ„Åå„Å©„Å°„ÇâÂÅ¥„ÅãÂà§ÂÆö
          const winnerSlotIdx = bracketSlots.findIndex(s => s && s.entry_id === rw.winnerId);
          const isLeftWinner = winnerSlotIdx >= groupStart && winnerSlotIdx < groupStart + halfSize;
          const winnerX = isLeftWinner ? leftX : rightX;

          // ÂãùËÄÖ„ÅÆÂûÇÁõ¥Á∑öÔºàÊòé„Çã„ÅÑÁ∑ëÔºâ
          html += `<line x1="${winnerX}" y1="${bottomY}" x2="${winnerX}" y2="${topY}" class="bracket-line winner" style="stroke-width:${strokeWWin};" />`;
          // ÂãùËÄÖ„Åã„Çâ‰∏≠Â§Æ„Å∏„ÅÆÊ∞¥Âπ≥Á∑öÔºàÊòé„Çã„ÅÑÁ∑ëÔºâ
          html += `<line x1="${winnerX}" y1="${topY}" x2="${centerX}" y2="${topY}" class="bracket-line winner" style="stroke-width:${strokeWWin};" />`;
        }
      }

      // ÂÑ™ÂãùËÄÖ„ÅÆÊ±∫Âãù‚ÜíÂÑ™ÂãùÁ∑öÔºàÊòé„Çã„ÅÑÁ∑ëÔºâ
      if (champion) {
        html += `<line x1="${finalCenterX}" y1="${finalTopY}" x2="${finalCenterX}" y2="0" class="bracket-line winner" style="stroke-width:${strokeWWin};" />`;
      }

      html += '</svg>';

      // „Éó„É¨„Ç§„É§„Éº„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫Ôºà„Çπ„Ç±„Éº„É´„Å´Âøú„Åò„Å¶Á∏ÆÂ∞èÔºâ
      const baseNameSize = bracketSize <= 2 ? 1 : (bracketSize <= 4 ? 0.9 : 0.8);
      const baseIdSize = bracketSize <= 4 ? 0.7 : 0.6;
      const nameFontSize = Math.max(0.5, baseNameSize * Math.max(0.65, scale)) + 'rem';
      const idFontSize = Math.max(0.4, baseIdSize * Math.max(0.65, scale)) + 'rem';
      const nameMaxH = Math.max(30, Math.round(80 * scale));
      const boxPad = Math.max(2, Math.round(8 * scale));
      const boxStyle = `width:${boxWidth}px;min-height:${boxHeight}px;padding:${boxPad}px ${Math.max(2, Math.round(4 * scale))}px;`;

      // „Éó„É¨„Ç§„É§„Éº„Éú„ÉÉ„ÇØ„ÇπÔºàSVG„ÅÆÁõ¥‰∏ã„ÄÅÈáç„Å™„Çâ„Å™„ÅÑ‰ΩçÁΩÆ„Å´ÈÖçÁΩÆÔºâ
      html += `<div class="bracket-round-row" style="position:absolute;top:${lineAreaHeight}px;left:0;right:0;display:flex;justify-content:center;gap:${boxGap}px;">`;

      for (let i = 0; i < bracketSize; i++) {
        const player = bracketSlots[i];

        if (!player) {
          // BYE„Çπ„É≠„ÉÉ„Éà„ÅØÈùûË°®Á§∫Ôºà„Çπ„Éö„Éº„Çπ„ÅÆ„ÅøÁ¢∫‰øùÔºâ
          html += `<div style="${boxStyle};visibility:hidden;"></div>`;
          continue;
        }

        // ÂØæÊà¶Áõ∏Êâã„ÇíÁâπÂÆö
        const pairIndex = (i % 2 === 0) ? i + 1 : i - 1;
        const opponent = bracketSlots[pairIndex] || null;
        const isByeWin = !opponent;

        // 1ÂõûÊà¶„ÅÆË©¶Âêà„ÇíÊ§úÁ¥¢
        const match = !isByeWin ? matches.find(mt =>
          (mt.player1_id === player.entry_id && mt.player2_id === opponent.entry_id) ||
          (mt.player2_id === player.entry_id && mt.player1_id === opponent.entry_id)
        ) : null;

        const winnerId = match?.winner_id;
        const isPending = match && !winnerId;
        const isWinner = isByeWin || winnerId === player.entry_id;
        const isLoser = !isByeWin && winnerId && winnerId !== player.entry_id;
        const hasSeed = player.has_seed;
        const canClick = isAdmin && isPending && opponent;

        const classes = [
          'bracket-player-box',
          isWinner ? 'winner' : '',
          isLoser ? 'loser' : '',
          hasSeed ? 'seed' : '',
          canClick ? 'clickable' : '',
          isPending ? 'active' : ''
        ].filter(Boolean).join(' ');

        html += `
          <div class="${classes}" style="${boxStyle}" data-slot="${i}"
            ${canClick ? `onclick="selectBracketWinner(${player.entry_id}, ${opponent.entry_id}, '${escapeHtml(player.username)}', '${escapeHtml(opponent.username)}')"` : ''}>
            ${isWinner && !isByeWin ? '<span class="winner-mark">üèÜ</span>' : ''}
            ${hasSeed ? '<span class="seed-mark">üéñÔ∏è</span>' : ''}
            <span class="player-name-v" style="font-size:${nameFontSize};max-height:${nameMaxH}px;">${escapeHtml(player.username)}</span>
            <span class="player-id-v" style="font-size:${idFontSize};">${String(player.entry_id).padStart(2, '0')}</span>
          </div>
        `;
      }

      html += '</div>'; // bracket-round-row

      // === ‰∏ä‰Ωç„É©„Ç¶„É≥„Éâ„ÅÆ„Éû„ÉÉ„ÉÅËá™Âãï‰ΩúÊàê + „Ç∏„É£„É≥„ÇØ„Ç∑„Éß„É≥„Å´VS„Éú„Çø„É≥Ë°®Á§∫ ===
      const vsBtnSize = Math.max(24, Math.round(30 * Math.max(0.6, scale)));

      for (let r = 1; r < rounds; r++) {
        const numMatchesInRound = Math.pow(2, rounds - 1 - r);
        for (let m = 0; m < numMatchesInRound; m++) {
          const groupSize = Math.pow(2, r + 1);
          const halfSize = Math.pow(2, r);
          const groupStart = m * groupSize;

          let p1 = null, p2 = null;
          const prevWL = roundWinners[r - 1].filter(w => {
            const gs = w.matchIndex * Math.pow(2, r);
            return gs >= groupStart && gs < groupStart + halfSize;
          });
          const prevWR = roundWinners[r - 1].filter(w => {
            const gs = w.matchIndex * Math.pow(2, r);
            return gs >= groupStart + halfSize && gs < groupStart + groupSize;
          });
          if (prevWL.length > 0) p1 = allEntries.find(e => e.entry_id === prevWL[prevWL.length - 1].winnerId);
          if (prevWR.length > 0) p2 = allEntries.find(e => e.entry_id === prevWR[prevWR.length - 1].winnerId);

          if (!p1 && !p2) continue;

          const rw = roundWinners[r].find(w => w.matchIndex === m);
          if (rw && rw.isBye) continue;
          const winnerId = rw ? rw.winnerId : null;

          // ‰∏°ËÄÖÊèÉ„Å£„ÅüÂ†¥Âêà„ÅÆ„Éû„ÉÉ„ÉÅ‰ΩúÊàê„ÉªVS„Éú„Çø„É≥Ë°®Á§∫
          if (p1 && p2) {
            const matchRecord = matches.find(mt =>
              (mt.player1_id === p1.entry_id && mt.player2_id === p2.entry_id) ||
              (mt.player2_id === p1.entry_id && mt.player1_id === p2.entry_id)
            );
            const needsMatch = !matchRecord && !winnerId;

            // ÁÆ°ÁêÜËÄÖ„Å™„ÇâÊú™‰ΩúÊàê„ÅÆ„Éû„ÉÉ„ÉÅ„ÇíËá™Âãï‰ΩúÊàê
            if (needsMatch && isAdmin && db) {
              const key = p1.entry_id + '_' + p2.entry_id + '_r' + r;
              if (!window._bracketMatchCreating) window._bracketMatchCreating = {};
              if (!window._bracketMatchCreating[key]) {
                window._bracketMatchCreating[key] = true;
                db.collection('matches').add({
                  player1_id: p1.entry_id,
                  player1_name: p1.username,
                  player2_id: p2.entry_id,
                  player2_name: p2.username,
                  winner_id: null,
                  round: r + 1,
                  group: appState.activeGroup || null,
                  created_at: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => { delete window._bracketMatchCreating[key]; })
                  .catch(e => { delete window._bracketMatchCreating[key]; });
              }
            }

            // Ê∞¥Âπ≥Á∑ö„ÅÆ‰∏≠Â§Æ„Å´VS„Éú„Çø„É≥„ÇíÈÖçÁΩÆÔºàÂãùËÄÖÊú™Ê±∫ÂÆöÊôÇ„ÅÆ„Åø„ÉªÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÔºâ
            const leftX = groupCenterX(groupStart, groupStart + halfSize - 1);
            const rightX = groupCenterX(groupStart + halfSize, groupStart + groupSize - 1);
            const centerX = (leftX + rightX) / 2;
            const junctionY = lineAreaHeight - (r + 1) * roundHeight;
            const isPending = (matchRecord && !matchRecord.winner_id) || needsMatch;

            if (isPending && isAdmin) {
              html += `<div class="bracket-vs-btn" style="position:absolute;left:${centerX - vsBtnSize / 2}px;top:${junctionY - vsBtnSize / 2}px;width:${vsBtnSize}px;height:${vsBtnSize}px;cursor:pointer;z-index:5;"
                onclick="showUpperRoundMatch(${p1.entry_id}, '${escapeHtml(p1.username)}', ${p2.entry_id}, '${escapeHtml(p2.username)}')">
                <span style="font-size:${Math.max(0.6, 0.8 * scale)}rem;">VS</span>
              </div>`;
            }
          }
        }
      }

      html += '</div>'; // SVG„Å®„Éó„É¨„Ç§„É§„Éº„ÅÆ„Ç≥„É≥„ÉÜ„Éä
      html += '</div>'; // bracket-tree

      container.innerHTML = html;
      
      // ÁÆ°ÁêÜËÄÖÁî®ÁµÇ‰∫Ü„Éú„Çø„É≥„ÅÆË°®Á§∫Âà∂Âæ°
      const bracketEndBtn = document.getElementById('bracketEndBtn');
      if (bracketEndBtn) {
        if (isAdmin) {
          bracketEndBtn.style.display = '';
        } else {
          bracketEndBtn.style.display = 'none';
        }
      }
    }
    
    // „Éñ„É©„Ç±„ÉÉ„Éà„Éó„É¨„Ç§„É§„Éº„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
    function renderBracketPlayer(player, opponent, winnerId, isPending, isAdmin, side) {
      if (!player) {
        return `<div class="bracket-player-box empty ${side}"><span class="player-name-v">BYE</span></div>`;
      }
      
      const isWinner = winnerId === player.entry_id;
      const isLoser = winnerId && winnerId !== player.entry_id;
      const hasSeed = player.has_seed;
      const canClick = isAdmin && isPending && opponent;
      
      const classes = [
        'bracket-player-box',
        side,
        isWinner ? 'winner' : '',
        isLoser ? 'loser' : '',
        hasSeed ? 'seed' : '',
        canClick ? 'clickable' : '',
        isPending ? 'active' : ''
      ].filter(Boolean).join(' ');
      
      return `
        <div class="${classes}"
          ${canClick ? `onclick="selectBracketWinner(${player.entry_id}, ${opponent.entry_id}, '${escapeHtml(player.username)}', '${escapeHtml(opponent.username)}')"` : ''}>
          ${isWinner ? '<span class="winner-mark">üèÜ</span>' : ''}
          ${hasSeed ? '<span class="seed-mark">üéñÔ∏è</span>' : ''}
          <span class="player-name-v">${escapeHtml(player.username)}</span>
          <span class="player-id-v">${String(player.entry_id).padStart(2, '0')}</span>
        </div>
      `;
    }
    
    // ÊóßÈñ¢Êï∞Ôºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
    function renderSlotVertical(player, opponent, winnerId, isPending, isAdmin) {
      return renderBracketPlayer(player, opponent, winnerId, isPending, isAdmin, 'left');
    }
    function renderSlot(player, opponent, winnerId, isPending, isAdmin, position, isByeMatch = false) {
      return renderBracketPlayer(player, opponent, winnerId, isPending, isAdmin, 'left');
    }
    
    // Ë©¶Âêà„ÅÆHTML„ÇíÁîüÊàê
    function generateMatchHtml(match, p1, p2, canDecide) {
      const isAdmin = appState.isAdmin || appState.tournament?.admin_device === appState.deviceId;
      const isWinner1 = match.winner_id === p1?.entry_id;
      const isWinner2 = match.winner_id === p2?.entry_id;
      const hasWinner = !!match.winner_id;
      
      const clickable = canDecide && isAdmin && !hasWinner;
      
      let html = `<div class="bracket-match${canDecide ? ' deciding' : ''}">`;
      
      if (p1) {
        const statusLabel = isWinner1 ? '<span style="color:var(--hud-gold);font-size:0.75rem;margin-left:auto;">üèÜ ÂãùËÄÖ</span>' : (hasWinner ? '<span style="color:#666;font-size:0.75rem;margin-left:auto;">ÊïóÈÄÄ</span>' : '');
        html += `<div class="bracket-player ${isWinner1 ? 'winner' : (hasWinner ? 'loser' : '')} ${clickable ? 'clickable' : ''}" 
          ${clickable ? `onclick="selectBracketWinner(${match.player1_id}, ${match.player2_id}, '${escapeHtml(p1.username)}', '${escapeHtml(p2?.username || '')}')"` : ''}>
          <span class="bracket-player-id">ID-${String(p1.entry_id).padStart(2,'0')}</span>
          <span class="bracket-player-name">${escapeHtml(p1.username)}</span>
          ${statusLabel}
        </div>`;
      }
      
      if (p2) {
        const statusLabel = isWinner2 ? '<span style="color:var(--hud-gold);font-size:0.75rem;margin-left:auto;">üèÜ ÂãùËÄÖ</span>' : (hasWinner ? '<span style="color:#666;font-size:0.75rem;margin-left:auto;">ÊïóÈÄÄ</span>' : '');
        html += `<div class="bracket-player ${isWinner2 ? 'winner' : (hasWinner ? 'loser' : '')} ${clickable ? 'clickable' : ''}"
          ${clickable ? `onclick="selectBracketWinner(${match.player2_id}, ${match.player1_id}, '${escapeHtml(p2.username)}', '${escapeHtml(p1?.username || '')}')"` : ''}>
          <span class="bracket-player-id">ID-${String(p2.entry_id).padStart(2,'0')}</span>
          <span class="bracket-player-name">${escapeHtml(p2.username)}</span>
          ${statusLabel}
        </div>`;
      }
      
      html += '</div>';
      return html;
    }
    
    // ‰∏ä‰Ωç„É©„Ç¶„É≥„Éâ„ÅÆÂØæÊà¶ÔºöVS„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´ÂãùËÄÖÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    function showUpperRoundMatch(p1Id, p1Name, p2Id, p2Name) {
      const isAdmin = appState.isAdmin || appState.tournament?.admin_device === appState.deviceId;
      if (!isAdmin) return;

      // upperRoundPicker„É¢„Éº„ÉÄ„É´„ÇíÂãïÁöÑÁîüÊàê„Åó„Å¶Ë°®Á§∫
      let picker = document.getElementById('upperRoundPicker');
      if (!picker) {
        picker = document.createElement('div');
        picker.className = 'modal-overlay';
        picker.id = 'upperRoundPicker';
        document.body.appendChild(picker);
      }
      picker.innerHTML = `
        <div class="modal-content" style="max-width:360px;">
          <button class="modal-close-btn" onclick="hideModal('upperRoundPicker')">√ó</button>
          <h3 class="modal-title" style="color:var(--hud-gold);">ÂãùËÄÖ„ÇíÈÅ∏Êäû</h3>
          <p style="text-align:center;color:var(--text-dim);margin:0.5rem 0;font-size:0.85rem;">„ÇØ„É™„ÉÉ„ÇØ„ÅßÂãùËÄÖ„ÇíÁ¢∫ÂÆö„Åó„Åæ„Åô</p>
          <div style="display:flex;gap:0.8rem;justify-content:center;margin:1rem 0;">
            <button class="modal-btn" style="background:var(--hud-green);border-color:var(--hud-green);padding:0.7rem 1.2rem;font-size:1rem;cursor:pointer;flex:1;"
              onclick="hideModal('upperRoundPicker');selectBracketWinner(${p1Id}, ${p2Id}, '${p1Name.replace(/'/g, "\\'")}', '${p2Name.replace(/'/g, "\\'")}')">
              ${p1Name}
            </button>
            <span style="color:var(--hud-gold);font-size:1.3rem;align-self:center;font-weight:bold;">VS</span>
            <button class="modal-btn" style="background:var(--hud-green);border-color:var(--hud-green);padding:0.7rem 1.2rem;font-size:1rem;cursor:pointer;flex:1;"
              onclick="hideModal('upperRoundPicker');selectBracketWinner(${p2Id}, ${p1Id}, '${p2Name.replace(/'/g, "\\'")}', '${p1Name.replace(/'/g, "\\'")}')">
              ${p2Name}
            </button>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="hideModal('upperRoundPicker')">„Ç≠„É£„É≥„Çª„É´</button>
          </div>
        </div>`;
      showModal('upperRoundPicker');
    }

    // „Éà„Éº„Éä„É°„É≥„ÉàË°®„Åã„ÇâÂãùËÄÖ„ÇíÈÅ∏Êäû
    function selectBracketWinner(winnerId, loserId, winnerName, loserName) {
      // ÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÊìç‰ΩúÂèØËÉΩ
      const isAdmin = appState.isAdmin || appState.tournament?.admin_device === appState.deviceId;
      if (!isAdmin) {
        return; // ‰Ωï„ÇÇÂèçÂøú„Åó„Å™„ÅÑ
      }

      const winner = appState.entries.find(e => e.entry_id === winnerId);
      const loser = appState.entries.find(e => e.entry_id === loserId);

      if (!winner || !loser) {
        showToast('„Éó„É¨„Ç§„É§„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
        return;
      }

      // „É´„Éº„É¨„ÉÉ„ÉàÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢ÔºàexecuteWinner„Åß„Éñ„É©„Ç±„ÉÉ„ÉàÁî®„ÅÆÊ§úÁ¥¢„Çí‰Ωø„ÅÜ„Åü„ÇÅÔºâ
      appState.selectedPlayer1 = null;
      appState.selectedPlayer2 = null;

      appState.pendingWinner = { winner, loser };
      document.getElementById('confirmWinnerText').textContent = winnerName + ' „ÇíÂãùËÄÖ„Å´„Åó„Åæ„Åô„ÅãÔºü';
      showModal('confirmWinnerModal');
    }
    
    // „Éà„Éº„Éä„É°„É≥„ÉàË°®„Éú„Çø„É≥„ÅÆË°®Á§∫Âà∂Âæ°
    function updateBracketControls() {
      const controls = document.getElementById('bracketControls');
      if (!controls) return;

      const filteredEntries = getGroupFilteredEntries();
      const activeCount = filteredEntries.filter(e => e.status !== 'LOST').length;
      const matchCount = getGroupFilteredMatches().length;

      // Êù°‰ª∂ÔºöÂØæÊà¶„Åå1„Å§‰ª•‰∏äÁ¢∫ÂÆö„Åó„Å¶„ÅÑ„Çã„ÄÅ„Åã„Å§21Âêç‰ª•‰∏ã
      if (matchCount >= 1 && activeCount <= 21 && activeCount >= 1) {
        controls.style.display = 'flex';
      } else {
        controls.style.display = 'none';
      }
    }

    // ÂÖ®ÂØæÊà¶„Ç´„Éº„Éâ„ÅåÁ¢∫ÂÆö„Åó„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÄÅÁ¢∫ÂÆöÊ∏à„Åø„Å™„Çâ„Éà„Éº„Éä„É°„É≥„ÉàË°®„ÇíË°®Á§∫
    function checkAllMatchupsDecided() {
      // „Éñ„É©„Ç±„ÉÉ„ÉàË°®Á§∫‰∏≠„ÅØËá™Âãï„Éû„ÉÉ„ÉÅ„É°„Ç§„ÇØ„Åó„Å™„ÅÑÔºà„Éñ„É©„Ç±„ÉÉ„Éà„ÅåÈÄ≤Ë°å„ÇíÁÆ°ÁêÜÔºâ
      if (bracketMode) return;

      const active = getGroupFilteredEntries().filter(e => e.status !== 'LOST');
      const inMatch = getGroupFilteredMatches().filter(m => !m.winner_id);
      const inMatchIds = inMatch.flatMap(m => [m.player1_id, m.player2_id]);
      const unmatched = active.filter(e => !inMatchIds.includes(e.entry_id) && !e.has_seed);

      // Êú™„Éû„ÉÉ„ÉÅ„ÅÆ‰∫∫„Åå1‰∫∫‚ÜíËá™Âãï„Ç∑„Éº„Éâ‰ªò‰∏é
      // ÔºàÁèæ„Éï„Çß„Éº„Ç∫ÂÜÖ„Åß„Åæ„Å†ÂãùÂà©„Åó„Å¶„ÅÑ„Å™„ÅÑÈÅ∏Êâã„ÅÆ„Åø„ÄÇÁµ±Âêà„Éï„Çß„Éº„Ç∫„Åß„ÅØÁµ±ÂêàÂæå„ÅÆ„Éû„ÉÉ„ÉÅ„ÅÆ„Åø„ÉÅ„Çß„ÉÉ„ÇØÔºâ
      if (unmatched.length === 1) {
        const player = unmatched[0];
        const currentPhaseMatches = getGroupFilteredMatches();
        const hasWonInPhase = currentPhaseMatches.some(m => m.winner_id === player.entry_id);
        if (!hasWonInPhase) {
          autoAssignSeed(unmatched[0]);
          return;
        }
      }

      // ÂÖ®Âì°„Åå„Éû„ÉÉ„ÉÅÊ∏à„Åø„Åæ„Åü„ÅØ„Ç∑„Éº„ÉâÊ∏à„Åø ‚Üí „Éà„Éº„Éä„É°„É≥„ÉàË°®„Éú„Çø„É≥„ÇíË°®Á§∫
      if (unmatched.length === 0 && getGroupFilteredMatches().length > 0) {
        updateBracketControls();
        if (!bracketMode) {
          const groupLabel = appState.activeGroup && appState.activeGroup !== 'finals' ? '„Ç∞„É´„Éº„Éó' + appState.activeGroup + '„ÅÆ' : '';
          showToast(groupLabel + 'ÂÖ®ÂØæÊà¶„Ç´„Éº„Éâ„ÅåÁ¢∫ÂÆö„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
        }
      }
    }
    
    
    
    // ÂãùËÄÖÈÅ∏Êäû„ÇíÊúâÂäπÂåñ
    function enableWinnerSelection() {
      const p1Box = document.getElementById('vsPlayer1Box');
      const p2Box = document.getElementById('vsPlayer2Box');
      const helpText = document.getElementById('vsHelp');
      if (p1Box) p1Box.classList.add('clickable');
      if (p2Box) p2Box.classList.add('clickable');
      if (helpText) helpText.style.display = 'block';
    }
    
    // ÂãùËÄÖÈÅ∏Êäû„ÇíÁÑ°ÂäπÂåñ
    function disableWinnerSelection() {
      const p1Box = document.getElementById('vsPlayer1Box');
      const p2Box = document.getElementById('vsPlayer2Box');
      const helpText = document.getElementById('vsHelp');
      if (p1Box) { p1Box.classList.remove('clickable'); p1Box.classList.remove('winner-selected'); }
      if (p2Box) { p2Box.classList.remove('clickable'); p2Box.classList.remove('winner-selected'); }
      if (helpText) helpText.style.display = 'none';
    }
    
    // ÂØæÊà¶„Ç´„Éº„Éâ„Åã„ÇâÂãùËÄÖ„ÇíÈÅ∏Êäû
    function selectWinnerFromCard(playerNum) {
      const isAdmin = appState.isAdmin || appState.tournament?.admin_device === appState.deviceId;
      if (!isAdmin) return;
      
      const p1Box = document.getElementById('vsPlayer1Box');
      const p2Box = document.getElementById('vsPlayer2Box');
      
      // „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Åß„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
      if (!p1Box.classList.contains('clickable')) return;
      
      // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíË°®Á§∫
      if (playerNum === 1) {
        p1Box.classList.add('winner-selected');
        p2Box.classList.remove('winner-selected');
      } else {
        p2Box.classList.add('winner-selected');
        p1Box.classList.remove('winner-selected');
      }
      
      // declareWinner„ÇíÂëº„Å≥Âá∫„Åô
      declareWinner(playerNum);
    }
    
    function declareWinner(n) { appState.pendingWinner = { winner: n === 1 ? appState.selectedPlayer1 : appState.selectedPlayer2, loser: n === 1 ? appState.selectedPlayer2 : appState.selectedPlayer1 }; document.getElementById('confirmWinnerText').textContent = appState.pendingWinner.winner.username; showModal('confirmWinnerModal'); }
    async function executeWinner() { 
      if (!db) return; 
      
      // ÁÆ°ÁêÜËÄÖ„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥„ÉÅ„Çß„ÉÉ„ÇØ
      const cd = await checkCooldown('admin');
      if (cd.blocked) { hideModal('confirmWinnerModal'); showToast('Áü≠ÊôÇÈñì„ÅßÁôªÈå≤„ÉªËß£Èô§„ÇíÁπ∞„ÇäËøî„Åó„Åü„Åü„ÇÅ„ÄÅ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑÔºàÊÆã„Çä' + cd.remaining + 'ÂàÜÔºâ', 'error'); return; }
      
      const { winner, loser } = appState.pendingWinner; 
      playClick(); 
      appendLog(winner.username + '„ÅåÂãùÂà©Ôºà' + loser.username + 'ÊïóÈÄÄÔºâ'); 
      
      // „Éû„ÉÉ„ÉÅ„ÇíÊé¢„ÅôÔºà„É´„Éº„É¨„ÉÉ„ÉàÁµåÁî± or „Éà„Éº„Éä„É°„É≥„ÉàË°®ÁµåÁî±Ôºâ
      let m = null;
      if (appState.selectedPlayer1 && appState.selectedPlayer2) {
        m = appState.matches.find(x => x.player1_id === appState.selectedPlayer1.entry_id && x.player2_id === appState.selectedPlayer2.entry_id && !x.winner_id);
      } else {
        // „Éà„Éº„Éä„É°„É≥„ÉàË°®„Åã„ÇâÈÅ∏„Çì„Å†Â†¥Âêà
        m = appState.matches.find(x => ((x.player1_id === winner.entry_id && x.player2_id === loser.entry_id) || (x.player1_id === loser.entry_id && x.player2_id === winner.entry_id)) && !x.winner_id);
      }
      
      if (m) db.collection('matches').doc(m.id).update({ winner_id: winner.entry_id, winner_name: winner.username }); 
      const le = appState.entries.find(e => e.entry_id === loser.entry_id); 
      if (le) db.collection('entries').doc(le.id).update({ status: 'LOST' }); 
      
      hideModal('confirmWinnerModal');
      disableWinnerSelection(); // ÂãùËÄÖÈÅ∏Êäû„ÇíÁÑ°ÂäπÂåñ
      appState.selectedPlayer1 = null;
      appState.selectedPlayer2 = null;
      updateVsDisplay(null, null);
      document.getElementById('wheelInner').style.transform = 'rotate(0deg)';
      showToast('ÂãùËÄÖ„ÇíÁ¢∫ÂÆö„Åó„Åæ„Åó„Åü', 'success');
      checkAndUpdateStatus();
      updateBracketControls(); // „Éà„Éº„Éä„É°„É≥„ÉàË°®„Éú„Çø„É≥„ÇíÂÜçË°®Á§∫

      // „Éà„Éº„Éä„É°„É≥„ÉàË°®„ÇíÊõ¥Êñ∞
      if (bracketMode) generateBracket();

      // „Ç∞„É´„Éº„ÉóÂãùËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ
      checkGroupWinner(winner, loser);
    }

    // „Ç∞„É´„Éº„ÉóÁµ±Âêà„ÉÅ„Çß„ÉÉ„ÇØÔºàÂÖ®„Ç∞„É´„Éº„ÉóÂêàË®à„ÅÆÁîüÂ≠òËÄÖ„Åå21‰∫∫‰ª•‰∏ã„Å´„Å™„Å£„Åü„ÇâÁµ±ÂêàÔºâ
    function checkGroupWinner(winner, loser) {
      if (!db) return;
      const phase = appState.tournament?.group_phase;
      if (!phase || phase === 'none' || phase === 'merged') return;

      const currentGroup = appState.activeGroup;
      if (!currentGroup || currentGroup === 'finals') return;

      // ÊïóËÄÖ„Åå„Åæ„Å† entries „Å´ÂèçÊò†„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅloser „ÇíÊâãÂãï„ÅßÈô§Â§ñ
      const allActive = appState.entries.filter(e => e.status !== 'LOST' && e.entry_id !== loser.entry_id);

      // ÂÖ®„Ç∞„É´„Éº„ÉóÂêàË®à„ÅÆÁîüÂ≠òËÄÖ„Åå21‰∫∫‰ª•‰∏ã ‚Üí „Ç∞„É´„Éº„ÉóÁµ±Âêà
      if (allActive.length <= 21) {
        // ÂÖ®„Ç®„É≥„Éà„É™„Éº„ÅÆgroup„Éªhas_seed„Çí„ÇØ„É™„Ç¢ÔºàÁµ±Âêà„Éª„Ç∑„Éº„Éâ„É™„Çª„ÉÉ„ÉàÔºâ
        const batch = db.batch();
        appState.entries.forEach(e => {
          batch.update(db.collection('entries').doc(e.id), { group: null, has_seed: false });
        });
        batch.update(db.collection('tournaments').doc('current'), {
          group_phase: 'merged',
          active_group: null,
          groups_assigned: false
        });
        batch.commit().then(() => {
          appState.activeGroup = null;
          appState.groupPhase = 'merged';
          appState.entries.forEach(e => { e.group = null; e.has_seed = false; });
          renderGroupTabs();
          updateEntriesDisplay();
          updateRouletteWheel();
          updateBracketControls();
          showToast('ÂÖ®„Ç∞„É´„Éº„ÉóÁµ±ÂêàÔºÅÊÆã„Çä' + allActive.length + 'Âêç„ÅßÊúÄÁµÇ„É´„Éº„É¨„ÉÉ„Éà„Å∏', 'success');
          appendLog('„Ç∞„É´„Éº„ÉóÁµ±Âêà: ÊÆã„Çä' + allActive.length + 'Âêç ‚Üí ÊúÄÁµÇ„É´„Éº„É¨„ÉÉ„Éà');
        });
        return;
      }

      // „Åæ„Å†21‰∫∫Ë∂Ö ‚Üí „Ç∞„É´„Éº„ÉóÂÜÖ„ÅÆÊÆã„Çä‰∫∫Êï∞Ë°®Á§∫„ÅÆ„ÅøÊõ¥Êñ∞
      const groupEntries = appState.entries.filter(e => e.group === currentGroup);
      const activeInGroup = groupEntries.filter(e => e.status !== 'LOST' && e.entry_id !== loser.entry_id);
      renderGroupTabs();
      updateEntriesDisplay();
      updateRouletteWheel();
    }

    // Â§ß‰ºöÁµÇ‰∫ÜÁ¢∫Ë™ç
    function confirmEndTournament() {
      const select = document.getElementById('championSelect');
      const desc = document.getElementById('endTournamentDesc');
      const selectGroup = document.getElementById('championSelectGroup');
      const active = appState.entries.filter(e => e.status !== 'LOST');

      if (active.length === 1) {
        // ÂÑ™ÂãùËÄÖ„ÅåÁ¢∫ÂÆöÊ∏à„ÅøÔºà1‰∫∫„Å†„ÅëÊÆã„Å£„Å¶„ÅÑ„ÇãÔºâ
        const champ = active[0];
        desc.textContent = 'ÂÑ™ÂãùËÄÖ: ' + champ.username + ' „ÅÆË®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åô';
        select.innerHTML = '';
        const opt = document.createElement('option');
        opt.value = champ.entry_id;
        opt.textContent = champ.username + ' (ID-' + String(champ.entry_id).padStart(2,'0') + ')';
        select.appendChild(opt);
        select.value = champ.entry_id;
        selectGroup.style.display = 'none';
      } else {
        // Ë§áÊï∞ÊÆã„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈÅ∏ÊäûÂºè
        desc.textContent = 'ÂÑ™ÂãùËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åô';
        selectGroup.style.display = '';
        select.innerHTML = '<option value="">-- ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ --</option>';
        active.forEach(e => {
          const opt = document.createElement('option');
          opt.value = e.entry_id;
          opt.textContent = e.username + ' (ID-' + String(e.entry_id).padStart(2,'0') + ')';
          select.appendChild(opt);
        });
      }
      showModal('endTournamentModal');
    }

    // Â§ß‰ºöÁµÇ‰∫ÜÂÆüË°å
    function executeEndTournament() {
      const select = document.getElementById('championSelect');
      const championId = select.value;
      if (!championId) {
        showToast('ÂÑ™ÂãùËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return;
      }
      const champion = appState.entries.find(e => e.entry_id === parseInt(championId));
      if (!champion) {
        showToast('ÂÑ™ÂãùËÄÖ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
        return;
      }
      playClick();
      appendLog('üèÜ ' + champion.username + '„ÅåÂÑ™ÂãùÔºÅÂ§ß‰ºöÁµÇ‰∫Ü');
      tournamentEndedLocally = true;

      // CSVÁî®„Å´ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí„Ç≠„É£„Éó„ÉÅ„É£
      const csvData = {
        gameName: appState.tournament?.game_name || '‰∏çÊòé',
        adminName: appState.tournament?.admin_name || '‰∏çÊòé',
        championName: champion.username,
        entries: appState.entries.map(e => ({ entry_id: e.entry_id, username: e.username }))
      };

      // Â±•Ê≠¥„Å´‰øùÂ≠ò„Åó„Å¶„Åã„ÇâÂÖ®„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
      if (db) {
        db.collection('history').add({
          game_name: appState.tournament?.game_name || '‰∏çÊòé',
          admin_name: appState.tournament?.admin_name || '‰∏çÊòé',
          champion_name: champion.username,
          champion_id: champion.entry_id,
          total_participants: appState.entries.length,
          participants: appState.entries.map(e => ({ entry_id: e.entry_id, username: e.username, group: e.group || null })),
          group_winners: appState.tournament?.group_winners || null,
          date: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          // „Åô„Åπ„Å¶„ÅÆFirestore„Éá„Éº„Çø„ÇíÂâäÈô§
          const deletePromises = [];
          
          // Â§ß‰ºö„Éá„Éº„Çø„ÇíÂâäÈô§
          deletePromises.push(db.collection('tournaments').doc('current').delete());
          
          // „Ç®„É≥„Éà„É™„Éº„ÇíÂâäÈô§
          deletePromises.push(
            db.collection('entries').get().then(snap => {
              const batch = db.batch();
              snap.forEach(doc => batch.delete(doc.ref));
              return batch.commit();
            })
          );
          
          // Ë©¶Âêà„ÇíÂâäÈô§
          deletePromises.push(
            db.collection('matches').get().then(snap => {
              const batch = db.batch();
              snap.forEach(doc => batch.delete(doc.ref));
              return batch.commit();
            })
          );
          
          // „É≠„Ç∞„ÇíÂâäÈô§
          deletePromises.push(
            db.collection('logs').get().then(snap => {
              const batch = db.batch();
              snap.forEach(doc => batch.delete(doc.ref));
              return batch.commit();
            })
          );
          
          return Promise.all(deletePromises);
        }).then(() => {
          console.log('ÂÖ®„Éá„Éº„ÇøÂâäÈô§ÂÆå‰∫Ü');
          completeEndTournament(champion.username, csvData);
        }).catch(e => {
          console.error('„Éá„Éº„ÇøÂâäÈô§„Ç®„É©„Éº:', e);
          completeEndTournament(champion.username, csvData);
        });
      } else {
        completeEndTournament(champion.username, csvData);
      }
    }
    
    // Â§ß‰ºöÁµÇ‰∫Ü„ÅÆÂÆå‰∫ÜÂá¶ÁêÜ
    function completeEndTournament(championName, csvData) {
      // BGM„ÇíÈÄöÂ∏∏„Å´Êàª„Åô
      switchToNormalBGM();

      hideModal('endTournamentModal');
      showToast('Â§ß‰ºö„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅÂÑ™Âãù: ' + championName, 'success');

      // ÁÆ°ÁêÜËÄÖ„ÅÆ„Åø: CSVËá™Âãï„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
      if (csvData) {
        downloadTournamentCSV(csvData.gameName, csvData.adminName, csvData.championName, csvData.entries);
        showToast('ÂèÇÂä†ËÄÖÂêçÁ∞øCSV„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'info');
      }

      // „Éñ„É©„Ç±„ÉÉ„ÉàË°®Á§∫„ÅÆ„Éú„Çø„É≥„ÇíÊõ¥Êñ∞ÔºàÁµêÊûú„ÇíË¶ã„Åõ„Åü„Åæ„ÅæÔºâ
      const bracketBackBtn = document.getElementById('bracketBackBtn');
      if (bracketBackBtn) {
        bracketBackBtn.textContent = 'üè† „Çø„Ç§„Éà„É´„Å´Êàª„Çã';
        bracketBackBtn.setAttribute('onclick', 'goToTitleAfterEnd()');
      }
      const bracketEndBtn = document.getElementById('bracketEndBtn');
      if (bracketEndBtn) {
        bracketEndBtn.disabled = true;
        bracketEndBtn.style.opacity = '0.3';
        bracketEndBtn.style.cursor = 'not-allowed';
        bracketEndBtn.style.background = 'rgba(40,10,20,0.4)';
        bracketEndBtn.style.borderColor = '#555';
        bracketEndBtn.style.color = '#555';
        bracketEndBtn.style.boxShadow = 'none';
      }

      // „É´„Éº„É¨„ÉÉ„ÉàÁîªÈù¢„ÅÆ„Éú„Çø„É≥„ÇÇÊõ¥Êñ∞
      const endTournamentBtn = document.getElementById('endTournamentBtn');
      if (endTournamentBtn) {
        endTournamentBtn.textContent = 'üè† „Çø„Ç§„Éà„É´„Å´Êàª„Çã';
        endTournamentBtn.setAttribute('onclick', 'goToTitleAfterEnd()');
        endTournamentBtn.style.background = '';
        endTournamentBtn.style.borderColor = 'var(--hud-green)';
        endTournamentBtn.style.color = 'var(--hud-green)';
      }
    }

    // Â§ß‰ºöÁµÇ‰∫ÜÂæå„Å´„Çø„Ç§„Éà„É´ÁîªÈù¢„Å´Êàª„Çã
    function goToTitleAfterEnd() {
      tournamentEndedLocally = false;

      // „É≠„Éº„Ç´„É´Áä∂ÊÖã„ÇíÂÆåÂÖ®„É™„Çª„ÉÉ„Éà
      appState.tournament = null;
      appState.entries = [];
      appState.matches = [];
      appState.selectedPlayer1 = null;
      appState.selectedPlayer2 = null;
      appState.matchingIds = [];
      appState.activeGroup = null;
      appState.groupPhase = null;
      appState.isAdmin = false;
      appState.adminName = null;
      bracketMode = false;

      // ÁÆ°ÁêÜËÄÖÊÉÖÂ†±„ÇílocalStorage„Åã„ÇâÂâäÈô§
      localStorage.removeItem('tournament_admin_name');

      // „Ç∞„É´„Éº„Éó„Çø„Éñ„ÇíÈùûË°®Á§∫
      const groupTabsEl = document.getElementById('groupTabsContainer');
      if (groupTabsEl) groupTabsEl.style.display = 'none';

      // HUD„É≠„Ç∞„Çí„ÇØ„É™„Ç¢
      hudLogs.length = 0;

      // ÁîªÈù¢„ÇíÊõ¥Êñ∞
      updateTournamentDisplay();
      updateEntriesDisplay();
      updateHudVisibility();

      // ÁîªÈù¢Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢
      screenHistory = [];

      // „Åô„Åπ„Å¶„ÅÆÁîªÈù¢„ÇíÈùûË°®Á§∫
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById('titleScreen').classList.add('active');
      currentScreen = 'titleScreen';

      // „Éò„ÉÉ„ÉÄ„Éº„ÇíÈùûË°®Á§∫
      document.getElementById('mainHeader').classList.remove('visible');
      document.getElementById('backBtn').classList.remove('visible');

      // ÊäΩÈÅ∏‰ºöÂ†¥„ÅÆÁä∂ÊÖã„ÇíÂÆåÂÖ®„É™„Çª„ÉÉ„Éà
      const bracketContainer = document.getElementById('bracketContainer');
      if (bracketContainer) bracketContainer.classList.remove('active');

      const lotteryArena = document.getElementById('lotteryArena');
      if (lotteryArena) {
        lotteryArena.style.display = 'none';
        lotteryArena.style.gridTemplateColumns = '';
      }

      const lotteryEntrance = document.getElementById('lotteryEntrance');
      if (lotteryEntrance) lotteryEntrance.style.display = '';

      const preArenaList = document.getElementById('preArenaList');
      if (preArenaList) preArenaList.style.display = '';

      const rouletteMain = document.querySelector('.lottery-main');
      if (rouletteMain) rouletteMain.style.display = 'flex';

      const lotterySidebar = document.querySelector('.lottery-sidebar');
      if (lotterySidebar) lotterySidebar.style.display = '';

      // „É´„Éº„É¨„ÉÉ„ÉàÈñ¢ÈÄ£„Çí„É™„Çª„ÉÉ„Éà
      const rouletteAdminControls = document.getElementById('rouletteAdminControls');
      if (rouletteAdminControls) rouletteAdminControls.style.display = 'none';

      const bracketControls = document.getElementById('bracketControls');
      if (bracketControls) bracketControls.style.display = 'none';

      const wheelInner = document.getElementById('wheelInner');
      if (wheelInner) wheelInner.style.transform = 'rotate(0deg)';

      // VSË°®Á§∫„Çí„É™„Çª„ÉÉ„Éà
      updateVsDisplay(null, null);
      disableWinnerSelection();
      updateMatchmakingButton();
      updateHudVisibility();

      // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÂÖÉ„Å´Êàª„Åô
      const bracketBackBtn = document.getElementById('bracketBackBtn');
      if (bracketBackBtn) {
        bracketBackBtn.textContent = 'üé≤ „É´„Éº„É¨„ÉÉ„Éà„Å´Êàª„Çã';
        bracketBackBtn.setAttribute('onclick', 'toggleBracketView()');
      }
      const bracketEndBtn = document.getElementById('bracketEndBtn');
      if (bracketEndBtn) {
        bracketEndBtn.disabled = false;
        bracketEndBtn.style.opacity = '';
        bracketEndBtn.style.cursor = '';
        bracketEndBtn.style.display = 'none';
        bracketEndBtn.style.background = 'rgba(40,10,20,0.8)';
        bracketEndBtn.style.borderColor = 'var(--hud-red)';
        bracketEndBtn.style.color = 'var(--hud-red)';
        bracketEndBtn.style.boxShadow = '';
      }
      const endTournamentBtn = document.getElementById('endTournamentBtn');
      if (endTournamentBtn) {
        endTournamentBtn.textContent = 'Â§ß‰ºöÁµÇ‰∫Ü„ÉªË®òÈå≤';
        endTournamentBtn.setAttribute('onclick', 'confirmEndTournament()');
        endTournamentBtn.style.background = 'rgba(40,10,20,0.8)';
        endTournamentBtn.style.borderColor = 'var(--hud-red)';
        endTournamentBtn.style.color = 'var(--hud-red)';
      }
    }
    
    // „Éà„Éº„Éä„É°„É≥„Éà„ÇíË¶ã„Çã„Éú„Çø„É≥„ÅÆË°®Á§∫Âà∂Âæ°ÔºàÂ∏∏„Å´Ë°®Á§∫Ôºâ
    function updateTournamentViewButton() {
      // Â∏∏„Å´Ë°®Á§∫ÔºàÂèÇÂä†ËÄÖ„É™„Çπ„Éà„ÅØË¶ã„Çå„Çã„Çà„ÅÜ„Å´„Åô„ÇãÔºâ
    }
    function loadHistory() {
      if (!db) { document.getElementById('historyList').innerHTML = '<p style="text-align:center;color:var(--text-dim);">„Éá„Éº„Çø„Éô„Éº„ÇπÊú™Êé•Á∂ö</p>'; return; }
      db.collection('history').orderBy('date', 'desc').get().then(snap => {
        const l = document.getElementById('historyList');
        if (snap.empty) { l.innerHTML = '<p style="text-align:center;color:var(--text-dim);">Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>'; return; }
        l.innerHTML = snap.docs.map((d, idx) => {
          const x = d.data();
          const dt = x.date?.toDate?.() || new Date();
          const participants = x.participants || [];
          const participantList = participants.length > 0
            ? '<div id="historyParticipants' + idx + '" style="display:none;margin-top:0.5rem;padding:0.5rem;background:rgba(0,20,10,0.5);border:1px solid var(--hud-green-dim);border-radius:4px;font-size:0.75rem;color:var(--text-dim);max-height:200px;overflow-y:auto;">'
              + participants.map(p => 'ID-' + String(p.entry_id).padStart(2,'0') + ' ' + escapeHtml(p.username)).join('<br>')
              + '</div>'
              + '<div style="margin-top:0.4rem;">'
              + '<button onclick="toggleHistoryParticipants(' + idx + ', this)" style="font-size:0.7rem;padding:0.2rem 0.6rem;background:rgba(0,40,20,0.8);border:1px solid var(--hud-green-dim);color:var(--hud-green);border-radius:4px;cursor:pointer;">‚ñº ÂèÇÂä†ËÄÖ‰∏ÄË¶ß (' + participants.length + 'Âêç)</button>'
              + '</div>'
            : '';
          return '<div class="history-card"><div class="history-date">' + dt.toLocaleDateString('ja-JP') + '</div><div class="history-game">' + escapeHtml(x.game_name || '‰∏çÊòé') + '</div><div class="history-winner">üëë ÂÑ™Âãù: ' + escapeHtml(x.champion_name || '‰∏çÊòé') + '</div><div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.4rem;">ÁÆ°ÁêÜËÄÖ: ' + escapeHtml(x.admin_name || '‰∏çÊòé') + ' / ÂèÇÂä†ËÄÖ: ' + (x.total_participants || 0) + 'Âêç</div>' + participantList + '</div>';
        }).join('');
      });
    }
    function toggleHistoryParticipants(idx, btn) {
      const el = document.getElementById('historyParticipants' + idx);
      if (!el) return;
      const count = el.querySelectorAll('br').length + 1;
      if (el.style.display === 'none') { el.style.display = 'block'; btn.textContent = '‚ñ≤ ‰∏ÄË¶ß„ÇíÈñâ„Åò„Çã'; }
      else { el.style.display = 'none'; btn.textContent = '‚ñº ÂèÇÂä†ËÄÖ‰∏ÄË¶ß (' + count + 'Âêç)'; }
    }
    // ÁÆ°ÁêÜËÄÖÂ∞ÇÁî®ÔºöÂ§ß‰ºöÁµÇ‰∫ÜÊôÇ„Å´CSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    function downloadTournamentCSV(gameName, adminName, championName, entries) {
      const now = new Date();
      const year = now.getFullYear();
      const dateStr = now.toLocaleDateString('ja-JP');
      let csv = '\uFEFF';
      csv += 'Â§ß‰ºöÊó•,„Ç≤„Éº„É†Âêç,ÁÆ°ÁêÜËÄÖ,ÂÑ™ÂãùËÄÖ,ÂèÇÂä†ËÄÖÊï∞\n';
      csv += '"' + dateStr + '","' + (gameName || '‰∏çÊòé') + '","' + (adminName || '‰∏çÊòé') + '","' + (championName || '‰∏çÊòé') + '",' + entries.length + '\n';
      csv += '\nID,ÂèÇÂä†ËÄÖÂêç\n';
      entries.forEach(e => { csv += 'ID-' + String(e.entry_id).padStart(2,'0') + ',"' + e.username + '"\n'; });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = year + '_' + (gameName || 'tournament') + '_ÂèÇÂä†ËÄÖÂêçÁ∞ø.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }
    
    // „É™„Çª„ÉÉ„ÉàÁ¢∫Ë™ç
    function confirmResetTournament() {
      // Á∑†ÂàáÂæå„Åã„Å§ÂèÇÂä†ËÄÖ„Åå„ÅÑ„ÇãÂ†¥Âêà„ÅØ„É™„Çª„ÉÉ„Éà‰∏çÂèØ
      const dl = appState.tournament?.deadline;
      if (dl) {
        const d = dl.toDate ? dl.toDate() : new Date(dl);
        if (new Date() >= d && appState.entries.length > 0) {
          showToast('Á∑†ÂàáÊó•ÊôÇ‰ª•Èôç„ÅØÂ§ß‰ºöÁµÇ‰∫Ü„Åæ„Åß„É™„Çª„ÉÉ„Éà„Åß„Åç„Åæ„Åõ„Çì', 'error');
          return;
        }
      }
      showModal('resetTournamentModal');
    }
    
    // „É™„Çª„ÉÉ„ÉàÂÆüË°å
    async function executeResetTournament() {
      playClick();
      appendLog('‚ö†Ô∏è ÁÆ°ÁêÜËÄÖ„ÅåÂ§ß‰ºö„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
      
      if (db) {
        // ÂÖ®„Éá„Éº„ÇøÂâäÈô§
        try {
          await db.collection('tournaments').doc('current').delete();
          const entriesSnap = await db.collection('entries').get();
          const entriesBatch = db.batch();
          entriesSnap.forEach(doc => entriesBatch.delete(doc.ref));
          await entriesBatch.commit();
          
          const matchesSnap = await db.collection('matches').get();
          const matchesBatch = db.batch();
          matchesSnap.forEach(doc => matchesBatch.delete(doc.ref));
          await matchesBatch.commit();
        } catch (e) { console.error('Reset error:', e); }
      }
      
      // „É≠„Éº„Ç´„É´Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
      localStorage.removeItem('tournament_admin_name');
      appState.tournament = null;
      appState.entries = [];
      appState.matches = [];
      appState.isAdmin = false;
      appState.adminName = null;
      
      hideModal('resetTournamentModal');
      showToast('Â§ß‰ºö„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„Åü', 'success');
      
      setTimeout(() => {
        goToTitle();
        updateTournamentDisplay();
      }, 1000);
    }
    
    // „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
    function updateResetButton() {
      const btn = document.getElementById('resetTournamentBtn');
      if (!btn) return;
      const dl = appState.tournament?.deadline;
      if (dl) {
        const d = dl.toDate ? dl.toDate() : new Date(dl);
        if (new Date() >= d) {
          btn.disabled = true;
          btn.style.opacity = '0.3';
        } else {
          btn.disabled = false;
          btn.style.opacity = '';
        }
      }
    }
  </script>
</body>
</html>
