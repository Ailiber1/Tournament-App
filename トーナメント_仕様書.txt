# 汎用トーナメント管理アプリ 公式仕様書

---

## 概要
- 汎用トーナメント管理アプリ
- ゲーム非依存（あらゆる対戦ゲームに対応）
- PC / スマホ対応（レスポンシブ）
- リアルタイム同期
- クラウド：Firebase
- **単体運用をデフォルトとする**
- **ゲームアプリ連携は任意（デフォルト無効）**

---

## 設計方針
- 締切日ベースで参加を制御（途中参加禁止）
- 観戦は常時可能（未登録ユーザーも閲覧可能）
- 管理者操作は誤操作防止を最優先（確認ポップ必須）
- Firebaseを唯一の正として状態を一元管理
- ゲーム名単位で大会・履歴を管理
- 大人数・長いユーザー名でも破綻しない表示設計
- **連携前提の挙動をデフォルトにしない**

---

## ユーザー種別

### 参加者（Player）
- ユーザーネーム必須（同名禁止）
- 参加登録時に参加IDを自動付与
- 1デバイスにつき1ユーザーのみ登録可能
- アイコン設定は任意（丸型表示）
- 締切日前まで登録・キャンセル可能
- 締切日以降は登録・キャンセル不可

### 観戦者（Viewer）
- 登録不要
- トーナメント閲覧のみ可能

### 管理者（Admin）
- 管理者は複数人存在可能
- あなた以外のユーザーが管理者になるケースを正式に想定
- 管理者登録後は、以下すべての操作が可能
  - ゲーム名登録・変更
  - トーナメント作成・編集
  - 締切日時設定・変更
  - 参加人数上限の設定・変更
  - ルーレット操作
  - 勝敗確定・取消
  - 優勝確定
  - 履歴管理
  - 回戦ごとの対戦日時設定（任意）
  - デバイス制限の例外解除
  - **ゲーム連携の有効化／無効化**

---

## タイトル画面（表示順・分離禁止）

### メインボタン
- [ エントリー登録する ]
- [ トーナメントを見る ]
- [ 過去の大会記録を見る ]
- [ 管理者登録をする ]

### 情報アイコン

#### アプリ説明アイコン（一般向け）
- タイトル画面に常設
- 内容：
  - アプリの目的
  - 参加方法
  - 観戦方法
  - ルーレット・トーナメントの基本構造
- 参加者・観戦者向け説明のみ

#### 管理者説明アイコン（管理者向け）
- タイトル画面に常設（別アイコン）
- 管理者登録有無に関わらず閲覧可能
- 内容：
  - 管理者操作一覧
  - グループフェーズの考え方
  - 20名以下でトーナメント表に切替するルール
  - ルーレット操作方法
  - 勝敗確定・取消の注意点
  - 誤操作防止の設計思想
  - **外部ゲーム連携は任意であり、デフォルト無効であること**

---

## 参加登録（Entry）
- 締切日以降は登録・キャンセル不可
- 同名禁止
- 最大100人
- 登録順に参加ID付与
- 本人は自分の参加IDを必ず確認可能

---

## 参加者名簿
- 誰でも閲覧可能
- 表示内容：
  - 参加ID
  - ユーザー名
  - アイコン（任意）
  - 状態（ACTIVE / LOST / SEED）
- 状態表示：
  - ACTIVE：明色
  - LOST：薄色
  - SEED：明示表示

---

## グループ構成ルール

- グループ：A / B / C / D / E
- 各グループ最大20名
- 21名以上の場合はグループフェーズで進行
- 未使用グループは表示のみ、操作不可

---

## ルーレット仕様
- 締切日以降のみ使用可能
- ルーレット盤：参加IDのみ表示
- 中央HUD：
  - 登録名（ID-xx） VS 登録名（ID-yy）
- 1回の確定＝1試合
- 勝敗確定・取消は管理者のみ
- 確定時は必ず最終確認ポップ
- 取消で完全巻き戻し

---

## シード仕様
- 奇数人数の場合は必ず1名
- **自動ランダム選出**
- 該当ラウンドのルーレット対象外
- SEED表示を必須

---

## トーナメント表ルール

### 作成条件
- **20名以下（20含む）の場合のみ作成可能**
- 21名以上では作成不可

### 管理者裁量
- 20名以下になった時点から
  - 管理者は任意のタイミングで切替可能
- 少人数（例：6名）の場合
  - 最初からトーナメント表で進行可能

### 表示仕様
- 縦構造（下→上）
- 横型トーナメントは禁止
- 縦スクロール
- ピンチズーム（俯瞰／詳細）
- スマホ縦横回転対応
- 現在対戦フォーカスHUD常時表示

---

## トーナメント表作成時の組み合わせ方式

### 方式A：ルーレット
- ルーレットで組み合わせ決定
- 抽選過程を観戦者・参加者が視認可能

### 方式B：自動ランダム配置
- ランダムシャッフルで即配置
- 演出なし・テンポ優先

※いずれも奇数時は自動ランダムSEEDを適用

---

## ゲームアプリ連携仕様（任意・デフォルト無効）

### 基本方針
- 本アプリは **単体運用をデフォルト** とする
- ゲーム連携は **常に可能な設計** だが、**自動では行わない**
- 管理者の明示操作がない限り、連携は無効

### 有効化条件
- 管理者が手動で「ゲーム連携を有効化」した場合のみ動作
- 有効化しない限り、外部からの勝敗入力は一切反映しない

### 連携時の扱い
- 勝敗反映は以下のいずれか（管理者判断）
  - 管理者が内容を確認したうえで確定
  - 外部入力を参照して反映
- **最終的な勝敗確定権限は常に管理者**

### 禁止事項
- 指示なしに自動連携しない
- 連携前提のUI・進行にしない

---

## Firebaseデータ管理方針

- Firebaseを唯一の正とする
- 主なコレクション例：
  - games
  - tournaments
  - entries
  - rounds
  - matches
  - history
  - devices
  - device_override_logs
- 不要なリアルタイム書き込みは禁止
- 保存対象は確定結果のみ
- 大会終了後は履歴化
- 削除は管理者のみ

※コレクション構成は設計方針であり、名称・分割は実装都合で変更可

---

## 設計思想まとめ（保持）
- 大人数前提でもUIが破綻しない
- IDと登録名の役割を明確に分離
- 観戦者・参加者双方が理解しやすい構造
- 締切・人数制御でトーナメント崩壊を防止
- 演出価値と実装現実性の両立
- 汎用設計で複数ゲーム展開に対応

---

# 追加確定事項（実装判断用）

## 重要ルール（変更不可・追記）
- タイトル画面のボタンは分離しない（上記メインボタン構成を固定）
- 途中参加禁止（締切日以降は登録・キャンセル不可）
- 同名禁止（同一ユーザー名は使用不可）
- 1デバイスにつき1ユーザーのみ登録
- 最大参加人数は100人（管理者が変更可能）
- 参加登録順で参加ID（ID-01, ID-02…）を自動付与
- 参加者本人は「自分の参加ID」を必ず確認できる
- 参加者名簿には「参加ID＋ユーザー名」を表示（誰でも閲覧可）

---

## ルーレット・トーナメント表示の考え方（追記）
- ルーレット盤上には「参加IDのみ」を表示（100人対応のため）
- 中央HUDでは必ず「登録名（ID-xx） VS 登録名（ID-yy）」を大きく表示
- トーナメント表は下から上に勝ち上がる縦構造
- 横型トーナメントは禁止
- 大人数の場合は
  - ラウンド分割
  - 縦スクロール
  - ズーム
  - 現在対戦フォーカス
  で表示する（1画面に100人は出さない）

---

## 管理者操作（追記）
- ルーレット操作は締切日以後のみ有効
- 勝敗確定・取消は管理者のみ
- 勝敗操作は必ず最終確認ポップを出す
- 勝敗取消で状態を完全に巻き戻せる
- 対戦日時（1回戦・2回戦など）をカレンダーで設定可能（任意）
- 負け判定は管理者操作で確定（参加者が自分で確定しない）
- 敗者は「ユーザー名を消す」のではなく、色を落として敗退が分かる状態にする
- 勝者（ACTIVE）のみ明るく表示される状態を維持する（名簿・トーナメント双方）

---

## 演出・世界観（追記）
- マトリックス風・SFネオン調
- 勝者は上にネオンで上がる演出
- 優勝時は王冠・金色ネオン
- BGM・SEあり（ON/OFF切替可能）

---

## 1) トーナメント表切替の人数判定
- 判定対象は **ACTIVE の人数のみ** とする。
- LOST は人数判定に含めない。

---

## 2) トーナメント表切替後のグループの扱い
- グループ（A〜E）は削除しない。
- 名簿リストとして閲覧用に残す（観戦者が見やすい状態を維持）。
- 進行（勝敗操作）はトーナメント表側で行う。

---

## 3) 方式A（ルーレット）の回転数ルール（最終確定）
- ACTIVE人数を N とする。

### 偶数人数（Nが偶数）
- ルーレット回数：**(N / 2) - 1 回**
- 残り2名は自動的に最後の対戦カードとして確定。

### 奇数人数（Nが奇数）
- ルーレット回数：**floor(N / 2) 回**
- 対戦カードを確定した後、最後に残った1名を **SEED（自動ランダム）** として確定。
- 残り3名の段階で「誰が誰と対戦し、誰がシードか」を決めるため、必要回数分は必ず回す。

---

## 4) 大会終了・記録・完全リセット（最終確定）

### トリガー
- 管理者のみ表示される **「記録する」ボタン** 押下。

### 押下時の処理（同時実行）
1) 履歴保存（history）
   - 西暦（YYYY）
   - 大会日時
   - 大会ゲーム名
   - 当時参加したメンバー（参加ID＋登録名）
   - 最終結果（優勝者など）
2) 完全リセット（初期状態へ）
   - entries（登録名・参加ID・状態）を全初期化
   - rounds / matches / トーナメント進行状態を全初期化
   - 管理者状態も保持しない（次回大会は管理者登録から必須）

### 一般ユーザー表示
- 「お疲れ様でした。大会は終了しました」ポップ表示
- タイトル画面に戻るボタンを表示

---

## 5) 1デバイスにつき1ユーザー（IP依存禁止・追記）
- IPアドレスでの判定は採用しない。
- 端末ローカルで生成したインストール識別子（deviceId）を用いて制限を担保する。
- devices / device_override_logs を用いて記録・例外対応を行う（管理者のみ例外解除）。

---

## 6) 履歴（history）の削除権限（表現確定）
- 履歴の削除は **サーバー管理権限を持つ運営者のみ** が実行可能。
- トーナメントアプリ内の管理者（大会運営者）には削除権限を付与しない。
- サーバー管理者は、保存容量・サーバー負荷を考慮し、必要に応じて古い履歴を削除できる。

---

# 不安要素の解消（実装確定事項：解釈分岐を禁止）

## A) Firebaseの範囲（確定）
- 本アプリが使用するデータベースは **Cloud Firestoreのみ** とする。
- Realtime Database は使用しない。
- Firebase Storage は本仕様の範囲外（使用しない）。
- Firebase Hosting の使用有無は実装都合に委ねる（仕様範囲外）。

## B) 「削除は管理者のみ」と「履歴削除は運営者のみ」の優先順位（確定）
- 「削除は管理者のみ」は **進行データ（entries / rounds / matches 等）** に適用する。
- history（履歴）削除は **サーバー管理権限を持つ運営者のみ** に限定する（アプリ内管理者は不可）。

## C) 管理者の判定方法（確定）
- 管理者判定は Firebase Authentication の UID を用いる。
- tournaments に **admin_uids（配列）** を保持し、UIDが含まれる場合のみ管理者権限を付与する。

## D) deviceId制限の扱い（確定）
- deviceIdは端末ローカルに永続保存する（アプリ削除で消える前提）。
- **再インストール／機種変更は別デバイス扱い** とする。
- 例外解除は devices / device_override_logs に記録し、管理者操作でのみ実行可能。

## E) ルーレット抽選の単位（確定）
- 「1回の確定＝1試合」を厳守する。
- 1試合確定とは「対戦する2名（VSカード）」を確定することを指す。
- 確定済みの参加IDは、次の抽選対象から除外する（重複抽選禁止）。
